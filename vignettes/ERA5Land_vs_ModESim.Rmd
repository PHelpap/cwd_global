---
title: "PCWD values from ModE-Sim vs ERA5Land output"
author: "Patricia Helpap"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r libraries, message=FALSE, echo=FALSE}
library(readr)
library(dplyr)
library(here)
library(lubridate)
library(patchwork)
library(ggplot2)
library(ncdf4)
library(reshape2)
library(ggpubr)
library(maps)
library(terra)
library(rnaturalearth)
library(sf)
library(rgdal)
library(sp)
library(RColorBrewer)
library(rJava)
library(tidyverse)
library(abind)
library(patchwork)
library(gridExtra)
library(DescTools) #for GINI calculation
library(ggsci)
library(purrr)
library(qmap)
```

## Comparison of ModE-Sim and ERA5-Land PCWD data

### Read in ERA5Land data

Read in and select only the overlapping years (1950-2009)
```{r}
#lat lon and time info from netcdf files
##read in data
input_file_ERA5 <- "/storage/research/giub_geco/data_2/scratch/phelpap/ERA5Land_1950-2024/04_result/PCWD_ANNMAX.nc"

nc_pwcd_ERA5 <- nc_open(input_file_ERA5)
pcwd_annmax_ERA5 = ncvar_get(nc_pwcd_ERA5, varid="pcwd_annmax")
lon = ncvar_get(nc_pwcd_ERA5, varid="lon")
lat = ncvar_get(nc_pwcd_ERA5, varid="lat") # --- will contain less latitudes as only contains Land data
time_ERA5 = ncvar_get(nc_pwcd_ERA5, varid="time")
# Convert to actual dates (days since 2001-01-01)
reference_date <- as.Date("2001-01-01")
time_dates_ERA5 <- reference_date + time_ERA5
# 
# Filter data to retain only years up to 2009
years <- as.numeric(format(time_dates_ERA5, "%Y"))
keep_indices <- which(years <= 2009)

# Subset time and data arrays
time_dates_ERA5_fil <- time_dates_ERA5[keep_indices]
pcwd_annmax_ERA5_fil <- pcwd_annmax_ERA5[,,keep_indices]  # Assuming time is the 3rd dimension


nc_close(nc_pwcd_ERA5)

```


### Read in ModE-Sim data 

Read in lat, lon and time info: 
```{r}
#lat lon and time info from netcdf files
##read in data
input_file_1850 <- "/storage/research/giub_geco/data_2/scratch/phelpap/ModESim/m001_tidy/04_result_1850/PCWD_ANNMAX.nc"

nc_pwcd_1850 <- nc_open(input_file_1850)
pcwd_annmax_1850 = ncvar_get(nc_pwcd_1850, varid="pcwd_annmax")
lon = ncvar_get(nc_pwcd_1850, varid="lon")
lat = ncvar_get(nc_pwcd_1850, varid="lat") 
time_1850 = ncvar_get(nc_pwcd_1850, varid="time")
# Convert to actual dates (days since 2001-01-01)
reference_date <- as.Date("2001-01-01")
time_dates_1850 <- reference_date + time_1850

# Filter data to retain only years up to 2009
years <- as.numeric(format(time_dates_1850, "%Y"))
keep_indices <- which(years >= 1950)

# Subset time and data arrays
time_dates_1850_fil <- time_dates_1850[keep_indices]
pcwd_annmax_1850_fil <- pcwd_annmax_1850[,,keep_indices]  # Assuming time is the 3rd dimension

nc_close(nc_pwcd_1850)

## read in 1420 period
input_file_1420 <- "/storage/research/giub_geco/data_2/scratch/phelpap/ModESim/m001_tidy/04_result_1420/PCWD_ANNMAX.nc"

nc_pwcd_1420 <- nc_open(input_file_1420)
pcwd_annmax_1420 = ncvar_get(nc_pwcd_1420, varid="pcwd_annmax")
time_1420 = ncvar_get(nc_pwcd_1420, varid="time")
# Convert to actual dates (days since 2001-01-01)
reference_date <- as.Date("2001-01-01")
time_dates_1420 <- reference_date + time_1420

# Filter data to retain only years up to 2009
years <- as.numeric(format(time_dates_1420, "%Y"))

nc_close(nc_pwcd_1420)
```

aggregate files and select only the overlapping years (1950-2009): 
```{r}
#### 1850 set: 
# Define the base path - have to think of way to seperate sets once there is data!!
path <- "/storage/research/giub_geco/data_2/scratch/phelpap/ModESim/"

# List all the directories within the base path
folders <- list.files(path, full.names = TRUE)

# Extract ensemble member identifiers from folder names
ensemble_members <- basename(folders)

# Identify the target files
target_files <- file.path(folders, "04_result_1850/PCWD_ANNMAX.nc")
target_files <- target_files[file.exists(target_files)]  # Ensure only existing files are included

# Filter ensemble members to match target files
ensemble_members <- ensemble_members[file.exists(target_files)]

# Initialize a list to store data for each ensemble member
data_by_ensemble_1850_fil <- list()
data_by_ensemble_1850 <- list()

# Extract dimensions from the first file to initialize the array size for consistency
nc <- nc_open(target_files[1])
dim_x <- dim(ncvar_get(nc, "pcwd_annmax"))[1]
dim_y <- dim(ncvar_get(nc, "pcwd_annmax"))[2]
dim_z <- dim(ncvar_get(nc, "pcwd_annmax"))[3]
nc_close(nc)

# Convert time variable to actual dates (assuming "days since 2001-01-01")
reference_date <- as.Date("2001-01-01")
time_dates <- reference_date + time_1850

# Find indices corresponding to years >= 1968
years <- as.numeric(format(time_dates, "%Y"))
keep_indices <- which(years >= 1950)

# Loop through all the target files and filter data
for (i in seq_along(target_files)) {
  file <- target_files[i]
  member <- ensemble_members[i]
  
  # Open the NetCDF file
  nc <- nc_open(file)
  
  # Extract the data variable
  data <- ncvar_get(nc, "pcwd_annmax")  # Adjust "pcwd_annmax" to your variable name
  
  # Subset data to retain only years from 1968 onwards
  data_filtered <- data[,,keep_indices]

  # Store the filtered data in the list
  data_by_ensemble_1850_fil[[member]] <- data_filtered
  data_by_ensemble_1850[[member]] <- data
  
  # Close the file
  nc_close(nc)
}

# Output the structure of the data list
print(names(data_by_ensemble_1850_fil))  # Check stored ensemble members
print(dim(data_by_ensemble_1850[[1]]))  # Check dimensions of the data for the first ensemble member

```

Aggregate 1420 files also: 
```{r}
#### 1420 set: 
# Define the base path - have to think of way to seperate sets once there is data!!
path <- "/storage/research/giub_geco/data_2/scratch/phelpap/ModESim/"

# List all the directories within the base path
folders <- list.files(path, full.names = TRUE)

# Extract ensemble member identifiers from folder names
ensemble_members <- basename(folders)

# Identify the target files
target_files <- file.path(folders, "04_result_1420/PCWD_ANNMAX.nc")
target_files <- target_files[file.exists(target_files)]  # Ensure only existing files are included

# Filter ensemble members to match target files
ensemble_members <- ensemble_members[file.exists(target_files)]

# Initialize a list to store data for each ensemble member
data_by_ensemble_1420 <- list()

# Extract dimensions from the first file to initialize the array size for consistency
nc <- nc_open(target_files[1])
dim_x <- dim(ncvar_get(nc, "pcwd_annmax"))[1]
dim_y <- dim(ncvar_get(nc, "pcwd_annmax"))[2]
dim_z <- dim(ncvar_get(nc, "pcwd_annmax"))[3]
nc_close(nc)

# Convert time variable to actual dates (assuming "days since 2001-01-01")
reference_date <- as.Date("2001-01-01")
time_dates <- reference_date + time_1420

# Loop through all the target files and filter data
for (i in seq_along(target_files)) {
  file <- target_files[i]
  member <- ensemble_members[i]
  
  # Open the NetCDF file
  nc <- nc_open(file)
  
  # Extract the data variable
  data <- ncvar_get(nc, "pcwd_annmax")  # Adjust "pcwd_annmax" to your variable name
   
  # Store the filtered data in the list
  data_by_ensemble_1420[[member]] <- data[,,1:430] #only until 1849
  
  # Close the file
  nc_close(nc)
}

# Output the structure of the data list
print(names(data_by_ensemble_1420))  # Check stored ensemble members
print(dim(data_by_ensemble_1420[[1]]))  # Check dimensions of the data for the first ensemble member
```


Compare global distribution of data sets
```{r}
#Calculate epoch mean of ModESim: 
ensemble_array <- simplify2array(data_by_ensemble_1850_fil)  # Shape: [192, 96, 42, 20]

# Compute the ensemble mean across the 3rd dimension (time)
ensemble_means_1850 <- apply(ensemble_array, c(1, 2, 4), mean, na.rm = TRUE)  # Shape: [192, 96, 20]
dim(ensemble_means_1850)
# Compute the ensemble mean across the 3rd dimension (time)
means_1850 <- apply(ensemble_means_1850, c(1, 2), mean, na.rm = TRUE)  # Shape: [192, 96]
dim(means_1850)

#Calculate epoch mean for ERA5:
ensemble_array <- simplify2array(pcwd_annmax_ERA5_fil)  # Shape: [192, 96, 42]

# Compute the ensemble mean across the 3rd dimension (time)
means_ERA5 <- apply(ensemble_array, c(1, 2), mean, na.rm = TRUE)  # Shape: [192, 96]
dim(means_ERA5)

```



```{r}
#plot ERA5Land data to validate
r <- raster(t(means_ERA5), xmn=min(lon), xmx=max(lon), ymn=min(lat), ymx=max(lat))
crs(r) <- "+proj=longlat +datum=WGS84"  # Set CRS for raster
r <- flip(r, direction='y')

# Retrieve land polygons and set the same CRS as the raster
land <- ne_countries(scale = "medium", returnclass = "sf")
land <- st_transform(land, crs = st_crs(r))  # Ensure CRS alignment

# Mask the raster with land polygons to remove ocean values
#r_masked <- mask(r, as(land, "Spatial"))

# Convert the masked raster to a data frame for ggplot2
r_df <- as.data.frame(r, xy = TRUE)
colnames(r_df) <- c("x", "y", "layer")  # Rename columns to match ggplot expectations

# Define custom color bins
custom_bins <- c(0, 20, 40, 60, 80, 100, 150, 200, 300, 500, 700, 900, 1200, 2000, Inf)  # Define breaks based on data range
# Define a custom 13-color palette from deep turquoise to bright pink with earthy tones in between
# Updated custom color palette with two additional colors
custom_colors <- c("#004f5a",  # New color: a darker turquoise at the beginning
                   "#006d75", "#1a9e96", "#55c1ab", "#85c68b", "#d1c54b", "#e8b249", 
                   "#e3842a", "#d45321", "#ba2e1f", "#9e2d2a", "#803c3d", "#63363f", 
                   "#9c276e",  # New color: a deeper shade in the pink tones
                   "#d238a5")

# Define the numeric labels for the breaks
break_labels <- c(as.character(scales::label_number(accuracy = 1)(custom_bins[-length(custom_bins)])), "Ocean")

# Define bounding box for Africa
#bbox <- c(xmin = -30, xmax = 60, ymin = -35, ymax = 30)  # Approximate bounding box for Oceania


# Define the ggplot2 object with the gradient scale
ggplot() +
  geom_raster(data = r_df, aes(x = x, y = y, fill = cut(layer, breaks = custom_bins)), na.rm = TRUE) +
  scale_fill_manual(name = "mean PCWD (mm)", values = custom_colors, na.value = "grey50", 
                    labels = c(levels(cut(r_df$layer, breaks = custom_bins)),"Ocean")) +  # Label ocean
  labs(title = "ERA5-Land", x = "Longitude", y = "Latitude") +
  theme_classic() +
  geom_sf(data = land, fill = NA, color = "black", lwd = 0.3) +
  coord_sf(xlim =	c(-180, 178.125), ylim =	c(-60, 90), expand = FALSE) + #leave out Antarctica
  theme(legend.position = "none", legend.title = element_text(size=15), legend.text = element_text(size=15), 
        axis.text = element_text(size=14), axis.title = element_text(size=14)) +
  guides(fill = guide_legend(title = "PCWD [mm]", reverse = TRUE))  # Adjust legend for better presentation

```

```{r}
#plot ModESim ensemble mean for the same period
r <- raster(t(means_1850), xmn=min(lon), xmx=max(lon), ymn=min(lat), ymx=max(lat))
crs(r) <- "+proj=longlat +datum=WGS84"  # Set CRS for raster
r <- flip(r, direction='y')

# Retrieve land polygons and set the same CRS as the raster
land <- ne_countries(scale = "medium", returnclass = "sf")
land <- st_transform(land, crs = st_crs(r))  # Ensure CRS alignment

# Mask the raster with land polygons to remove ocean values
r_masked <- mask(r, as(land, "Spatial"))

# Convert the masked raster to a data frame for ggplot2
r_df <- as.data.frame(r_masked, xy = TRUE)
colnames(r_df) <- c("x", "y", "layer")  # Rename columns to match ggplot expectations

# Define custom color bins
custom_bins <- c(0, 20, 40, 60, 80, 100, 150, 200, 300, 500, 700, 900, 1200, 2000, Inf)  # Define breaks based on data range
# Define a custom 13-color palette from deep turquoise to bright pink with earthy tones in between
# Updated custom color palette with two additional colors
custom_colors <- c("#004f5a",  # New color: a darker turquoise at the beginning
                   "#006d75", "#1a9e96", "#55c1ab", "#85c68b", "#d1c54b", "#e8b249", 
                   "#e3842a", "#d45321", "#ba2e1f", "#9e2d2a", "#803c3d", "#63363f", 
                   "#9c276e",  # New color: a deeper shade in the pink tones
                   "#d238a5")

# Define the numeric labels for the breaks
break_labels <- c(as.character(scales::label_number(accuracy = 1)(custom_bins[-length(custom_bins)])), "Ocean")

# Define bounding box for Africa
#bbox <- c(xmin = -30, xmax = 60, ymin = -35, ymax = 30)  # Approximate bounding box for Oceania


# Define the ggplot2 object with the gradient scale
ggplot() +
  geom_raster(data = r_df, aes(x = x, y = y, fill = cut(layer, breaks = custom_bins)), na.rm = TRUE) +
  scale_fill_manual(name = "mean PCWD (mm)", values = custom_colors, na.value = "grey50", 
                    labels = c(levels(cut(r_df$layer, breaks = custom_bins)),"Ocean")) +  # Label ocean
  labs(title = "ModE-Sim", x = "Longitude", y = "Latitude") +
  theme_classic() +
  geom_sf(data = land, fill = NA, color = "black", lwd = 0.3) +
  coord_sf(xlim =	c(-180, 178.125), ylim =	c(-60, 90), expand = FALSE) + #leave out Antarctica
  theme(legend.position = "none", legend.title = element_text(size=18), legend.text = element_text(size=18), 
        axis.text = element_text(size=14), axis.title = element_text(size=14)) +
  guides(fill = guide_legend(title = "PCWD [mm]", reverse = TRUE))  # Adjust legend for better presentation

```


Calculate spatial bias of ModESim data - ensemble mean 
```{r}
#ModE-Sim data - ERA5Land data
spatial_bias <-  means_1850 - means_ERA5

##prepare for plotting:
r <- raster(t(spatial_bias), xmn=min(lon), xmx=max(lon), ymn=min(lat), ymx=max(lat))
crs(r) <- "+proj=longlat +datum=WGS84"  # Set CRS for raster
r <- flip(r, direction='y')

# Retrieve land polygons and set the same CRS as the raster
land <- ne_countries(scale = "medium", returnclass = "sf")
land <- st_transform(land, crs = st_crs(r))  # Ensure CRS alignment

# Mask the raster with land polygons to remove ocean values
r_masked <- mask(r, as(land, "Spatial"))

# Convert the masked raster to a data frame for ggplot2
r_df <- as.data.frame(r_masked, xy = TRUE)
colnames(r_df) <- c("x", "y", "layer")  # Rename columns to match ggplot expectations

# Define custom color bins
custom_bins <- c(-Inf, -2000, -1000, -500, -250, -100, -50, 0, 50, 100, 250, 500, 1000, 2000, Inf)  # Define breaks based on data range

custom_colors <- colorRampPalette(c("blue", "white", "red"))(length(custom_bins)-1)

# Define the numeric labels for the breaks
break_labels <- c(as.character(scales::label_number(accuracy = 1)(custom_bins[-length(custom_bins)])), "Ocean")

#–– build the labels for all 14 bins
finite_vals <- custom_bins[!is.infinite(custom_bins)]
mid_lbls    <- paste0(finite_vals[-length(finite_vals)], "–", finite_vals[-1])

lbls <- c(
  paste0("<", finite_vals[1]),   # "<-1000"
  mid_lbls,                       # "-1000–-500", …, "500–1000"  (12 items)
  paste0(">", tail(finite_vals,1))# ">1000"
)
# check
length(lbls)  # should be 14

#–– cut into that factor
r_df$delta_cat <- cut(
  r_df$layer,
  breaks         = custom_bins,
  labels         = lbls,
  include.lowest = TRUE,
  right          = FALSE
)

# Define the ggplot2 object with the gradient scale
ggplot() +
  geom_raster(data = r_df, aes(x = x, y = y, fill = delta_cat, na.rm = TRUE)) +
  scale_fill_manual(name = "ΔPCWD [mm]",     values = c("Ocean" = "grey50", setNames(custom_colors, lbls)),
    breaks = c("Ocean", lbls),
    labels = c("Ocean", lbls),
    na.value = "grey50")+
    labs(title = "ModE-Sim - ERA5-Land", x = "Longitude", y = "Latitude") +
  theme_classic() +
  geom_sf(data = land, fill = NA, color = "black", lwd = 0.3) +
  coord_sf(xlim =	c(-180, 178.125), ylim =	c(-60, 90), expand = FALSE) + #leave out Antarctica
  theme(legend.position = "none", legend.title = element_text(size=15), legend.text = element_text(size=15), 
        axis.text = element_text(size=14), axis.title = element_text(size=14)) +
  guides(fill = guide_legend(title = "ΔPCWD [mm]", reverse = TRUE))  # better for continuous legends(title = "ΔPCWD [mm]", reverse = TRUE))  # Adjust legend for better presentation


```
### Trends over the same period

ModESim trend calculation:
```{r}
#### 1968 - 2009 trends ModESim

# Initialize an empty list to store results
trend_results_ModESim <- list()

# Iterate through each ensemble member
for (ensemble_name in names(data_by_ensemble_1850_fil)) {
  # Extract the data for the current ensemble member (3D array)
  ensemble_data <- data_by_ensemble_1850_fil[[ensemble_name]]
  
  # Get dimensions
  lon_dim <- dim(ensemble_data)[1]
  lat_dim <- dim(ensemble_data)[2]
  time_dim <- dim(ensemble_data)[3]
  
  # Create a data frame for regression: Reshape data into `grid_cell x time`
  reshaped_data <- as.data.frame(
    array(ensemble_data, dim = c(lon_dim * lat_dim, time_dim))
  )
  colnames(reshaped_data) <- 1:time_dim  # Name columns as time indices
  
  # Add grid cell indices
  reshaped_data <- reshaped_data %>%
    mutate(grid_id = 1:(lon_dim * lat_dim)) %>%
    pivot_longer(
      cols = -grid_id,
      names_to = "time",
      values_to = "value"
    ) %>%
    mutate(time = as.numeric(time))
  
# Perform linear regression for each grid cell and extract slope & p-value
trends <- reshaped_data %>%
  group_by(grid_id) %>%
  summarize(
    trend = coef(lm(value ~ time))[["time"]],  # Extract slope (trend)
    p_value = summary(lm(value ~ time))$coefficients["time", "Pr(>|t|)"],  # Extract p-value
    .groups = "drop"
  )
  
  # Reshape trend data back into 2D array (lon x lat)
  trend_matrix <- matrix(trends$trend, nrow = lon_dim, ncol = lat_dim)
  
  # Reshape p-value data back into 2D array (lon x lat)
  p_matrix <- matrix(trends$p_value, nrow = lon_dim, ncol = lat_dim)
  
  # Store in results list
  trend_results_ModESim[[ensemble_name]] <- list(trend = trend_matrix, p_value = p_matrix)
}

# Compute the mean trend
mean_trend_ModESim <- Reduce("+", lapply(trend_results_ModESim, `[[`, "trend")) / length(trend_results_ModESim)

# Compute the mean p-value
mean_p_ModESim <- Reduce("+", lapply(trend_results_ModESim, `[[`, "p_value")) / length(trend_results_ModESim)

# Create a significance mask (TRUE for significant, FALSE otherwise)
sig_mask_ModESim <- mean_p_ModESim < 0.05


```

ERA5Land trend calculation: 
```{r}
pcwd_annmax_ERA5_fil_30 <- pcwd_annmax_ERA5[,,42:60] #last 30 years

# Get dimensions
lon_dim <- dim(pcwd_annmax_ERA5_fil_30)[1] #pcwd_annmax_ERA5_fil for overlap period with ModESim
lat_dim <- dim(pcwd_annmax_ERA5_fil_30)[2]
time_dim <- dim(pcwd_annmax_ERA5_fil_30)[3]
  
# Create a data frame for regression: Reshape data into `grid_cell x time`
reshaped_data <- as.data.frame(
  array(pcwd_annmax_ERA5_fil_30, dim = c(lon_dim * lat_dim, time_dim))
  )
colnames(reshaped_data) <- 1:time_dim  # Name columns as time indices
  
# Add grid cell indices
reshaped_data <- reshaped_data %>%
  mutate(grid_id = 1:(lon_dim * lat_dim)) %>%
  pivot_longer(
    cols = -grid_id,
    names_to = "time",
    values_to = "value"
  ) %>%
  mutate(time = as.numeric(time))
  
# Perform linear regression for each grid cell and extract slope & p-value
trends <- reshaped_data %>%
  group_by(grid_id) %>%
  summarize(
    trend = coef(lm(value ~ time))[["time"]],  # Extract slope (trend)
    p_value = summary(lm(value ~ time))$coefficients["time", "Pr(>|t|)"],  # Extract p-value
    .groups = "drop"
  )
  
# Reshape trend data back into 2D array (lon x lat)
trend_results_ERA5 <- matrix(trends$trend, nrow = lon_dim, ncol = lat_dim)
# Reshape p-value data back into 2D array (lon x lat)
p_matrix_ERA5 <- matrix(trends$p_value, nrow = lon_dim, ncol = lat_dim)

# Create a significance mask (TRUE for significant, FALSE otherwise)
sig_mask_ERA5 <- p_matrix_ERA5 < 0.05
```

plot both: 

```{r}
##### ModESim:
# Convert data into a raster object
r <- raster(t(mean_trend_ModESim), xmn=min(lon), xmx=max(lon), ymn=min(lat), ymx=max(lat))
crs(r) <- "+proj=longlat +datum=WGS84"  # Set CRS for raster
r <- flip(r, direction='y')

# Convert significance mask into a raster (same dimensions as trend)
sig_r <- raster(t(sig_mask_ModESim), xmn=min(lon), xmx=max(lon), ymn=min(lat), ymx=max(lat))
crs(sig_r) <- "+proj=longlat +datum=WGS84"
sig_r <- flip(sig_r, direction='y')

# Retrieve land polygons and set the same CRS as the raster
land <- ne_countries(scale = "medium", returnclass = "sf")
land <- st_transform(land, crs = st_crs(r))  # Ensure CRS alignment

# Mask the raster with land polygons to remove ocean values
r_masked <- mask(r, as(land, "Spatial"))
sig_masked <- mask(sig_r, as(land, "Spatial"))

# Convert the masked raster to a data frame for ggplot2
r_df <- as.data.frame(r_masked, xy = TRUE)
colnames(r_df) <- c("x", "y", "layer")  # Rename columns to match ggplot expectations

sig_df <- as.data.frame(sig_masked, xy = TRUE)
colnames(sig_df) <- c("x", "y", "sig")

# Filter non-significant grid cells
sig_df <- sig_df %>% filter(sig == 1)  # Retain only non-significant areas

# Create the plot
ggplot() +
  geom_raster(data = r_df, aes(x = x, y = y, fill = layer), na.rm = TRUE) +  # Continuous fill
  
  # Continuous diverging blue-red color scale centered at zero with improved scaling
  scale_fill_distiller(
    palette = "RdBu", direction = -1,
    limits = c(-25, 25), name = "trends", na.value = "grey50", values = scales::rescale(c(-10, -1, 0, 1, 10))
  ) +
  
  labs(
    title = "ModE-Sim", 
    x = "Longitude", y = "Latitude") +
  theme_classic() +
  geom_sf(data = land, fill = NA, color = "black", lwd = 0.3) +
  # Overlay significant areas with hatching or stippling
  geom_point(data = sig_df, aes(x = x, y = y, shape = "Significant"), 
             size = 1.5, color = "#15B34C") +

  scale_shape_manual(name = "", values = c("Significant" = 4)) +  # shape 4 = 'x'
  
  coord_sf(xlim =	c(-180, 178.125), ylim =	c(-60, 90), expand = FALSE) + #leave out Antarctica
  theme(legend.title = element_text(size=12), legend.text = element_text(size=12), 
        axis.text = element_text(size=13), axis.title = element_text(size=13), legend.position = "none") +
  guides(fill = guide_colorbar(title = "mm/yr"))


###### ERA5Land data:
# Convert data into a raster object
r <- raster(t(trend_results_ERA5), xmn=min(lon), xmx=max(lon), ymn=min(lat), ymx=max(lat))
crs(r) <- "+proj=longlat +datum=WGS84"  # Set CRS for raster
r <- flip(r, direction='y')

# Convert significance mask into a raster (same dimensions as trend)
sig_r <- raster(t(sig_mask_ERA5), xmn=min(lon), xmx=max(lon), ymn=min(lat), ymx=max(lat))
crs(sig_r) <- "+proj=longlat +datum=WGS84"
sig_r <- flip(sig_r, direction='y')

# Retrieve land polygons and set the same CRS as the raster
land <- ne_countries(scale = "medium", returnclass = "sf")
land <- st_transform(land, crs = st_crs(r))  # Ensure CRS alignment

# Mask the raster with land polygons to remove ocean values
r_masked <- mask(r, as(land, "Spatial"))
sig_masked <- mask(sig_r, as(land, "Spatial"))

# Convert the masked raster to a data frame for ggplot2
r_df <- as.data.frame(r_masked, xy = TRUE)
colnames(r_df) <- c("x", "y", "layer")  # Rename columns to match ggplot expectations

sig_df <- as.data.frame(sig_masked, xy = TRUE)
colnames(sig_df) <- c("x", "y", "sig")

# Filter non-significant grid cells
sig_df <- sig_df %>% filter(sig == 1)  # Retain only non-significant areas

# Create the plot
ggplot() +
  geom_raster(data = r_df, aes(x = x, y = y, fill = layer), na.rm = TRUE) +  # Continuous fill
  
  # Continuous diverging blue-red color scale centered at zero with improved scaling
  scale_fill_distiller(
    palette = "RdBu", direction = -1,
    limits = c(-25, 25), name = "trends", na.value = "grey50", values = scales::rescale(c(-10, -1, 0, 1, 10))
  ) +
  
  labs(
    title = "ERA5-Land (1994-2024)", 
    x = "Longitude", y = "Latitude") +
  theme_classic() +
  
  geom_sf(data = land, fill = NA, color = "black", lwd = 0.3) +
  # Overlay significant areas with hatching or stippling
  #geom_point(data = sig_df, aes(x = x, y = y, shape = "Significant"), size = 3, color = "#15B34C") +

  scale_shape_manual(name = "", values = c("Significant" = 4)) +  # shape 4 = 'x'
  
  coord_sf(xlim =	c(-180, 178.125), ylim =	c(-60, 90), expand = FALSE) + #leave out Antarctica
  theme(legend.title = element_text(size=12), legend.text = element_text(size=12), 
        axis.text = element_text(size=13), axis.title = element_text(size=13), legend.position = "none") +
  guides(fill = guide_colorbar(title = "mm/yr"))
```

### Annmax PCWD DOY

Look at DOY of ERA5Land data: 

```{r}
#lat lon and time info from netcdf files
##read in data
input_file_doy <- "/storage/research/giub_geco/data_2/scratch/phelpap/ERA5Land_1950-2024/06_DOY/PCWD_ANNMAX_DOY.nc"

nc_pwcd_doy <- nc_open(input_file_doy)
annmax_doy = ncvar_get(nc_pwcd_doy, varid="pcwd_annmax_doy")
lon = ncvar_get(nc_pwcd_doy, varid="lon")
lat = ncvar_get(nc_pwcd_doy, varid="lat")
time_doy = ncvar_get(nc_pwcd_doy, varid="time")
# Convert to actual dates (days since 2001-01-01)
reference_date <- as.Date("2001-01-01")
time_dates_doy <- reference_date + time_doy

# # Print the resulting dates
# print(time_dates)

nc_close(nc_pwcd_doy)

# Filter data to retain only years up to 2009
years <- as.numeric(format(time_dates_doy, "%Y"))
keep_indices <- which(years <= 2009)

# Subset time and data arrays
time_dates_doy <- time_dates_doy[keep_indices]
annmax_doy <- annmax_doy[,,keep_indices]  # Assuming time is the 3rd dimension


nc_close(nc_pwcd_doy)

# 3. Calculate the mean over the 431 years (3rd dimension)
# This reduces the array to [192, 96] (longitude × latitude)
era_mean_doy <- apply(annmax_doy, c(1, 2), mean, na.rm = TRUE)

```

```{r}
### plot mean DOY of maximum deficit for each gridcell - 1420 epoch:

#plot
# Convert first year's data into a raster object
r <- raster(t(era_mean_doy), xmn=min(lon), xmx=max(lon), ymn=min(lat), ymx=max(lat))
crs(r) <- "+proj=longlat +datum=WGS84"  # Set CRS for raster
r <- flip(r, direction='y')

# Retrieve land polygons and set the same CRS as the raster
land <- ne_countries(scale = "medium", returnclass = "sf")
land <- st_transform(land, crs = st_crs(r))  # Ensure CRS alignment

# Mask the raster with land polygons to remove ocean values
r_masked <- mask(r, as(land, "Spatial"))

# Convert the masked raster to a data frame for ggplot2
r_df <- as.data.frame(r_masked, xy = TRUE)
colnames(r_df) <- c("x", "y", "layer")  # Rename columns to match ggplot expectations

ggplot() +
  geom_raster(data = r_df, aes(x = x, y = y, fill = layer), na.rm = TRUE) +
  scale_fill_gradientn(
    name = "DOY", 
    colors = c("#3E4594", "#3D996B", "#FEE08B", "#D65C3C"),  # Seasonal transition
    limits = c(1, 366), 
    na.value = "grey50"
  ) +
  labs(title = "ERA5-Land", x = "Longitude", y = "Latitude") +
  theme_classic() +
  geom_sf(data = land, fill = NA, color = "black", lwd = 0.3) +
  coord_sf(xlim =	c(-180, 178.125), ylim =	c(-60, 90), expand = FALSE) + #leave out Antarctica
    theme(legend.title = element_text(size=12), legend.text = element_text(size=12), 
        axis.text = element_text(size=13), axis.title = element_text(size=13), legend.position = "none") +
  guides(fill = guide_colorbar(title = "DOY"))   # Improves legend readability

```


## Bias correcting ModE-Sim data: 
- for 30 yr overlap period compare ERA5-Land and ModE-Sim; bias correct ModE-Sim in each grid cell based on that period

1. Calculate ensemble mean for ModE-Sim 1850 and 1420 period: 

```{r}
#Calculate ensemble mean of ModESim: 
ensemble_array_1850 <- simplify2array(data_by_ensemble_1850)  # Shape: [192, 96, 160, 20]

# Compute the ensemble mean across the 4th dim (EMs)
EM_1850 <- apply(ensemble_array_1850, c(1, 2, 3), mean, na.rm = TRUE)  # Shape: [192, 96, 160]
dim(EM_1850)

#Calculate ensemble mean of ModESim: 
ensemble_array_1420 <- simplify2array(data_by_ensemble_1420)  # Shape: [192, 96, 160, 20]

# Compute the ensemble mean across the 4th dim (EMs)
EM_1420 <- apply(ensemble_array_1420, c(1, 2, 3), mean, na.rm = TRUE)  # Shape: [192, 96, 160]
dim(EM_1420)

# Load abind package
library(abind)

# Merge along the 3rd dimension (time)
EM_merged <- abind(EM_1420, EM_1850, along = 3)
time_merged <-abind(time_1420, time_1850)
# Convert to actual dates (days since 2001-01-01)
reference_date <- as.Date("2001-01-01")
time_dates_merged <- reference_date + time_merged

```


apply land masking
```{r}
#apply land mask to both ModE-Sim and ERA5-Land to make sure those areas are not bias corrected
# Step 1: Create a land-sea mask from the natural earth dataset
land <- ne_countries(scale = "medium", returnclass = "sf")
land <- st_transform(land, crs = "+proj=longlat +datum=WGS84")

# Step 2: Create a grid with the same lon/lat as gini_values_1850
grid_df <- expand.grid(lon = lon, lat = lat)

# Step 3: Check which grid cells are land or ocean based on the land polygons
grid_sf <- st_as_sf(grid_df, coords = c("lon", "lat"), crs = st_crs(land))

# Step 4: Use `st_intersects` to check if each grid cell is land (1) or ocean (0)
grid_sf$in_land <- st_intersects(grid_sf, land, sparse = FALSE) %>% rowSums() > 0  # TRUE for land, FALSE for ocean

# Step 5: Create a land-sea mask based on the land check and ensure correct dimensions
land_sea_mask <- matrix(grid_sf$in_land, nrow = 192, ncol = 96, byrow = FALSE)  # Corrected: 192 longitudes, 96 latitudes

apply_land_mask <- function(grid_data, slm) {
  # grid_data: 3D array [lon, lat, time]
  # slm:    2D logical matrix [lon, lat] TRUE=land, FALSE=ocean

  # Make a copy
  masked_array <- grid_data

  # Number of time steps
  nt <- dim(grid_data)[3]

  for (t in seq_len(nt)) {
    # grab the lon×lat slice at time t
    slice <- masked_array[ , , t]
    # set ocean cells to NA
    slice[!slm] <- NA
    # put it back
    masked_array[ , , t] <- slice
  }

  return(masked_array)
}

# Apply land-sea mask 
EM_merged_masked <- apply_land_mask(EM_merged, land_sea_mask)
pcwd_annmax_ERA5_masked <- apply_land_mask(pcwd_annmax_ERA5, land_sea_mask)
```


compute overlap period with ERA5 (1970-1999)
```{r}
## ERA5-Land
# Filter data to retain overlap period
years <- as.numeric(format(time_dates_ERA5, "%Y"))
keep_indices <- which(years >= 1970 & years <= 1999)

# Subset time and data arrays
time_dates_ERA5_overlap <- time_dates_ERA5[keep_indices]
pcwd_annmax_ERA5_overlap <- pcwd_annmax_ERA5_masked[,,keep_indices]  # Assuming time is the 3rd dimension

## ModE-Sim 1965 - 1995 period
# Find indices corresponding to years >= 1965 and <= 1995
years <- as.numeric(format(time_dates_merged, "%Y"))
keep_indices <- which(years >= 1970 & years <= 1999)
# Subset time and data arrays
time_dates_merged <- time_dates_merged[keep_indices]
pcwd_annmax_merged_overlap <- EM_merged_masked[,,keep_indices]  # Assuming time is the 3rd dimension

```

```{r}
library(qmap)
library(future.apply)


# Inputs (all 3D arrays of dimension [lon, lat, time]):
#   pcwd_annmax_ERA5_masked    192×96×30  — ERA5‐Land overlap, NA over ocean
#   pcwd_annmax_merged_masked  192×96×30  — ModE‐Sim overlap, NA over ocean
#   pcwd_annmax_merged_full    192×96×590 — full ModE‐Sim run, already masked
#
# Output:
#   pcwd_corrected             192×96×590 — bias‐corrected ModE‐Sim

#---------------------------------------------------
# 1) Prepare output array
nlon <- dim(EM_merged_masked)[1]
nlat <- dim(EM_merged_masked)[2]
ntime <- dim(EM_merged_masked)[3]

pcwd_corrected <- array(NA,
                        dim = c(nlon, nlat, ntime),
                        dimnames = dimnames(EM_merged_masked))

#---------------------------------------------------
# 2) Set up parallel plan (optional but recommended)
plan(multisession)    # or multicore

#---------------------------------------------------
# 3) Loop over grid cells, fit & apply QM
for (i in seq_len(nlon)) {
  
  # Run all latitudes in parallel, get a [ntime x nlat] matrix
  mat_tm_by_lat <- future_sapply(seq_len(nlat), function(j) {
    
    obs_30   <- pcwd_annmax_ERA5_overlap[i, j, ]
    mod_30   <- pcwd_annmax_merged_overlap[i, j, ]
    mod_full <- EM_merged_masked[i, j, ]
    
    # Skip ocean cells
    if (all(is.na(obs_30))) {
      return(rep(NA_real_, ntime))
    }
    
    # Fit on 30-year overlap
    qm <- fitQmapPTF(
      obs     = obs_30,
      mod     = mod_30,
      wet.day = FALSE,
      qstep   = 0.001
    )
    
    # Apply to full time series
    doQmapPTF(
      x      = mod_full,
      fobj = qm
    )
    
  }, USE.NAMES = FALSE)
  
  # Transpose to [nlat x ntime] before assigning
  pcwd_corrected[i, , ] <- t(mat_tm_by_lat)
}

#save bias corrected ModE-SIm data: 
saveRDS(pcwd_corrected, file="~/cwd_global/data/ModESim_grid_BiasCorrected.rds")
```


plot test plot to check bias correction
```{r}
#plot ERA5Land data to validate
r <- raster(t(EM_merged_masked[,,531]), xmn=min(lon), xmx=max(lon), ymn=min(lat), ymx=max(lat))
crs(r) <- "+proj=longlat +datum=WGS84"  # Set CRS for raster
r <- flip(r, direction='y')

# Retrieve land polygons and set the same CRS as the raster
land <- ne_countries(scale = "medium", returnclass = "sf")
land <- st_transform(land, crs = st_crs(r))  # Ensure CRS alignment

# Mask the raster with land polygons to remove ocean values
#r_masked <- mask(r, as(land, "Spatial"))

# Convert the masked raster to a data frame for ggplot2
r_df <- as.data.frame(r, xy = TRUE)
colnames(r_df) <- c("x", "y", "layer")  # Rename columns to match ggplot expectations

# Define custom color bins
custom_bins <- c(0, 20, 40, 60, 80, 100, 150, 200, 300, 500, 700, 900, 1200, 2000, Inf)  # Define breaks based on data range
# Define a custom 13-color palette from deep turquoise to bright pink with earthy tones in between
# Updated custom color palette with two additional colors
custom_colors <- c("#004f5a",  # New color: a darker turquoise at the beginning
                   "#006d75", "#1a9e96", "#55c1ab", "#85c68b", "#d1c54b", "#e8b249", 
                   "#e3842a", "#d45321", "#ba2e1f", "#9e2d2a", "#803c3d", "#63363f", 
                   "#9c276e",  # New color: a deeper shade in the pink tones
                   "#d238a5")

# Define the numeric labels for the breaks
break_labels <- c(as.character(scales::label_number(accuracy = 1)(custom_bins[-length(custom_bins)])), "Ocean")

# Define bounding box for Africa
#bbox <- c(xmin = -30, xmax = 60, ymin = -35, ymax = 30)  # Approximate bounding box for Oceania


# Define the ggplot2 object with the gradient scale
ggplot() +
  geom_raster(data = r_df, aes(x = x, y = y, fill = cut(layer, breaks = custom_bins)), na.rm = TRUE) +
  scale_fill_manual(name = "mean PCWD (mm)", values = custom_colors, na.value = "grey50", 
                    labels = c(levels(cut(r_df$layer, breaks = custom_bins)),"Ocean")) +  # Label ocean
  labs(title = "1950 ModESim before bias correction", x = "Longitude", y = "Latitude") +
  theme_classic() +
  geom_sf(data = land, fill = NA, color = "black", lwd = 0.3) +
  coord_sf(xlim =	c(-180, 178.125), ylim =	c(-60, 90), expand = FALSE) + #leave out Antarctica
  theme(legend.position = "none", legend.title = element_text(size=18), legend.text = element_text(size=18), 
        axis.text = element_text(size=14), axis.title = element_text(size=14)) +
  guides(fill = guide_legend(title = "PCWD [mm]", reverse = TRUE))  # Adjust legend for better presentation


##################### bias corrected ModESim
#plot ERA5Land data to validate
r <- raster(t(pcwd_corrected[,,531]), xmn=min(lon), xmx=max(lon), ymn=min(lat), ymx=max(lat))
crs(r) <- "+proj=longlat +datum=WGS84"  # Set CRS for raster
r <- flip(r, direction='y')

# Retrieve land polygons and set the same CRS as the raster
land <- ne_countries(scale = "medium", returnclass = "sf")
land <- st_transform(land, crs = st_crs(r))  # Ensure CRS alignment

# Mask the raster with land polygons to remove ocean values
#r_masked <- mask(r, as(land, "Spatial"))

# Convert the masked raster to a data frame for ggplot2
r_df <- as.data.frame(r, xy = TRUE)
colnames(r_df) <- c("x", "y", "layer")  # Rename columns to match ggplot expectations

# Define custom color bins
custom_bins <- c(0, 20, 40, 60, 80, 100, 150, 200, 300, 500, 700, 900, 1200, 2000, Inf)  # Define breaks based on data range
# Define a custom 13-color palette from deep turquoise to bright pink with earthy tones in between
# Updated custom color palette with two additional colors
custom_colors <- c("#004f5a",  # New color: a darker turquoise at the beginning
                   "#006d75", "#1a9e96", "#55c1ab", "#85c68b", "#d1c54b", "#e8b249", 
                   "#e3842a", "#d45321", "#ba2e1f", "#9e2d2a", "#803c3d", "#63363f", 
                   "#9c276e",  # New color: a deeper shade in the pink tones
                   "#d238a5")

# Define the numeric labels for the breaks
break_labels <- c(as.character(scales::label_number(accuracy = 1)(custom_bins[-length(custom_bins)])), "Ocean")

# Define bounding box for Africa
#bbox <- c(xmin = -30, xmax = 60, ymin = -35, ymax = 30)  # Approximate bounding box for Oceania


# Define the ggplot2 object with the gradient scale
ggplot() +
  geom_raster(data = r_df, aes(x = x, y = y, fill = cut(layer, breaks = custom_bins)), na.rm = TRUE) +
  scale_fill_manual(name = "mean PCWD (mm)", values = custom_colors, na.value = "grey50", 
                    labels = c(levels(cut(r_df$layer, breaks = custom_bins)),"Ocean")) +  # Label ocean
  labs(title = "1950 bias corrected ModESim", x = "Longitude", y = "Latitude") +
  theme_classic() +
  geom_sf(data = land, fill = NA, color = "black", lwd = 0.3) +
  coord_sf(xlim =	c(-180, 178.125), ylim =	c(-60, 90), expand = FALSE) + #leave out Antarctica
  theme(legend.position = "none", legend.title = element_text(size=18), legend.text = element_text(size=18), 
        axis.text = element_text(size=14), axis.title = element_text(size=14)) +
  guides(fill = guide_legend(title = "PCWD [mm]", reverse = TRUE))  # Adjust legend for better presentation


################################################################################
#plot ERA5Land data to validate
r <- raster(t(pcwd_annmax_ERA5_masked[,,1]), xmn=min(lon), xmx=max(lon), ymn=min(lat), ymx=max(lat))
crs(r) <- "+proj=longlat +datum=WGS84"  # Set CRS for raster
r <- flip(r, direction='y')

# Retrieve land polygons and set the same CRS as the raster
land <- ne_countries(scale = "medium", returnclass = "sf")
land <- st_transform(land, crs = st_crs(r))  # Ensure CRS alignment

# Mask the raster with land polygons to remove ocean values
#r_masked <- mask(r, as(land, "Spatial"))

# Convert the masked raster to a data frame for ggplot2
r_df <- as.data.frame(r, xy = TRUE)
colnames(r_df) <- c("x", "y", "layer")  # Rename columns to match ggplot expectations

# Define custom color bins
custom_bins <- c(0, 20, 40, 60, 80, 100, 150, 200, 300, 500, 700, 900, 1200, 2000, Inf)  # Define breaks based on data range
# Define a custom 13-color palette from deep turquoise to bright pink with earthy tones in between
# Updated custom color palette with two additional colors
custom_colors <- c("#004f5a",  # New color: a darker turquoise at the beginning
                   "#006d75", "#1a9e96", "#55c1ab", "#85c68b", "#d1c54b", "#e8b249", 
                   "#e3842a", "#d45321", "#ba2e1f", "#9e2d2a", "#803c3d", "#63363f", 
                   "#9c276e",  # New color: a deeper shade in the pink tones
                   "#d238a5")

# Define the numeric labels for the breaks
break_labels <- c(as.character(scales::label_number(accuracy = 1)(custom_bins[-length(custom_bins)])), "Ocean")

# Define bounding box for Africa
#bbox <- c(xmin = -30, xmax = 60, ymin = -35, ymax = 30)  # Approximate bounding box for Oceania


# Define the ggplot2 object with the gradient scale
ggplot() +
  geom_raster(data = r_df, aes(x = x, y = y, fill = cut(layer, breaks = custom_bins)), na.rm = TRUE) +
  scale_fill_manual(name = "mean PCWD (mm)", values = custom_colors, na.value = "grey50", 
                    labels = c(levels(cut(r_df$layer, breaks = custom_bins)),"Ocean")) +  # Label ocean
  labs(title = "1950 ERA5-Land", x = "Longitude", y = "Latitude") +
  theme_classic() +
  geom_sf(data = land, fill = NA, color = "black", lwd = 0.3) +
  coord_sf(xlim =	c(-180, 178.125), ylim =	c(-60, 90), expand = FALSE) + #leave out Antarctica
  theme(legend.position = "none", legend.title = element_text(size=18), legend.text = element_text(size=18), 
        axis.text = element_text(size=14), axis.title = element_text(size=14)) +
  guides(fill = guide_legend(title = "PCWD [mm]", reverse = TRUE))  # Adjust legend for better presentation

```

### Extreme value analysis on bias corrected values

Calculate 5yr return period values for each gridcell for three periods
- 1970 - 1999 (ERA5 data)
- 1970 - 1999 (BC ModESim data)
- 1800 - 1970 (BC ModESim - early ind)
- 1420 - 1700 (BC ModESim - preind)

```{r}
#function to calculate return periods: 
calculate_return_level <- function(data, return_period) {
  # 1) Clean up
  data <- na.omit(data)
  
  # 2) Skip too-short series
  if (length(data) < 5) {
    warning("Too few points to fit a Gumbel (n=", length(data), "). Returning NA.")
    return(NA_real_)
  }
  
  # 3) Constant series → return that constant
  if (length(unique(data)) == 1) {
    return(unique(data))
  }
  
  # 4) Try the fit + return-level, catch any errors
  out <- tryCatch({
    evd_fit <- extRemes::fevd(x = data,
                              type   = "Gumbel",
                              method = "MLE",
                              units  = "years")
    rl <- extRemes::return.level(evd_fit,
                                 return.period = return_period)
    as.numeric(rl)
  }, error = function(e) {
    warning("Gumbel fit/return-level failed: ", e$message)
    NA_real_
  })
  
  return(out)
}


##ERA5 5 year return levels: 
X5_ERA5 <- matrix(NA, nrow = length(lon), ncol = length(lat))

for (i in seq_len(nlon)) {
  for (j in seq_len(nlat)) {
    # pull out the 30‐year overlap
    raw_ts <- pcwd_annmax_ERA5_masked[i, j, 21:50]

    # drop NA's
    data <- raw_ts[!is.na(raw_ts)]

    # skip ocean cells or too‐short records
    if (length(data) < 10) next

    # now safe to calculate the 5‐year return level
    X5_ERA5[i, j] <- calculate_return_level(data,
                                            return_period = 5)
  }
}


##ModESim 5 year return levels: 
# Create an empty matrix to store 5-year return levels
X5_ModE_modern <- matrix(NA, nrow = length(lon), ncol = length(lat))

# Loop through each grid cell
for (i in seq_along(lon)) {
  for (j in seq_along(lat)) {
    # Extract time series for the grid cell
    data <- pcwd_corrected[i, j, 551:580]
    
    # Check for NA or insufficient data
   # if (all(is.na(data)) || length(na.omit(data)) < 10) next
    
    # Calculate 80-year return level
    X5_ModE_modern[i, j] <- calculate_return_level(data, return_period = 5)
  }
}

##ModESim early industrial 5 year return levels: 
# Create an empty matrix to store 5-year return levels
X5_ModE_early <- matrix(NA, nrow = length(lon), ncol = length(lat))

# Loop through each grid cell
for (i in seq_along(lon)) {
  for (j in seq_along(lat)) {
    # Extract time series for the grid cell
    data <- pcwd_corrected[i, j, 381:450] #1800-1970
    
    # Check for NA or insufficient data
   # if (all(is.na(data)) || length(na.omit(data)) < 10) next
    
    # Calculate 80-year return level
    X5_ModE_early[i, j] <- calculate_return_level(data, return_period = 5)
  }
}

##ModESim pre industrial 5 year return levels: 
# Create an empty matrix to store 5-year return levels
X5_ModE_pre <- matrix(NA, nrow = length(lon), ncol = length(lat))

# Loop through each grid cell
for (i in seq_along(lon)) {
  for (j in seq_along(lat)) {
    # Extract time series for the grid cell
    data <- pcwd_corrected[i, j, 1:280]
    
    # Check for NA or insufficient data
   # if (all(is.na(data)) || length(na.omit(data)) < 10) next
    
    # Calculate 80-year return level
    X5_ModE_pre[i, j] <- calculate_return_level(data, return_period = 5)
  }
}


```


Plot 
1) ERA5 calibration period (1970-1999) 5yr extreme events in each gridcell
2) Early ind - modern (ModESim)
3) Preind - modern (ModESim)
```{r}
#plot ERA5Land data to validate
r <- raster(t(X5_ERA5), xmn=min(lon), xmx=max(lon), ymn=min(lat), ymx=max(lat))
crs(r) <- "+proj=longlat +datum=WGS84"  # Set CRS for raster
r <- flip(r, direction='y')

# Retrieve land polygons and set the same CRS as the raster
land <- ne_countries(scale = "medium", returnclass = "sf")
land <- st_transform(land, crs = st_crs(r))  # Ensure CRS alignment

# Mask the raster with land polygons to remove ocean values
#r_masked <- mask(r, as(land, "Spatial"))

# Convert the masked raster to a data frame for ggplot2
r_df <- as.data.frame(r, xy = TRUE)
colnames(r_df) <- c("x", "y", "layer")  # Rename columns to match ggplot expectations

custom_bins <- c(0, 20, 40, 60, 80, 100, 150, 200, 300, 500, 700, 900, 1200, 2000, Inf)
custom_colors <- c("#004f5a",  # New color: a darker turquoise at the beginning
                   "#006d75", "#1a9e96", "#55c1ab", "#85c68b", "#d1c54b", "#e8b249",
                   "#e3842a", "#d45321", "#ba2e1f", "#9e2d2a", "#803c3d", "#63363f",
                   "#9c276e",  # New color: a deeper shade in the pink tones
                   "#d238a5")


# 1) build a vector of human–readable labels
#    for the finite intervals we do "a–b", 
#    and then for the last one ">2000"
finite_bins <- custom_bins[!is.infinite(custom_bins)]
lbls_finite <- paste0(finite_bins[-length(finite_bins)], "–", finite_bins[-1])
lbls <- c(lbls_finite, ">2000")

# 2) turn your raster values into a factor with exactly these levels
r_df$pcwd_cat <- cut(
  r_df$layer, 
  breaks = custom_bins, 
  labels = lbls, 
  include.lowest = TRUE, 
  right = FALSE
)

# 3) draw the plot, manually specifying levels, labels and colours
ggplot() +
  geom_raster(
    data = r_df, 
    aes(x = x, y = y, fill = pcwd_cat), 
    na.rm = TRUE
  ) +
  # note we put "Ocean" *first* in the breaks, so it shows at the top
  scale_fill_manual(
    name      = "5yr PCWD (mm)",
    values    = c("Ocean" = "grey50", setNames(custom_colors, lbls)), 
    breaks    = c("Ocean", lbls),
    labels    = c("Ocean", lbls),
    na.value  = "grey50"
  ) +
  labs(title = "ERA5-Land 5-yr event (reference)", x = "Longitude", y = "Latitude") +
  theme_classic() +
  geom_sf(data = land, fill = NA, color = "black", lwd = 0.3) +
  coord_sf(xlim =	c(-180, 178.125), ylim =	c(-60, 90), expand = FALSE) + #leave out Antarctica
  theme(legend.position = "none", legend.title = element_text(size=18), legend.text = element_text(size=18), 
        axis.text = element_text(size=14), axis.title = element_text(size=14)) +
  guides(fill = guide_legend(title = "PCWD [mm]", reverse = TRUE))  # Adjust legend for better presentation

############################## compare to ModESim (BC) same period 
#plot ERA5Land data to validate
r <- raster(t(X5_ModE_modern), xmn=min(lon), xmx=max(lon), ymn=min(lat), ymx=max(lat))
crs(r) <- "+proj=longlat +datum=WGS84"  # Set CRS for raster
r <- flip(r, direction='y')

# Retrieve land polygons and set the same CRS as the raster
land <- ne_countries(scale = "medium", returnclass = "sf")
land <- st_transform(land, crs = st_crs(r))  # Ensure CRS alignment

# Mask the raster with land polygons to remove ocean values
#r_masked <- mask(r, as(land, "Spatial"))

# Convert the masked raster to a data frame for ggplot2
r_df <- as.data.frame(r, xy = TRUE)
colnames(r_df) <- c("x", "y", "layer")  # Rename columns to match ggplot expectations

custom_bins <- c(0, 20, 40, 60, 80, 100, 150, 200, 300, 500, 700, 900, 1200, 2000, Inf)
custom_colors <- c("#004f5a",  # New color: a darker turquoise at the beginning
                   "#006d75", "#1a9e96", "#55c1ab", "#85c68b", "#d1c54b", "#e8b249",
                   "#e3842a", "#d45321", "#ba2e1f", "#9e2d2a", "#803c3d", "#63363f",
                   "#9c276e",  # New color: a deeper shade in the pink tones
                   "#d238a5")


# 1) build a vector of human–readable labels
#    for the finite intervals we do "a–b", 
#    and then for the last one ">2000"
finite_bins <- custom_bins[!is.infinite(custom_bins)]
lbls_finite <- paste0(finite_bins[-length(finite_bins)], "–", finite_bins[-1])
lbls <- c(lbls_finite, ">2000")

# 2) turn your raster values into a factor with exactly these levels
r_df$pcwd_cat <- cut(
  r_df$layer, 
  breaks = custom_bins, 
  labels = lbls, 
  include.lowest = TRUE, 
  right = FALSE
)

# 3) draw the plot, manually specifying levels, labels and colours
ggplot() +
  geom_raster(
    data = r_df, 
    aes(x = x, y = y, fill = pcwd_cat), 
    na.rm = TRUE
  ) +
  # note we put "Ocean" *first* in the breaks, so it shows at the top
  scale_fill_manual(
    name      = "5yr PCWD (mm)",
    values    = c("Ocean" = "grey50", setNames(custom_colors, lbls)), 
    breaks    = c("Ocean", lbls),
    labels    = c("Ocean", lbls),
    na.value  = "grey50"
  ) +
  labs(title = "ModE-Sim modern", x = "Longitude", y = "Latitude") +
  theme_classic() +
  geom_sf(data = land, fill = NA, color = "black", lwd = 0.3) +
  coord_sf(xlim =	c(-180, 178.125), ylim =	c(-60, 90), expand = FALSE) + #leave out Antarctica
  theme(legend.position = "none", legend.title = element_text(size=18), legend.text = element_text(size=18), 
        axis.text = element_text(size=14), axis.title = element_text(size=14), plot.title = element_text(face="bold")) +
  guides(fill = guide_legend(title = "PCWD [mm]", reverse = TRUE))  # Adjust legend for better presentation

##################### bias corrected ModESim early ind - modern 
D_earlyind = X5_ModE_early - X5_ModE_modern
#plot ERA5Land data to validate
# Convert first year's data into a raster object
r <- raster(t(D_earlyind), xmn=min(lon), xmx=max(lon), ymn=min(lat), ymx=max(lat))
crs(r) <- "+proj=longlat +datum=WGS84"  # Set CRS for raster
r <- flip(r, direction='y')

# Retrieve land polygons and set the same CRS as the raster
land <- ne_countries(scale = "medium", returnclass = "sf")
land <- st_transform(land, crs = st_crs(r))  # Ensure CRS alignment

# Mask the raster with land polygons to remove ocean values
r_masked <- mask(r, as(land, "Spatial"))

# Convert the masked raster to a data frame for ggplot2
r_df <- as.data.frame(r_masked, xy = TRUE)
colnames(r_df) <- c("x", "y", "layer")  # Rename columns to match ggplot expectations

# your breaks + palette
custom_bins   <- c(-Inf, -1000,  -500,  -100,   -50,   -20,   -10,
                    0,    10,     20,     50,    100,    500,   1000,  Inf)
custom_colors <- colorRampPalette(c("blue", "white", "red"))(length(custom_bins)-1)

#–– build the labels for all 14 bins
finite_vals <- custom_bins[!is.infinite(custom_bins)]
mid_lbls    <- paste0(finite_vals[-length(finite_vals)], "–", finite_vals[-1])

lbls <- c(
  paste0("<", finite_vals[1]),   # "<-1000"
  mid_lbls,                       # "-1000–-500", …, "500–1000"  (12 items)
  paste0(">", tail(finite_vals,1))# ">1000"
)
# check
length(lbls)  # should be 14

#–– cut into that factor
r_df$delta_cat <- cut(
  r_df$layer,
  breaks         = custom_bins,
  labels         = lbls,
  include.lowest = TRUE,
  right          = FALSE
)

#–– 4) plot, forcing Ocean (NA) to the top
ggplot() +
  geom_raster(
    data = r_df,
    aes(x = x, y = y, fill = delta_cat),
    na.rm = TRUE
  ) +
  scale_fill_manual(
    name   = expression(Delta*" (5 yr PCWD [mm])"),
    values = c("Ocean" = "grey50", setNames(custom_colors, lbls)),
    breaks = c("Ocean", lbls),
    labels = c("Ocean", lbls),
    na.value = "grey50"
  ) +
  labs(title = "ΔModE-Sim (early-ind - reference)", x = "Longitude", y = "Latitude") +
  theme_classic() +
  geom_sf(data = land, fill = NA, color = "black", lwd = 0.3) +
  coord_sf(xlim =	c(-180, 178.125), ylim =	c(-60, 90), expand = FALSE) + #leave out Antarctica
  theme(legend.position = "none", legend.title = element_text(size=18), legend.text = element_text(size=18), 
        axis.text = element_text(size=14), axis.title = element_text(size=14)) +
  guides(fill = guide_legend(title = "PCWD [mm]", reverse = TRUE))  # Adjust legend for better presentation


##################### bias corrected ModESim early ind - modern 
D_preind = X5_ModE_pre - X5_ModE_modern
#plot ERA5Land data to validate
# Convert first year's data into a raster object
r <- raster(t(D_preind), xmn=min(lon), xmx=max(lon), ymn=min(lat), ymx=max(lat))
crs(r) <- "+proj=longlat +datum=WGS84"  # Set CRS for raster
r <- flip(r, direction='y')

# Retrieve land polygons and set the same CRS as the raster
land <- ne_countries(scale = "medium", returnclass = "sf")
land <- st_transform(land, crs = st_crs(r))  # Ensure CRS alignment

# Mask the raster with land polygons to remove ocean values
r_masked <- mask(r, as(land, "Spatial"))

# Convert the masked raster to a data frame for ggplot2
r_df <- as.data.frame(r_masked, xy = TRUE)
colnames(r_df) <- c("x", "y", "layer")  # Rename columns to match ggplot expectations

# your breaks + palette
custom_bins   <- c(-Inf, -1000,  -500,  -100,   -50,   -20,   -10,
                    0,    10,     20,     50,    100,    500,   1000,  Inf)
custom_colors <- colorRampPalette(c("blue", "white", "red"))(length(custom_bins)-1)

#–– build the labels for all 14 bins
finite_vals <- custom_bins[!is.infinite(custom_bins)]
mid_lbls    <- paste0(finite_vals[-length(finite_vals)], "–", finite_vals[-1])

lbls <- c(
  paste0("<", finite_vals[1]),   # "<-1000"
  mid_lbls,                       # "-1000–-500", …, "500–1000"  (12 items)
  paste0(">", tail(finite_vals,1))# ">1000"
)
# check
length(lbls)  # should be 14

#–– cut into that factor
r_df$delta_cat <- cut(
  r_df$layer,
  breaks         = custom_bins,
  labels         = lbls,
  include.lowest = TRUE,
  right          = FALSE
)

#–– 4) plot, forcing Ocean (NA) to the top
ggplot() +
  geom_raster(
    data = r_df,
    aes(x = x, y = y, fill = delta_cat),
    na.rm = TRUE
  ) +
  scale_fill_manual(
    name   = expression(Delta*" (5 yr PCWD [mm])"),
    values = c("Ocean" = "grey50", setNames(custom_colors, lbls)),
    breaks = c("Ocean", lbls),
    labels = c("Ocean", lbls),
    na.value = "grey50"
  ) +
  labs(title = "ΔModE-Sim (pre-ind - reference)", x = "Longitude", y = "Latitude") +
  theme_classic() +
  geom_sf(data = land, fill = NA, color = "black", lwd = 0.3) +
  coord_sf(xlim =	c(-180, 178.125), ylim =	c(-60, 90), expand = FALSE) + #leave out Antarctica
  theme(legend.position = "none", legend.title = element_text(size=18), legend.text = element_text(size=18), 
        axis.text = element_text(size=14), axis.title = element_text(size=14)) +
  guides(fill = guide_legend(title = "ΔPCWD [mm]", reverse = TRUE))  # Adjust legend for better presentation
```

Plot ERA5-Land 5-year extreme values for validation
```{r}
##test plot for legend
#plot ERA5Land data to validate
r <- raster(t(X5_ERA5), xmn=min(lon), xmx=max(lon), ymn=min(lat), ymx=max(lat))
crs(r) <- "+proj=longlat +datum=WGS84"  # Set CRS for raster
r <- flip(r, direction='y')

# Retrieve land polygons and set the same CRS as the raster
land <- ne_countries(scale = "medium", returnclass = "sf")
land <- st_transform(land, crs = st_crs(r))  # Ensure CRS alignment

# Mask the raster with land polygons to remove ocean values
#r_masked <- mask(r, as(land, "Spatial"))

# Convert the masked raster to a data frame for ggplot2
r_df <- as.data.frame(r, xy = TRUE)
colnames(r_df) <- c("x", "y", "layer")  # Rename columns to match ggplot expectations

custom_bins <- c(0, 20, 40, 60, 80, 100, 150, 200, 300, 500, 700, 900, 1200, 2000, Inf)
custom_colors <- c("#004f5a",  # New color: a darker turquoise at the beginning
                   "#006d75", "#1a9e96", "#55c1ab", "#85c68b", "#d1c54b", "#e8b249",
                   "#e3842a", "#d45321", "#ba2e1f", "#9e2d2a", "#803c3d", "#63363f",
                   "#9c276e",  # New color: a deeper shade in the pink tones
                   "#d238a5")


# 1) build a vector of human–readable labels
#    for the finite intervals we do "a–b", 
#    and then for the last one ">2000"
finite_bins <- custom_bins[!is.infinite(custom_bins)]
lbls_finite <- paste0(finite_bins[-length(finite_bins)], "–", finite_bins[-1])
lbls <- c(lbls_finite, ">2000")

# 2) turn your raster values into a factor with exactly these levels
r_df$pcwd_cat <- cut(
  r_df$layer, 
  breaks = custom_bins, 
  labels = lbls, 
  include.lowest = TRUE, 
  right = FALSE
)

# 3) draw the plot, manually specifying levels, labels and colours
ggplot() +
  geom_raster(
    data = r_df, 
    aes(x = x, y = y, fill = pcwd_cat), 
    na.rm = TRUE
  ) +
  # note we put "Ocean" *first* in the breaks, so it shows at the top
  scale_fill_manual(
    name      = "5yr PCWD (mm)",
    values    = c("Ocean" = "grey50", setNames(custom_colors, lbls)), 
    breaks    = c("Ocean", lbls),
    labels    = c("Ocean", lbls),
    na.value  = "grey50"
  ) +
  labs(
    title = "ModE-Sim modern (1970-1999)",
    x = "Longitude", y = "Latitude"
  ) +
  theme_classic(base_size = 14) +
  geom_sf(data = land, fill = NA, color = "black", lwd = 0.3) +
  coord_sf(
    xlim   = c(-180, 178.125),
    ylim   = c(-60,   90),
    expand = FALSE
  ) +
  theme(
    legend.position   = "right",
    legend.title      = element_text(size = 18),
    legend.text       = element_text(size = 16)
  ) +
  guides(
    fill = guide_legend(title = "PCWD [mm]", reverse = TRUE)
  )
```

# Regional comparisons 

## Compute regional dataset for ERA5Land data: 

```{r}
### read in IPCC Region information:
#Load reference regions and coastlines:

load("/storage/homefs/ph23v078/Reference_regions/IPCC-WGI-reference-regions-v4_R.rda", verbose = TRUE)

#simplify this object by converting it to a SpatialPolygons class object (i.e., only the polygons are retained and their attributes discarded):
refregions <- as(IPCC_WGI_reference_regions_v4, "SpatialPolygons")

# List of regions to loop over --- excludes ocean basins
regions <- c("GIC", "NWN", "NEN", "WNA", "CNA", "ENA", "NCA", "SCA", "CAR", "NWS",
             "NSA", "NES", "SAM", "SWS", "SES", "SSA", "NEU", "WCE", "EEU", "MED",
             "SAH", "WAF", "CAF", "NEAF", "SEAF", "WSAF", "ESAF", "MDG", "RAR", "WSB",
             "ESB", "RFE", "WCA", "ECA", "TIB", "EAS", "ARP", "SAS", "SEA", "NAU",
             "CAU", "EAU", "SAU", "NZ")
# regions <- c("GIC")

# Define continent assignments
continent_mapping <- list(
  "Europe" = c("NEU", "WCE", "EEU", "MED"),
  "North America" = c("NWN", "NEN", "WNA", "CNA", "ENA", "GIC"),
  "Africa" = c("SAH", "WAF", "CAF", "NEAF", "SEAF", "WSAF", "ESAF", "MDG"),
  "Asia" = c("WCA", "ECA", "TIB", "EAS", "ARP", "SAS", "SEA", "WSB", "ESB", "RFE", "RAR"),
  "Central America" =c("NCA", "SCA", "CAR"),
  "South America" = c("NWS", "NSA", "NES", "SAM", "SWS", "SES", "SSA"),
  "Australia" = c("NAU", "CAU", "EAU", "SAU", "NZ")
)


regional_results_ERA5Land<- readRDS("~/cwd_global/data/regionalResults_ERA5Land.RData") #1950 - 2024
### to match ModE-Sim years only include until 2009 (42 years from 1968):
#regional_results_ERA5Land <- lapply(regional_results_ERA5Land, function(x) x[1:60])


```

### Bias correct regional ModE-Sim data

#### Apply Quantile Mapping to already regional average data in order to fit distribution better
- fit quantile mapping for an overlap period
- then apply to the rest of the dataset

Apply bias correction for chosen overlap period (21:50) - excludes 60s with potential precipitation problem in ModE-Sim and somewhat allows for stationary climate

```{r}
#install.packages("qmap") # uncomment if you haven't installed it
library(qmap)
library(Metrics)

corrected_full <- list()

for (region in names(regional_results_ERA5Land)) {
  
  obs <- regional_results_ERA5Land[[region]][21:50]  # [1:60] - 30 years (1970-1999)
  sim_overlap <- merged_results[[region]][551:580, ]  # 1970-1999 period for training as 60s have precip problems
  sim_full <- merged_results[[region]]  # 160 years
  
  corrected_matrix <- matrix(NA, nrow = nrow(sim_full), ncol = ncol(sim_full))
  colnames(corrected_matrix) <- colnames(sim_full)

  for (i in 1:ncol(sim_full)) {  #loop through ensemble members
    mod_train <- sim_overlap[, i]  # 60-year overlap
    mod_full <- sim_full[, i]      # 160-year full run
    
    # # Fit QM model on 60-year overlap on a parametric transfer function
    qm_model <- fitQmapPTF(obs = obs, mod = mod_train, wet.day = FALSE, qstep = 0.001)
    #
    # # Apply to full 160-year series
    corrected_matrix[, i] <- doQmapPTF(mod_full, qm_model)
  }

  corrected_full[[region]] <- corrected_matrix
}
```



Validation plots: 
- violin plots for each region, showing the values from ModESim with ERA5 overlain to see where the match works well 
- scatterplot where data should lie on 1:1 line if it represents well 

```{r}
library(ggplot2)
library(dplyr)
library(tidyr)

# Convert ModESim data to long format
ModESim_long <- bind_rows(lapply(names(regional_results_ModESim), function(region) {
  data.frame(
    Year = rep(1950:2009, times = 20),  # Repeat years for each ensemble member
    Value = as.vector(regional_results_ModESim[[region]][101:160,]),  # Flatten matrix
    Region = region,
    Source = "ModESim"
  )
}))

# Convert ModESim data to long format
ModESim_long_bc <- bind_rows(lapply(names(corrected_full), function(region) { #regional_results_ModESim_bc for mean_bias corrected global data
  data.frame(
    Year = rep(1950:2009, times = 20),  # Repeat years for each ensemble member
    Value = as.vector(corrected_full[[region]][531:590,]),  # Flatten matrix
    Region = region,
    Source = "ModESim_bc"
  )
}))

# Convert ERA5Land data to long format (assuming it's stored in a similar list format)
ERA5Land_long <- bind_rows(lapply(names(regional_results_ERA5Land), function(region) {
  data.frame(
    Year = 1950:2009, #change to 2009 for overlap period
    Value = regional_results_ERA5Land[[region]][1:60],
    Region = region,
    Source = "ERA5Land"
  )
}))

# Combine both datasets
combined_data_raw <- bind_rows(ModESim_long, ERA5Land_long)
combined_data_bc <- bind_rows(ModESim_long_bc, ERA5Land_long) #bias corrected ModE-Sim

#### colours x-axis
# Define continent assignments
continent_mapping <- list(
  "Europe" = c("NEU", "WCE", "EEU", "MED"),
  "North America" = c("NWN", "NEN", "WNA", "CNA", "ENA", "GIC"),
  "Africa" = c("SAH", "WAF", "CAF", "NEAF", "SEAF", "WSAF", "ESAF", "MDG"),
  "Asia" = c("WCA", "ECA", "TIB", "EAS", "ARP", "SAS", "SEA", "WSB", "ESB", "RFE", "RAR"),
  "Central America" =c("NCA", "SCA", "CAR"),
  "South America" = c("NWS", "NSA", "NES", "SAM", "SWS", "SES", "SSA"),
  "Australia" = c("NAU", "CAU", "EAU", "SAU", "NZ")
)
continent_colors <- c(
  "Europe" = "#F5B0CB",
  "North America" = "#236A3F",
  "Africa" = "#91C7B1",
  "Asia" = "#E5973B",
  "Central America" = "#B33951",
  "South America" = "#E3D081",
  "Australia" = "#3C3980",
  "Ocean" = "white"
)

# Extract unique regions from your data
unique_regions <- unique(combined_data_raw$Region)

# Initialize a named character vector for storing formatted labels.
region_color_labels <- setNames(rep(NA, length(unique_regions)), unique_regions)

#install.packages("ggtext")  # if not already installed
library(ggtext)             # must be called in your script


# For each continent, assign the corresponding region labels that match
for (continent in names(continent_mapping)) {
  regions <- continent_mapping[[continent]]
  for (region in regions) {
    if (region %in% unique_regions) {
      # Format the region label with the designated colour from continent_colors
      region_color_labels[region] <- sprintf("<span style='color:%s;'>%s</span>", 
                                               continent_colors[continent], 
                                               region)
    }
  }
}

# In case any regions haven't been matched, assign a default colour (e.g. black)
for (region in unique_regions) {
  if (is.na(region_color_labels[region])) {
    region_color_labels[region] <- sprintf("<span style='color:%s;'>%s</span>", "black", region)
  }
}

# Inspect the mapping to confirm:
#print(region_color_labels)

# Plot the violin plot
ggplot(combined_data_raw, aes(x = Region, y = Value, fill = Source)) +
  geom_violin(scale = "width") +
  theme_minimal() +
  scale_fill_manual(
    values = c( "ERA5Land" = "#087E8B", "ModESim" = "#FF5A5F"),
    labels = c( "ERA5-Land", "ModE-Sim")  # Or customize as you like
  ) +
  scale_x_discrete(labels = region_color_labels) +  # Apply custom coloured labels
  theme(axis.text.x = element_markdown(angle = 90, hjust = 1, size = 12),
    legend.position = "none",
    axis.text.y = element_text(size = 12), 
    axis.title.x = element_text(size = 13),
    axis.title.y = element_text(size = 13),
    legend.title = element_text(face = "bold"),
    legend.text = element_text(size=12),) +  # Rotate x-axis labels
  labs(title = "ModE-Sim (RAW) vs ERA5-Land by Region (1950-2009)",
       y = "PCWD Value [mm]",
       x = "Region",
       fill = "Dataset")


# Plot the violin plot
ggplot(combined_data_bc, aes(x = Region, y = Value, fill = Source)) +
  geom_violin(scale = "width") +
  theme_minimal() +
  scale_fill_manual(
    values = c( "ERA5Land" = "#087E8B", "ModESim_bc" = "#FF5A5F"),
    labels = c( "ERA5-Land", "ModE-Sim")  # Or customize as you like
  ) +
  scale_x_discrete(labels = region_color_labels) +  # Apply custom coloured labels
  theme(axis.text.x = element_markdown(angle = 90, hjust = 1, size = 12),
    legend.position = "none",
    axis.text.y = element_text(size = 12), 
    axis.title.x = element_text(size = 13),
    axis.title.y = element_text(size = 13),
    legend.title = element_text(face = "bold"),
    legend.text = element_text(size=12),) +  # Rotate x-axis labels
  labs(title = "ModE-Sim (BC) vs ERA5-Land by Region (1950-2009)",
       y = "PCWD Value [mm]",
       x = "Region",
       fill = "Dataset")

```


```{r}
library(ggExtra)
library(MASS)  # For density estimation

# Merge the datasets by Year and Region
scatter_data <- inner_join(ModESim_long, ERA5Land_long, by = c("Year", "Region"), suffix = c("_ModESim", "_ERA5Land"))
#bias corrected: 
scatter_data_bc <- inner_join(ModESim_long_bc, ERA5Land_long, by = c("Year", "Region"), suffix = c("_ModESim_bc", "_ERA5Land"))

# Compute 2D Kernel Density Estimation
dens <- kde2d(scatter_data$Value_ERA5Land, scatter_data$Value_ModESim, n = 100)
dens_bc <- kde2d(scatter_data_bc$Value_ERA5Land, scatter_data_bc$Value_ModESim_bc, n = 100)

# Find the density values for each point in the scatter plot
scatter_data$density <- dens$z[cbind(
  findInterval(scatter_data$Value_ERA5Land, dens$x), 
  findInterval(scatter_data$Value_ModESim, dens$y)
)]

# Find the density values for each point in the scatter plot
scatter_data_bc$density <- dens_bc$z[cbind(
  findInterval(scatter_data_bc$Value_ERA5Land, dens_bc$x), 
  findInterval(scatter_data_bc$Value_ModESim, dens_bc$y)
)]

# Scatter plot with density-based coloring
ggplot(scatter_data, aes(x = Value_ERA5Land, y = Value_ModESim, color = density)) +
  geom_point(size = 1.5) +  # Regular points, colored by density
  geom_abline(slope = 1, intercept = 0, color = "grey42") +
  scale_color_viridis_c(option = "plasma") +  # Heatmap-like color scheme
  geom_smooth(method = "lm", color = "red", se = FALSE, linewidth= 0.5) +  # Trend line
  theme_minimal() +
  labs(title = "ERA5Land vs. ModESim (1950-2009)",
       x = expression(PCWD[ERA5Land]),
       y = expression(PCWD[ModE-Sim]),
       color = "Density") +
  theme(legend.position = "right")

# Scatter plot with density-based coloring
ggplot(scatter_data_bc, aes(x = Value_ERA5Land, y = Value_ModESim_bc, color = density)) +
  geom_point(size = 1.5) +  # Regular points, colored by density
  geom_abline(slope = 1, intercept = 0, color = "grey42") +
  scale_color_viridis_c(option = "plasma") +  # Heatmap-like color scheme
  geom_smooth(method = "lm", color = "red", se = FALSE, linewidth= 0.5) +  # Trend line
  theme_minimal() +
  labs(title = "ERA5Land vs. ModESim_bc (QM) (1950-2009)",
       x = expression(PCWD[ERA5Land]),
       y = expression(PCWD[ModE-Sim]),
       color = "Density") +
  theme(legend.position = "right")
```


Regional density curves showing bias corrected ensemble members
```{r}
# # Convert the list to a long format data frame
# regional_df_ModESim <- map_dfr(names(regional_results_ModESim), 
#                        ~ tibble(value = as.vector(regional_results_ModESim[[.x]]),
#                                 ensemble = rep(colnames(regional_results_ModESim[[.x]]), each = nrow(regional_results_ModESim[[.x]])),
#                                 region = .x)) 
# regional_df_ModESim$continent <- NA  # Initialize continent column
# 
# for (continent in names(continent_mapping)) {
#   regional_df_ModESim$continent[regional_df_ModESim$region %in% continent_mapping[[continent]]] <- continent
# }

# Convert the list to a long format data frame
regional_df_ModESim_bc <- map_dfr(names(corrected_full), #quantile mapped corrected -- replace with corrected_full!!!
                       ~ tibble(value = as.vector(corrected_full[[.x]]),
                                ensemble = rep(colnames(corrected_full[[.x]]), each = nrow(corrected_full[[.x]])), #regional_results_ModESim_bc for mean_bias corrected version
                                region = .x)) 
regional_df_ModESim_bc$continent <- NA  # Initialize continent column

for (continent in names(continent_mapping)) {
  regional_df_ModESim_bc$continent[regional_df_ModESim_bc$region %in% continent_mapping[[continent]]] <- continent
}

#Convert
regional_df_ERA5 <- map_dfr(names(regional_results_ERA5Land), 
                           ~ tibble(value = as.vector(regional_results_ERA5Land[[.x]]),
                                    region = .x)) 
regional_df_ERA5$continent <- NA  # Initialize continent column

for (continent in names(continent_mapping)) {
  regional_df_ERA5$continent[regional_df_ERA5$region %in% continent_mapping[[continent]]] <- continent
}


selected_continent <- "Europe"
# Filter both datasets for the selected continent
#filtered_mod <- regional_df_ModESim %>% filter(continent == selected_continent)
filtered_mod_bc <- regional_df_ModESim_bc %>% filter(continent == selected_continent)
filtered_era  <- regional_df_ERA5 %>% filter(continent == selected_continent)

# Plot
ggplot() +
  geom_density(data = filtered_mod_bc, aes(x = value, fill = ensemble, color = ensemble), alpha = 0.3) +
  #geom_density(data = filtered_mod_bc, aes(x = value, fill = "ModESim-BC", color = "ModESim-BC"), alpha = 0.5, linewidth = 0.5) +
  geom_density(data = filtered_era, aes(x = value, fill = "ERA5Land", color = "ERA5Land"), alpha = 0.5, linewidth = 0.5) +
  facet_wrap(~region, scales = "free") +
  theme_minimal() +
  scale_color_manual(values = c(setNames(viridis::viridis(length(unique(filtered_mod_bc$ensemble))), unique(filtered_mod_bc$ensemble)), "ERA5Land" = "black")) +
  scale_fill_manual(values = c(setNames(viridis::viridis(length(unique(filtered_mod_bc$ensemble))), unique(filtered_mod_bc$ensemble)), "ERA5Land" = "black")) +
  labs(title = paste("(QM_BC) Density of Values by Region and Datasets for", selected_continent),
       x = "PWCD [mm]", y = "Density", fill = "Dataset", color = "Dataset") +
  theme(legend.position = "none")

#####
selected_continent <- "Asia"
# Filter both datasets for the selected continent
#filtered_mod <- regional_df_ModESim %>% filter(continent == selected_continent)
filtered_mod_bc <- regional_df_ModESim_bc %>% filter(continent == selected_continent)
filtered_era  <- regional_df_ERA5 %>% filter(continent == selected_continent)

# Plot
ggplot() +
  geom_density(data = filtered_mod_bc, aes(x = value, fill = ensemble, color = ensemble), alpha = 0.3) +
  #geom_density(data = filtered_mod_bc, aes(x = value, fill = "ModESim-BC", color = "ModESim-BC"), alpha = 0.5, linewidth = 0.5) +
  geom_density(data = filtered_era, aes(x = value, fill = "ERA5Land", color = "ERA5Land"), alpha = 0.5, linewidth = 0.5) +
  facet_wrap(~region, scales = "free") +
  theme_minimal() +
  scale_color_manual(values = c(setNames(viridis::viridis(length(unique(filtered_mod_bc$ensemble))), unique(filtered_mod_bc$ensemble)), "ERA5Land" = "black")) +
  scale_fill_manual(values = c(setNames(viridis::viridis(length(unique(filtered_mod_bc$ensemble))), unique(filtered_mod_bc$ensemble)), "ERA5Land" = "black")) +
  labs(title = paste("(QM_BC) Density of Values by Region and Datasets for", selected_continent),
       x = "PWCD [mm]", y = "Density", fill = "Dataset", color = "Dataset") +
  theme(legend.position = "bottom")

######
selected_continent <- "Australia"
# Filter both datasets for the selected continent
#filtered_mod <- regional_df_ModESim %>% filter(continent == selected_continent)
filtered_mod_bc <- regional_df_ModESim_bc %>% filter(continent == selected_continent)
filtered_era  <- regional_df_ERA5 %>% filter(continent == selected_continent)

# Plot
ggplot() +
  geom_density(data = filtered_mod_bc, aes(x = value, fill = ensemble, color = ensemble), alpha = 0.3) +
  #geom_density(data = filtered_mod_bc, aes(x = value, fill = "ModESim-BC", color = "ModESim-BC"), alpha = 0.5, linewidth = 0.5) +
  geom_density(data = filtered_era, aes(x = value, fill = "ERA5Land", color = "ERA5Land"), alpha = 0.5, linewidth = 0.5) +
  facet_wrap(~region, scales = "free") +
  theme_minimal() +
  scale_color_manual(values = c(setNames(viridis::viridis(length(unique(filtered_mod_bc$ensemble))), unique(filtered_mod_bc$ensemble)), "ERA5Land" = "black")) +
  scale_fill_manual(values = c(setNames(viridis::viridis(length(unique(filtered_mod_bc$ensemble))), unique(filtered_mod_bc$ensemble)), "ERA5Land" = "black")) +
  labs(title = paste("(QM_BC) Density of Values by Region and Datasets for", selected_continent),
       x = "PWCD [mm]", y = "Density", fill = "Dataset", color = "Dataset") +
  theme(legend.position = "bottom")

#####
selected_continent <- "Africa"
# Filter both datasets for the selected continent
#filtered_mod <- regional_df_ModESim %>% filter(continent == selected_continent)
filtered_mod_bc <- regional_df_ModESim_bc %>% filter(continent == selected_continent)
filtered_era  <- regional_df_ERA5 %>% filter(continent == selected_continent)

# Plot
ggplot() +
  geom_density(data = filtered_mod_bc, aes(x = value, fill = ensemble, color = ensemble), alpha = 0.3) +
  #geom_density(data = filtered_mod_bc, aes(x = value, fill = "ModESim-BC", color = "ModESim-BC"), alpha = 0.5, linewidth = 0.5) +
  geom_density(data = filtered_era, aes(x = value, fill = "ERA5Land", color = "ERA5Land"), alpha = 0.5, linewidth = 0.5) +
  facet_wrap(~region, scales = "free") +
  theme_minimal() +
  scale_color_manual(values = c(setNames(viridis::viridis(length(unique(filtered_mod_bc$ensemble))), unique(filtered_mod_bc$ensemble)), "ERA5Land" = "black")) +
  scale_fill_manual(values = c(setNames(viridis::viridis(length(unique(filtered_mod_bc$ensemble))), unique(filtered_mod_bc$ensemble)), "ERA5Land" = "black")) +
  labs(title = paste("(QM_BC) Density of Values by Region and Datasets for", selected_continent),
       x = "PWCD [mm]", y = "Density", fill = "Dataset", color = "Dataset") +
  theme(legend.position = "bottom")

######
selected_continent <- "North America"
# Filter both datasets for the selected continent
#filtered_mod <- regional_df_ModESim %>% filter(continent == selected_continent)
filtered_mod_bc <- regional_df_ModESim_bc %>% filter(continent == selected_continent)
filtered_era  <- regional_df_ERA5 %>% filter(continent == selected_continent)

# Plot
ggplot() +
  geom_density(data = filtered_mod_bc, aes(x = value, fill = ensemble, color = ensemble), alpha = 0.3) +
  #geom_density(data = filtered_mod_bc, aes(x = value, fill = "ModESim-BC", color = "ModESim-BC"), alpha = 0.5, linewidth = 0.5) +
  geom_density(data = filtered_era, aes(x = value, fill = "ERA5Land", color = "ERA5Land"), alpha = 0.5, linewidth = 0.5) +
  facet_wrap(~region, scales = "free") +
  theme_minimal() +
  scale_color_manual(values = c(setNames(viridis::viridis(length(unique(filtered_mod_bc$ensemble))), unique(filtered_mod_bc$ensemble)), "ERA5Land" = "black")) +
  scale_fill_manual(values = c(setNames(viridis::viridis(length(unique(filtered_mod_bc$ensemble))), unique(filtered_mod_bc$ensemble)), "ERA5Land" = "black")) +
  labs(title = paste("(QM_BC) Density of Values by Region and Datasets for", selected_continent),
       x = "PWCD [mm]", y = "Density", fill = "Dataset", color = "Dataset") +
  theme(legend.position = "bottom")

######
selected_continent <- "South America"
# Filter both datasets for the selected continent
#filtered_mod <- regional_df_ModESim %>% filter(continent == selected_continent)
filtered_mod_bc <- regional_df_ModESim_bc %>% filter(continent == selected_continent)
filtered_era  <- regional_df_ERA5 %>% filter(continent == selected_continent)

# Plot
ggplot() +
  geom_density(data = filtered_mod_bc, aes(x = value, fill = ensemble, color = ensemble), alpha = 0.3) +
  #geom_density(data = filtered_mod_bc, aes(x = value, fill = "ModESim-BC", color = "ModESim-BC"), alpha = 0.5, linewidth = 0.5) +
  geom_density(data = filtered_era, aes(x = value, fill = "ERA5Land", color = "ERA5Land"), alpha = 0.5, linewidth = 0.5) +
  facet_wrap(~region, scales = "free") +
  theme_minimal() +
  scale_color_manual(values = c(setNames(viridis::viridis(length(unique(filtered_mod_bc$ensemble))), unique(filtered_mod_bc$ensemble)), "ERA5Land" = "black")) +
  scale_fill_manual(values = c(setNames(viridis::viridis(length(unique(filtered_mod_bc$ensemble))), unique(filtered_mod_bc$ensemble)), "ERA5Land" = "black")) +
  labs(title = paste("(QM_BC) Density of Values by Region and Datasets for", selected_continent),
       x = "PWCD [mm]", y = "Density", fill = "Dataset", color = "Dataset") +
  theme(legend.position = "bottom")

#####
selected_continent <- "Central America"
# Filter both datasets for the selected continent
#filtered_mod <- regional_df_ModESim %>% filter(continent == selected_continent)
filtered_mod_bc <- regional_df_ModESim_bc %>% filter(continent == selected_continent)
filtered_era  <- regional_df_ERA5 %>% filter(continent == selected_continent)

# Plot
ggplot() +
  geom_density(data = filtered_mod_bc, aes(x = value, fill = ensemble, color = ensemble), alpha = 0.3) +
  #geom_density(data = filtered_mod_bc, aes(x = value, fill = "ModESim-BC", color = "ModESim-BC"), alpha = 0.5, linewidth = 0.5) +
  geom_density(data = filtered_era, aes(x = value, fill = "ERA5Land", color = "ERA5Land"), alpha = 0.5, linewidth = 0.5) +
  facet_wrap(~region, scales = "free") +
  theme_minimal() +
  scale_color_manual(values = c(setNames(viridis::viridis(length(unique(filtered_mod_bc$ensemble))), unique(filtered_mod_bc$ensemble)), "ERA5Land" = "black")) +
  scale_fill_manual(values = c(setNames(viridis::viridis(length(unique(filtered_mod_bc$ensemble))), unique(filtered_mod_bc$ensemble)), "ERA5Land" = "black")) +
  labs(title = paste("(QM_BC) Density of Values by Region and Datasets for", selected_continent),
       x = "PWCD [mm]", y = "Density", fill = "Dataset", color = "Dataset") +
  theme(legend.position = "bottom")
```


### Absolute values timeseries of bias corrected ModE-Sim and ERA5-Land

```{r}
### raw ModESim regional data - corrected_full = bias corrected 1850-2009
abs_ModESim <- do.call(rbind,lapply(names(corrected_full), function(region) { #merged_results for raw
  df <- as.data.frame(corrected_full[[region]][431:590,]) ## corrected_full for bc
  df$time <- seq(1850,2009)
  df$region <- region
  df_long <- pivot_longer(df, cols = -c(time, region), names_to = "ensemble_member", values_to = "PCWD")
  return(df_long)
}))

# Add a continent column
abs_ModESim$continent <- NA  # Initialize continent column
for (continent in names(continent_mapping)) {
  abs_ModESim$continent[abs_ModESim$region %in% continent_mapping[[continent]]] <- continent
}

abs_ERA5 <- do.call(rbind,lapply(names(regional_results_ERA5Land), function(region) {
  df <- as.data.frame(regional_results_ERA5Land[[region]])
  df$time <- seq(1950,2024)
  df$region <- region
  df_long <- pivot_longer(df, cols = -c(time, region),  values_to = "PCWD")
  return(df_long)
}))

# Add a continent column
abs_ERA5$continent <- NA  # Initialize continent column
for (continent in names(continent_mapping)) {
  abs_ERA5$continent[abs_ERA5$region %in% continent_mapping[[continent]]] <- continent
}

############### plot for regions
# Filter for selected continent
selected_continent <- "Europe"
mod_filtered <- abs_ModESim %>% filter(continent == selected_continent)
era_filtered <- abs_ERA5 %>% filter(continent == selected_continent)

# Plot rolling mean time series
ggplot() +
  # Plot individual ensemble members as fine grey lines
  geom_line(data = mod_filtered, aes(x = time, y = PCWD, group = ensemble_member, 
            color = factor("Ensemble Members")), alpha = 0.5, linewidth = 0.3, show.legend = TRUE) +
  # Plot mean z-score as a bold black line
  geom_line(data = mod_filtered %>% group_by(time, region) %>% summarise(EM = mean(PCWD, na.rm = TRUE)),
            aes(x = time, y = EM, color = factor("ModESim")), linewidth = 1) +
  geom_line(data = era_filtered, aes(x = time, y = PCWD,
            color = factor("ERA5")), linewidth = 1, show.legend = TRUE) +
  labs(
    x = "Year",
    y = "PCWD [mm]",
    title = paste("Absolute PCWD (QM-BC) for", selected_continent)
  ) +
  # Manual color scale for legend
  scale_color_manual(
    values = c("Ensemble Members" = "#7EA3CC","ModESim" = "#255C99",
               "ERA5" = "#B3001B" ),
    labels = c("Ensemble Members","PCWD (Mean) - ModESim", 
               "PCWD - ERA5Land" )
  ) +
  # Customize the legend
  guides(
    color = guide_legend(title = "Legend", override.aes = list(alpha = 1, linewidth = 1))  # Improve legend readability
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    legend.title = element_text(face = "bold"),
    plot.title = element_text(hjust = 0.5, face = "bold"),
    strip.text = element_text(size = 10),
    strip.background = element_rect(fill = "#F5B0CB"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  
  facet_wrap(~region, scales = "free_y")


# Filter for selected continent
selected_continent <- "Asia"
mod_filtered <- abs_ModESim %>% filter(continent == selected_continent)
era_filtered <- abs_ERA5 %>% filter(continent == selected_continent)

# Plot rolling mean time series
ggplot() +
  # Plot individual ensemble members as fine grey lines
  geom_line(data = mod_filtered, aes(x = time, y = PCWD, group = ensemble_member, 
            color = factor("Ensemble Members")), alpha = 0.5, linewidth = 0.3, show.legend = TRUE) +
  # Plot mean z-score as a bold black line
  geom_line(data = mod_filtered %>% group_by(time, region) %>% summarise(EM = mean(PCWD, na.rm = TRUE)),
            aes(x = time, y = EM, color = factor("ModESim")), linewidth = 1) +
  geom_line(data = era_filtered, aes(x = time, y = PCWD,
            color = factor("ERA5")), linewidth = 1, show.legend = TRUE) +
  labs(
    x = "Year",
    y = "PCWD [mm]",
    title = paste("Absolute PCWD (QM-BC) for", selected_continent)
  ) +
  # Manual color scale for legend
  scale_color_manual(
    values = c("Ensemble Members" = "#7EA3CC","ModESim" = "#255C99", "ERA5" = "#B3001B" ),
    labels = c("Ensemble Members","PCWD (Mean) - ModESim", "PCWD - ERA5Land" )
  ) +
  # Customize the legend
  guides(
    color = guide_legend(title = "Legend", override.aes = list(alpha = 1, linewidth = 1))  # Improve legend readability
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    legend.title = element_text(face = "bold"),
    plot.title = element_text(hjust = 0.5, face = "bold"),
    strip.text = element_text(size = 10),
    strip.background = element_rect(fill = "#E5973B"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  
  facet_wrap(~region, scales = "free_y")


# Filter for selected continent
selected_continent <- "Australia"
mod_filtered <- abs_ModESim %>% filter(continent == selected_continent)
era_filtered <- abs_ERA5 %>% filter(continent == selected_continent)

ggplot() +
  # Plot individual ensemble members as fine grey lines
  geom_line(data = mod_filtered, aes(x = time, y = PCWD, group = ensemble_member, 
            color = factor("Ensemble Members")), alpha = 0.5, linewidth = 0.3, show.legend = TRUE) +
  # Plot mean z-score as a bold black line
  geom_line(data = mod_filtered %>% group_by(time, region) %>% summarise(EM = mean(PCWD, na.rm = TRUE)),
            aes(x = time, y = EM, color = factor("ModESim")), linewidth = 1) +
  geom_line(data = era_filtered, aes(x = time, y = PCWD,
            color = factor("ERA5")), linewidth = 1, show.legend = TRUE) +
  labs(
    x = "Year",
    y = "PCWD [mm]",
    title = paste("Absolute PCWD (QM-BC) for", selected_continent)
  ) +
  # Manual color scale for legend
  scale_color_manual(
    values = c("Ensemble Members" = "#7EA3CC","ModESim" = "#255C99",
               "ERA5" = "#B3001B" ),
    labels = c("Ensemble Members","PCWD (Mean) - ModESim", 
               "PCWD - ERA5Land" )
  ) +
  # Customize the legend
  guides(
    color = guide_legend(title = "Legend", override.aes = list(alpha = 1, linewidth = 1))  # Improve legend readability
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    legend.title = element_text(face = "bold"),
    plot.title = element_text(hjust = 0.5, face = "bold"),
    strip.text = element_text(size = 10, color = "white"),
    strip.background = element_rect(fill = "#3C3980"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  
  facet_wrap(~region, scales = "free_y")

# Filter for selected continent
selected_continent <- "Africa"
mod_filtered <- abs_ModESim %>% filter(continent == selected_continent)
era_filtered <- abs_ERA5 %>% filter(continent == selected_continent)

ggplot() +
  # Plot individual ensemble members as fine grey lines
  geom_line(data = mod_filtered, aes(x = time, y = PCWD, group = ensemble_member, 
            color = factor("Ensemble Members")), alpha = 0.5, linewidth = 0.3, show.legend = TRUE) +
  # Plot mean z-score as a bold black line
  geom_line(data = mod_filtered %>% group_by(time, region) %>% summarise(EM = mean(PCWD, na.rm = TRUE)),
            aes(x = time, y = EM, color = factor("ModESim")), linewidth = 1) +
  geom_line(data = era_filtered, aes(x = time, y = PCWD,
            color = factor("ERA5")), linewidth = 1, show.legend = TRUE) +
  labs(
    x = "Year",
    y = "PCWD [mm]",
    title = paste("Absolute PCWD (QM-BC) for", selected_continent)
  ) +
  # Manual color scale for legend
  scale_color_manual(
    values = c("Ensemble Members" = "#7EA3CC","ModESim" = "#255C99",
               "ERA5" = "#B3001B" ),
    labels = c("Ensemble Members","PCWD (Mean) - ModESim", 
               "PCWD - ERA5Land" )
  ) +
  # Customize the legend
  guides(
    color = guide_legend(title = "Legend", override.aes = list(alpha = 1, linewidth = 1))  # Improve legend readability
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    legend.title = element_text(face = "bold"),
    plot.title = element_text(hjust = 0.5, face = "bold"),
    strip.text = element_text(size = 10),
    strip.background = element_rect(fill = "#91C7B1"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  
  facet_wrap(~region, scales = "free_y")

# Filter for selected continent
selected_continent <- "North America"
mod_filtered <- abs_ModESim %>% filter(continent == selected_continent)
era_filtered <- abs_ERA5 %>% filter(continent == selected_continent)

ggplot() +
  # Plot individual ensemble members as fine grey lines
  geom_line(data = mod_filtered, aes(x = time, y = PCWD, group = ensemble_member, 
            color = factor("Ensemble Members")), alpha = 0.5, linewidth = 0.3, show.legend = TRUE) +
  # Plot mean z-score as a bold black line
  geom_line(data = mod_filtered %>% group_by(time, region) %>% summarise(EM = mean(PCWD, na.rm = TRUE)),
            aes(x = time, y = EM, color = factor("ModESim")), linewidth = 1) +
  geom_line(data = era_filtered, aes(x = time, y = PCWD,
            color = factor("ERA5")), linewidth = 1, show.legend = TRUE) +
  labs(
    x = "Year",
    y = "PCWD [mm]",
    title = paste("Absolute PCWD (QM-BC) for", selected_continent)
  ) +
  # Manual color scale for legend
  scale_color_manual(
    values = c("Ensemble Members" = "#7EA3CC","ModESim" = "#255C99",
               "ERA5" = "#B3001B" ),
    labels = c("Ensemble Members","PCWD (Mean) - ModESim", 
               "PCWD - ERA5Land" )
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    legend.title = element_text(face = "bold"),
    plot.title = element_text(hjust = 0.5, face = "bold"),
    strip.text = element_text(size = 10, color = "white"),
    strip.background = element_rect(fill = "#236A3F"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  
  facet_wrap(~region, scales = "free_y")

# Filter for selected continent
selected_continent <- "South America"
mod_filtered <- abs_ModESim %>% filter(continent == selected_continent)
era_filtered <- abs_ERA5 %>% filter(continent == selected_continent)

ggplot() +
  # Plot individual ensemble members as fine grey lines
  geom_line(data = mod_filtered, aes(x = time, y = PCWD, group = ensemble_member, 
            color = factor("Ensemble Members")), alpha = 0.5, linewidth = 0.3, show.legend = TRUE) +
  # Plot mean z-score as a bold black line
  geom_line(data = mod_filtered %>% group_by(time, region) %>% summarise(EM = mean(PCWD, na.rm = TRUE)),
            aes(x = time, y = EM, color = factor("ModESim")), linewidth = 1) +
  geom_line(data = era_filtered, aes(x = time, y = PCWD,
            color = factor("ERA5")), linewidth = 1, show.legend = TRUE) +
  labs(
    x = "Year",
    y = "PCWD [mm]",
    title = paste("Absolute PCWD (QM-BC) for", selected_continent)
  ) +
  # Manual color scale for legend
  scale_color_manual(
    values = c("Ensemble Members" = "#7EA3CC","ModESim" = "#255C99",
               "ERA5" = "#B3001B" ),
    labels = c("Ensemble Members","PCWD (Mean) - ModESim", 
               "PCWD - ERA5Land" )
  ) +
  # Customize the legend
  guides(
    color = guide_legend(title = "Legend", override.aes = list(alpha = 1, linewidth = 1))  # Improve legend readability
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    legend.title = element_text(face = "bold"),
    plot.title = element_text(hjust = 0.5, face = "bold"),
    strip.text = element_text(size = 10),
    strip.background = element_rect(fill = "#E3D081"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  
  facet_wrap(~region, scales = "free_y")

# Filter for selected continent
selected_continent <- "Central America"
mod_filtered <- abs_ModESim %>% filter(continent == selected_continent)
era_filtered <- abs_ERA5 %>% filter(continent == selected_continent)

ggplot() +
  # Plot individual ensemble members as fine grey lines
  geom_line(data = mod_filtered, aes(x = time, y = PCWD, group = ensemble_member, 
            color = factor("Ensemble Members")), alpha = 0.5, linewidth = 0.3, show.legend = TRUE) +
  # Plot mean z-score as a bold black line
  geom_line(data = mod_filtered %>% group_by(time, region) %>% summarise(EM = mean(PCWD, na.rm = TRUE)),
            aes(x = time, y = EM, color = factor("ModESim")), linewidth = 1) +
  geom_line(data = era_filtered, aes(x = time, y = PCWD,
            color = factor("ERA5")), linewidth = 1, show.legend = TRUE) +
  labs(
    x = "Year",
    y = "PCWD [mm]",
    title = paste("Absolute PCWD (QM-BC) for", selected_continent)
  ) +
  # Manual color scale for legend
  scale_color_manual(
    values = c("Ensemble Members" = "#7EA3CC","ModESim" = "#255C99",
               "ERA5" = "#B3001B" ),
    labels = c("Ensemble Members","PCWD (Mean) - ModESim", 
               "PCWD - ERA5Land" )
  ) +
  # Customize the legend
  guides(
    color = guide_legend(title = "Legend", override.aes = list(alpha = 1, linewidth = 1))  # Improve legend readability
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    legend.title = element_text(face = "bold"),
    plot.title = element_text(hjust = 0.5, face = "bold"),
    strip.text = element_text(size = 10),
    strip.background = element_rect(fill = "#B33951"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  
  facet_wrap(~region, scales = "free_y")
```


## Regional Extreme Value analysis on bias corrected data

Select entire ERA5 data available to calculate 2 and 5 year events for specific regions: 

```{r}
# ##Read in data: 
# ##ERA5Land regional aggregates:
regional_results_ERA5Land <- readRDS("~/cwd_global/data/regionalResults_ERA5Land.RData")
WCE_ERA5 <- regional_results_ERA5Land[["WCE"]]

#ModESim data
WCE_MODE <- corrected_full[["WCE"]]

#attach time dimension
time_info_mode <- seq(from = as.numeric(1420), to = as.numeric(2009))
time_info_era <- seq(from = as.numeric(1950), to = as.numeric(2024))


# Convert ModE dataset to long format
WCE_MODE_long <- WCE_MODE %>%
  as.data.frame() %>%
  mutate(time = time_info_mode) %>%
  pivot_longer(cols = -time, names_to = "ensemble", values_to = "PCWD")

# Compute means
WCE_MODE_mean <- WCE_MODE_long %>%
  group_by(time) %>%
  summarise(PCWD = mean(PCWD, na.rm = TRUE), .groups = "drop")

# Convert ERA5 dataset into long format
WCE_ERA5_df <- data.frame(time = time_info_era, PCWD = WCE_ERA5)


#### ---------------------- Copy for MED ---------------------------------
# ##Read in data: 
# ##ERA5Land regional aggregates:
regional_results_ERA5Land <- readRDS("~/cwd_global/data/regionalResults_ERA5Land.RData")
MED_ERA5 <- regional_results_ERA5Land[["MED"]]

#ModESim data
MED_MODE <- corrected_full[["MED"]]

#attach time dimension
time_info_mode <- seq(from = as.numeric(1420), to = as.numeric(2009))
time_info_era <- seq(from = as.numeric(1950), to = as.numeric(2024))


# Convert ModE dataset to long format
MED_MODE_long <- MED_MODE %>%
  as.data.frame() %>%
  mutate(time = time_info_mode) %>%
  pivot_longer(cols = -time, names_to = "ensemble", values_to = "PCWD")

# Compute means
MED_MODE_mean <- MED_MODE_long %>%
  group_by(time) %>%
  summarise(PCWD = mean(PCWD, na.rm = TRUE), .groups = "drop")

# Convert ERA5 dataset into long format
MED_ERA5_df <- data.frame(time = time_info_era, PCWD = MED_ERA5)

```

plot raw data all together: 
```{r}
# Plot
ggplot() +
  geom_line(data = WCE_MODE_long, aes(x = time, y = PCWD, group = ensemble, color = factor("EMs_ModE")), linewidth=0.3,alpha = 0.3, show.legend = TRUE) +
  geom_line(data = WCE_MODE_mean, aes(x = time, y = PCWD, color = factor("Mean_ModE")), linewidth = 0.8) +
  geom_line(data = WCE_ERA5_df, aes(x = time, y = PCWD, color = factor("ERA5")), linewidth = 0.8) +
    # Manual color scale for legend
  scale_color_manual(
    values = c("EMs_ModE" = "#7EA3CC","Mean_ModE" = "#255C99", "ERA5" = "#B3001B" ),
    labels = c("EMs - ModESim","Mean - ModESim", "ERA5Land" )
  ) +
  labs(title = "Annmax PCWD Time Series for WCE",
       x = "Year",
       y = "PCWD [mm]",
       color = "Dataset") +
  theme_minimal()+
  theme(legend.position = "bottom")

### ------------------- MED ---------------------------------
# Plot
ggplot() +
  geom_line(data = MED_MODE_long, aes(x = time, y = PCWD, group = ensemble, color = factor("EMs_ModE")), linewidth=0.3,alpha = 0.3, show.legend = TRUE) +
  geom_line(data = MED_MODE_mean, aes(x = time, y = PCWD, color = factor("Mean_ModE")), linewidth = 0.8) +
  geom_line(data = MED_ERA5_df, aes(x = time, y = PCWD, color = factor("ERA5")), linewidth = 0.8) +
    # Manual color scale for legend
  scale_color_manual(
    values = c("EMs_ModE" = "#7EA3CC","Mean_ModE" = "#255C99", "ERA5" = "#B3001B" ),
    labels = c("EMs - ModESim","Mean - ModESim", "ERA5Land" )
  ) +
  labs(title = "Annmax PCWD Time Series for MED",
       x = "Year",
       y = "PCWD [mm]",
       color = "Dataset") +
  theme_minimal()+
  theme(legend.position = "bottom")
```


### Assessing the change in frequency of an ERA5 5-year drought events (Moderate drought)

```{r functions for RP calc}
# From https://geco-bern.github.io/cwd/articles/cwd_example.html: 
# calculate return period as a function of the CWD extreme. Using the two 
# coefficients of the fitted distribution as arguments
calc_return_period <- function(x, loc, scale){
  1 / (1 - exp(-exp(-(x-loc)/scale)))
}

extract_loc <- function(mod){
  loc <- mod$results$par[ "location" ]
  if (!is.null(loc)){
    return(loc)
  } else {
    return(NA)
  }
}

extract_scale <- function(mod){
  scale <- mod$results$par[ "scale" ]
  if (!is.null(scale)){
    return(scale)
  } else {
    return(NA)
  }
}
```


WCE ERA5 2 year event: PCWD of 416 mm
WCE ERA5 5 year event: 513 mm
```{r calculate return periods, eval=FALSE, echo=FALSE }
library(extRemes)
use_rp <- 5    # return period of two years
nyears <- 31   # bin width

# Calculate magnitude of event with RP = X in reference period
# Calculate the baseline 2-year return level using the last 30 years
baseline <- WCE_ERA5[46:75]
fit_ref <- extRemes::fevd(baseline, type = "Gumbel", method = "MLE", units = "years")
cwd_ref <- extRemes::return.level(fit_ref, return.period = use_rp)

# initialise for entire time calculation
rp_window <- rep(NA, nrow(WCE_MODE) - nyears + 1)

for (window_start in 1:(nrow(WCE_MODE) - nyears + 1)){

# Extract data for the current window
  window_data <- WCE_MODE[window_start:(window_start + nyears - 1), ]
  
  # Flatten the matrix into a single vector
  window_data <- as.vector(window_data)
  
  # Fit Gumbel distribution to the window data
  fit_window <- fevd(window_data, type = "Gumbel")

	# determine return period of cwd_ref based on new fit (How much more/less probably is an event that corresponded to an X-yearly event in the reference period?)
	rp_window[window_start] <- calc_return_period(cwd_ref, extract_loc(fit_window), extract_scale(fit_window))

}
# Create a data.frame combining time and effective return period
result_combined <- data.frame(
  time = seq(1435,1994),
  RP = rp_window
)


#####plot result of 1850: 
ggplot() +
  geom_line(data = result_combined, mapping= aes(x=time, y=RP, color=factor("ModESim")))+
  geom_hline(yintercept=5, linetype="dashed", color = "black")+
  ylim(min(result_combined$RP), max(result_combined$RP)) +
  xlim(min(result_combined$time), max(result_combined$time)) +
  labs(
    x = "Year", 
    y = "return period (years)",
    title = "WCE: Return period of ERA5Land 5 yr event"
  ) +
  theme_minimal()+
      scale_color_manual(name="Dataset",values = c("ModESim" = "#210124","1420 epoch" = "#750D37", "1850 epoch" = "#B3DEC1"))


##### ----------------------------------- MED ----------------------------------------------
# Calculate magnitude of event with RP = X in reference period
# Calculate the baseline 2-year return level using the last 30 years
baseline <- MED_ERA5[46:75]
fit_ref <- extRemes::fevd(baseline, type = "Gumbel", method = "MLE", units = "years")
cwd_ref <- extRemes::return.level(fit_ref, return.period = use_rp)

# initialise for entire time calculation
rp_window <- rep(NA, nrow(MED_MODE) - nyears + 1)

for (window_start in 1:(nrow(MED_MODE) - nyears + 1)){

# Extract data for the current window
  window_data <- MED_MODE[window_start:(window_start + nyears - 1), ]
  
  # Flatten the matrix into a single vector
  window_data <- as.vector(window_data)
  
  # Fit Gumbel distribution to the window data
  fit_window <- fevd(window_data, type = "Gumbel")

	# determine return period of cwd_ref based on new fit (How much more/less probably is an event that corresponded to an X-yearly event in the reference period?)
	rp_window[window_start] <- calc_return_period(cwd_ref, extract_loc(fit_window), extract_scale(fit_window))

}
# Create a data.frame combining time and effective return period
result_combined <- data.frame(
  time = seq(1435,1994),
  RP = rp_window
)


#####plot result of 1850: 
ggplot() +
  geom_line(data = result_combined, mapping= aes(x=time, y=RP, color=factor("ModESim")))+
  geom_hline(yintercept=5, linetype="dashed", color = "black")+
  ylim(min(result_combined$RP), max(result_combined$RP)) +
  xlim(min(result_combined$time), max(result_combined$time)) +
  labs(
    x = "Year", 
    y = "return period (years)",
    title = "MED: Return period of ERA5Land 5 yr event"
  ) +
  theme_minimal()+
      scale_color_manual(name="Dataset",values = c("ModESim" = "#210124","1420 epoch" = "#750D37", "1850 epoch" = "#B3DEC1"))
```


ModESim WCE annmax PCWD distribution as context for ERA5Land extremes
```{r}
baseline <- WCE_ERA5[1:60]
fit_ref <- extRemes::fevd(baseline, type = "Gumbel", method = "MLE", units = "years")
era_ref_2yr <- round(as.numeric(extRemes::return.level(fit_ref, return.period = 2)))
era_ref_5yr <- round(as.numeric(extRemes::return.level(fit_ref, return.period = 5)))
era_2018 <- round(max(WCE_ERA5))

baseline <- as.vector(WCE_MODE[531:590,])
fit_ref <- extRemes::fevd(baseline, type = "Gumbel", method = "MLE", units = "years")
ModESim_ref_2yr <- round(as.numeric(extRemes::return.level(fit_ref, return.period = 2)))

# 1) extract last 60 rows of the wide matrix, then pivot
WCE_last60_long <- WCE_MODE[(nrow(WCE_MODE)-60):nrow(WCE_MODE), ] %>%
  as.data.frame() %>%
  pivot_longer(cols = everything(),
               names_to  = "ensemble",
               values_to = "PCWD")

# 1) extract last 60 rows of the wide matrix, then pivot
WCE_ERA5_long <- WCE_ERA5[1:60] %>%
  as.data.frame() %>%
  pivot_longer(cols = everything(),
              names_to  = "year",
               values_to = "PCWD")

WCE_ERA5_last30 <- WCE_ERA5[46:75] %>%
  as.data.frame() %>%
  pivot_longer(cols = everything(),
              names_to  = "year",
               values_to = "PCWD")

ggplot(WCE_MODE_long, aes(x = PCWD)) +
  geom_histogram(color = "#210124", fill = "#210124", bins = 12, alpha = 0.7) +
  labs(title = "WCE: PCWD (mm) distribution from ModESim", x = "PCWD (mm)", y = "Frequency") +
    # overlay just the last‑60‑rows histogram
  geom_histogram(data   = WCE_last60_long, aes(x = PCWD), bins   = 12,
                 fill   = "#F2545B",   # pick a contrasting color
                 alpha  = 0.4) +
  geom_histogram(data   = WCE_ERA5_long, aes(x = PCWD), bins   = 12,
                 fill   = "lightblue",   # pick a contrasting color
                 ) +
  geom_histogram(data   = WCE_ERA5_last30, aes(x = PCWD), bins   = 12,
                 fill   = "lightgreen",   # pick a contrasting color
                 ) +
  geom_vline(aes(xintercept = ModESim_ref_2yr, color = factor("ModESim")), linetype = "dashed", linewidth=0.9) +
  geom_vline(aes(xintercept = era_ref_2yr, color = factor("2yr")), linetype = "dashed", linewidth=0.9) +
  geom_vline(aes(xintercept = era_ref_5yr, color = factor("5yr")), linetype = "dashed", linewidth=0.9) +
  geom_vline(aes(xintercept = era_2018, color = factor("2018")), linetype = "dashed", linewidth=0.9) +
  theme_minimal() +
  scale_color_manual(
    name = "Reference",
    values = c( "ModESim" = "#5BC0BE", "2yr" = "#F3A712", "5yr" = "#F2545B", "2018" = "#A93F55"),
    labels = c( "ModESim 2yr 1420-1450", "ERA5 - 2 yr event", "ERA5 - 5 year event", "ERA5 max event (2018)")
  )+
    theme(
    #legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold")
  ) 

ggplot() +
  # full‑data density
  geom_density(
    data    = WCE_MODE_long,
    aes(x   = PCWD,
    color   = factor("ModESim_fill_full"),
    fill    = factor("ModESim_fill_full")),
    alpha   = 0.5,
    linewidth    = 0.6,
    show.legend = TRUE
  ) +
  # last‑60 density
  geom_density(
    data    = WCE_last60_long,
    aes(x   = PCWD,
    color   = factor("ModESim_fill"),
    fill    = factor("ModESim_fill")),
    alpha   = 0.5,
    linewidth    = 0.6,
    show.legend = TRUE
  ) +
    # first‑60 density
  geom_density(
    data    = WCE_ERA5_long,
    aes(x   = PCWD,
    color   = factor("ERA5_fill"),
    fill    = factor("ERA5_fill")),
    alpha   = 0.5,
    linewidth    = 0.6,
    show.legend = TRUE
  ) +
  geom_density(
    data    = WCE_ERA5_last30,
    aes(x   = PCWD,
    color   = factor("ERA5_fill_last30"),
    fill    = factor("ERA5_fill_last30")),
    alpha   = 0.5,
    linewidth    = 0.6,
    show.legend = TRUE
  ) +
  geom_vline(aes(xintercept = ModESim_ref_2yr, color = factor("ModESim")), linetype = "dashed", linewidth=0.9) +
  geom_vline(aes(xintercept = era_ref_2yr, color = factor("2yr")), linetype = "dashed", linewidth=0.9) +
  geom_vline(aes(xintercept = era_ref_5yr, color = factor("5yr")), linetype = "dashed", linewidth=0.9) +
  geom_vline(aes(xintercept = era_2018, color = factor("2018")), linetype = "dashed", linewidth=0.9) +
    labs(
    x = "PCWD [mm]",
    y = "Density",
    title = "WCE Extreme Value Distribution"
  ) +
  theme_minimal() +
 scale_fill_manual(
    name = "Data Source",
    values = c("ModESim_fill_full" = "#FF5A5F","ModESim_fill" = "#58355E", "ERA5_fill" = "#087E8B", "ERA5_fill_last30" = "#FFF689"),
    labels = c("ModE-Sim 1420-2009", "ModE-Sim 1950-2009", "ERA5-Land 1950-2009", "ERA5-Land 1994-2024")
  )+
  scale_color_manual(
    name = "Extreme Event",
    values = c("ModESim" = "#5BC0BE", "2yr" = "#F3A712", "5yr" = "#F2545B", "2018" = "#A93F55"),
    labels = c("ModESim 2yr (1950 - 2009)", "ERA5Land - 2yr (1950 - 2009)", "ERA5Land - 5yr (1950 - 2009)", "ERA5Land max event (2018)")
    #guide = guide_legend(override.aes = list(fill= NA,shape = NA, color = "white"))
  )+

    theme(
    #legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),
    legend.key = element_rect(fill   = NA,    # transparent fill
                              colour = NA)    # no border
  )
```

same plot for MED: 
```{r}
baseline <- MED_ERA5[1:60]
fit_ref <- extRemes::fevd(baseline, type = "Gumbel", method = "MLE", units = "years")
era_ref_2yr <- round(as.numeric(extRemes::return.level(fit_ref, return.period = 2)))
era_ref_5yr <- round(as.numeric(extRemes::return.level(fit_ref, return.period = 5)))
era_2018 <- round(max(MED_ERA5))

baseline <- as.vector(MED_MODE[531:590,])
fit_ref <- extRemes::fevd(baseline, type = "Gumbel", method = "MLE", units = "years")
ModESim_ref_2yr <- round(as.numeric(extRemes::return.level(fit_ref, return.period = 2)))

# 1) extract last 60 rows of the wide matrix, then pivot
MED_last60_long <- MED_MODE[(nrow(MED_MODE)-60):nrow(MED_MODE), ] %>%
  as.data.frame() %>%
  pivot_longer(cols = everything(),
               names_to  = "ensemble",
               values_to = "PCWD")

# 1) extract last 60 rows of the wide matrix, then pivot
MED_ERA5_long <- MED_ERA5[1:60] %>%
  as.data.frame() %>%
  pivot_longer(cols = everything(),
              names_to  = "year",
               values_to = "PCWD")

MED_ERA5_last30 <- MED_ERA5[46:75] %>%
  as.data.frame() %>%
  pivot_longer(cols = everything(),
              names_to  = "year",
               values_to = "PCWD")

ggplot(MED_MODE_long, aes(x = PCWD)) +
  geom_histogram(color = "#210124", fill = "#210124", bins = 12, alpha = 0.7) +
  labs(title = "MED: PCWD (mm) distribution from ModESim", x = "PCWD (mm)", y = "Frequency") +
    # overlay just the last‑60‑rows histogram
  geom_histogram(data   = MED_last60_long, aes(x = PCWD), bins   = 12,
                 fill   = "#F2545B",   # pick a contrasting color
                 alpha  = 0.4) +
    geom_histogram(data   = MED_ERA5_long, aes(x = PCWD), bins   = 12,
                 fill   = "lightblue",   # pick a contrasting color
                 ) +
  geom_vline(aes(xintercept = ModESim_ref_2yr, color = factor("ModESim")), linetype = "dashed", linewidth=0.9) +
  geom_vline(aes(xintercept = era_ref_2yr, color = factor("2yr")), linetype = "dashed", linewidth=0.9) +
  geom_vline(aes(xintercept = era_ref_5yr, color = factor("5yr")), linetype = "dashed", linewidth=0.9) +
  geom_vline(aes(xintercept = era_2018, color = factor("2018")), linetype = "dashed", linewidth=0.9) +
  theme_minimal() +
  scale_color_manual(
    name = "Reference",
    values = c( "ModESim" = "#5BC0BE", "2yr" = "#F3A712", "5yr" = "#F2545B", "2018" = "#A93F55"),
    labels = c( "ModESim 2yr (1950 - 2009)", "ERA5Land - 2yr (1950 - 2009)", "ERA5Land - 5yr (1950 - 2009)", "ERA5 max event (2018)")
  )+
    theme(
    #legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold")
  ) 
  

ggplot() +
  # full‑data density
  geom_density(
    data    = MED_MODE_long,
    aes(x   = PCWD,
    color   = factor("ModESim_fill_full"),
    fill    = factor("ModESim_fill_full")),
    alpha   = 0.8,
    linewidth    = 0.6,
    show.legend = TRUE
  ) +
  # last‑60 density
  geom_density(
    data    = MED_last60_long,
    aes(x   = PCWD,
    color   = factor("ModESim_fill"),
    fill    = factor("ModESim_fill")),
    alpha   = 0.8,
    linewidth    = 0.6,
    show.legend = TRUE
  ) +
    # first‑60 density
  geom_density(
    data    = MED_ERA5_long,
    aes(x   = PCWD,
    color   = factor("ERA5_fill"),
    fill    = factor("ERA5_fill")),
    alpha   = 0.6,
    linewidth    = 0.6,
    show.legend = TRUE
  ) +
  geom_density(
    data    = MED_ERA5_last30,
    aes(x   = PCWD,
    color   = factor("ERA5_fill_last30"),
    fill    = factor("ERA5_fill_last30")),
    alpha   = 0.6,
    linewidth    = 0.6,
    show.legend = TRUE
  ) +
  geom_vline(aes(xintercept = ModESim_ref_2yr, color = factor("ModESim")), linetype = "dashed", linewidth=0.9) +
  geom_vline(aes(xintercept = era_ref_2yr, color = factor("2yr")), linetype = "dashed", linewidth=0.9) +
  geom_vline(aes(xintercept = era_ref_5yr, color = factor("5yr")), linetype = "dashed", linewidth=0.9) +
  geom_vline(aes(xintercept = era_2018, color = factor("2018")), linetype = "dashed", linewidth=0.9) +
    labs(
    x = "PCWD [mm]",
    y = "Density",
    title = "MED Extreme Value Distribution"
  ) +
  theme_minimal() +
 scale_fill_manual(
    name = "Data Source",
    values = c("ModESim_fill_full" = "#FF5A5F","ModESim_fill" = "#58355E", "ERA5_fill" = "#087E8B", "ERA5_fill_last30" = "#FFF689") ,
    labels = c("ModE-Sim 1420-2009", "ModE-Sim 1950-2009", "ERA5-Land 1950-2009", "ERA5-Land 1994-2024")
  )+
  scale_color_manual(
    name = "Extreme Event",
    values = c("ModESim" = "#5BC0BE", "2yr" = "#F3A712", "5yr" = "#F2545B", "2018" = "#A93F55"),
    labels = c("ModESim 2yr (1950 - 2009)", "ERA5Land 2yr (1950 - 2009)", "ERA5Land 5yr (1950 - 2009)", "ERA5 max event (2013)")
    #guide = guide_legend(override.aes = list(fill= NA,shape = NA, color = "white"))
  )+

    theme(
    legend.position = "right",
    plot.title = element_text(hjust = 0.5, face = "bold"),
    legend.key = element_rect(fill   = NA,    # transparent fill
                              colour = NA)    # no border
  )
```



#### rolling effective RP for all regions
calculate 5 yr event return periods
```{r}
library(extRemes)

#################### Calc for ModE-SIm ######################################
use_rp <- 5    # return period of interest
nyears <- 30   # window size
n_ens <- 20    # number of ensemble members

# Store output
EVA_regional_ensemble <- list()

for (region in names(corrected_full)) {
  result_array_region_BL <- corrected_full[[region]][551:580,]  # [time, ensemble]
  result_array_region <- corrected_full[[region]]                         # [590, 20]
  
  # ----- Fit pooled baseline -----
  baseline_pooled <- as.vector(result_array_region_BL)
  fit_ref <- extRemes::fevd(baseline_pooled, type = "Gumbel", method = "MLE", units = "years")
  cwd_ref <- extRemes::return.level(fit_ref, return.period = use_rp)

  region_df_list <- list()

  for (ens_member in 1:n_ens) {
    # Initialize return period time series
    rp_window <- rep(NA, nrow(result_array_region) - nyears + 1)

    for (window_start in 1:(nrow(result_array_region) - nyears + 1)) {
      # Extract current 30-year window for this ensemble member
      window_data <- result_array_region[window_start:(window_start + nyears - 1), ens_member]

      # Fit Gumbel distribution
      fit_window <- extRemes::fevd(window_data, type = "Gumbel")

      # Estimate return period of the baseline event in this new fit
      rp_window[window_start] <- calc_return_period(cwd_ref, extract_loc(fit_window), extract_scale(fit_window))
    }

    # Time vector (adjust if needed)
    time_info <- seq(from = as.numeric(1420), to = as.numeric(2009))
    ens_df <- data.frame(
      time = time_info[15:575],
      RP = rp_window,
      region = region,
      member = paste0("m", sprintf("%03d", ens_member), "_tidy")
    )

    region_df_list[[ens_member]] <- ens_df
  }

  # Combine all members for this region
  EVA_regional_ensemble[[region]] <- do.call(rbind, region_df_list)
}

# Combine all regions
combined_results_5yr_ens <- do.call(rbind, EVA_regional_ensemble)

# Save to file
write.csv(combined_results_5yr_ens, "~/cwd_global/data/5yr_return_periods_regions_ERA_members.csv", row.names = FALSE) #ModESim all ensemble members

################ now for ERA5 ###############################
######################### --------------------- 5 year events -------------------------------------------------------------
use_rp <- 5    # return period of two years
nyears <- 30   # bin width

# Initialize a list to store results for all regions
EVA_regional <- list()

# Loop through each region in regional_results
for (region in names(regional_results_ERA5Land)) { #swap european_regions for regional_results for all regions
  # Extract the result array for the current region
  result_array_region_BL <- corrected_full[[region]][551:580,]  # [time, ensemble]
  result_array_region <- regional_results_ERA5Land[[region]][20:75] #exclude 60s                         # [590, 20]
  
  # ----- Fit pooled baseline -----
  baseline_pooled <- as.vector(result_array_region_BL)
  fit_ref <- extRemes::fevd(baseline_pooled, type = "Gumbel", method = "MLE", units = "years")
  cwd_ref <- extRemes::return.level(fit_ref, return.period = use_rp)

  # initialise
  rp_window <- rep(NA, length(result_array_region) - nyears + 1)

  for (window_start in 1:(length(result_array_region) - nyears + 1)){

    # Extract data for the current window
    window_data <- result_array_region[window_start:(window_start + nyears - 1)]
  
    # Flatten the matrix into a single vector
    window_data <- as.vector(window_data)
  
    # Fit Gumbel distribution to the window data
    fit_window <- fevd(window_data, type = "Gumbel")

	  # determine return period of cwd_ref based on new fit (How much more/less probably is an event that corresponded to an X-yearly event in the reference period?)
	  rp_window[window_start] <- calc_return_period(cwd_ref, extract_loc(fit_window), extract_scale(fit_window))

  }
  # Create a dataframe for the current region
  time_info <- seq(from = as.numeric(1970), to = as.numeric(2024))  # Replace with actual time if available
  region_df <- data.frame(
    time = time_info[15:41],
    RP = rp_window,
    region = region
  )
  
  # Store the region's dataframe in the results list
  EVA_regional[[region]] <- region_df
}
  
# Combine all region results into a single dataframe
combined_results_5yr_ERA <- do.call(rbind, EVA_regional)

# Save or process the combined dataframe
# Example: Save to a CSV file
write.csv(combined_results_5yr_ERA, "~/cwd_global/data/5yr_return_periods_regions_ERA5Land.csv", row.names = FALSE)

```

### Frequency changes of 5-yr return period events for all IPCC regions (1420 - 2009 epoch):

```{r timeseries and map plots for each region, echo=FALSE, warning=FALSE, message=FALSE}
#plot all ensemble members and ensemble mean: 
combined_df <- read.csv("~/cwd_global/data/5yr_return_periods_regions_ERA_members.csv") #ModESim all ensemble members
combined_era <- read.csv("~/cwd_global/data/5yr_return_periods_regions_ERA5Land.csv")
#combined_df$window_size <- "30yr"

####################################### EUROPE #####################################
##### Step 2: Filter European regions for the map and timeseries
# Filter regions for Europe
selected_continent <- "Europe"
sel_regions <- continent_mapping[[selected_continent]]
sel_regions <- "WCE"

# Filter combined data for timeseries 
combined_df_sel <- combined_df %>% filter(region %in% sel_regions)
combined_era_sel <- combined_era %>% filter(region %in% sel_regions)
# Compute ensemble mean
ensemble_mean_df <- combined_df_sel %>%
  group_by(region, time) %>%
  summarise(RP_mean = mean(RP, na.rm = TRUE), .groups = "drop")

ensemble_band_df <- combined_df_sel %>%
  group_by(region, time) %>%
  summarise(
    RP_mean = mean(RP, na.rm = TRUE),
    RP_lower = quantile(RP, 0.05, na.rm = TRUE),
    RP_upper = quantile(RP, 0.95, na.rm = TRUE),
    .groups = "drop"
  )

ggplot() +
  # Uncertainty band with legend
  geom_ribbon(data = ensemble_band_df, aes(x = time, ymin = RP_lower, ymax = RP_upper, fill = "ModE-Sim Ensemble Range (5th-95th)"),alpha = 0.4) +
  # Ensemble mean line with legend
  geom_line(data = ensemble_band_df, aes(x = time, y = RP_mean, color = "ModE-Sim Mean (1420-2009)"), linewidth = 1) +
  # ERA5 line with legend
  geom_line(data = combined_era_sel, aes(x = time, y = RP, color = "ERA5 (1970-2024)"), linewidth = 1) +
  # Reference line (no legend)
  geom_hline(yintercept = 5, linetype = "dashed", color = "grey40") +
  # Labels and theme
  labs(
    x = "Year",
    y = "Effective Return Period",
    title = "Frequency Change of 5-Year Events",
    color = "Line",  # Legend titles
    fill = "Shading"
  ) +
  scale_color_manual(values = c("ModE-Sim Mean (1420-2009)" = "black", "ERA5 (1970-2024)" = "#B3001B")) +
  scale_fill_manual(values = c("ModE-Sim Ensemble Range (5th-95th)" = "grey70")) +
  theme_classic() +
  theme(
    legend.position = "none",
    plot.title = element_text(hjust = 0.5, face = "bold"),
    strip.text = element_text(size = 18),
    axis.text.x = element_text(angle = 45, hjust = 1, size = 18),
    axis.text.y = element_text(size = 18), 
    axis.title.x = element_text(size = 18),
    axis.title.y = element_text(size = 18),
    legend.title = element_text(size = 14),
    legend.text = element_text(size = 12),
    strip.background = element_rect(fill = "#F5B0CB")
  ) +
  facet_wrap(~region, scales = "free_y")


######################################ASIA#######################################
##### Step 2: Filter Asian regions for the map and timeseries
# Filter regions for Asian
selected_continent <- "Asia"
sel_regions <- continent_mapping[[selected_continent]]
sel_regions <- "ARP"

# Filter combined data for timeseries 
combined_df_sel <- combined_df %>% filter(region %in% sel_regions)
combined_era_sel <- combined_era %>% filter(region %in% sel_regions)
# Compute ensemble mean
ensemble_mean_df <- combined_df_sel %>%
  group_by(region, time) %>%
  summarise(RP_mean = mean(RP, na.rm = TRUE), .groups = "drop")

ensemble_band_df <- combined_df_sel %>%
  group_by(region, time) %>%
  summarise(
    RP_mean = mean(RP, na.rm = TRUE),
    RP_lower = quantile(RP, 0.05, na.rm = TRUE),
    RP_upper = quantile(RP, 0.95, na.rm = TRUE),
    .groups = "drop"
  )

ggplot() +
  # Uncertainty band with legend
  geom_ribbon(data = ensemble_band_df, aes(x = time, ymin = RP_lower, ymax = RP_upper, fill = "ModE-Sim Ensemble Range (5th-95th)"),alpha = 0.4) +
  # Ensemble mean line with legend
  geom_line(data = ensemble_band_df, aes(x = time, y = RP_mean, color = "ModE-Sim Mean (1420-2009)"), linewidth = 1) +
  # ERA5 line with legend
  geom_line(data = combined_era_sel, aes(x = time, y = RP, color = "ERA5 (1970-2024)"), linewidth = 1) +
  # Reference line (no legend)
  geom_hline(yintercept = 5, linetype = "dashed", color = "grey40") +
  # Labels and theme
  labs(
    x = "Year",
    y = "Effective Return Period",
    title = "Frequency Change of 5-Year Events",
    color = "Line",  # Legend titles
    fill = "Shading"
  ) +
  scale_color_manual(values = c("ModE-Sim Mean (1420-2009)" = "black", "ERA5 (1970-2024)" = "#B3001B")) +
  scale_fill_manual(values = c("ModE-Sim Ensemble Range (5th-95th)" = "grey70")) +
  theme_classic() +
  theme(
    legend.position = "none",
    plot.title = element_text(hjust = 0.5, face = "bold"),
    strip.text = element_text(size = 18),
    axis.text.x = element_text(angle = 45, hjust = 1, size = 18),
    axis.text.y = element_text(size = 18), 
    axis.title.x = element_text(size = 18),
    axis.title.y = element_text(size = 18),
    legend.title = element_text(size = 14),
    legend.text = element_text(size = 12),
    strip.background = element_rect(fill = "#E5973B"),
  ) +
  facet_wrap(~region, scales = "free_y")


###################################### OCEANIA #######################################
##### Step 2: Filter Oceanian regions for the map and timeseries
# Filter regions for Oceania
selected_continent <- "Australia"
sel_regions <- continent_mapping[[selected_continent]]
sel_regions <- "CAU"

# Filter combined data for timeseries 
combined_df_sel <- combined_df %>% filter(region %in% sel_regions)
combined_era_sel <- combined_era %>% filter(region %in% sel_regions)
# Compute ensemble mean
ensemble_mean_df <- combined_df_sel %>%
  group_by(region, time) %>%
  summarise(RP_mean = mean(RP, na.rm = TRUE), .groups = "drop")

ensemble_band_df <- combined_df_sel %>%
  group_by(region, time) %>%
  summarise(
    RP_mean = mean(RP, na.rm = TRUE),
    RP_lower = quantile(RP, 0.05, na.rm = TRUE),
    RP_upper = quantile(RP, 0.95, na.rm = TRUE),
    .groups = "drop"
  )

ggplot() +
  # Uncertainty band with legend
  geom_ribbon(data = ensemble_band_df, aes(x = time, ymin = RP_lower, ymax = RP_upper, fill = "ModE-Sim Ensemble Range (5th-95th)"),alpha = 0.4) +
  # Ensemble mean line with legend
  geom_line(data = ensemble_band_df, aes(x = time, y = RP_mean, color = "ModE-Sim Mean (1420-2009)"), linewidth = 1) +
  # ERA5 line with legend
  geom_line(data = combined_era_sel, aes(x = time, y = RP, color = "ERA5 (1970-2024)"), linewidth = 1) +
  # Reference line (no legend)
  geom_hline(yintercept = 5, linetype = "dashed", color = "grey40") +
  # Labels and theme
  labs(
    x = "Year",
    y = "Effective Return Period",
    title = "Frequency Change of 5-Year Events",
    color = "Line",  # Legend titles
    fill = "Shading"
  ) +
  scale_color_manual(values = c("ModE-Sim Mean (1420-2009)" = "black", "ERA5 (1970-2024)" = "#B3001B")) +
  scale_fill_manual(values = c("ModE-Sim Ensemble Range (5th-95th)" = "grey70")) +
  theme_classic() +
  theme(
    legend.position = "none",
    plot.title = element_text(hjust = 0.5, face = "bold"),
    strip.text = element_text(size = 14, color = "white"),
    axis.text.x = element_text(angle = 45, hjust = 1, size = 18),
    axis.text.y = element_text(size = 18), 
    axis.title.x = element_text(size = 18),
    axis.title.y = element_text(size = 18),
    legend.title = element_text(size = 14),
    legend.text = element_text(size = 12),
    strip.background = element_rect(fill = "#3C3980")
  ) +
  facet_wrap(~region, scales = "free_y")

###################################### AFRICA #######################################
##### Step 2: Filter African regions for the map and timeseries
# Filter regions for Africa
selected_continent <- "Africa"
sel_regions <- continent_mapping[[selected_continent]]
sel_regions <- "NEAF"

# Filter combined data for timeseries 
combined_df_sel <- combined_df %>% filter(region %in% sel_regions)
combined_era_sel <- combined_era %>% filter(region %in% sel_regions)
# Compute ensemble mean
ensemble_mean_df <- combined_df_sel %>%
  group_by(region, time) %>%
  summarise(RP_mean = mean(RP, na.rm = TRUE), .groups = "drop")

ensemble_band_df <- combined_df_sel %>%
  group_by(region, time) %>%
  summarise(
    RP_mean = mean(RP, na.rm = TRUE),
    RP_lower = quantile(RP, 0.05, na.rm = TRUE),
    RP_upper = quantile(RP, 0.95, na.rm = TRUE),
    .groups = "drop"
  )

ggplot() +
  # Uncertainty band with legend
  geom_ribbon(data = ensemble_band_df, aes(x = time, ymin = RP_lower, ymax = RP_upper, fill = "ModE-Sim Ensemble Range (5th-95th)"),alpha = 0.4) +
  # Ensemble mean line with legend
  geom_line(data = ensemble_band_df, aes(x = time, y = RP_mean, color = "ModE-Sim Mean (1420-2009)"), linewidth = 1) +
  # ERA5 line with legend
  geom_line(data = combined_era_sel, aes(x = time, y = RP, color = "ERA5 (1970-2024)"), linewidth = 1) +
  # Reference line (no legend)
  geom_hline(yintercept = 5, linetype = "dashed", color = "grey40") +
  # Labels and theme
  labs(
    x = "Year",
    y = "Effective Return Period",
    title = "Frequency Change of 5-Year Events",
    color = "Line",  # Legend titles
    fill = "Shading"
  ) +
  scale_color_manual(values = c("ModE-Sim Mean (1420-2009)" = "black", "ERA5 (1970-2024)" = "#B3001B")) +
  scale_fill_manual(values = c("ModE-Sim Ensemble Range (5th-95th)" = "grey70")) +
  theme_classic() +
  theme(
    legend.position = "none",
    plot.title = element_text(hjust = 0.5, face = "bold"),
    strip.text = element_text(size = 18),
    axis.text.x = element_text(angle = 45, hjust = 1, size = 18),
    axis.text.y = element_text(size = 18), 
    axis.title.x = element_text(size = 18),
    axis.title.y = element_text(size = 18),
    legend.title = element_text(size = 14),
    legend.text = element_text(size = 12),
    strip.background = element_rect(fill = "#91C7B1"),
  ) +
  facet_wrap(~region, scales = "free_y")


###################################### N AMERICA #######################################
##### Step 2: Filter N AMERICA regions for the map and timeseries
# Filter regions for N America
selected_continent <- "North America"
sel_regions <- continent_mapping[[selected_continent]]
sel_regions <- "ENA"

# Filter combined data for timeseries 
combined_df_sel <- combined_df %>% filter(region %in% sel_regions)
combined_era_sel <- combined_era %>% filter(region %in% sel_regions)
# Compute ensemble mean
ensemble_mean_df <- combined_df_sel %>%
  group_by(region, time) %>%
  summarise(RP_mean = mean(RP, na.rm = TRUE), .groups = "drop")

ensemble_band_df <- combined_df_sel %>%
  group_by(region, time) %>%
  summarise(
    RP_mean = mean(RP, na.rm = TRUE),
    RP_lower = quantile(RP, 0.05, na.rm = TRUE),
    RP_upper = quantile(RP, 0.95, na.rm = TRUE),
    .groups = "drop"
  )

ggplot() +
  # Uncertainty band with legend
  geom_ribbon(data = ensemble_band_df, aes(x = time, ymin = RP_lower, ymax = RP_upper, fill = "ModE-Sim Ensemble Range (5th-95th)"),alpha = 0.4) +
  # Ensemble mean line with legend
  geom_line(data = ensemble_band_df, aes(x = time, y = RP_mean, color = "ModE-Sim Mean (1420-2009)"), linewidth = 1) +
  # ERA5 line with legend
  geom_line(data = combined_era_sel, aes(x = time, y = RP, color = "ERA5 (1970-2024)"), linewidth = 1) +
  # Reference line (no legend)
  geom_hline(yintercept = 5, linetype = "dashed", color = "grey40") +
  # Labels and theme
  labs(
    x = "Year",
    y = "Effective Return Period",
    title = "Frequency Change of 5-Year Events",
    color = "Line",  # Legend titles
    fill = "Shading"
  ) +
  scale_color_manual(values = c("ModE-Sim Mean (1420-2009)" = "black", "ERA5 (1970-2024)" = "#B3001B")) +
  scale_fill_manual(values = c("ModE-Sim Ensemble Range (5th-95th)" = "grey70")) +
  theme_classic() +
  theme(
    legend.position = "none",
    plot.title = element_text(hjust = 0.5, face = "bold"),
    strip.text = element_text(size = 14, color= "white"),
    axis.text.x = element_text(angle = 45, hjust = 1, size = 18),
    axis.text.y = element_text(size = 18), 
    axis.title.x = element_text(size = 18),
    axis.title.y = element_text(size = 18),
    legend.title = element_text(size = 14),
    legend.text = element_text(size = 12),
    strip.background = element_rect(fill = "#236A3F"),
  ) +
  facet_wrap(~region, scales = "free_y")

###################################### C AMERICA #######################################
##### Step 2: Filter C AMERICA regions for the map and timeseries
# Filter regions for C America
selected_continent <- "Central America"
sel_regions <- continent_mapping[[selected_continent]]
sel_regions <- "NCA"

# Filter combined data for timeseries 
combined_df_sel <- combined_df %>% filter(region %in% sel_regions)
combined_era_sel <- combined_era %>% filter(region %in% sel_regions)
# Compute ensemble mean
ensemble_mean_df <- combined_df_sel %>%
  group_by(region, time) %>%
  summarise(RP_mean = mean(RP, na.rm = TRUE), .groups = "drop")

ensemble_band_df <- combined_df_sel %>%
  group_by(region, time) %>%
  summarise(
    RP_mean = mean(RP, na.rm = TRUE),
    RP_lower = quantile(RP, 0.05, na.rm = TRUE),
    RP_upper = quantile(RP, 0.95, na.rm = TRUE),
    .groups = "drop"
  )

ggplot() +
  # Uncertainty band with legend
  geom_ribbon(data = ensemble_band_df, aes(x = time, ymin = RP_lower, ymax = RP_upper, fill = "ModE-Sim Ensemble Range (5th-95th)"),alpha = 0.4) +
  # Ensemble mean line with legend
  geom_line(data = ensemble_band_df, aes(x = time, y = RP_mean, color = "ModE-Sim Mean (1420-2009)"), linewidth = 1) +
  # ERA5 line with legend
  geom_line(data = combined_era_sel, aes(x = time, y = RP, color = "ERA5 (1970-2024)"), linewidth = 1) +
  # Reference line (no legend)
  geom_hline(yintercept = 5, linetype = "dashed", color = "grey40") +
  # Labels and theme
  labs(
    x = "Year",
    y = "Effective Return Period",
    title = "Frequency Change of 5-Year Events",
    color = "Line",  # Legend titles
    fill = "Shading"
  ) +
  scale_color_manual(values = c("ModE-Sim Mean (1420-2009)" = "black", "ERA5 (1970-2024)" = "#B3001B")) +
  scale_fill_manual(values = c("ModE-Sim Ensemble Range (5th-95th)" = "grey70")) +
  theme_classic() +
  theme(
    legend.position = "none",
    plot.title = element_text(hjust = 0.5, face = "bold"),
    strip.text = element_text(size = 18),
    axis.text.x = element_text(angle = 45, hjust = 1, size = 18),
    axis.text.y = element_text(size = 18), 
    axis.title.x = element_text(size = 18),
    axis.title.y = element_text(size = 18),
    legend.title = element_text(size = 14),
    legend.text = element_text(size = 12),
    strip.background = element_rect(fill = "#B33951")
  ) +
  facet_wrap(~region, scales = "free_y")





###################################### S AMERICA #######################################
##### Step 2: Filter S AMERICA regions for the map and timeseries
# Filter regions for S America
selected_continent <- "South America"
sel_regions <- continent_mapping[[selected_continent]]
sel_regions <- "NWS"

# Filter combined data for timeseries 
combined_df_sel <- combined_df %>% filter(region %in% sel_regions)
combined_era_sel <- combined_era %>% filter(region %in% sel_regions)
# Compute ensemble mean
ensemble_mean_df <- combined_df_sel %>%
  group_by(region, time) %>%
  summarise(RP_mean = mean(RP, na.rm = TRUE), .groups = "drop")

ensemble_band_df <- combined_df_sel %>%
  group_by(region, time) %>%
  summarise(
    RP_mean = mean(RP, na.rm = TRUE),
    RP_lower = quantile(RP, 0.05, na.rm = TRUE),
    RP_upper = quantile(RP, 0.95, na.rm = TRUE),
    .groups = "drop"
  )

ggplot() +
  # Uncertainty band with legend
  geom_ribbon(data = ensemble_band_df, aes(x = time, ymin = RP_lower, ymax = RP_upper, fill = "ModE-Sim Ensemble Range (5th-95th)"),alpha = 0.4) +
  # Ensemble mean line with legend
  geom_line(data = ensemble_band_df, aes(x = time, y = RP_mean, color = "ModE-Sim Mean (1420-2009)"), linewidth = 1) +
  # ERA5 line with legend
  geom_line(data = combined_era_sel, aes(x = time, y = RP, color = "ERA5 (1970-2024)"), linewidth = 1) +
  # Reference line (no legend)
  geom_hline(yintercept = 5, linetype = "dashed", color = "grey40") +
  # Labels and theme
  labs(
    x = "Year",
    y = "Effective Return Period (log10)",
    title = "Frequency Change of 5-Year Events",
    color = "Line",  # Legend titles
    fill = "Shading"
  ) +
  scale_color_manual(values = c("ModE-Sim Mean (1420-2009)" = "black", "ERA5 (1970-2024)" = "#B3001B")) +
  scale_fill_manual(values = c("ModE-Sim Ensemble Range (5th-95th)" = "grey70")) +
  theme_classic() +
  theme(
    legend.position = "none",
    plot.title = element_text(hjust = 0.5, face = "bold"),
    strip.text = element_text(size = 18),
    axis.text.x = element_text(angle = 45, hjust = 1, size = 18),
    axis.text.y = element_text(size = 18), 
    axis.title.x = element_text(size = 18),
    axis.title.y = element_text(size = 18),
    legend.title = element_text(size = 14),
    legend.text = element_text(size = 12),
    strip.background = element_rect(fill = "#E3D081")
  ) +
  facet_wrap(~region, scales = "free_y")


```

time warped plots: 

```{r}
# Warp function: compress early years, stretch recent years
warp_time <- function(year) {
  ifelse(year < 1950, year * 0.5, 975 + (year - 1950) * 2)
}


#plot all ensemble members and ensemble mean: 
combined_df <- read.csv("~/cwd_global/data/5yr_return_periods_regions_ERA_members.csv")
combined_era <- read.csv("~/cwd_global/data/5yr_return_periods_regions_ERA5Land.csv")
#combined_df$window_size <- "30yr"

####################################### EUROPE #####################################
##### Step 2: Filter European regions for the map and timeseries
# Filter regions for Europe
selected_continent <- "Europe"
sel_regions <- continent_mapping[[selected_continent]]
sel_regions <- "WCE"

# Filter combined data for timeseries 
combined_df_sel <- combined_df %>% filter(region %in% sel_regions)
combined_era_sel <- combined_era %>% filter(region %in% sel_regions)
# Compute ensemble mean
ensemble_mean_df <- combined_df_sel %>%
  group_by(region, time) %>%
  summarise(RP_mean = mean(RP, na.rm = TRUE), .groups = "drop")

ensemble_band_df <- combined_df_sel %>%
  group_by(region, time) %>%
  summarise(
    RP_mean = mean(RP, na.rm = TRUE),
    RP_lower = quantile(RP, 0.05, na.rm = TRUE),
    RP_upper = quantile(RP, 0.95, na.rm = TRUE),
    .groups = "drop"
  )

# Apply to both datasets
ensemble_band_df$time_warped <- warp_time(ensemble_band_df$time)
combined_era_sel$time_warped <- warp_time(combined_era_sel$time)

# 3. Define range for highlight box
highlight_xmin <- warp_time(1950)
highlight_xmax <- warp_time(2010)


ggplot() +
  # Highlight box for stretched area
geom_rect(aes(xmin = highlight_xmin, xmax = highlight_xmax, ymin = 0.8, ymax = 110),
          fill = "white", color = "black", linetype = "solid", alpha = 0.6)+
  geom_ribbon(data = ensemble_band_df, aes(x = time_warped, ymin = RP_lower, ymax = RP_upper,
                                           fill = "ModE-Sim Ensemble Range (5th-95th)"), alpha = 0.4) +
  geom_line(data = ensemble_band_df, aes(x = time_warped, y = RP_mean,
                                         color = "ModE-Sim Mean (1420-2009)"), linewidth = 1) +
  geom_line(data = combined_era_sel, aes(x = time_warped, y = RP,
                                         color = "ERA5 (1970-2024)"), linewidth = 1) +
  geom_hline(yintercept = 5, linetype = "dashed", color = "grey40") +
  
  # Custom x-axis ticks: use original years as labels
  scale_x_continuous(
    breaks = warp_time(c( 1500, 1600, 1700, 1800, 1900, 1950, 1970, 1990, 2010)),
    labels = c( "1500", "1600", "1700", "1800", "1900", "1950", "1970", "1990", "2010"),
    name = "Year"
  ) +
  scale_y_log10(name = expression("Effective Return Period (" * log[10] * ")"),
        breaks = c(1, 2, 5, 10, 20, 50, 100),
  labels = c("1", "2", "5", "10", "20", "50", "100")) +  # Log scale for y-axis
  scale_color_manual(values = c("ModE-Sim Mean (1420-2009)" = "black", "ERA5 (1970-2024)" = "#B3001B")) +
  scale_fill_manual(values = c("ModE-Sim Ensemble Range (5th-95th)" = "grey70")) +
  
  labs(title = "", color = "Line", fill = "Shading") +
  theme_classic() +
  theme(
    legend.position = "none",
    plot.title = element_text(hjust = 0.5, face = "bold"),
    strip.text = element_text(size = 18),
    axis.text.x = element_text(angle = 45, hjust = 1, size = 18),
    axis.text.y = element_text(size = 18), 
    axis.title.x = element_text(size = 18),
    axis.title.y = element_text(size = 18),
    legend.title = element_text(size = 14),
    legend.text = element_text(size = 12),
    strip.background = element_rect(fill = "#F5B0CB")
  ) +
  facet_wrap(~region, scales = "free_y")+
  annotation_logticks()

########################################
selected_continent <- "Asia"
sel_regions <- continent_mapping[[selected_continent]]
sel_regions <- "ARP"

# Filter combined data for timeseries 
combined_df_sel <- combined_df %>% filter(region %in% sel_regions)
combined_era_sel <- combined_era %>% filter(region %in% sel_regions)
# Compute ensemble mean
ensemble_mean_df <- combined_df_sel %>%
  group_by(region, time) %>%
  summarise(RP_mean = mean(RP, na.rm = TRUE), .groups = "drop")

ensemble_band_df <- combined_df_sel %>%
  group_by(region, time) %>%
  summarise(
    RP_mean = mean(RP, na.rm = TRUE),
    RP_lower = quantile(RP, 0.05, na.rm = TRUE),
    RP_upper = quantile(RP, 0.95, na.rm = TRUE),
    .groups = "drop"
  )

# Apply to both datasets
ensemble_band_df$time_warped <- warp_time(ensemble_band_df$time)
combined_era_sel$time_warped <- warp_time(combined_era_sel$time)

# 3. Define range for highlight box
highlight_xmin <- warp_time(1950)
highlight_xmax <- warp_time(2010)

ggplot() +
  # Highlight box for stretched area
  geom_rect(aes(xmin = highlight_xmin, xmax = highlight_xmax, ymin = 1, ymax = 40),
          fill = "white", color = "black", linetype = "solid", alpha = 0.6)+
  # Uncertainty band with legend
  geom_ribbon(data = ensemble_band_df, aes(x = time_warped, ymin = RP_lower, ymax = RP_upper, fill = "ModE-Sim Ensemble Range (5th-95th)"),alpha = 0.4) +
  # Ensemble mean line with legend
  geom_line(data = ensemble_band_df, aes(x = time_warped, y = RP_mean, color = "ModE-Sim Mean (1420-2009)"), linewidth = 1) +
  # ERA5 line with legend
  geom_line(data = combined_era_sel, aes(x = time_warped, y = RP, color = "ERA5 (1970-2024)"), linewidth = 1) +
  # Reference line (no legend)
  geom_hline(yintercept = 5, linetype = "dashed", color = "grey40") +
    # Custom x-axis ticks: use original years as labels
  scale_x_continuous(
    breaks = warp_time(c( 1500, 1600, 1700, 1800, 1900, 1950, 1970, 1990, 2010)),
    labels = c("1500", "1600", "1700", "1800", "1900", "1950", "1970", "1990", "2010"),
    name = "Year"
  ) +
  scale_y_log10(name = expression("Effective Return Period (" * log[10] * ")"),
        breaks = c(2, 5, 10, 20, 30),
  labels = c( "2", "5", "10", "20", "30")) +  # Log scale for y-axis
  # Labels and theme
  labs(
    title = "",
    color = "Line",  # Legend titles
    fill = "Shading"
  ) +
  scale_color_manual(values = c("ModE-Sim Mean (1420-2009)" = "black", "ERA5 (1970-2024)" = "#B3001B")) +
  scale_fill_manual(values = c("ModE-Sim Ensemble Range (5th-95th)" = "grey70")) +
  theme_classic() +
  theme(
    legend.position = "none",
    plot.title = element_text(hjust = 0.5, face = "bold"),
    strip.text = element_text(size = 18),
    axis.text.x = element_text(angle = 45, hjust = 1, size = 18),
    axis.text.y = element_text(size = 18), 
    axis.title.x = element_text(size = 18),
    axis.title.y = element_text(size = 18),
    legend.title = element_text(size = 14),
    legend.text = element_text(size = 12),
    strip.background = element_rect(fill = "#E5973B"),
  ) +
  facet_wrap(~region, scales = "free_y")+
  annotation_logticks()


###################################### OCEANIA #######################################
##### Step 2: Filter Oceanian regions for the map and timeseries
# Filter regions for Oceania
selected_continent <- "Australia"
sel_regions <- continent_mapping[[selected_continent]]
sel_regions <- "CAU"

# Filter combined data for timeseries 
combined_df_sel <- combined_df %>% filter(region %in% sel_regions)
combined_era_sel <- combined_era %>% filter(region %in% sel_regions)
# Compute ensemble mean
ensemble_mean_df <- combined_df_sel %>%
  group_by(region, time) %>%
  summarise(RP_mean = mean(RP, na.rm = TRUE), .groups = "drop")

ensemble_band_df <- combined_df_sel %>%
  group_by(region, time) %>%
  summarise(
    RP_mean = mean(RP, na.rm = TRUE),
    RP_lower = quantile(RP, 0.05, na.rm = TRUE),
    RP_upper = quantile(RP, 0.95, na.rm = TRUE),
    .groups = "drop"
  )

# Apply to both datasets
ensemble_band_df$time_warped <- warp_time(ensemble_band_df$time)
combined_era_sel$time_warped <- warp_time(combined_era_sel$time)

# 3. Define range for highlight box
highlight_xmin <- warp_time(1950)
highlight_xmax <- warp_time(2010)

ggplot() +
  # Highlight box for stretched area
  geom_rect(aes(xmin = highlight_xmin, xmax = highlight_xmax, ymin = 1.8, ymax = 110),
          fill = "white", color = "black", linetype = "solid", alpha = 0.6)+
  # Uncertainty band with legend
  geom_ribbon(data = ensemble_band_df, aes(x = time_warped, ymin = RP_lower, ymax = RP_upper, fill = "ModE-Sim Ensemble Range (5th-95th)"),alpha = 0.4) +
  # Ensemble mean line with legend
  geom_line(data = ensemble_band_df, aes(x = time_warped, y = RP_mean, color = "ModE-Sim Mean (1420-2009)"), linewidth = 1) +
  # ERA5 line with legend
  geom_line(data = combined_era_sel, aes(x = time_warped, y = RP, color = "ERA5 (1970-2024)"), linewidth = 1) +
  # Reference line (no legend)
  geom_hline(yintercept = 5, linetype = "dashed", color = "grey40") +
  scale_x_continuous(
    breaks = warp_time(c(1500, 1600, 1700, 1800, 1900, 1950, 1970, 1990, 2010)),
    labels = c("1500", "1600", "1700", "1800", "1900", "1950", "1970", "1990", "2010"),
    name = "Year"
  ) +
  scale_y_log10(name = expression("Effective Return Period (" * log[10] * ")"),
        breaks = c(2, 5, 10, 20, 50, 100),
  labels = c("2", "5", "10", "20", "50", "100")) +  # Log scale for y-axis
  # Labels and theme
  labs(
    title = "",
    color = "Line",  # Legend titles
    fill = "Shading"
  ) +
  scale_color_manual(values = c("ModE-Sim Mean (1420-2009)" = "black", "ERA5 (1970-2024)" = "#B3001B")) +
  scale_fill_manual(values = c("ModE-Sim Ensemble Range (5th-95th)" = "grey70")) +
  theme_classic() +
  theme(
    legend.position = "none",
    plot.title = element_text(hjust = 0.5, face = "bold"),
    strip.text = element_text(size = 14, color = "white"),
    axis.text.x = element_text(angle = 45, hjust = 1, size = 18),
    axis.text.y = element_text(size = 18), 
    axis.title.x = element_text(size = 18),
    axis.title.y = element_text(size = 18),
    legend.title = element_text(size = 14),
    legend.text = element_text(size = 12),
    strip.background = element_rect(fill = "#3C3980")
  ) +
  facet_wrap(~region, scales = "free_y")+
    annotation_logticks()


###################################### N AMERICA #######################################
##### Step 2: Filter N AMERICA regions for the map and timeseries
# Filter regions for N America
selected_continent <- "North America"
sel_regions <- continent_mapping[[selected_continent]]
sel_regions <- "ENA"

# Filter combined data for timeseries 
combined_df_sel <- combined_df %>% filter(region %in% sel_regions)
combined_era_sel <- combined_era %>% filter(region %in% sel_regions)
# Compute ensemble mean
ensemble_mean_df <- combined_df_sel %>%
  group_by(region, time) %>%
  summarise(RP_mean = mean(RP, na.rm = TRUE), .groups = "drop")

ensemble_band_df <- combined_df_sel %>%
  group_by(region, time) %>%
  summarise(
    RP_mean = mean(RP, na.rm = TRUE),
    RP_lower = quantile(RP, 0.05, na.rm = TRUE),
    RP_upper = quantile(RP, 0.95, na.rm = TRUE),
    .groups = "drop"
  )
# Apply to both datasets
ensemble_band_df$time_warped <- warp_time(ensemble_band_df$time)
combined_era_sel$time_warped <- warp_time(combined_era_sel$time)

# 3. Define range for highlight box
highlight_xmin <- warp_time(1950)
highlight_xmax <- warp_time(2010)

ggplot() +
  # Highlight box for stretched area
  geom_rect(aes(xmin = highlight_xmin, xmax = highlight_xmax, ymin = 2, ymax = 30),
          fill = "white", color = "black", linetype = "solid", alpha = 0.6)+
  # Uncertainty band with legend
  geom_ribbon(data = ensemble_band_df, aes(x = time_warped, ymin = RP_lower, ymax = RP_upper, fill = "ModE-Sim Ensemble Range (5th-95th)"),alpha = 0.4) +
  # Ensemble mean line with legend
  geom_line(data = ensemble_band_df, aes(x = time_warped, y = RP_mean, color = "ModE-Sim Mean (1420-2009)"), linewidth = 1) +
  # ERA5 line with legend
  geom_line(data = combined_era_sel, aes(x = time_warped, y = RP, color = "ERA5 (1970-2024)"), linewidth = 1) +
  # Reference line (no legend)
  geom_hline(yintercept = 5, linetype = "dashed", color = "grey40") +
  scale_x_continuous(
    breaks = warp_time(c(1500, 1600, 1700, 1800, 1900, 1950, 1970, 1990, 2010)),
    labels = c("1500", "1600", "1700", "1800", "1900", "1950", "1970", "1990", "2010"),
    name = "Year"
  ) +
  scale_y_log10(name = expression("Effective Return Period (" * log[10] * ")"),
        breaks = c(2, 5, 10, 20, 30),
  labels = c("2", "5", "10", "20", "30")) +  # Log scale for y-axis
  # Labels and theme
  labs(
    title = "",
    color = "Line",  # Legend titles
    fill = "Shading"
  ) +
  scale_color_manual(values = c("ModE-Sim Mean (1420-2009)" = "black", "ERA5 (1970-2024)" = "#B3001B")) +
  scale_fill_manual(values = c("ModE-Sim Ensemble Range (5th-95th)" = "grey70")) +
  theme_classic() +
  theme(
    legend.position = "none",
    plot.title = element_text(hjust = 0.5, face = "bold"),
    strip.text = element_text(size = 14, color= "white"),
    axis.text.x = element_text(angle = 45, hjust = 1, size = 18),
    axis.text.y = element_text(size = 18), 
    axis.title.x = element_text(size = 18),
    axis.title.y = element_text(size = 18),
    legend.title = element_text(size = 14),
    legend.text = element_text(size = 12),
    strip.background = element_rect(fill = "#236A3F"),
  ) +
  facet_wrap(~region, scales = "free_y")+
    annotation_logticks()

```


#### Scatterplots for modern times:
first 3: 
1st plot: reference/overlap period *5 yr* events in mm for ERA5 and ModE-Sim: 1970-2009 (exclude problematic 60s of ERA5) 
2nd: y-axis: ERA5_Land 1995-2024 5yr vs x-axis: ERA5 Land 1970-1999
3rd: y-axis: ERA5-Land 1995-2024 5 yr vs x-axis: ModE-SIm BC 1970-1999

```{r}
##calculate return level of 5 year events - 30 year chunks for consistency: 
#remove SAH due to unphysically large PCWD values - runaway PCWD 
regional_results_ERA5Land_eva <- regional_results_ERA5Land[ names(regional_results_ERA5Land) != "SAH" ]

use_rp <- 5   # return period of two years

# Modern ERA5-Land (1994-2024) for each region: 
# Initialize a list to store results for all regions
RL_ERA_modern <- list() #save modern 5yr events (in mm) for each region

# Loop through each region in regional_results
for (region in names(regional_results_ERA5Land_eva)) { #swap european_regions for regional_results for all regions
  # Extract the result array for the current region
  result_array_region <- regional_results_ERA5Land_eva[[region]][46:75] #1995-2024
  fit_ref <- extRemes::fevd(result_array_region, type = "Gumbel", method = "MLE", units = "years")
  return_level <- round(as.numeric(extRemes::return.level(fit_ref, return.period = use_rp)))

  RL_ERA_modern[[region]] <- return_level
  
}

# Modern ERA5-Land (1994-2024) for each region: 
# Initialize a list to store results for all regions
RL_ERA_overlap <- list() #save modern 5yr events (in mm) for each region

# Loop through each region in regional_results
for (region in names(regional_results_ERA5Land_eva)) { #swap european_regions for regional_results for all regions
  # Extract the result array for the current region
  result_array_region <- regional_results_ERA5Land_eva[[region]][21:50] #1970-1999
  fit_ref <- extRemes::fevd(result_array_region, type = "Gumbel", method = "MLE", units = "years")
  return_level <- round(as.numeric(extRemes::return.level(fit_ref, return.period = use_rp)))

  RL_ERA_overlap[[region]] <- return_level
  
}

##### ModE-Sim 
path <- "/storage/research/giub_geco/data_2/scratch/phelpap/ModESim"
folders <- list.files(path, full.names = TRUE, pattern = "m[0-9]{3}_tidy") #m001 - m020 in first set

# Extract unique ensemble member identifiers from folder names
ensemble_members <- unique(basename(folders))[1:20]

corrected_full_eva <- corrected_full[ names(corrected_full) != "SAH" ]


###Overlap with ERA5-land for each region (1970-2009):
RL_ModE_overlap <- list()

# Loop over all regions
for (region in names(corrected_full_eva)) {
  # Extract the result array for the current region
  result_array_region <- corrected_full_eva[[region]][551:580,]#1970-1999
  RL_list <- list()
  
  for (em in ensemble_members) {
    # Extract the result array for the current em
    result_array_em <- result_array_region[,em]
    fit_ref <- extRemes::fevd(result_array_em, type = "Gumbel", method = "MLE", units = "years")
    return_level <- round(as.numeric(extRemes::return.level(fit_ref, return.period = use_rp)))
    RL_list[[em]] <- return_level
 }
    # Combine all spatial averages into a single array for the current region
  result_array_region <- do.call(cbind, RL_list)
  # Store the result for the current region
  RL_ModE_overlap[[region]] <- result_array_region
}

### Pre-industrial for every region (1420-1850):
RL_ModE_preind <- list()

# Loop over all regions
for (region in names(corrected_full_eva)) {
  # Extract the result array for the current region
  result_array_region <- corrected_full_eva[[region]][1:30,]#1420-1450
  RL_list <- list()
  
  for (em in ensemble_members) {
    # Extract the result array for the current em
    result_array_em <- result_array_region[,em]
    fit_ref <- extRemes::fevd(result_array_em, type = "Gumbel", method = "MLE", units = "years")
    return_level <- round(as.numeric(extRemes::return.level(fit_ref, return.period = use_rp)))
    RL_list[[em]] <- return_level
 }
    # Combine all spatial averages into a single array for the current region
  result_array_region <- do.call(cbind, RL_list)
  # Store the result for the current region
  RL_ModE_preind[[region]] <- result_array_region
}

### Early-industrial for every region (1851-1950):
RL_ModE_earlyind <- list()

# Loop over all regions
for (region in names(corrected_full_eva)) {
  # Extract the result array for the current region
  result_array_region <- corrected_full_eva[[region]][470:501,]#1890-1920
  RL_list <- list()
  
  for (em in ensemble_members) {
    # Extract the result array for the current em
    result_array_em <- result_array_region[,em]
    fit_ref <- extRemes::fevd(result_array_em, type = "Gumbel", method = "MLE", units = "years")
    return_level <- round(as.numeric(extRemes::return.level(fit_ref, return.period = use_rp)))
    RL_list[[em]] <- return_level
 }
    # Combine all spatial averages into a single array for the current region
  result_array_region <- do.call(cbind, RL_list)
  # Store the result for the current region
  RL_ModE_earlyind[[region]] <- result_array_region
}


### Modern ModeSIM for every region (1951-2009):
RL_ModE_modern <- list()

# Loop over all regions
for (region in names(corrected_full_eva)) {
  # Extract the result array for the current region
  result_array_region <- corrected_full_eva[[region]][551:580,]#1970-1999
  RL_list <- list()
  
  for (em in ensemble_members) {
    # Extract the result array for the current em
    result_array_em <- result_array_region[,em]
    fit_ref <- extRemes::fevd(result_array_em, type = "Gumbel", method = "MLE", units = "years")
    return_level <- round(as.numeric(extRemes::return.level(fit_ref, return.period = use_rp)))
    RL_list[[em]] <- return_level
 }
    # Combine all spatial averages into a single array for the current region
  result_array_region <- do.call(cbind, RL_list)
  # Store the result for the current region
  RL_ModE_modern[[region]] <- result_array_region
}

```

Plot in scatterplots: 

```{r}
# #### Overlap period ModE-Sim and ERA5-Land
# library(dplyr)
# library(ggplot2)

####### -------------------- Overlap period --------------------------------
# 1) Summarise lists into a data.frame:
df_overlap <- tibble(
  region = names(RL_ERA_overlap),
  era     = unlist(RL_ERA_overlap)
) %>% 
  mutate(
    # Grab the ensemble vector for each region
    mod_vec = RL_ModE_overlap[region],
    # Compute mean, min, max
    mod_mean = map_dbl(mod_vec, ~ mean(.x)),
    mod_min  = map_dbl(mod_vec, ~ min(.x)),
    mod_max  = map_dbl(mod_vec, ~ max(.x))
  ) %>% 
  dplyr::select(-mod_vec)

# Ensure the continent information is consistent
df_overlap <- df_overlap %>%
  mutate(continent = case_when(
    region %in% continent_mapping[["Europe"]] ~ "Europe",
    region %in% continent_mapping[["North America"]] ~ "North America",
    region %in% continent_mapping[["Africa"]] ~ "Africa",
    region %in% continent_mapping[["Asia"]] ~ "Asia",
    region %in% continent_mapping[["Central America"]] ~ "Central America",
    region %in% continent_mapping[["South America"]] ~ "South America",
    region %in% continent_mapping[["Australia"]] ~ "Australia",
    TRUE ~ "Other"
  ))

# 2) Plot with horizontal error bars
ggplot(df_overlap, aes(x = mod_mean, y = era, color = continent)) +
  geom_errorbarh(aes(xmin = mod_min, xmax = mod_max), height = 100) +
  geom_point(size = 2) +
  scale_color_manual(values = continent_colors) +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed") +
  geom_smooth(method = "lm", color = "red", se = FALSE, linewidth= 0.5) +  # Trend line
  #geom_text(aes(label = region), hjust = 0.5, vjust = -0.5, size = 3, colour = "black") + # Annotate with region names
  labs(
    x     = "ModE-Sim 5yr PCWD [mm]",
    y     = "ERA5-Land 5yr PCWD [mm]",
    title = "Overlap period (1970-1999)",
    color = "Continent"
  ) +
  scale_x_continuous(limits = c(0, 2000, 500)) +
  scale_y_continuous(limits = c(0, 2000, 500)) +
  theme_classic() +
  theme(
    legend.position    = "right",
    axis.text          = element_text(size = 12),
    axis.title         = element_text(size = 13),
    plot.title         = element_text(hjust = 0.5, face = "bold"),
    legend.title       = element_text(face = "bold"),
    legend.text        = element_text(size = 12)
  )


####### -------------------- Modern_ModE-Sim --------------------------------
# 1) Summarise lists into a data.frame:
df_modern_era <- tibble(
  region = names(RL_ERA_modern),
  era_mod     = unlist(RL_ERA_modern),
  era_overlap = unlist(RL_ERA_overlap)
) 

# Ensure the continent information is consistent
df_modern_era <- df_modern_era %>%
  mutate(continent = case_when(
    region %in% continent_mapping[["Europe"]] ~ "Europe",
    region %in% continent_mapping[["North America"]] ~ "North America",
    region %in% continent_mapping[["Africa"]] ~ "Africa",
    region %in% continent_mapping[["Asia"]] ~ "Asia",
    region %in% continent_mapping[["Central America"]] ~ "Central America",
    region %in% continent_mapping[["South America"]] ~ "South America",
    region %in% continent_mapping[["Australia"]] ~ "Australia",
    TRUE ~ "Other"
  ))

# 2) Plot with horizontal error bars
ggplot(df_modern_era, aes(x = era_overlap, y = era_mod, color = continent)) +
  geom_point(size = 2) +
  scale_color_manual(values = continent_colors) +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed") +
  geom_smooth(method = "lm", color = "red", se = FALSE, linewidth= 0.5) +  # Trend line
  #geom_text(aes(label = region), hjust = 0.5, vjust = -0.5, size = 3, colour = "black") + # Annotate with region names
  labs(
    x     = "ERA5-Land 5yr PCWD [mm] (1970-1999)",
    y     = "ERA5-Land 5yr PCWD [mm] (1995-2024)",
    title = "Modern ERA5-Land",
    color = "Continent"
  ) +
  scale_x_continuous(limits = c(0, 2000, 500)) +
  scale_y_continuous(limits = c(0, 2000, 500)) +
  theme_classic() +
  theme(
    legend.position    = "right",
    axis.text          = element_text(size = 12),
    axis.title         = element_text(size = 13),
    plot.title         = element_text(hjust = 0.5, face = "bold"),
    legend.title       = element_text(face = "bold"),
    legend.text        = element_text(size = 12)
  )


####### -------------------- Modern ModE-SIm --------------------------------
# 1) Summarise lists into a data.frame:
df_modern_ModE <- tibble(
  region = names(RL_ERA_modern),
  era     = unlist(RL_ERA_modern)
) %>% 
  mutate(
    # Grab the ensemble vector for each region
    mod_vec = RL_ModE_overlap[region],
    # Compute mean, min, max
    mod_mean = map_dbl(mod_vec, ~ mean(.x)),
    mod_min  = map_dbl(mod_vec, ~ min(.x)),
    mod_max  = map_dbl(mod_vec, ~ max(.x))
  ) %>% 
  dplyr::select(-mod_vec)

# Ensure the continent information is consistent
df_modern_ModE <- df_modern_ModE %>%
  mutate(continent = case_when(
    region %in% continent_mapping[["Europe"]] ~ "Europe",
    region %in% continent_mapping[["North America"]] ~ "North America",
    region %in% continent_mapping[["Africa"]] ~ "Africa",
    region %in% continent_mapping[["Asia"]] ~ "Asia",
    region %in% continent_mapping[["Central America"]] ~ "Central America",
    region %in% continent_mapping[["South America"]] ~ "South America",
    region %in% continent_mapping[["Australia"]] ~ "Australia",
    TRUE ~ "Other"
  ))

# 2) Plot with horizontal error bars
ggplot(df_modern_ModE, aes(x = mod_mean, y = era, color = continent)) +
  geom_errorbarh(aes(xmin = mod_min, xmax = mod_max), height = 100) +
  geom_point(size = 2) +
  scale_color_manual(values = continent_colors) +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed") +
  geom_smooth(method = "lm", color = "red", se = FALSE, linewidth= 0.5) +  # Trend line
  #geom_text(aes(label = region), hjust = 0.5, vjust = -0.5, size = 3, colour = "black") + # Annotate with region names
  labs(
    x     = "ModE-Sim (BC) 5yr PCWD [mm] (1970-1999)",
    y     = "ERA5-Land 5yr PCWD [mm] (1995-2024)",
    title = "Modern ERA5-Land vs ModE-Sim",
    color = "Continent"
  ) +
  scale_x_continuous(limits = c(0, 2000, 500)) +
  scale_y_continuous(limits = c(0, 2000, 500)) +
  theme_classic() +
  theme(
    legend.position    = "right",
    axis.text          = element_text(size = 12),
    axis.title         = element_text(size = 13),
    plot.title         = element_text(hjust = 0.5, face = "bold"),
    legend.title       = element_text(face = "bold"),
    legend.text        = element_text(size = 12)
  )

```

#### Same thing but comparing historic extremes to modern times and *30 yr* events
Scatterplots for 4 periods:
first 2: 
- y-axis: ModE-Sim 5yr extreme event in mm (1420-1490) for each region (70 year period)
- x-axis: ModE-Sim 5yr extreme event in mm 
  - early-industrial (1880-1950) for each region with error denoting spread of ensemble members
  - ERA5-Land "modern" (1954-2024) for each region with error denoting spread of ensemble members

```{r}
##calculate return level of 5 year events - 30 year chunks for consistency: 
#remove SAH due to unphysically large PCWD values - runaway PCWD 
regional_results_ERA5Land_eva <- regional_results_ERA5Land[ names(regional_results_ERA5Land) != "SAH" ]

use_rp <- 30   # return period of two years

# Modern ERA5-Land (1994-2024) for each region: 
# Initialize a list to store results for all regions
RL_ERA_modern <- list() #save modern 5yr events (in mm) for each region

# Loop through each region in regional_results
for (region in names(regional_results_ERA5Land_eva)) { #swap european_regions for regional_results for all regions
  # Extract the result array for the current region
  result_array_region <- regional_results_ERA5Land_eva[[region]][46:75] #1994-2024
  fit_ref <- extRemes::fevd(result_array_region, type = "Gumbel", method = "MLE", units = "years")
  return_level <- round(as.numeric(extRemes::return.level(fit_ref, return.period = use_rp)))

  RL_ERA_modern[[region]] <- return_level
  
}

##### ModE-Sim 
path <- "/storage/research/giub_geco/data_2/scratch/phelpap/ModESim"
folders <- list.files(path, full.names = TRUE, pattern = "m[0-9]{3}_tidy") #m001 - m020 in first set

# Extract unique ensemble member identifiers from folder names
ensemble_members <- unique(basename(folders))[1:20]

corrected_full_eva <- corrected_full[ names(corrected_full) != "SAH" ]


### Pre-industrial for every region (1420-1800):
RL_ModE_preind <- list()

# Loop over all regions
for (region in names(corrected_full_eva)) {
  # Extract the result array for the current region
  result_array_region <- corrected_full_eva[[region]][1:381,]#1420-1800
  RL_list <- list()
  
  for (em in ensemble_members) {
    # Extract the result array for the current em
    result_array_em <- result_array_region[,em]
    fit_ref <- extRemes::fevd(result_array_em, type = "Gumbel", method = "MLE", units = "years")
    return_level <- round(as.numeric(extRemes::return.level(fit_ref, return.period = use_rp)))
    RL_list[[em]] <- return_level
 }
    # Combine all spatial averages into a single array for the current region
  result_array_region <- do.call(cbind, RL_list)
  # Store the result for the current region
  RL_ModE_preind[[region]] <- result_array_region
}

### Early-industrial for every region (1851-1950):
RL_ModE_earlyind <- list()

# Loop over all regions
for (region in names(corrected_full_eva)) {
  # Extract the result array for the current region
  result_array_region <- corrected_full_eva[[region]][382:551,]#1801-1970
  RL_list <- list()
  
  for (em in ensemble_members) {
    # Extract the result array for the current em
    result_array_em <- result_array_region[,em]
    fit_ref <- extRemes::fevd(result_array_em, type = "Gumbel", method = "MLE", units = "years")
    return_level <- round(as.numeric(extRemes::return.level(fit_ref, return.period = use_rp)))
    RL_list[[em]] <- return_level
 }
    # Combine all spatial averages into a single array for the current region
  result_array_region <- do.call(cbind, RL_list)
  # Store the result for the current region
  RL_ModE_earlyind[[region]] <- result_array_region
}


### Modern for every region (1970-2009):
RL_ModE_modern <- list()

# Loop over all regions
for (region in names(corrected_full_eva)) {
  # Extract the result array for the current region
  result_array_region <- corrected_full_eva[[region]][552:590,]#1971-2009
  RL_list <- list()
  
  for (em in ensemble_members) {
    # Extract the result array for the current em
    result_array_em <- result_array_region[,em]
    fit_ref <- extRemes::fevd(result_array_em, type = "Gumbel", method = "MLE", units = "years")
    return_level <- round(as.numeric(extRemes::return.level(fit_ref, return.period = use_rp)))
    RL_list[[em]] <- return_level
 }
    # Combine all spatial averages into a single array for the current region
  result_array_region <- do.call(cbind, RL_list)
  # Store the result for the current region
  RL_ModE_modern[[region]] <- result_array_region
}

```


Plot in scatterplots: 

```{r}
# #### Overlap period ModE-Sim and ERA5-Land
# library(dplyr)
# library(ggplot2)

####### -------------------- Early-industrial --------------------------------
# 1) Summarise lists into a data.frame:
df_30yr <- tibble(
  region = names(RL_ERA_modern),
  era = unlist(RL_ERA_modern)
) %>% 
  mutate(
    # Grab the ensemble vector for each region
    mod_vec_pre = RL_ModE_preind[region],
    # Compute mean, min, max
    mod_mean_pre = map_dbl(mod_vec_pre, ~ mean(.x)),
    mod_min_pre  = map_dbl(mod_vec_pre, ~ min(.x)),
    mod_max_pre  = map_dbl(mod_vec_pre, ~ max(.x)), 
    # Grab the ensemble vector for each region earlyind
    mod_vec_early = RL_ModE_earlyind[region],
    # Compute mean, min, max
    mod_mean_early = map_dbl(mod_vec_early, ~ mean(.x)),
    mod_min_early  = map_dbl(mod_vec_early, ~ min(.x)),
    mod_max_early  = map_dbl(mod_vec_early, ~ max(.x)),
    # Grab the ensemble vector for each region modern
    mod_vec_modern = RL_ModE_modern[region],
    # Compute mean, min, max
    mod_mean_modern = map_dbl(mod_vec_modern, ~ mean(.x)),
    mod_min_modern  = map_dbl(mod_vec_modern, ~ min(.x)),
    mod_max_modern  = map_dbl(mod_vec_modern, ~ max(.x))
  ) %>% 
  dplyr::select(-mod_vec_early, -mod_vec_pre, -mod_vec_modern)


#####-------------------------Modern
# Ensure the continent information is consistent
df_30yr <- df_30yr %>%
  mutate(continent = case_when(
    region %in% continent_mapping[["Europe"]] ~ "Europe",
    region %in% continent_mapping[["North America"]] ~ "North America",
    region %in% continent_mapping[["Africa"]] ~ "Africa",
    region %in% continent_mapping[["Asia"]] ~ "Asia",
    region %in% continent_mapping[["Central America"]] ~ "Central America",
    region %in% continent_mapping[["South America"]] ~ "South America",
    region %in% continent_mapping[["Australia"]] ~ "Australia",
    TRUE ~ "Other"
  ))

# 2) Plot with horizontal error bars
ggplot(df_30yr, aes(x = mod_mean_modern, y = era, color = continent)) +
  annotate("rect", xmin  = 0, xmax  = 500, ymin  = 0, ymax  = 500, fill  = "grey70", alpha = 0.3) +
  geom_errorbarh(aes(xmin = mod_min_modern, xmax = mod_max_modern), height = 0) +
  geom_point(size = 2) +
  scale_color_manual(values = continent_colors) +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed") +
  geom_smooth(method = "lm", color = "red", se = FALSE, linewidth= 0.5) +  # Trend line
  #geom_text(aes(label = region), hjust = 0.5, vjust = -0.5, size = 3, colour = "black") + # Annotate with region names

  labs(
    x     = "ModE-Sim 30yr PCWD [mm] (1971-2009)",
    y     = "ERA5-Land 30yr PCWD [mm] (1995-2024)",
    title = "Modern period",
    color = "Continent"
  ) +
  scale_x_continuous(limits = c(0, 2500, 500)) +
  scale_y_continuous(limits = c(0, 2500, 500)) +
  theme_classic() +
  theme(
    legend.position    = "right",
    axis.text          = element_text(size = 12),
    axis.title         = element_text(size = 13),
    plot.title         = element_text(hjust = 0.5, face = "bold"),
    legend.title       = element_text(face = "bold"),
    legend.text        = element_text(size = 12)
  )


#########-----------------Early industrial

# 2) Plot with horizontal error bars
ggplot(df_30yr, aes(x = mod_mean_early, y = era, color = continent)) +
    annotate("rect", xmin  = 0, xmax  = 500, ymin  = 0, ymax  = 500, fill  = "grey70", alpha = 0.3) +
geom_errorbarh(aes(xmin = mod_min_early, xmax = mod_max_early), height = 0) +
  geom_point(size = 2) +
  scale_color_manual(values = continent_colors) +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed") +
  geom_smooth(method = "lm", color = "red", se = FALSE, linewidth= 0.5) +  # Trend line
  #geom_text(aes(label = region), hjust = 0.5, vjust = -0.5, size = 3, colour = "black") + # Annotate with region names

  labs(
    x     = "ModE-Sim 30yr PCWD [mm] (1801-1970)",
    y     = "ERA5-Land 30yr PCWD [mm] (1995-2024)",
    title = "Modern vs Early-industrial period",
    color = "Continent"
  ) +
  scale_x_continuous(limits = c(0, 2500, 500)) +
  scale_y_continuous(limits = c(0, 2500, 500)) +
  theme_classic() +
  theme(
    legend.position    = "right",
    axis.text          = element_text(size = 12),
    axis.title         = element_text(size = 13),
    plot.title         = element_text(hjust = 0.5, face = "bold"),
    legend.title       = element_text(face = "bold"),
    legend.text        = element_text(size = 12)
  )


####### -------------------- Preindustrial --------------------------------
# 2) Plot with horizontal error bars
ggplot(df_30yr, aes(x =mod_mean_pre , y = era, color = continent)) +
    annotate("rect", xmin  = 0, xmax  = 500, ymin  = 0, ymax  = 500, fill  = "grey70", alpha = 0.3) +
geom_errorbarh(aes(xmin = mod_min_pre, xmax = mod_max_pre), height = 0) +
  geom_point(size = 2) +
  scale_color_manual(values = continent_colors) +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed") +
  geom_smooth(method = "lm", color = "red", se = FALSE, linewidth= 0.5) +  # Trend line
  #geom_text(aes(label = region), hjust = 0.5, vjust = -0.5, size = 3, colour = "black") + # Annotate with region names

  labs(
    x     = "ModE-Sim 30yr PCWD [mm] (1420-1800)",
    y     = "ERA5-Land 30yr PCWD [mm] (1995-2024)",
    title = "Modern vs Preindustrial period",
    color = "Continent"
  ) +
  scale_x_continuous(limits = c(0, 2500, 500)) +
  scale_y_continuous(limits = c(0, 2500, 500)) +
  theme_classic() +
  theme(
    legend.position    = "right",
    axis.text          = element_text(size = 12),
    axis.title         = element_text(size = 13),
    plot.title         = element_text(hjust = 0.5, face = "bold"),
    legend.title       = element_text(face = "bold"),
    legend.text        = element_text(size = 12)
  )



```


"Zoomed in" version of the previous plots: 

```{r}
df_zoom <- df_30yr %>%
  filter(
    mod_mean_modern <= 500,
    era              <= 500
  )

# 2) Plot with horizontal error bars
ggplot(df_zoom, aes(x = mod_mean_modern, y = era, color = continent)) +
annotate("rect", xmin  = 0, xmax  = 500, ymin  = 0, ymax  = 500, fill  = "grey70", alpha = 0.3) +
geom_errorbarh(aes(xmin = mod_min_modern, xmax = mod_max_modern), height = 0) +
  geom_point(size = 2) +
  scale_color_manual(values = continent_colors) +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed") +
  #geom_smooth(method = "lm", color = "red", se = FALSE, linewidth= 0.5) +  # Trend line
  #geom_text(aes(label = region), hjust = 0.5, vjust = -0.5, size = 3, colour = "black") + # Annotate with region names

  labs(
    x     = "ModE-Sim 30yr PCWD [mm] (1971-2009)",
    y     = "ERA5-Land 30yr PCWD [mm] (1995-2024)",
    title = "Modern period",
    color = "Continent"
  ) +
  scale_x_continuous(limits = c(0, 500), breaks = seq(0, 500, 100)) +
  scale_y_continuous(limits = c(0, 500), breaks = seq(0, 500, 100)) +
  theme_classic() +
  theme(
    legend.position    = "right",
    axis.text          = element_text(size = 12),
    axis.title         = element_text(size = 13),
    plot.title         = element_text(hjust = 0.5, face = "bold"),
    legend.title       = element_text(face = "bold"),
    legend.text        = element_text(size = 12)
  )


#########-----------------Early industrial

# 2) Plot with horizontal error bars
ggplot(df_zoom, aes(x = mod_mean_early, y = era, color = continent)) +
  annotate("rect", xmin  = 0, xmax  = 500, ymin  = 0, ymax  = 500, fill  = "grey70", alpha = 0.3) +
 geom_errorbarh(aes(xmin = mod_min_early, xmax = mod_max_early), height = 0) +
  geom_point(size = 2) +
  scale_color_manual(values = continent_colors) +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed") +
  #geom_smooth(method = "lm", color = "red", se = FALSE, linewidth= 0.5) +  # Trend line
  #geom_text(aes(label = region), hjust = 0.5, vjust = -0.5, size = 3, colour = "black") + # Annotate with region names

  labs(
    x     = "ModE-Sim 30yr PCWD [mm] (1801-1970)",
    y     = "ERA5-Land 30yr PCWD [mm] (1995-2024)",
    title = "Modern vs Early-industrial period",
    color = "Continent"
  ) +
  scale_x_continuous(limits = c(0, 500), breaks = seq(0, 500, 100)) +
  scale_y_continuous(limits = c(0, 500), breaks = seq(0, 500, 100)) +
  theme_classic() +
  theme(
    legend.position    = "right",
    axis.text          = element_text(size = 12),
    axis.title         = element_text(size = 13),
    plot.title         = element_text(hjust = 0.5, face = "bold"),
    legend.title       = element_text(face = "bold"),
    legend.text        = element_text(size = 12)
  )


####### -------------------- Preindustrial --------------------------------
# 2) Plot with horizontal error bars
ggplot(df_zoom, aes(x =mod_mean_pre , y = era, color = continent)) +
  annotate("rect", xmin  = 0, xmax  = 500, ymin  = 0, ymax  = 500, fill  = "grey70", alpha = 0.3) +
 geom_errorbarh(aes(xmin = mod_min_pre, xmax = mod_max_pre), height = 0) +
  #geom_errorbar(aes(ymin = mod_min_pre, ymax = mod_max_pre), width = 50) +
  geom_point(size = 2) +
  scale_color_manual(values = continent_colors) +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed") +
  #geom_smooth(method = "lm", color = "red", se = FALSE, linewidth= 0.5) +  # Trend line
  #geom_text(aes(label = region), hjust = 0.5, vjust = -0.5, size = 3, colour = "black") + # Annotate with region names

  labs(
    x     = "ModE-Sim 30yr PCWD [mm] (1420-1800)",
    y     = "ERA5-Land 30yr PCWD [mm] (1995-2024)",
    title = "Modern vs Preindustrial period",
    color = "Continent"
  ) +
  scale_x_continuous(limits = c(0, 500), breaks = seq(0, 500, 100)) +
  scale_y_continuous(limits = c(0, 500), breaks = seq(0, 500, 100)) +
  theme_classic() +
  theme(
    legend.position    = "right",
    axis.text          = element_text(size = 12),
    axis.title         = element_text(size = 13),
    plot.title         = element_text(hjust = 0.5, face = "bold"),
    legend.title       = element_text(face = "bold"),
    legend.text        = element_text(size = 12)
  )

```
Quantify how many regions are within simulated spread
```{r}
#library(dplyr)

df_30yr %>%
  # 1) flag “outside of [min, max]” in each period
  mutate(
    outside_pre   = era < mod_min_pre   | era > mod_max_pre,
    outside_early = era < mod_min_early | era > mod_max_early,
    outside_mod   = era < mod_min_modern| era > mod_max_modern
  ) %>%
  # 2) tally up how many TRUEs in each flag
  summarise(
    n_regions = n(),
    n_out_pre   = sum(outside_pre),
    n_out_early = sum(outside_early),
    n_out_mod   = sum(outside_mod)
  ) %>%
  # 3) optionally add percentage of total
  mutate(
    pct_out_pre   = 100 * n_out_pre   / n_regions,
    pct_out_early = 100 * n_out_early / n_regions,
    pct_out_mod   = 100 * n_out_mod   / n_regions
  )

###only era larger than past: 
df_30yr %>%
  # 1) flag “outside of [min, max]” in each period
  mutate(
    outside_pre   = era > mod_max_pre,
    outside_early = era > mod_max_early,
    outside_mod   = era > mod_max_modern
  ) %>%
  # 2) tally up how many TRUEs in each flag
  summarise(
    n_regions = n(),
    n_out_pre   = sum(outside_pre),
    n_out_early = sum(outside_early),
    n_out_mod   = sum(outside_mod)
  ) %>%
  # 3) optionally add percentage of total
  mutate(
    pct_out_pre   = 100 * n_out_pre   / n_regions,
    pct_out_early = 100 * n_out_early / n_regions,
    pct_out_mod   = 100 * n_out_mod   / n_regions
  )

```

```{r}
## check values for regions exceeding the natural variability
df_30yr %>% 
  mutate(
    outside_pre   = era > mod_max_pre,
    outside_early = era > mod_max_early,
    outside_mod   = era > mod_max_modern
  ) %>% 
  filter(outside_pre) %>% 
  dplyr::select(region, era, mod_min_pre, mod_max_pre)

```
##### Show which regions are affected

Load reference region info:
```{r}
#Load reference regions and coastlines:

load("/storage/homefs/ph23v078/Reference_regions/IPCC-WGI-reference-regions-v4_R.rda", verbose = TRUE)
# IPCC_WGI_reference_regions_v4 is a Spatial*DataFrame with a column "region" (or similar)
refregions_sf <- st_as_sf(IPCC_WGI_reference_regions_v4)
refregions_sf <- refregions_sf %>% rename(region = Acronym)

temp.dir <- tempdir()
unzip("/storage/homefs/ph23v078/Reference_regions/ne_110m_coastline.zip", exdir = temp.dir)
coastLines <- readOGR(dsn = temp.dir, layer = "ne_110m_coastline")

names(names(refregions))

proj4string(refregions)

# Convert `refregions` (SpatialPolygons) to an `sf` object for ggplot compatibility
#refregions_sf <- st_as_sf(refregions)

# Define continent assignments
continent_mapping <- list(
  "Europe" = c("NEU", "WCE", "EEU", "MED"),
  "North America" = c("NWN", "NEN", "WNA", "CNA", "ENA", "GIC"),
  "Africa" = c("SAH", "WAF", "CAF", "NEAF", "SEAF", "WSAF", "ESAF", "MDG"),
  "Asia" = c("WCA", "ECA", "TIB", "EAS", "ARP", "SAS", "SEA", "WSB", "ESB", "RFE", "RAR"),
  "Central America" =c("NCA", "SCA", "CAR"),
  "South America" = c("NWS", "NSA", "NES", "SAM", "SWS", "SES", "SSA"),
  "Australia" = c("NAU", "CAU", "EAU", "SAU", "NZ")
)

# Assign continents to regions
refregions_sf <- refregions_sf %>%
  mutate(
    continent = case_when(
      row.names(refregions) %in% continent_mapping$Europe ~ "Europe",
      row.names(refregions) %in% continent_mapping$`North America` ~ "North America",
      row.names(refregions) %in% continent_mapping$Africa ~ "Africa",
      row.names(refregions) %in% continent_mapping$Asia ~ "Asia",
      row.names(refregions) %in% continent_mapping$`Central America` ~ "Central America",
      row.names(refregions) %in% continent_mapping$`South America` ~ "South America",
      row.names(refregions) %in% continent_mapping$Australia ~ "Australia",
      TRUE ~ "Ocean"  # For regions not mapped to a continent
    )
  ) 


# Define continent colors
continent_colors <- c(
  "Europe" = "#F5B0CB",
  "North America" = "#236A3F",
  "Africa" = "#91C7B1",
  "Asia" = "#E5973B",
  "Central America" = "#B33951",
  "South America" = "#E3D081",
  "Australia" = "#3C3980",
  "Ocean" = "white"
)

# Extract region centroids for labeling
region_labels <- refregions_sf %>%
  st_centroid() %>%
  mutate(label = row.names(refregions))  # Add region names as labels


# Load land data for filling continents
land <- ne_countries(scale = "medium", returnclass = "sf")

# Plot the map with ggplot2
ggplot() +
  geom_sf(data = land, fill = "lightgray", color = NA) +  # Fill land areas
  geom_sf(data = refregions_sf, aes(fill = continent), color = "black", alpha = 0.5) +  # Transparent overlay
  geom_sf_text(data = region_labels, aes(label = label), size = 3, color = "black", check_overlap = FALSE) +  # Add region names
  scale_fill_manual(values = continent_colors, name = "Continent") +
  theme_minimal() +
  labs(x= "", y=""
       #title = "Map of IPCC Regions by Continent",
       #subtitle = "Regions coloured by assigned continents, region names labeled"
       ) +
  theme(
    plot.title = element_text(size = 16, face = "bold"),
    plot.subtitle = element_text(size = 12),
    legend.position = "none"
  )
```

Calculate flags and plot:
```{r}
library(dplyr)
library(sf)
library(ggplot2)

# 1) Build your flags table with categories
flags <- df_30yr %>%
  mutate(
    outside_pre   = era < mod_min_pre   | era > mod_max_pre,
    outside_early = era < mod_min_early | era > mod_max_early,
    outside_mod   = era < mod_min_modern| era > mod_max_modern,
    exceed_cat = case_when(
      outside_pre   & !outside_early & !outside_mod ~ "Pre only",
      !outside_pre  & outside_early & !outside_mod ~ "Early only",
      !outside_pre  & !outside_early & outside_mod ~ "Modern only",
      outside_pre & outside_early & !outside_mod   ~ "Pre + Early",
      outside_pre & !outside_early & outside_mod   ~ "Pre + Modern",
      !outside_pre & outside_early & outside_mod   ~ "Early + Modern",
      outside_pre & outside_early & outside_mod    ~ "All three",
      TRUE                                           ~ NA_character_
    )
  ) %>%
  dplyr::select(region, exceed_cat)

# 2) Prepare the spatial object and join
refregions_sf <- refregions_sf %>%
  #mutate(region = row.names(.)) %>%
  left_join(flags, by = "region")

# 3) Compute centroids for labels (only for regions with exceed_cat not NA)
label_pts <- refregions_sf %>%
  filter(!is.na(exceed_cat)) %>%
  st_centroid() %>%
  mutate(label = region)

# 4) Define a palette for the 7 non-NA categories
category_colors <- c(
  "Pre only"       = "#BDF7B7", 
  "Early only"     = "#2AA16C",
  "Modern only"    = "#3943B7",
  "Pre + Early"    = "#AB71ED",
  "Pre + Modern"   = "#F8F4A6",
  "Early + Modern" = "#E08E45",
  "All three"      = "#6B2737"
)

# 5) Plot
ggplot() +
  # Base land
  geom_sf(data = land, fill = "lightgray", color = NA) +
  # Regions, colored only if exceed_cat is not NA
  geom_sf(
    data = refregions_sf,
    aes(fill = exceed_cat),
    color = "grey30",
    size = 0.2, 
    alpha = 0.5
  ) +
  # Region labels for only those that exceed
  geom_sf_text(
    data    = label_pts,
    aes(label = label),
    size    = 3,
    color   = "black", check_overlap = FALSE
  ) +
  scale_fill_manual(
    values   = category_colors,
    name     = "Period exceedance",
    na.value = NA  # leave 'None' regions transparent
  ) +
  theme_minimal() +
  theme(
    axis.text      = element_blank(),
    axis.title     = element_blank(),
    panel.grid     = element_blank(),
    legend.title   = element_text(face = "bold"),
    legend.key     = element_rect(color = NA),
    plot.title = element_text(size = 16, face = "bold"),
    plot.subtitle = element_text(size = 12),
    legend.position = "none"
  ) +
  labs(
    #title    = "Regions where modern 30-yr extremes exceed natural spread",
    #subtitle = "Annotations show region codes for those exceeding in at least one period"
  )

```


