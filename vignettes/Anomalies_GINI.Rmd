---
title: "PCWD Anomalies and GINI calculation"
author: "Patricia Helpap"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r libraries, message=FALSE, echo=FALSE}
library(readr)
library(dplyr)
library(here)
library(lubridate)
library(patchwork)
library(ggplot2)
library(cwd)
library(ncdf4)
library(reshape2)
library(ggpubr)
library(maps)
library(raster)
library(rnaturalearth)
library(sf)
library(rgdal)
library(sp)
library(RColorBrewer)
library(rJava)
library(loadeR.java)
library(transformeR)
library(loadeR)
library(visualizeR)
library(geoprocessoR)
library(tidyverse)
library(abind)
library(patchwork)
library(gridExtra)
library(DescTools) #for GINI calculation
library(ggsci)
```

### Anomalies wrt anomaly

- calculate timeseries of moving anomalies wrt a reference; try 1420-1450 as reference, 30 year window? Use PCWD mean values
- timeseries for each region including std? 
- calculate anomalies as in value(t) - mean(1420-1450) and plot
- calculate anomalies as z-scores: zscore = (x - mean) /std

```{r}
#read in aggregated regional data
# #Load with
regional_results_1420 <- readRDS("~/cwd_global/data/regionalResults_1420_1.RData")
regional_results_1850 <- readRDS("~/cwd_global/data/regionalResults_1850_1.RData")

```

```{r}
# Define continent assignments
continent_mapping <- list(
  "Europe" = c("NEU", "WCE", "EEU", "MED"),
  "North America" = c("NWN", "NEN", "WNA", "CNA", "ENA", "GIC"),
  "Africa" = c("SAH", "WAF", "CAF", "NEAF", "SEAF", "WSAF", "ESAF", "MDG"),
  "Asia" = c("WCA", "ECA", "TIB", "EAS", "ARP", "SAS", "SEA", "WSB", "ESB", "RFE", "RAR"),
  "Central America" =c("NCA", "SCA", "CAR"),
  "South America" = c("NWS", "NSA", "NES", "SAM", "SWS", "SES", "SSA"),
  "Australia" = c("NAU", "CAU", "EAU", "SAU", "NZ")
)
```


```{r}
#read in volcanic forcing data for set 1: 
#AOD years 1000 C.E. to 1900 C.E.:
input_file <- "/storage/research/giub_geco/data_2/scratch/phelpap/ModESim/ModESim_forcings/1420_1/eva_holo2.2_forcing_echam_T63_ir_1000-1900.nc"
nc_forcings <- nc_open(input_file)
aod = ncvar_get(nc_forcings, varid="aod")[6,,] # index 6 for 500nm wavelength
lat = ncvar_get(nc_forcings, varid="lat")
time_1420 = ncvar_get(nc_forcings, varid="time")
nc_close(nc_forcings)

########### Calculate annual mean values for first epoch years:
# Define the years of interest
years_of_interest <- 1420:1849

# Find indices of columns corresponding to the desired years
selected_indices <- which(time_1420 %in% years_of_interest)

# Subset the matrix to include only those years
aod_selected <- aod[, selected_indices]
time_selected <- time_1420[selected_indices]  # Corresponding time values

# Compute the mean over latitudes (first dimension)
mean_latitude <- apply(aod_selected, 2, mean, na.rm = TRUE)

# Convert to a data frame for easier manipulation
df <- data.frame(year = time_selected, mean_value = mean_latitude)

# Compute the annual mean (since each year has 12 monthly values)
library(dplyr)
aod_annual_mean_1420 <- df %>%
  group_by(year) %>%
  summarise(annual_mean_value = mean(mean_value, na.rm = TRUE))

write.csv(aod_annual_mean_1420, "~/cwd_global/data/AOD_annual_mean_1420epoch.csv")


####read in data: 
##### volc forcing for 1420 - global annual mean: 
aod_annual_mean_1420 <- read.csv("~/cwd_global/data/AOD_annual_mean_1420epoch.csv")
##### volc forcing for 1850 - global annual mean: 
aod_annual_mean_1850 <- read.csv("~/cwd_global/data/AOD_annual_mean_1850epoch.csv")
aod_annual_mean_1850 <- aod_annual_mean_1850 %>% 
  rename(
    year = Year,
    annual_mean_value = mean_AOD
    )
```


Anomalies for each time step: 

```{r}
### calculate anomalies for both epochs based on reference time 1420-1450

### calculate baseline for anomalies: 1420-1450 mean for each region
# Initialize list to store baselines for each region
anom_baseline <- list()

# Loop over regions
for (region_name in names(regional_results_1420)) {
  
  # Extract all ensemble members for the region
  ensemble_members <- regional_results_1420[[region_name]]
  
  # Compute baseline (mean over first 30 years) for each ensemble member
  anom_baseline[[region_name]] <- colMeans(ensemble_members[1:30, ], na.rm = TRUE)
}

# Initialize lists to store results
anoms_1420 <- list()      # Mean anomalies for each region
anoms_sd_1420 <- list()   # Standard deviation of anomalies for each region

# Loop over regions
for (region_name in names(regional_results_1420)) {
  
  # Extract the ensemble members for the region
  ensemble_members <- regional_results_1420[[region_name]]  # Now using full ensemble data
  
  # Compute anomalies for each ensemble member
  ensemble_anoms <- sweep(ensemble_members, 2, anom_baseline[[region_name]], "-")  # Subtract baseline
  
  # Compute mean anomaly across ensemble members
  anoms_1420[[region_name]] <- rowMeans(ensemble_anoms, na.rm = TRUE)
  
  # Compute standard deviation (uncertainty) across ensemble members
  anoms_sd_1420[[region_name]] <- apply(ensemble_anoms, 1, sd, na.rm = TRUE)
}

### calculate baseline for anomalies: 1420-1450 mean for each region
# Initialize list to store baselines for each region
anom_baseline_1850 <- list()

# Loop over regions
for (region_name in names(regional_results_1850)) {
  
  # Extract all ensemble members for the region
  ensemble_members <- regional_results_1850[[region_name]]
  
  # Compute baseline (mean over first 30 years) for each ensemble member
  anom_baseline_1850[[region_name]] <- colMeans(ensemble_members[1:30, ], na.rm = TRUE)
}

# Initialize lists to store results
anoms_1850 <- list()      # Mean anomalies for each region
anoms_sd_1850 <- list()   # Standard deviation of anomalies for each region

# Loop over regions
for (region_name in names(regional_results_1850)) {
  
  # Extract the ensemble members for the region
  ensemble_members <- regional_results_1850[[region_name]]  # Now using full ensemble data
  
  # Compute anomalies for each ensemble member
  ensemble_anoms <- sweep(ensemble_members, 2, anom_baseline_1850[[region_name]], "-")  # Subtract baseline
  
  # Compute mean anomaly across ensemble members
  anoms_1850[[region_name]] <- rowMeans(ensemble_anoms, na.rm = TRUE)
  
  # Compute standard deviation (uncertainty) across ensemble members
  anoms_sd_1850[[region_name]] <- apply(ensemble_anoms, 1, sd, na.rm = TRUE)
}

```



Create Dataframe region, SNR and time: 
```{r}
########### 1420 period
# Convert SNR list into a data frame
anom_df_1420 <- do.call(rbind, lapply(names(anoms_1420), function(region) {
  data.frame(
    time = seq(1420,1849),  # Extract time from names
    anomalies = anoms_1420[[region]],
    std = anoms_sd_1420[[region]],
    region = region                                # Add region identifier
  )
}))

# Add a continent column to the SNR data frame
anom_df_1420$continent <- NA  # Initialize continent column

for (continent in names(continent_mapping)) {
  anom_df_1420$continent[anom_df_1420$region %in% continent_mapping[[continent]]] <- continent
}


###### 1850 period
# Convert SNR list into a data frame
anom_df_1850 <- do.call(rbind, lapply(names(anoms_1850), function(region) {
  data.frame(
    time = seq(1850,2009),  # Extract time from names
    anomalies = anoms_1850[[region]], 
    std = anoms_sd_1850[[region]],
    region = region                                # Add region identifier
  )
}))

# Add a continent column to the SNR data frame
anom_df_1850$continent <- NA  # Initialize continent column

for (continent in names(continent_mapping)) {
  anom_df_1850$continent[anom_df_1850$region %in% continent_mapping[[continent]]] <- continent
}

```

```{r}
#test to incorporate volcanic forcings also: 
#### Europe ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "Europe"
anom_filtered <- anom_df_1420 %>% filter(continent == selected_continent)

# Normalize AOD data to fit the anomalies scale
aod_min <- min(aod_annual_mean_1420$annual_mean_value, na.rm = TRUE)
aod_max <- max(aod_annual_mean_1420$annual_mean_value, na.rm = TRUE)
anom_min <- min(anom_filtered$anomalies, na.rm = TRUE)
anom_max <- max(anom_filtered$anomalies, na.rm = TRUE)

# Calculate scale factor to ensure zero alignment
aod_zero <- 0  # AOD zero point
anom_zero <- 0  # Anomalies zero point
scale_factor <- (anom_max - anom_min) / (aod_max - aod_min)  # Scale based on range

# Scale AOD values to match the anomalies scale
annual_mean <- aod_annual_mean_1420 %>%
  mutate(scaled_aod = (annual_mean_value - aod_zero) * scale_factor + anom_zero)

# Plot
ggplot() +
  # Primary Y-axis: CWD Anomalies
  geom_line(data = anom_filtered, aes(x = time, y = anomalies, group = region, color = "CWD Anomalies")) +
  geom_ribbon(data = anom_filtered, aes(x = time, ymin = anomalies - std, ymax = anomalies + std, group = region), fill = "grey", alpha = 0.3) +
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed") +
  
  # Secondary Y-axis: Volcanic Forcing (AOD)
  geom_point(data = annual_mean, aes(x = year, y = scaled_aod, color = "Volcanic Forcing (AOD)")) +
  
  # Labels
  labs(
    x = "Year",
    y = "Anomalies [mm] (w.r.t. 1420-1450)",
    title = paste("EM PCWD anomalies for", selected_continent),
    color = "Legend"  # Title for the legend
  ) +
  
  # Secondary axis transformation ensuring zero alignment
  scale_y_continuous(
    sec.axis = sec_axis(
      ~ (. - anom_zero) / scale_factor + aod_zero, 
      name = "Annual Mean AOD"
    )
  ) +

  # Manual color scale for legend
  scale_color_manual(
    values = c("CWD Anomalies" = "black", "Volcanic Forcing (AOD)" = "red")
  ) +

  theme_classic() +
  theme(
    legend.position = "top",  # Legend at the top
    legend.title = element_text(face = "bold"),
    plot.title = element_text(hjust = 0.5, face = "bold"),  
    strip.text = element_text(size = 10),  
    strip.background = element_rect(fill = "pink")
  ) +
  
  facet_wrap(~region
             #, scales = "free_y"
             )  # Facet by region
```


Plot timeseries of anomalies for all regions: 

```{r}
#################all continents for 1420 epoch ###################################

#### Europe ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "Europe"
anom_filtered <- anom_df_1420 %>% filter(continent == selected_continent)

# Plot anom time series
ggplot(anom_filtered, aes(x = time, y = anomalies)) +
  geom_line() +  # Plot lines for each region
  geom_ribbon(aes(ymin = anomalies - std, ymax = anomalies + std), fill = "grey", alpha = 0.3) +
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  labs(
    x = "Year",
    y = "anomalies [mm] (w.r.t. 1420-1450)",
    title = paste("EM PCWD anomalies for", selected_continent)
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "pink")
  ) +
  facet_wrap(~region, scales = "free_y")  # Facet by region with independent y-axis scales

#### Asia ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "Asia"
anom_filtered <- anom_df_1420 %>% filter(continent == selected_continent)

# Plot anom time series
ggplot(anom_filtered, aes(x = time, y = anomalies)) +
  geom_line() +  # Plot lines for each region
  geom_ribbon(aes(ymin = anomalies - std, ymax = anomalies + std), fill = "grey", alpha = 0.3) +
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  labs(
    x = "Year",
    y = "anomalies [mm] (w.r.t. 1420-1450)",
    title = paste("EM PCWD anomalies for", selected_continent)
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "orange")
  ) +
  facet_wrap(~region, scales = "free_y")  # Facet by region with independent y-axis scales

##### Australia ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "Australia"
anom_filtered <- anom_df_1420 %>% filter(continent == selected_continent)

# Plot anom time series
ggplot(anom_filtered, aes(x = time, y = anomalies)) +
  geom_line() +  # Plot lines for each region
  geom_ribbon(aes(ymin = anomalies - std, ymax = anomalies + std), fill = "grey", alpha = 0.3) +
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  labs(
    x = "Year",
    y = "anomalies [mm] (w.r.t. 1420-1450)",
    title = paste("EM PCWD anomalies for", selected_continent)
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10, colour = "white"),  # Size for facet labels
    strip.background = element_rect(fill = "blue")
  ) +
  facet_wrap(~region, scales = "free_y")  # Facet by region with independent y-axis scales


##### Africa ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "Africa"
anom_filtered <- anom_df_1420 %>% filter(continent == selected_continent)

# Plot anom time series
ggplot(anom_filtered, aes(x = time, y = anomalies)) +
  geom_line() +  # Plot lines for each region
  geom_ribbon(aes(ymin = anomalies - std, ymax = anomalies + std), fill = "grey", alpha = 0.3) +
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  labs(
    x = "Year",
    y = "anomalies [mm] (w.r.t. 1420-1450)",
    title = paste("EM PCWD anomalies for", selected_continent)
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "purple")
  ) +
  facet_wrap(~region, scales = "free_y")  # Facet by region with independent y-axis scales


#### North America ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "North America"
anom_filtered <- anom_df_1420 %>% filter(continent == selected_continent)

# Plot anom time series
ggplot(anom_filtered, aes(x = time, y = anomalies)) +
  geom_line() +  # Plot lines for each region
  geom_ribbon(aes(ymin = anomalies - std, ymax = anomalies + std), fill = "grey", alpha = 0.3) +
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  labs(
    x = "Year",
    y = "anomalies [mm] (w.r.t. 1420-1450)",
    title = paste("EM PCWD anomalies for", selected_continent)
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "lightgreen")
  ) +
  facet_wrap(~region, scales = "free_y")  # Facet by region with independent y-axis scales

#### Central America ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "Central America"
anom_filtered <- anom_df_1420 %>% filter(continent == selected_continent)

# Plot anom time series
ggplot(anom_filtered, aes(x = time, y = anomalies)) +
  geom_line() +  # Plot lines for each region
  geom_ribbon(aes(ymin = anomalies - std, ymax = anomalies + std), fill = "grey", alpha = 0.3) +
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  labs(
    x = "Year",
    y = "anomalies [mm] (w.r.t. 1420-1450)",
    title = paste("EM PCWD anomalies for", selected_continent)
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "lightblue")
  ) +
  facet_wrap(~region, scales = "free_y")  # Facet by region with independent y-axis scales


#### South America ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "South America"
anom_filtered <- anom_df_1420 %>% filter(continent == selected_continent)

# Plot anom time series
ggplot(anom_filtered, aes(x = time, y = anomalies)) +
  geom_line() +  # Plot lines for each region
  geom_ribbon(aes(ymin = anomalies - std, ymax = anomalies + std), fill = "grey", alpha = 0.3) +
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  labs(
    x = "Year",
    y = "anomalies [mm] (w.r.t. 1420-1450)",
    title = paste("EM PCWD anomalies for", selected_continent)
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "yellow")
  ) +
  facet_wrap(~region, scales = "free_y")  # Facet by region with independent y-axis scales

```
```{r}
#################all continents for 1850 epoch ###################################

#### Europe ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "Europe"
anom_filtered <- anom_df_1850 %>% filter(continent == selected_continent)

# Plot anom time series
ggplot(anom_filtered, aes(x = time, y = anomalies)) +
  geom_line() +  # Plot lines for each region
  geom_ribbon(aes(ymin = anomalies - std, ymax = anomalies + std), fill = "grey", alpha = 0.3) +
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  labs(
    x = "Year",
    y = "anomalies [mm] (w.r.t. 1420-1450)",
    title = paste("EM PCWD anomalies for", selected_continent)
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "pink")
  ) +
  facet_wrap(~region, scales = "free_y")  # Facet by region with independent y-axis scales

#### Asia ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "Asia"
anom_filtered <- anom_df_1850 %>% filter(continent == selected_continent)

# Plot anom time series
ggplot(anom_filtered, aes(x = time, y = anomalies)) +
  geom_line() +  # Plot lines for each region
  geom_ribbon(aes(ymin = anomalies - std, ymax = anomalies + std), fill = "grey", alpha = 0.3) +
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  labs(
    x = "Year",
    y = "anomalies [mm] (w.r.t. 1420-1450)",
    title = paste("EM PCWD anomalies for", selected_continent)
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "orange")
  ) +
  facet_wrap(~region, scales = "free_y")  # Facet by region with independent y-axis scales

##### Australia ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "Australia"
anom_filtered <- anom_df_1850 %>% filter(continent == selected_continent)

# Plot anom time series
ggplot(anom_filtered, aes(x = time, y = anomalies)) +
  geom_line() +  # Plot lines for each region
  geom_ribbon(aes(ymin = anomalies - std, ymax = anomalies + std), fill = "grey", alpha = 0.3) +
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  labs(
    x = "Year",
    y = "anomalies [mm] (w.r.t. 1420-1450)",
    title = paste("EM PCWD anomalies for", selected_continent)
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10, colour = "white"),  # Size for facet labels
    strip.background = element_rect(fill = "blue")
  ) +
  facet_wrap(~region, scales = "free_y")  # Facet by region with independent y-axis scales


##### Africa ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "Africa"
anom_filtered <- anom_df_1850 %>% filter(continent == selected_continent)

# Plot anom time series
ggplot(anom_filtered, aes(x = time, y = anomalies)) +
  geom_line() +  # Plot lines for each region
  geom_ribbon(aes(ymin = anomalies - std, ymax = anomalies + std), fill = "grey", alpha = 0.3) +
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  labs(
    x = "Year",
    y = "anomalies [mm] (w.r.t. 1420-1450)",
    title = paste("EM PCWD anomalies for", selected_continent)
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "purple")
  ) +
  facet_wrap(~region, scales = "free_y")  # Facet by region with independent y-axis scales


#### North America ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "North America"
anom_filtered <- anom_df_1850 %>% filter(continent == selected_continent)

# Plot anom time series
ggplot(anom_filtered, aes(x = time, y = anomalies)) +
  geom_line() +  # Plot lines for each region
  geom_ribbon(aes(ymin = anomalies - std, ymax = anomalies + std), fill = "grey", alpha = 0.3) +
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  labs(
    x = "Year",
    y = "anomalies [mm] (w.r.t. 1420-1450)",
    title = paste("EM PCWD anomalies for", selected_continent)
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "lightgreen")
  ) +
  facet_wrap(~region, scales = "free_y")  # Facet by region with independent y-axis scales

#### Central America ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "Central America"
anom_filtered <- anom_df_1850 %>% filter(continent == selected_continent)

# Plot anom time series
ggplot(anom_filtered, aes(x = time, y = anomalies)) +
  geom_line() +  # Plot lines for each region
  geom_ribbon(aes(ymin = anomalies - std, ymax = anomalies + std), fill = "grey", alpha = 0.3) +
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  labs(
    x = "Year",
    y = "anomalies [mm] (w.r.t. 1420-1450)",
    title = paste("EM PCWD anomalies for", selected_continent)
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "lightblue")
  ) +
  facet_wrap(~region, scales = "free_y")  # Facet by region with independent y-axis scales


#### South America ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "South America"
anom_filtered <- anom_df_1850 %>% filter(continent == selected_continent)

# Plot anom time series
ggplot(anom_filtered, aes(x = time, y = anomalies)) +
  geom_line() +  # Plot lines for each region
  geom_ribbon(aes(ymin = anomalies - std, ymax = anomalies + std), fill = "grey", alpha = 0.3) +
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  labs(
    x = "Year",
    y = "anomalies [mm] (w.r.t. 1420-1450)",
    title = paste("EM PCWD anomalies for", selected_continent)
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "yellow")
  ) +
  facet_wrap(~region, scales = "free_y")  # Facet by region with independent y-axis scales

```

Calculate z-scores (annual values):

Interpreting the Z-Scores
- z = 0 → Anomaly is equal to the baseline mean.
- z = ±1 → Anomaly is one standard deviation from the baseline.
- z > ±2 → Strong anomaly, may indicate a significant departure from normal variability.
- z > ±3 → Extreme anomaly, suggesting an event outside typical variability.

```{r}
###################### 1420 epoch z-scores
# Initialize lists to store baselines and standard deviations
anom_baseline <- list()
anom_baseline_sd <- list()

# Loop over regions
for (region_name in names(regional_results_1420)) {
  
  # Extract all ensemble members for the region
  ensemble_members <- regional_results_1420[[region_name]]
  
  # Compute baseline mean (over first 30 years) for each ensemble member
  anom_baseline[[region_name]] <- colMeans(ensemble_members[1:30, ], na.rm = TRUE)
  
  # Compute baseline standard deviation (over first 30 years) for each ensemble member
  anom_baseline_sd[[region_name]] <- apply(ensemble_members[1:30, ], 2, sd, na.rm = TRUE) #calc sd across columns(years)
}

# ## calculate baseline spread of means
# baseline_spread <- list()
# # Loop over regions
# for (region_name in names(regional_results_1420)) {
#   # Compute baseline spread across EMs
#   baseline_spread[[region_name]] <- sd(anom_baseline[[region_name]], na.rm = TRUE) # Use sd directly
# }

# Initialize lists to store results
ensemble_anoms_1420 <- list()      # Mean anomalies for each region
ensemble_zscores_1420 <- list()   # Standard deviation of anomalies for each region

# Loop over regions to compute anomalies and z-scores
for (region_name in names(regional_results_1420)) {
  # Extract the ensemble members for the region
  ensemble_members <- regional_results_1420[[region_name]]  # Now using full ensemble data
  
  # Compute anomalies per ensemble member (subtract baseline)
  ensemble_anoms_1420[[region_name]] <- sweep(ensemble_members, 2, anom_baseline[[region_name]], "-")
  
  # Compute z-scores per ensemble member (divide by baseline standard deviation)
  ensemble_zscores_1420[[region_name]] <- sweep(ensemble_anoms_1420[[region_name]], 2, anom_baseline_sd[[region_name]], "/")
}

#mean z-scores for each region
# Initialize a list to store mean z-scores
mean_zscores_1420 <- list()

# Loop over regions
for (region_name in names(regional_results_1420)) {
  
  # Compute the mean z-score across ensemble members for each time step
  mean_zscores_1420[[region_name]] <- rowMeans(ensemble_zscores_1420[[region_name]], na.rm = TRUE)
}

# Initialize a list to store z-score standard deviations
sd_zscores_1420 <- list()

# Loop over regions
for (region_name in names(regional_results_1420)) {
  
  # Compute standard deviation of z-scores across ensemble members
  sd_zscores_1420[[region_name]] <- apply(ensemble_zscores_1420[[region_name]], 1, sd, na.rm = TRUE) #calc sd across rows (EMs)
}

########### 1420 period
# Convert z-score data into a data frame for ggplot
zscore_df_1420 <- do.call(rbind, lapply(names(mean_zscores_1420), function(region) {
  data.frame(
    time = seq(1420, 1849),  # Adjust time range accordingly
    mean_zscore = mean_zscores_1420[[region]],  
    sd_zscore = sd_zscores_1420[[region]],  # Standard deviation for uncertainty bands
    region = region
  )
}))


# Add a continent column to the SNR data frame
zscore_df_1420$continent <- NA  # Initialize continent column

for (continent in names(continent_mapping)) {
  zscore_df_1420$continent[zscore_df_1420$region %in% continent_mapping[[continent]]] <- continent
}

###################### 1850 epoch z-scores
# Initialize lists to store baselines and standard deviations
anom_baseline <- list()
anom_baseline_sd <- list()

# Loop over regions
for (region_name in names(regional_results_1850)) {
  
  # Extract all ensemble members for the region
  ensemble_members <- regional_results_1850[[region_name]]
  
  # Compute baseline mean (over first 30 years) for each ensemble member
  anom_baseline[[region_name]] <- colMeans(ensemble_members[1:30, ], na.rm = TRUE)
  
  # Compute baseline standard deviation (over first 30 years) for each ensemble member
  anom_baseline_sd[[region_name]] <- apply(ensemble_members[1:30, ], 2, sd, na.rm = TRUE) #calc sd across columns(years)
}


# Initialize lists to store results
ensemble_anoms_1850 <- list()      # Mean anomalies for each region
ensemble_zscores_1850 <- list()   # Standard deviation of anomalies for each region

# Loop over regions to compute anomalies and z-scores
for (region_name in names(regional_results_1850)) {
  # Extract the ensemble members for the region
  ensemble_members <- regional_results_1850[[region_name]]  # Now using full ensemble data
  
  # Compute anomalies per ensemble member (subtract baseline)
  ensemble_anoms_1850[[region_name]] <- sweep(ensemble_members, 2, anom_baseline[[region_name]], "-")
  
  # Compute z-scores per ensemble member (divide by baseline standard deviation)
  ensemble_zscores_1850[[region_name]] <- sweep(ensemble_anoms_1850[[region_name]], 2, anom_baseline_sd[[region_name]], "/")
}

#mean z-scores for each region
# Initialize a list to store mean z-scores
mean_zscores_1850 <- list()

# Loop over regions
for (region_name in names(regional_results_1850)) {
  
  # Compute the mean z-score across ensemble members for each time step
  mean_zscores_1850[[region_name]] <- rowMeans(ensemble_zscores_1850[[region_name]], na.rm = TRUE)
}

# Initialize a list to store z-score standard deviations
sd_zscores_1850 <- list()

# Loop over regions
for (region_name in names(regional_results_1850)) {
  
  # Compute standard deviation of z-scores across ensemble members
  sd_zscores_1850[[region_name]] <- apply(ensemble_zscores_1850[[region_name]], 1, sd, na.rm = TRUE) #calc sd across rows (EMs)
}

########### 1850 period
# Convert z-score data into a data frame for ggplot
zscore_df_1850 <- do.call(rbind, lapply(names(mean_zscores_1850), function(region) {
  data.frame(
    time = seq(1850, 2009),  # Adjust time range accordingly
    mean_zscore = mean_zscores_1850[[region]],  
    sd_zscore = sd_zscores_1850[[region]],  # Standard deviation for uncertainty bands
    region = region
  )
}))


# Add a continent column to the SNR data frame
zscore_df_1850$continent <- NA  # Initialize continent column

for (continent in names(continent_mapping)) {
  zscore_df_1850$continent[zscore_df_1850$region %in% continent_mapping[[continent]]] <- continent
}


```

plot z-score anomalies overlain with volcanic forcing for earlier epoch: 


```{r}
#plot all ensemble member z-scores for GIC region: 
# Extract the z-scores for the 'GIC' field (you can replace this with any other field if needed)
ensemble_data <- ensemble_zscores_1420$GIC

# Check the structure to confirm it is a matrix with dimensions 430 x 20
str(ensemble_data)

# Create a time vector for the x-axis (corresponding to 430 years from 1420 to 1849)
time <- 1420:1849

# Convert the data to a data frame and reshape it for plotting
ensemble_df <- as.data.frame(ensemble_data)
ensemble_df$time <- time  # Add the time variable

# Reshape the data to long format
library(tidyr)
ensemble_long <- ensemble_df %>%
  pivot_longer(cols = -time, names_to = "ensemble_member", values_to = "z_score")

# Plot all z-scores for ensemble members
library(ggplot2)
ggplot(ensemble_long, aes(x = time, y = z_score, group = ensemble_member), color = "black", linewidth=0.2) +
  geom_line() +
  labs(title = "Ensemble Member Z-Scores Over Time",
       x = "Year", y = "Z-Score") +
  theme_minimal() +
  theme(legend.position = "none")  # Optional: Hide legend if you don't need it

```


```{r}
#################all continents for 1420 epoch ###################################

## for Poster plots; have changed which regions are displayed by filtering for regions and the title description for NA and CA

#test to incorporate volcanic forcings also: 

#### Europe ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "Europe"
zscore_filtered <- zscore_df_1420 %>% filter(continent == selected_continent)

# Normalize AOD data to fit the anomalies scale
aod_min <- min(aod_annual_mean_1420$annual_mean_value, na.rm = TRUE)
aod_max <- max(aod_annual_mean_1420$annual_mean_value, na.rm = TRUE)
zscore_min <- min(zscore_filtered$mean_zscore, na.rm = TRUE)
zscore_max <- max(zscore_filtered$mean_zscore, na.rm = TRUE)

# Calculate scale factor to ensure zero alignment
aod_zero <- 0  # AOD zero point
zs_zero <- 0  # Anomalies zero point
scale_factor <- (zscore_max - zscore_min) / (aod_max - aod_min)  # Scale based on range

# Scale AOD values to match the anomalies scale
annual_mean <- aod_annual_mean_1420 %>%
  mutate(scaled_aod = (annual_mean_value - aod_zero) * scale_factor + zs_zero)

# Plot zscore time series
ggplot(zscore_filtered, aes(x = time, y = mean_zscore, color = "PCWD Z-Scores")) +
  geom_line(show.legend = TRUE) +  # Plot lines for each region
  geom_ribbon(aes(ymin = mean_zscore - sd_zscore, ymax = mean_zscore + sd_zscore, fill = "SD across EMs"), alpha = 0.3,color = NA, show.legend = TRUE) +  # Ribbon shaded area with no black outline
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  # geom_hline(yintercept = 2, color = "indianred", linetype = "dotted")+
  # geom_hline(yintercept = -2, color = "indianred", linetype = "dotted")+
  # Secondary Y-axis: Volcanic Forcing (AOD)
  geom_line(data = annual_mean, aes(x = year, y = scaled_aod, color = "Volcanic Forcing (AOD)"), linewidth = 0.5, linetype = "dotted", show.legend = TRUE) +
  labs(
    x = "Year",
    y = "z-score (w.r.t. 1420-1450)",
    title = paste("Annual PCWD Z-Scores for", selected_continent)
  ) +
  # Secondary axis transformation ensuring zero alignment
  scale_y_continuous(
    sec.axis = sec_axis(
      ~ (. - zs_zero) / scale_factor + aod_zero, 
      name = "Annual Mean AOD"
    )
  ) +
  # Manual color scale for legend
  scale_color_manual(
    values = c("PCWD Z-Scores" = "black", "Volcanic Forcing (AOD)" = "red"),
    labels = c("PCWD Z-Scores (Mean)", "Volcanic Forcing (AOD)")
  ) +
  scale_fill_manual(
    values = c("SD across EMs" = "honeydew4"), 
    labels = c("SD across EMs")
  ) +
    # Adjust legend appearance and keep the ribbon and line separate
  # Customize the legend to avoid the honeydew4 background around lines (using override.aes)
  guides(
    color = guide_legend(title = "Legend", 
                         order = 1, 
                         override.aes = list(fill = NA, shape = NA)),  # Remove background for color lines
    fill = guide_legend(title = "", order = 2)  # Fill scale: SD across Ensemble Members
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    legend.title = element_text(face = "bold"),
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "pink"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  facet_wrap(~region, scales = "free_y")  # Facet by region with independent y-axis scales


#### Asia ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "Asia"
zscore_filtered <- zscore_df_1420 %>% filter(continent == selected_continent)

# Normalize AOD data to fit the anomalies scale
aod_min <- min(aod_annual_mean_1420$annual_mean_value, na.rm = TRUE)
aod_max <- max(aod_annual_mean_1420$annual_mean_value, na.rm = TRUE)
zscore_min <- min(zscore_filtered$mean_zscore, na.rm = TRUE)
zscore_max <- max(zscore_filtered$mean_zscore, na.rm = TRUE)

# Calculate scale factor to ensure zero alignment
aod_zero <- 0  # AOD zero point
zs_zero <- 0  # Anomalies zero point
scale_factor <- (zscore_max - zscore_min) / (aod_max - aod_min)  # Scale based on range

# Scale AOD values to match the anomalies scale
annual_mean <- aod_annual_mean_1420 %>%
  mutate(scaled_aod = (annual_mean_value - aod_zero) * scale_factor + zs_zero)

# Plot zscore time series
ggplot(zscore_filtered, aes(x = time, y = mean_zscore, color = "PCWD Z-Scores")) +
  geom_line(show.legend = TRUE) +  # Plot lines for each region
  geom_ribbon(aes(ymin = mean_zscore - sd_zscore, ymax = mean_zscore + sd_zscore, fill = "SD across EMs"), alpha = 0.3,color = NA, show.legend = TRUE) +  # Ribbon shaded area with no black outline
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  # geom_hline(yintercept = 2, color = "indianred", linetype = "dotted")+
  # geom_hline(yintercept = -2, color = "indianred", linetype = "dotted")+
  # Secondary Y-axis: Volcanic Forcing (AOD)
  geom_line(data = annual_mean, aes(x = year, y = scaled_aod, color = "Volcanic Forcing (AOD)"), linewidth = 0.5, linetype = "dotted", show.legend = TRUE) +
  labs(
    x = "Year",
    y = "z-score (w.r.t. 1420-1450)",
    title = paste("Annual PCWD Z-Scores for", selected_continent)
  ) +
  # Secondary axis transformation ensuring zero alignment
  scale_y_continuous(
    sec.axis = sec_axis(
      ~ (. - zs_zero) / scale_factor + aod_zero, 
      name = "Annual Mean AOD"
    )
  ) +
  # Manual color scale for legend
  scale_color_manual(
    values = c("PCWD Z-Scores" = "black", "Volcanic Forcing (AOD)" = "red"),
    labels = c("PCWD Z-Scores (Mean)", "Volcanic Forcing (AOD)")
  ) +
  scale_fill_manual(
    values = c("SD across EMs" = "honeydew4"), 
    labels = c("SD across EMs")
  ) +
    # Adjust legend appearance and keep the ribbon and line separate
  # Customize the legend to avoid the grey background around lines (using override.aes)
  guides(
    color = guide_legend(title = "Legend", 
                         order = 1, 
                         override.aes = list(fill = NA, shape = NA)),  # Remove background for color lines
    fill = guide_legend(title = "", order = 2)  # Fill scale: SD across Ensemble Members
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    legend.title = element_text(face = "bold"),
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "orange"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  facet_wrap(~region, scales = "free_y")  # Facet by region with independent y-axis scales

#### Australia ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "Australia"
selected_region <- "CAU"
zscore_filtered <- zscore_df_1420 %>% filter(region == selected_region)

# Normalize AOD data to fit the anomalies scale
aod_min <- min(aod_annual_mean_1420$annual_mean_value, na.rm = TRUE)
aod_max <- max(aod_annual_mean_1420$annual_mean_value, na.rm = TRUE)
zscore_min <- min(zscore_filtered$mean_zscore, na.rm = TRUE)
zscore_max <- max(zscore_filtered$mean_zscore, na.rm = TRUE)

# Calculate scale factor to ensure zero alignment
aod_zero <- 0  # AOD zero point
zs_zero <- 0  # Anomalies zero point
scale_factor <- (zscore_max - zscore_min) / (aod_max - aod_min)  # Scale based on range

# Scale AOD values to match the anomalies scale
annual_mean <- aod_annual_mean_1420 %>%
  mutate(scaled_aod = (annual_mean_value - aod_zero) * scale_factor + zs_zero)

# Plot zscore time series
ggplot(zscore_filtered, aes(x = time, y = mean_zscore, color = "PCWD Z-Scores")) +
  geom_line(show.legend = TRUE) +  # Plot lines for each region
  geom_ribbon(aes(ymin = mean_zscore - sd_zscore, ymax = mean_zscore + sd_zscore, fill = "SD across EMs"), alpha = 0.3,color = NA, show.legend = TRUE) +  # Ribbon shaded area with no black outline
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  # geom_hline(yintercept = 2, color = "indianred", linetype = "dotted")+
  # geom_hline(yintercept = -2, color = "indianred", linetype = "dotted")+
  # Secondary Y-axis: Volcanic Forcing (AOD)
  geom_line(data = annual_mean, aes(x = year, y = scaled_aod, color = "Volcanic Forcing (AOD)"), linewidth = 0.5, linetype = "dotted", show.legend = TRUE) +
  labs(
    x = "Year",
    y = "z-score (w.r.t. 1420-1450)",
    title = paste("Annual PCWD Z-Scores for Central Australia (1420-1849)")
  ) +
  # Secondary axis transformation ensuring zero alignment
  scale_y_continuous(
    sec.axis = sec_axis(
      ~ (. - zs_zero) / scale_factor + aod_zero, 
      name = "Annual Mean AOD"
    )
  ) +
  # Manual color scale for legend
  scale_color_manual(
    values = c("PCWD Z-Scores" = "black", "Volcanic Forcing (AOD)" = "red"),
    labels = c("PCWD Z-Scores (Mean)", "Volcanic Forcing (AOD)")
  ) +
  scale_fill_manual(
    values = c("SD across EMs" = "honeydew4"), 
    labels = c("SD across EMs")
  ) +
    # Adjust legend appearance and keep the ribbon and line separate
  # Customize the legend to avoid the grey background around lines (using override.aes)
  guides(
    color = guide_legend(title = "Legend:", 
                         order = 1, 
                         override.aes = list(fill = NA, shape = NA)),  # Remove background for color lines
    fill = guide_legend(title = "", order = 2)  # Fill scale: SD across Ensemble Members
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    legend.title = element_text(),
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10, colour = "white"),  # Size for facet labels
    strip.background = element_rect(fill = "blue"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  facet_wrap(~region, scales = "free_y")  # Facet by region with independent y-axis scales

#### Africa ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "Africa"
zscore_filtered <- zscore_df_1420 %>% filter(continent == selected_continent)

# Normalize AOD data to fit the anomalies scale
aod_min <- min(aod_annual_mean_1420$annual_mean_value, na.rm = TRUE)
aod_max <- max(aod_annual_mean_1420$annual_mean_value, na.rm = TRUE)
zscore_min <- min(zscore_filtered$mean_zscore, na.rm = TRUE)
zscore_max <- max(zscore_filtered$mean_zscore, na.rm = TRUE)

# Calculate scale factor to ensure zero alignment
aod_zero <- 0  # AOD zero point
zs_zero <- 0  # Anomalies zero point
scale_factor <- (zscore_max - zscore_min) / (aod_max - aod_min)  # Scale based on range

# Scale AOD values to match the anomalies scale
annual_mean <- aod_annual_mean_1420 %>%
  mutate(scaled_aod = (annual_mean_value - aod_zero) * scale_factor + zs_zero)

# Plot zscore time series
ggplot(zscore_filtered, aes(x = time, y = mean_zscore, color = "PCWD Z-Scores")) +
  geom_line(show.legend = TRUE) +  # Plot lines for each region
  geom_ribbon(aes(ymin = mean_zscore - sd_zscore, ymax = mean_zscore + sd_zscore, fill = "SD across EMs"), alpha = 0.3,color = NA, show.legend = TRUE) +  # Ribbon shaded area with no black outline
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  # geom_hline(yintercept = 2, color = "indianred", linetype = "dotted")+
  # geom_hline(yintercept = -2, color = "indianred", linetype = "dotted")+
  # Secondary Y-axis: Volcanic Forcing (AOD)
  geom_line(data = annual_mean, aes(x = year, y = scaled_aod, color = "Volcanic Forcing (AOD)"), linewidth = 0.5, linetype = "dotted", show.legend = TRUE) +
  labs(
    x = "Year",
    y = "z-score (w.r.t. 1420-1450)",
    title = paste("Annual PCWD Z-Scores for", selected_continent)
  ) +
  # Secondary axis transformation ensuring zero alignment
  scale_y_continuous(
    sec.axis = sec_axis(
      ~ (. - zs_zero) / scale_factor + aod_zero, 
      name = "Annual Mean AOD"
    )
  ) +
  # Manual color scale for legend
  scale_color_manual(
    values = c("PCWD Z-Scores" = "black", "Volcanic Forcing (AOD)" = "red"),
    labels = c("PCWD Z-Scores (Mean)", "Volcanic Forcing (AOD)")
  ) +
  scale_fill_manual(
    values = c("SD across EMs" = "honeydew4"), 
    labels = c("SD across EMs")
  ) +
    # Adjust legend appearance and keep the ribbon and line separate
  # Customize the legend to avoid the grey background around lines (using override.aes)
  guides(
    color = guide_legend(title = "Legend", 
                         order = 1, 
                         override.aes = list(fill = NA, shape = NA)),  # Remove background for color lines
    fill = guide_legend(title = "", order = 2)  # Fill scale: SD across Ensemble Members
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    legend.title = element_text(face = "bold"),
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "purple"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  facet_wrap(~region, scales = "free_y")  # Facet by region with independent y-axis scales

#### North America ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "North America"
selected_region <- "WNA"
zscore_filtered <- zscore_df_1420 %>% filter(region == selected_region)

# Normalize AOD data to fit the anomalies scale
aod_min <- min(aod_annual_mean_1420$annual_mean_value, na.rm = TRUE)
aod_max <- max(aod_annual_mean_1420$annual_mean_value, na.rm = TRUE)
zscore_min <- min(zscore_filtered$mean_zscore, na.rm = TRUE)
zscore_max <- max(zscore_filtered$mean_zscore, na.rm = TRUE)

# Calculate scale factor to ensure zero alignment
aod_zero <- 0  # AOD zero point
zs_zero <- 0  # Anomalies zero point
scale_factor <- (zscore_max - zscore_min) / (aod_max - aod_min)  # Scale based on range

# Scale AOD values to match the anomalies scale
annual_mean <- aod_annual_mean_1420 %>%
  mutate(scaled_aod = (annual_mean_value - aod_zero) * scale_factor + zs_zero)

# Plot zscore time series
ggplot(zscore_filtered, aes(x = time, y = mean_zscore, color = "PCWD Z-Scores")) +
  geom_line(show.legend = TRUE) +  # Plot lines for each region
  geom_ribbon(aes(ymin = mean_zscore - sd_zscore, ymax = mean_zscore + sd_zscore, fill = "SD across EMs"), alpha = 0.3,color = NA, show.legend = TRUE) +  # Ribbon shaded area with no black outline
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  # geom_hline(yintercept = 2, color = "indianred", linetype = "dotted")+
  # geom_hline(yintercept = -2, color = "indianred", linetype = "dotted")+
  # Secondary Y-axis: Volcanic Forcing (AOD)
  geom_line(data = annual_mean, aes(x = year, y = scaled_aod, color = "Volcanic Forcing (AOD)"), linewidth = 0.5, linetype = "dotted", show.legend = TRUE) +
  labs(
    x = "Year",
    y = "z-score (w.r.t. 1420-1450)",
    title = paste("Annual PCWD Z-Scores for Western North America (1420-1849)")
  ) +
  # Secondary axis transformation ensuring zero alignment
  scale_y_continuous(
    sec.axis = sec_axis(
      ~ (. - zs_zero) / scale_factor + aod_zero, 
      name = "Annual Mean AOD"
    )
  ) +
  # Manual color scale for legend
  scale_color_manual(
    values = c("PCWD Z-Scores" = "black", "Volcanic Forcing (AOD)" = "red"),
    labels = c("PCWD Z-Scores (Mean)", "Volcanic Forcing (AOD)")
  ) +
  scale_fill_manual(
    values = c("SD across EMs" = "honeydew4"), 
    labels = c("SD across Ensemble")
  ) +
    # Adjust legend appearance and keep the ribbon and line separate
  # Customize the legend to avoid the grey background around lines (using override.aes)
  guides(
    color = guide_legend(title = "Legend:", 
                         order = 1, 
                         override.aes = list(fill = NA, shape = NA)),  # Remove background for color lines
    fill = guide_legend(title = "", order = 2)  # Fill scale: SD across Ensemble Members
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    legend.title = element_text(),
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "lightgreen"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  facet_wrap(~region, scales = "free_y")  # Facet by region with independent y-axis scales

#### Central America ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "Central America"
selected_region <- "NCA"
zscore_filtered <- zscore_df_1420 %>% filter(region == selected_region)

# Normalize AOD data to fit the anomalies scale
aod_min <- min(aod_annual_mean_1420$annual_mean_value, na.rm = TRUE)
aod_max <- max(aod_annual_mean_1420$annual_mean_value, na.rm = TRUE)
zscore_min <- min(zscore_filtered$mean_zscore, na.rm = TRUE)
zscore_max <- max(zscore_filtered$mean_zscore, na.rm = TRUE)

# Calculate scale factor to ensure zero alignment
aod_zero <- 0  # AOD zero point
zs_zero <- 0  # Anomalies zero point
scale_factor <- (zscore_max - zscore_min) / (aod_max - aod_min)  # Scale based on range

# Scale AOD values to match the anomalies scale
annual_mean <- aod_annual_mean_1420 %>%
  mutate(scaled_aod = (annual_mean_value - aod_zero) * scale_factor + zs_zero)

# Plot zscore time series
ggplot(zscore_filtered, aes(x = time, y = mean_zscore, color = "PCWD Z-Scores")) +
  geom_line(show.legend = TRUE) +  # Plot lines for each region
  geom_ribbon(aes(ymin = mean_zscore - sd_zscore, ymax = mean_zscore + sd_zscore, fill = "SD across EMs"), alpha = 0.3,color = NA, show.legend = TRUE) +  # Ribbon shaded area with no black outline
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  # geom_hline(yintercept = 2, color = "indianred", linetype = "dotted")+
  # geom_hline(yintercept = -2, color = "indianred", linetype = "dotted")+
  # Secondary Y-axis: Volcanic Forcing (AOD)
  geom_line(data = annual_mean, aes(x = year, y = scaled_aod, color = "Volcanic Forcing (AOD)"), linewidth = 0.5, linetype = "dotted", show.legend = TRUE) +
  labs(
    x = "Year",
    y = "z-score (w.r.t. 1420-1450)",
    title = paste("Annual PCWD Z-Scores for Northern Central America (1420-1849)")
  ) +
  # Secondary axis transformation ensuring zero alignment
  scale_y_continuous(
    sec.axis = sec_axis(
      ~ (. - zs_zero) / scale_factor + aod_zero, 
      name = "Annual Mean AOD"
    )
  ) +
  # Manual color scale for legend
  scale_color_manual(
    values = c("PCWD Z-Scores" = "black", "Volcanic Forcing (AOD)" = "red"),
    labels = c("PCWD Z-Scores (Mean)", "Volcanic Forcing (AOD)")
  ) +
  scale_fill_manual(
    values = c("SD across EMs" = "honeydew4"), 
    labels = c("SD across EMs")
  ) +
    # Adjust legend appearance and keep the ribbon and line separate
  # Customize the legend to avoid the grey background around lines (using override.aes)
  guides(
    color = guide_legend(title = "Legend:", 
                         order = 1, 
                         override.aes = list(fill = NA, shape = NA)),  # Remove background for color lines
    fill = guide_legend(title = "", order = 2)  # Fill scale: SD across Ensemble Members
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    legend.title = element_text(),
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "lightblue"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  facet_wrap(~region, scales = "free_y")  # Facet by region with independent y-axis scales

#### South America ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "South America"
zscore_filtered <- zscore_df_1420 %>% filter(continent == selected_continent)

# Normalize AOD data to fit the anomalies scale
aod_min <- min(aod_annual_mean_1420$annual_mean_value, na.rm = TRUE)
aod_max <- max(aod_annual_mean_1420$annual_mean_value, na.rm = TRUE)
zscore_min <- min(zscore_filtered$mean_zscore, na.rm = TRUE)
zscore_max <- max(zscore_filtered$mean_zscore, na.rm = TRUE)

# Calculate scale factor to ensure zero alignment
aod_zero <- 0  # AOD zero point
zs_zero <- 0  # Anomalies zero point
scale_factor <- (zscore_max - zscore_min) / (aod_max - aod_min)  # Scale based on range

# Scale AOD values to match the anomalies scale
annual_mean <- aod_annual_mean_1420 %>%
  mutate(scaled_aod = (annual_mean_value - aod_zero) * scale_factor + zs_zero)

# Plot zscore time series
ggplot(zscore_filtered, aes(x = time, y = mean_zscore, color = "PCWD Z-Scores")) +
  geom_line(show.legend = TRUE) +  # Plot lines for each region
  geom_ribbon(aes(ymin = mean_zscore - sd_zscore, ymax = mean_zscore + sd_zscore, fill = "SD across EMs"), alpha = 0.3,color = NA, show.legend = TRUE) +  # Ribbon shaded area with no black outline
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  # geom_hline(yintercept = 2, color = "indianred", linetype = "dotted")+
  # geom_hline(yintercept = -2, color = "indianred", linetype = "dotted")+
  # Secondary Y-axis: Volcanic Forcing (AOD)
  geom_line(data = annual_mean, aes(x = year, y = scaled_aod, color = "Volcanic Forcing (AOD)"), linewidth = 0.5, linetype = "dotted", show.legend = TRUE) +
  labs(
    x = "Year",
    y = "z-score (w.r.t. 1420-1450)",
    title = paste("Annual PCWD Z-Scores for", selected_continent)
  ) +
  # Secondary axis transformation ensuring zero alignment
  scale_y_continuous(
    sec.axis = sec_axis(
      ~ (. - zs_zero) / scale_factor + aod_zero, 
      name = "Annual Mean AOD"
    )
  ) +
  # Manual color scale for legend
  scale_color_manual(
    values = c("PCWD Z-Scores" = "black", "Volcanic Forcing (AOD)" = "red"),
    labels = c("PCWD Z-Scores (Mean)", "Volcanic Forcing (AOD)")
  ) +
  scale_fill_manual(
    values = c("SD across EMs" = "honeydew4"), 
    labels = c("SD across EMs")
  ) +
    # Adjust legend appearance and keep the ribbon and line separate
  # Customize the legend to avoid the grey background around lines (using override.aes)
  guides(
    color = guide_legend(title = "Legend", 
                         order = 1, 
                         override.aes = list(fill = NA, shape = NA)),  # Remove background for color lines
    fill = guide_legend(title = "", order = 2)  # Fill scale: SD across Ensemble Members
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    legend.title = element_text(face = "bold"),
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "yellow"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  facet_wrap(~region, scales = "free_y")  # Facet by region with independent y-axis scales


```

```{r}
#################all continents for 1850 epoch ###################################

## for Poster plots; have changed which regions are displayed by filtering for regions and the title description for NA and CA

#test to incorporate volcanic forcings also: 

#### Europe ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "Europe"
zscore_filtered <- zscore_df_1850 %>% filter(continent == selected_continent)

# Normalize AOD data to fit the anomalies scale
aod_min <- min(aod_annual_mean_1850$annual_mean_value, na.rm = TRUE)
aod_max <- max(aod_annual_mean_1850$annual_mean_value, na.rm = TRUE)
zscore_min <- min(zscore_filtered$mean_zscore, na.rm = TRUE)
zscore_max <- max(zscore_filtered$mean_zscore, na.rm = TRUE)

# Calculate scale factor to ensure zero alignment
aod_zero <- 0  # AOD zero point
zs_zero <- 0  # Anomalies zero point
scale_factor <- (zscore_max - zscore_min) / (aod_max - aod_min)  # Scale based on range

# Scale AOD values to match the anomalies scale
annual_mean <- aod_annual_mean_1850 %>%
  mutate(scaled_aod = (annual_mean_value - aod_zero) * scale_factor + zs_zero)

# Plot zscore time series
ggplot(zscore_filtered, aes(x = time, y = mean_zscore, color = "PCWD Z-Scores")) +
  geom_line(show.legend = TRUE) +  # Plot lines for each region
  geom_ribbon(aes(ymin = mean_zscore - sd_zscore, ymax = mean_zscore + sd_zscore, fill = "SD across EMs"), alpha = 0.3,color = NA, show.legend = TRUE) +  # Ribbon shaded area with no black outline
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  # geom_hline(yintercept = 2, color = "indianred", linetype = "dotted")+
  # geom_hline(yintercept = -2, color = "indianred", linetype = "dotted")+
  # Secondary Y-axis: Volcanic Forcing (AOD)
  geom_line(data = annual_mean, aes(x = year, y = scaled_aod, color = "Volcanic Forcing (AOD)"), linewidth = 0.5, linetype = "dotted", show.legend = TRUE) +
  labs(
    x = "Year",
    y = "z-score (w.r.t. 1850-1880)",
    title = paste("Annual PCWD Z-Scores for", selected_continent)
  ) +
  # Secondary axis transformation ensuring zero alignment
  scale_y_continuous(
    sec.axis = sec_axis(
      ~ (. - zs_zero) / scale_factor + aod_zero, 
      name = "Annual Mean AOD"
    )
  ) +
  # Manual color scale for legend
  scale_color_manual(
    values = c("PCWD Z-Scores" = "black", "Volcanic Forcing (AOD)" = "red"),
    labels = c("PCWD Z-Scores (Mean)", "Volcanic Forcing (AOD)")
  ) +
  scale_fill_manual(
    values = c("SD across EMs" = "honeydew4"), 
    labels = c("SD across EMs")
  ) +
    # Adjust legend appearance and keep the ribbon and line separate
  # Customize the legend to avoid the honeydew4 background around lines (using override.aes)
  guides(
    color = guide_legend(title = "Legend", 
                         order = 1, 
                         override.aes = list(fill = NA, shape = NA)),  # Remove background for color lines
    fill = guide_legend(title = "", order = 2)  # Fill scale: SD across Ensemble Members
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    legend.title = element_text(face = "bold"),
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "pink"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  facet_wrap(~region, scales = "free_y")  # Facet by region with independent y-axis scales


#### Asia ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "Asia"
zscore_filtered <- zscore_df_1850 %>% filter(continent == selected_continent)

# Normalize AOD data to fit the anomalies scale
aod_min <- min(aod_annual_mean_1850$annual_mean_value, na.rm = TRUE)
aod_max <- max(aod_annual_mean_1850$annual_mean_value, na.rm = TRUE)
zscore_min <- min(zscore_filtered$mean_zscore, na.rm = TRUE)
zscore_max <- max(zscore_filtered$mean_zscore, na.rm = TRUE)

# Calculate scale factor to ensure zero alignment
aod_zero <- 0  # AOD zero point
zs_zero <- 0  # Anomalies zero point
scale_factor <- (zscore_max - zscore_min) / (aod_max - aod_min)  # Scale based on range

# Scale AOD values to match the anomalies scale
annual_mean <- aod_annual_mean_1850 %>%
  mutate(scaled_aod = (annual_mean_value - aod_zero) * scale_factor + zs_zero)

# Plot zscore time series
ggplot(zscore_filtered, aes(x = time, y = mean_zscore, color = "PCWD Z-Scores")) +
  geom_line(show.legend = TRUE) +  # Plot lines for each region
  geom_ribbon(aes(ymin = mean_zscore - sd_zscore, ymax = mean_zscore + sd_zscore, fill = "SD across EMs"), alpha = 0.3,color = NA, show.legend = TRUE) +  # Ribbon shaded area with no black outline
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  # geom_hline(yintercept = 2, color = "indianred", linetype = "dotted")+
  # geom_hline(yintercept = -2, color = "indianred", linetype = "dotted")+
  # Secondary Y-axis: Volcanic Forcing (AOD)
  geom_line(data = annual_mean, aes(x = year, y = scaled_aod, color = "Volcanic Forcing (AOD)"), linewidth = 0.5, linetype = "dotted", show.legend = TRUE) +
  labs(
    x = "Year",
    y = "z-score (w.r.t. 1850-1880)",
    title = paste("Annual PCWD Z-Scores for", selected_continent)
  ) +
  # Secondary axis transformation ensuring zero alignment
  scale_y_continuous(
    sec.axis = sec_axis(
      ~ (. - zs_zero) / scale_factor + aod_zero, 
      name = "Annual Mean AOD"
    )
  ) +
  # Manual color scale for legend
  scale_color_manual(
    values = c("PCWD Z-Scores" = "black", "Volcanic Forcing (AOD)" = "red"),
    labels = c("PCWD Z-Scores (Mean)", "Volcanic Forcing (AOD)")
  ) +
  scale_fill_manual(
    values = c("SD across EMs" = "honeydew4"), 
    labels = c("SD across EMs")
  ) +
    # Adjust legend appearance and keep the ribbon and line separate
  # Customize the legend to avoid the grey background around lines (using override.aes)
  guides(
    color = guide_legend(title = "Legend", 
                         order = 1, 
                         override.aes = list(fill = NA, shape = NA)),  # Remove background for color lines
    fill = guide_legend(title = "", order = 2)  # Fill scale: SD across Ensemble Members
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    legend.title = element_text(face = "bold"),
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "orange"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  facet_wrap(~region, scales = "free_y")  # Facet by region with independent y-axis scales

#### Australia ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "Australia"
selected_region <- "CAU"
zscore_filtered <- zscore_df_1850 %>% filter(continent == selected_continent)

# Normalize AOD data to fit the anomalies scale
aod_min <- min(aod_annual_mean_1850$annual_mean_value, na.rm = TRUE)
aod_max <- max(aod_annual_mean_1850$annual_mean_value, na.rm = TRUE)
zscore_min <- min(zscore_filtered$mean_zscore, na.rm = TRUE)
zscore_max <- max(zscore_filtered$mean_zscore, na.rm = TRUE)

# Calculate scale factor to ensure zero alignment
aod_zero <- 0  # AOD zero point
zs_zero <- 0  # Anomalies zero point
scale_factor <- (zscore_max - zscore_min) / (aod_max - aod_min)  # Scale based on range

# Scale AOD values to match the anomalies scale
annual_mean <- aod_annual_mean_1850 %>%
  mutate(scaled_aod = (annual_mean_value - aod_zero) * scale_factor + zs_zero)

# Plot zscore time series
ggplot(zscore_filtered, aes(x = time, y = mean_zscore, color = "PCWD Z-Scores")) +
  geom_line(show.legend = TRUE) +  # Plot lines for each region
  geom_ribbon(aes(ymin = mean_zscore - sd_zscore, ymax = mean_zscore + sd_zscore, fill = "SD across EMs"), alpha = 0.3,color = NA, show.legend = TRUE) +  # Ribbon shaded area with no black outline
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  # geom_hline(yintercept = 2, color = "indianred", linetype = "dotted")+
  # geom_hline(yintercept = -2, color = "indianred", linetype = "dotted")+
  # Secondary Y-axis: Volcanic Forcing (AOD)
  geom_line(data = annual_mean, aes(x = year, y = scaled_aod, color = "Volcanic Forcing (AOD)"), linewidth = 0.5, linetype = "dotted", show.legend = TRUE) +
  labs(
    x = "Year",
    y = "z-score (w.r.t. 1850-1880)",
    title = paste("Annual PCWD Z-Scores for Central Australia (1850-1849)")
  ) +
  # Secondary axis transformation ensuring zero alignment
  scale_y_continuous(
    sec.axis = sec_axis(
      ~ (. - zs_zero) / scale_factor + aod_zero, 
      name = "Annual Mean AOD"
    )
  ) +
  # Manual color scale for legend
  scale_color_manual(
    values = c("PCWD Z-Scores" = "black", "Volcanic Forcing (AOD)" = "red"),
    labels = c("PCWD Z-Scores (Mean)", "Volcanic Forcing (AOD)")
  ) +
  scale_fill_manual(
    values = c("SD across EMs" = "honeydew4"), 
    labels = c("SD across EMs")
  ) +
    # Adjust legend appearance and keep the ribbon and line separate
  # Customize the legend to avoid the grey background around lines (using override.aes)
  guides(
    color = guide_legend(title = "Legend:", 
                         order = 1, 
                         override.aes = list(fill = NA, shape = NA)),  # Remove background for color lines
    fill = guide_legend(title = "", order = 2)  # Fill scale: SD across Ensemble Members
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    legend.title = element_text(),
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10, colour = "white"),  # Size for facet labels
    strip.background = element_rect(fill = "blue"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  facet_wrap(~region, scales = "free_y")  # Facet by region with independent y-axis scales

#### Africa ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "Africa"
zscore_filtered <- zscore_df_1850 %>% filter(continent == selected_continent)

# Normalize AOD data to fit the anomalies scale
aod_min <- min(aod_annual_mean_1850$annual_mean_value, na.rm = TRUE)
aod_max <- max(aod_annual_mean_1850$annual_mean_value, na.rm = TRUE)
zscore_min <- min(zscore_filtered$mean_zscore, na.rm = TRUE)
zscore_max <- max(zscore_filtered$mean_zscore, na.rm = TRUE)

# Calculate scale factor to ensure zero alignment
aod_zero <- 0  # AOD zero point
zs_zero <- 0  # Anomalies zero point
scale_factor <- (zscore_max - zscore_min) / (aod_max - aod_min)  # Scale based on range

# Scale AOD values to match the anomalies scale
annual_mean <- aod_annual_mean_1850 %>%
  mutate(scaled_aod = (annual_mean_value - aod_zero) * scale_factor + zs_zero)

# Plot zscore time series
ggplot(zscore_filtered, aes(x = time, y = mean_zscore, color = "PCWD Z-Scores")) +
  geom_line(show.legend = TRUE) +  # Plot lines for each region
  geom_ribbon(aes(ymin = mean_zscore - sd_zscore, ymax = mean_zscore + sd_zscore, fill = "SD across EMs"), alpha = 0.3,color = NA, show.legend = TRUE) +  # Ribbon shaded area with no black outline
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  # geom_hline(yintercept = 2, color = "indianred", linetype = "dotted")+
  # geom_hline(yintercept = -2, color = "indianred", linetype = "dotted")+
  # Secondary Y-axis: Volcanic Forcing (AOD)
  geom_line(data = annual_mean, aes(x = year, y = scaled_aod, color = "Volcanic Forcing (AOD)"), linewidth = 0.5, linetype = "dotted", show.legend = TRUE) +
  labs(
    x = "Year",
    y = "z-score (w.r.t. 1850-1880)",
    title = paste("Annual PCWD Z-Scores for", selected_continent)
  ) +
  # Secondary axis transformation ensuring zero alignment
  scale_y_continuous(
    sec.axis = sec_axis(
      ~ (. - zs_zero) / scale_factor + aod_zero, 
      name = "Annual Mean AOD"
    )
  ) +
  # Manual color scale for legend
  scale_color_manual(
    values = c("PCWD Z-Scores" = "black", "Volcanic Forcing (AOD)" = "red"),
    labels = c("PCWD Z-Scores (Mean)", "Volcanic Forcing (AOD)")
  ) +
  scale_fill_manual(
    values = c("SD across EMs" = "honeydew4"), 
    labels = c("SD across EMs")
  ) +
    # Adjust legend appearance and keep the ribbon and line separate
  # Customize the legend to avoid the grey background around lines (using override.aes)
  guides(
    color = guide_legend(title = "Legend", 
                         order = 1, 
                         override.aes = list(fill = NA, shape = NA)),  # Remove background for color lines
    fill = guide_legend(title = "", order = 2)  # Fill scale: SD across Ensemble Members
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    legend.title = element_text(face = "bold"),
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "purple"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  facet_wrap(~region, scales = "free_y")  # Facet by region with independent y-axis scales

#### North America ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "North America"
selected_region <- "WNA"
zscore_filtered <- zscore_df_1850 %>% filter(continent == selected_continent)

# Normalize AOD data to fit the anomalies scale
aod_min <- min(aod_annual_mean_1850$annual_mean_value, na.rm = TRUE)
aod_max <- max(aod_annual_mean_1850$annual_mean_value, na.rm = TRUE)
zscore_min <- min(zscore_filtered$mean_zscore, na.rm = TRUE)
zscore_max <- max(zscore_filtered$mean_zscore, na.rm = TRUE)

# Calculate scale factor to ensure zero alignment
aod_zero <- 0  # AOD zero point
zs_zero <- 0  # Anomalies zero point
scale_factor <- (zscore_max - zscore_min) / (aod_max - aod_min)  # Scale based on range

# Scale AOD values to match the anomalies scale
annual_mean <- aod_annual_mean_1850 %>%
  mutate(scaled_aod = (annual_mean_value - aod_zero) * scale_factor + zs_zero)

# Plot zscore time series
ggplot(zscore_filtered, aes(x = time, y = mean_zscore, color = "PCWD Z-Scores")) +
  geom_line(show.legend = TRUE) +  # Plot lines for each region
  geom_ribbon(aes(ymin = mean_zscore - sd_zscore, ymax = mean_zscore + sd_zscore, fill = "SD across EMs"), alpha = 0.3,color = NA, show.legend = TRUE) +  # Ribbon shaded area with no black outline
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  # geom_hline(yintercept = 2, color = "indianred", linetype = "dotted")+
  # geom_hline(yintercept = -2, color = "indianred", linetype = "dotted")+
  # Secondary Y-axis: Volcanic Forcing (AOD)
  geom_line(data = annual_mean, aes(x = year, y = scaled_aod, color = "Volcanic Forcing (AOD)"), linewidth = 0.5, linetype = "dotted", show.legend = TRUE) +
  labs(
    x = "Year",
    y = "z-score (w.r.t. 1850-1450)",
    title = paste("Annual PCWD Z-Scores for Western North America (1850-1849)")
  ) +
  # Secondary axis transformation ensuring zero alignment
  scale_y_continuous(
    sec.axis = sec_axis(
      ~ (. - zs_zero) / scale_factor + aod_zero, 
      name = "Annual Mean AOD"
    )
  ) +
  # Manual color scale for legend
  scale_color_manual(
    values = c("PCWD Z-Scores" = "black", "Volcanic Forcing (AOD)" = "red"),
    labels = c("PCWD Z-Scores (Mean)", "Volcanic Forcing (AOD)")
  ) +
  scale_fill_manual(
    values = c("SD across EMs" = "honeydew4"), 
    labels = c("SD across Ensemble")
  ) +
    # Adjust legend appearance and keep the ribbon and line separate
  # Customize the legend to avoid the grey background around lines (using override.aes)
  guides(
    color = guide_legend(title = "Legend:", 
                         order = 1, 
                         override.aes = list(fill = NA, shape = NA)),  # Remove background for color lines
    fill = guide_legend(title = "", order = 2)  # Fill scale: SD across Ensemble Members
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    legend.title = element_text(),
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "lightgreen"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  facet_wrap(~region, scales = "free_y")  # Facet by region with independent y-axis scales

#### Central America ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "Central America"
selected_region <- "NCA"
zscore_filtered <- zscore_df_1850 %>% filter(continent == selected_continent)

# Normalize AOD data to fit the anomalies scale
aod_min <- min(aod_annual_mean_1850$annual_mean_value, na.rm = TRUE)
aod_max <- max(aod_annual_mean_1850$annual_mean_value, na.rm = TRUE)
zscore_min <- min(zscore_filtered$mean_zscore, na.rm = TRUE)
zscore_max <- max(zscore_filtered$mean_zscore, na.rm = TRUE)

# Calculate scale factor to ensure zero alignment
aod_zero <- 0  # AOD zero point
zs_zero <- 0  # Anomalies zero point
scale_factor <- (zscore_max - zscore_min) / (aod_max - aod_min)  # Scale based on range

# Scale AOD values to match the anomalies scale
annual_mean <- aod_annual_mean_1850 %>%
  mutate(scaled_aod = (annual_mean_value - aod_zero) * scale_factor + zs_zero)

# Plot zscore time series
ggplot(zscore_filtered, aes(x = time, y = mean_zscore, color = "PCWD Z-Scores")) +
  geom_line(show.legend = TRUE) +  # Plot lines for each region
  geom_ribbon(aes(ymin = mean_zscore - sd_zscore, ymax = mean_zscore + sd_zscore, fill = "SD across EMs"), alpha = 0.3,color = NA, show.legend = TRUE) +  # Ribbon shaded area with no black outline
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  # geom_hline(yintercept = 2, color = "indianred", linetype = "dotted")+
  # geom_hline(yintercept = -2, color = "indianred", linetype = "dotted")+
  # Secondary Y-axis: Volcanic Forcing (AOD)
  geom_line(data = annual_mean, aes(x = year, y = scaled_aod, color = "Volcanic Forcing (AOD)"), linewidth = 0.5, linetype = "dotted", show.legend = TRUE) +
  labs(
    x = "Year",
    y = "z-score (w.r.t. 1850-1880)",
    title = paste("Annual PCWD Z-Scores for Northern Central America (1850-1849)")
  ) +
  # Secondary axis transformation ensuring zero alignment
  scale_y_continuous(
    sec.axis = sec_axis(
      ~ (. - zs_zero) / scale_factor + aod_zero, 
      name = "Annual Mean AOD"
    )
  ) +
  # Manual color scale for legend
  scale_color_manual(
    values = c("PCWD Z-Scores" = "black", "Volcanic Forcing (AOD)" = "red"),
    labels = c("PCWD Z-Scores (Mean)", "Volcanic Forcing (AOD)")
  ) +
  scale_fill_manual(
    values = c("SD across EMs" = "honeydew4"), 
    labels = c("SD across EMs")
  ) +
    # Adjust legend appearance and keep the ribbon and line separate
  # Customize the legend to avoid the grey background around lines (using override.aes)
  guides(
    color = guide_legend(title = "Legend:", 
                         order = 1, 
                         override.aes = list(fill = NA, shape = NA)),  # Remove background for color lines
    fill = guide_legend(title = "", order = 2)  # Fill scale: SD across Ensemble Members
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    legend.title = element_text(),
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "lightblue"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  facet_wrap(~region, scales = "free_y")  # Facet by region with independent y-axis scales

#### South America ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "South America"
zscore_filtered <- zscore_df_1850 %>% filter(continent == selected_continent)

# Normalize AOD data to fit the anomalies scale
aod_min <- min(aod_annual_mean_1850$annual_mean_value, na.rm = TRUE)
aod_max <- max(aod_annual_mean_1850$annual_mean_value, na.rm = TRUE)
zscore_min <- min(zscore_filtered$mean_zscore, na.rm = TRUE)
zscore_max <- max(zscore_filtered$mean_zscore, na.rm = TRUE)

# Calculate scale factor to ensure zero alignment
aod_zero <- 0  # AOD zero point
zs_zero <- 0  # Anomalies zero point
scale_factor <- (zscore_max - zscore_min) / (aod_max - aod_min)  # Scale based on range

# Scale AOD values to match the anomalies scale
annual_mean <- aod_annual_mean_1850 %>%
  mutate(scaled_aod = (annual_mean_value - aod_zero) * scale_factor + zs_zero)

# Plot zscore time series
ggplot(zscore_filtered, aes(x = time, y = mean_zscore, color = "PCWD Z-Scores")) +
  geom_line(show.legend = TRUE) +  # Plot lines for each region
  geom_ribbon(aes(ymin = mean_zscore - sd_zscore, ymax = mean_zscore + sd_zscore, fill = "SD across EMs"), alpha = 0.3,color = NA, show.legend = TRUE) +  # Ribbon shaded area with no black outline
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  # geom_hline(yintercept = 2, color = "indianred", linetype = "dotted")+
  # geom_hline(yintercept = -2, color = "indianred", linetype = "dotted")+
  # Secondary Y-axis: Volcanic Forcing (AOD)
  geom_line(data = annual_mean, aes(x = year, y = scaled_aod, color = "Volcanic Forcing (AOD)"), linewidth = 0.5, linetype = "dotted", show.legend = TRUE) +
  labs(
    x = "Year",
    y = "z-score (w.r.t. 1850-1880)",
    title = paste("Annual PCWD Z-Scores for", selected_continent)
  ) +
  # Secondary axis transformation ensuring zero alignment
  scale_y_continuous(
    sec.axis = sec_axis(
      ~ (. - zs_zero) / scale_factor + aod_zero, 
      name = "Annual Mean AOD"
    )
  ) +
  # Manual color scale for legend
  scale_color_manual(
    values = c("PCWD Z-Scores" = "black", "Volcanic Forcing (AOD)" = "red"),
    labels = c("PCWD Z-Scores (Mean)", "Volcanic Forcing (AOD)")
  ) +
  scale_fill_manual(
    values = c("SD across EMs" = "honeydew4"), 
    labels = c("SD across EMs")
  ) +
    # Adjust legend appearance and keep the ribbon and line separate
  # Customize the legend to avoid the grey background around lines (using override.aes)
  guides(
    color = guide_legend(title = "Legend", 
                         order = 1, 
                         override.aes = list(fill = NA, shape = NA)),  # Remove background for color lines
    fill = guide_legend(title = "", order = 2)  # Fill scale: SD across Ensemble Members
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    legend.title = element_text(face = "bold"),
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "yellow"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  facet_wrap(~region, scales = "free_y")  # Facet by region with independent y-axis scales


```

Calculate z-scores (for 30 year moving window-climatic anomalies):

Interpreting the Z-Scores
- z = 0 → Anomaly is equal to the baseline mean.
- z = ±1 → Anomaly is one standard deviation from the baseline.
- z > ±2 → Strong anomaly, may indicate a significant departure from normal variability.
- z > ±3 → Extreme anomaly, suggesting an event outside typical variability.

```{r}
# Initialize list to store rolling 30-year means
rolling_means <- list()

# Define window size
window_size <- 30

# Compute rolling means for each ensemble member
for (region_name in names(regional_results_1420)) {
  
  # Extract ensemble members for the region
  ensemble_members <- regional_results_1420[[region_name]]
  num_years <- nrow(ensemble_members)
  
  # Initialize matrix to store rolling means
  rolling_mean_matrix <- matrix(NA, nrow=num_years - window_size + 1, ncol=ncol(ensemble_members))
  
  # Compute rolling means
  for (t in 1:(num_years - window_size + 1)) {
    rolling_mean_matrix[t, ] <- colMeans(ensemble_members[t:(t+window_size-1), ], na.rm = TRUE)
  }
  
  # Store rolling means
  rolling_means[[region_name]] <- rolling_mean_matrix
}

# Initialize lists to store baselines and standard deviations
anom_baseline <- list()
anom_baseline_sd <- list()

# Compute baseline mean and standard deviation from the first 30 values of rolling mean
for (region_name in names(rolling_means)) {
  rolling_mean_matrix <- rolling_means[[region_name]]
  
  anom_baseline[[region_name]] <- colMeans(rolling_mean_matrix[1:30, ], na.rm = TRUE)
  anom_baseline_sd[[region_name]] <- apply(rolling_mean_matrix[1:30, ], 2, sd, na.rm = TRUE)
}

# Initialize lists to store z-scores
ensemble_zscores_1420 <- list()

# Compute z-scores
for (region_name in names(rolling_means)) {
  rolling_mean_matrix <- rolling_means[[region_name]]
  num_years <- nrow(rolling_mean_matrix)
  
  # Initialize matrix to store z-scores
  z_scores <- matrix(NA, nrow=num_years, ncol=ncol(rolling_mean_matrix))
  
  # Compute z-scores using rolling mean baseline
  for (t in 1:num_years) {
    z_scores[t, ] <- (rolling_mean_matrix[t, ] - anom_baseline[[region_name]]) / anom_baseline_sd[[region_name]]
  }
  
  # Store results
  ensemble_zscores_1420[[region_name]] <- z_scores
}

# Compute mean z-scores across ensemble members
mean_zscores_1420 <- list()
for (region_name in names(ensemble_zscores_1420)) {
  mean_zscores_1420[[region_name]] <- rowMeans(ensemble_zscores_1420[[region_name]], na.rm = TRUE)
}

# Compute standard deviation of z-scores across ensemble members
sd_zscores_1420 <- list()
for (region_name in names(ensemble_zscores_1420)) {
  sd_zscores_1420[[region_name]] <- apply(ensemble_zscores_1420[[region_name]], 1, sd, na.rm = TRUE)
}


####################### 1850 epoch z-scores
# Initialize list to store rolling 30-year means
rolling_means_1850 <- list()

# Define window size
window_size <- 30

# Compute rolling means for each ensemble member
for (region_name in names(regional_results_1850)) {
  
  # Extract ensemble members for the region
  ensemble_members <- regional_results_1850[[region_name]]
  num_years <- nrow(ensemble_members)
  
  # Initialize matrix to store rolling means
  rolling_mean_matrix <- matrix(NA, nrow=num_years - window_size + 1, ncol=ncol(ensemble_members))
  
  # Compute rolling means
  for (t in 1:(num_years - window_size + 1)) {
    rolling_mean_matrix[t, ] <- colMeans(ensemble_members[t:(t+window_size-1), ], na.rm = TRUE)
  }
  
  # Store rolling means
  rolling_means_1850[[region_name]] <- rolling_mean_matrix
}

# Initialize lists to store baselines and standard deviations
anom_baseline_1850 <- list()
anom_baseline_sd_1850 <- list()

# Compute baseline mean and standard deviation from the first 30 values of rolling mean
for (region_name in names(rolling_means_1850)) {
  rolling_mean_matrix <- rolling_means_1850[[region_name]]
  
  anom_baseline_1850[[region_name]] <- colMeans(rolling_mean_matrix[1:30, ], na.rm = TRUE)
  anom_baseline_sd_1850[[region_name]] <- apply(rolling_mean_matrix[1:30, ], 2, sd, na.rm = TRUE)
}

# Initialize lists to store z-scores
ensemble_zscores_1850 <- list()

# Compute z-scores
for (region_name in names(rolling_means_1850)) {
  rolling_mean_matrix <- rolling_means_1850[[region_name]]
  num_years <- nrow(rolling_mean_matrix)
  
  # Initialize matrix to store z-scores
  z_scores <- matrix(NA, nrow=num_years, ncol=ncol(rolling_mean_matrix))
  
  # Compute z-scores using rolling mean baseline
  for (t in 1:num_years) {
    z_scores[t, ] <- (rolling_mean_matrix[t, ] - anom_baseline_1850[[region_name]]) / anom_baseline_sd_1850[[region_name]]
  }
  
  # Store results
  ensemble_zscores_1850[[region_name]] <- z_scores
}

# Compute mean z-scores across ensemble members
mean_zscores_1850 <- list()
for (region_name in names(ensemble_zscores_1850)) {
  mean_zscores_1850[[region_name]] <- rowMeans(ensemble_zscores_1850[[region_name]], na.rm = TRUE)
}

# Compute standard deviation of z-scores across ensemble members
sd_zscores_1850 <- list()
for (region_name in names(ensemble_zscores_1850)) {
  sd_zscores_1850[[region_name]] <- apply(ensemble_zscores_1850[[region_name]], 1, sd, na.rm = TRUE)
}



```

Convert to dataframes for plotting: 

```{r}
########### 1420 period
# Convert z-score data into a data frame for ggplot
zscore_df_1420 <- do.call(rbind, lapply(names(mean_zscores_1420), function(region) {
  data.frame(
    time = seq(1435, 1835),  # Adjust time range accordingly
    mean_zscore = mean_zscores_1420[[region]],  
    sd_zscore = sd_zscores_1420[[region]],  # Standard deviation for uncertainty bands
    region = region
  )
}))

continent_mapping <- list(
  "Europe" = c("NEU", "MED"),
  "North America" = c( "ENA", "WNA"),
  "Africa" = c("SAH", "WAF", "CAF", "NEAF", "SEAF", "WSAF", "ESAF", "MDG"),
  "Asia" = c("WCA", "ECA", "TIB", "EAS", "ARP", "SAS", "SEA", "WSB", "ESB", "RFE", "RAR"),
  "Central America" =c("NCA"),
  "South America" = c("NSA"),
  "Australia" = c("NAU", "CAU", "EAU", "SAU", "NZ")
)


# Add a continent column to the SNR data frame
zscore_df_1420$continent <- NA  # Initialize continent column

for (continent in names(continent_mapping)) {
  zscore_df_1420$continent[zscore_df_1420$region %in% continent_mapping[[continent]]] <- continent
}


###### 1850 period
# Convert z-score data into a data frame for ggplot
zscore_df_1850 <- do.call(rbind, lapply(names(mean_zscores_1850), function(region) {
  data.frame(
    time = seq(1865, 1995),  # Adjust time range accordingly
    mean_zscore = mean_zscores_1850[[region]],  
    sd_zscore = sd_zscores_1850[[region]],  # Standard deviation for uncertainty bands
    region = region
  )
}))

##### for poster: only show selected regions
continent_mapping <- list(
  "Europe" = c("NEU", "MED"),
  "North America" = c( "ENA", "WNA"),
  "Africa" = c("SAH", "WAF", "CAF", "NEAF", "SEAF", "WSAF", "ESAF", "MDG"),
  "Asia" = c("WCA", "ECA", "TIB", "EAS", "ARP", "SAS", "SEA", "WSB", "ESB", "RFE", "RAR"),
  "Central America" =c("NCA", "SCA", "CAR"),
  "South America" = c("NSA"),
  "Australia" = c("NAU", "CAU", "EAU", "SAU", "NZ")
)

# Add a continent column to the SNR data frame
zscore_df_1850$continent <- NA  # Initialize continent column

for (continent in names(continent_mapping)) {
  zscore_df_1850$continent[zscore_df_1850$region %in% continent_mapping[[continent]]] <- continent
}

```

test plot with volcanic forcing overlay: 
```{r}
#################all continents for 1420 epoch ###################################
#test to incorporate volcanic forcings also: 

#### Europe ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "Europe"
zscore_filtered <- zscore_df_1420 %>% filter(continent == selected_continent)

# Normalize AOD data to fit the anomalies scale
aod_min <- min(aod_annual_mean_1420$annual_mean_value, na.rm = TRUE)
aod_max <- max(aod_annual_mean_1420$annual_mean_value, na.rm = TRUE)
zscore_min <- min(zscore_filtered$mean_zscore, na.rm = TRUE)
zscore_max <- max(zscore_filtered$mean_zscore, na.rm = TRUE)

# Calculate scale factor to ensure zero alignment
aod_zero <- 0  # AOD zero point
zs_zero <- 0  # Anomalies zero point
scale_factor <- (zscore_max - zscore_min) / (aod_max - aod_min)  # Scale based on range

# Scale AOD values to match the anomalies scale
annual_mean <- aod_annual_mean_1420 %>%
  mutate(scaled_aod = (annual_mean_value - aod_zero) * scale_factor + zs_zero)

# Plot zscore time series
ggplot(zscore_filtered, aes(x = time, y = mean_zscore, color = "PCWD Z-Scores")) +
  geom_line(show.legend = TRUE) +  # Plot lines for each region
  geom_ribbon(aes(ymin = mean_zscore - sd_zscore, ymax = mean_zscore + sd_zscore, fill = "SD across EMs"), alpha = 0.3,color = NA, show.legend = TRUE) +  # Ribbon shaded area with no black outline
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  # geom_hline(yintercept = 2, color = "indianred", linetype = "dotted")+
  # geom_hline(yintercept = -2, color = "indianred", linetype = "dotted")+
  # Secondary Y-axis: Volcanic Forcing (AOD)
  geom_line(data = annual_mean, aes(x = year, y = scaled_aod, color = "Volcanic Forcing (AOD)"), linewidth = 0.5, linetype = "dotted", show.legend = TRUE) +
  labs(
    x = "Year",
    y = "z-score (w.r.t. 1420-1450)",
    title = paste("EM PCWD (clim) Z-Scores for", selected_continent)
  ) +
  # Secondary axis transformation ensuring zero alignment
  scale_y_continuous(
    sec.axis = sec_axis(
      ~ (. - zs_zero) / scale_factor + aod_zero, 
      name = "Annual Mean AOD"
    )
  ) +
  # Manual color scale for legend
  scale_color_manual(
    values = c("PCWD Z-Scores" = "black", "Volcanic Forcing (AOD)" = "red"),
    labels = c("PCWD Z-Scores (Mean)", "Volcanic Forcing (AOD)")
  ) +
  scale_fill_manual(
    values = c("SD across EMs" = "honeydew4"), 
    labels = c("SD across EMs")
  ) +
    # Adjust legend appearance and keep the ribbon and line separate
  # Customize the legend to avoid the grey background around lines (using override.aes)
  guides(
    color = guide_legend(title = "Legend", 
                         order = 1, 
                         override.aes = list(fill = NA, shape = NA)),  # Remove background for color lines
    fill = guide_legend(title = "", order = 2)  # Fill scale: SD across Ensemble Members
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    legend.title = element_text(face = "bold"),
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "pink"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  facet_wrap(~region, scales = "free_y")  # Facet by region with independent y-axis scales


#### Asia ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "Asia"
zscore_filtered <- zscore_df_1420 %>% filter(continent == selected_continent)

# Normalize AOD data to fit the anomalies scale
aod_min <- min(aod_annual_mean_1420$annual_mean_value, na.rm = TRUE)
aod_max <- max(aod_annual_mean_1420$annual_mean_value, na.rm = TRUE)
zscore_min <- min(zscore_filtered$mean_zscore, na.rm = TRUE)
zscore_max <- max(zscore_filtered$mean_zscore, na.rm = TRUE)

# Calculate scale factor to ensure zero alignment
aod_zero <- 0  # AOD zero point
zs_zero <- 0  # Anomalies zero point
scale_factor <- (zscore_max - zscore_min) / (aod_max - aod_min)  # Scale based on range

# Scale AOD values to match the anomalies scale
annual_mean <- aod_annual_mean_1420 %>%
  mutate(scaled_aod = (annual_mean_value - aod_zero) * scale_factor + zs_zero)

# Plot zscore time series
ggplot(zscore_filtered, aes(x = time, y = mean_zscore, color = "PCWD Z-Scores")) +
  geom_line(show.legend = TRUE) +  # Plot lines for each region
  geom_ribbon(aes(ymin = mean_zscore - sd_zscore, ymax = mean_zscore + sd_zscore, fill = "SD across EMs"), alpha = 0.3,color = NA, show.legend = TRUE) +  # Ribbon shaded area with no black outline
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  # geom_hline(yintercept = 2, color = "indianred", linetype = "dotted")+
  # geom_hline(yintercept = -2, color = "indianred", linetype = "dotted")+
  # Secondary Y-axis: Volcanic Forcing (AOD)
  geom_line(data = annual_mean, aes(x = year, y = scaled_aod, color = "Volcanic Forcing (AOD)"), linewidth = 0.5, linetype = "dotted", show.legend = TRUE) +
  labs(
    x = "Year",
    y = "z-score (w.r.t. 1420-1450)",
    title = paste("EM PCWD (clim) Z-Scores for", selected_continent)
  ) +
  # Secondary axis transformation ensuring zero alignment
  scale_y_continuous(
    sec.axis = sec_axis(
      ~ (. - zs_zero) / scale_factor + aod_zero, 
      name = "Annual Mean AOD"
    )
  ) +
  # Manual color scale for legend
  scale_color_manual(
    values = c("PCWD Z-Scores" = "black", "Volcanic Forcing (AOD)" = "red"),
    labels = c("PCWD Z-Scores (Mean)", "Volcanic Forcing (AOD)")
  ) +
  scale_fill_manual(
    values = c("SD across EMs" = "honeydew4"), 
    labels = c("SD across EMs")
  ) +
    # Adjust legend appearance and keep the ribbon and line separate
  # Customize the legend to avoid the grey background around lines (using override.aes)
  guides(
    color = guide_legend(title = "Legend", 
                         order = 1, 
                         override.aes = list(fill = NA, shape = NA)),  # Remove background for color lines
    fill = guide_legend(title = "", order = 2)  # Fill scale: SD across Ensemble Members
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    legend.title = element_text(face = "bold"),
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "orange"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  facet_wrap(~region, scales = "free_y")  # Facet by region with independent y-axis scales

#### Australia ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "Australia"
zscore_filtered <- zscore_df_1420 %>% filter(continent == selected_continent)

# Normalize AOD data to fit the anomalies scale
aod_min <- min(aod_annual_mean_1420$annual_mean_value, na.rm = TRUE)
aod_max <- max(aod_annual_mean_1420$annual_mean_value, na.rm = TRUE)
zscore_min <- min(zscore_filtered$mean_zscore, na.rm = TRUE)
zscore_max <- max(zscore_filtered$mean_zscore, na.rm = TRUE)

# Calculate scale factor to ensure zero alignment
aod_zero <- 0  # AOD zero point
zs_zero <- 0  # Anomalies zero point
scale_factor <- (zscore_max - zscore_min) / (aod_max - aod_min)  # Scale based on range

# Scale AOD values to match the anomalies scale
annual_mean <- aod_annual_mean_1420 %>%
  mutate(scaled_aod = (annual_mean_value - aod_zero) * scale_factor + zs_zero)

# Plot zscore time series
ggplot(zscore_filtered, aes(x = time, y = mean_zscore, color = "PCWD Z-Scores")) +
  geom_line(show.legend = TRUE) +  # Plot lines for each region
  geom_ribbon(aes(ymin = mean_zscore - sd_zscore, ymax = mean_zscore + sd_zscore, fill = "SD across EMs"), alpha = 0.3,color = NA, show.legend = TRUE) +  # Ribbon shaded area with no black outline
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  # geom_hline(yintercept = 2, color = "indianred", linetype = "dotted")+
  # geom_hline(yintercept = -2, color = "indianred", linetype = "dotted")+
  # Secondary Y-axis: Volcanic Forcing (AOD)
  geom_line(data = annual_mean, aes(x = year, y = scaled_aod, color = "Volcanic Forcing (AOD)"), linewidth = 0.5, linetype = "dotted", show.legend = TRUE) +
  labs(
    x = "Year",
    y = "z-score (w.r.t. 1420-1450)",
    title = paste("EM PCWD (clim) Z-Scores for", selected_continent)
  ) +
  # Secondary axis transformation ensuring zero alignment
  scale_y_continuous(
    sec.axis = sec_axis(
      ~ (. - zs_zero) / scale_factor + aod_zero, 
      name = "Annual Mean AOD"
    )
  ) +
  # Manual color scale for legend
  scale_color_manual(
    values = c("PCWD Z-Scores" = "black", "Volcanic Forcing (AOD)" = "red"),
    labels = c("PCWD Z-Scores (Mean)", "Volcanic Forcing (AOD)")
  ) +
  scale_fill_manual(
    values = c("SD across EMs" = "honeydew4"), 
    labels = c("SD across EMs")
  ) +
    # Adjust legend appearance and keep the ribbon and line separate
  # Customize the legend to avoid the grey background around lines (using override.aes)
  guides(
    color = guide_legend(title = "Legend", 
                         order = 1, 
                         override.aes = list(fill = NA, shape = NA)),  # Remove background for color lines
    fill = guide_legend(title = "", order = 2)  # Fill scale: SD across Ensemble Members
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    legend.title = element_text(face = "bold"),
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10, colour="white"),  # Size for facet labels
    strip.background = element_rect(fill = "blue"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  facet_wrap(~region, scales = "free_y")  # Facet by region with independent y-axis scales

#### Africa ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "Africa"
zscore_filtered <- zscore_df_1420 %>% filter(continent == selected_continent)

# Normalize AOD data to fit the anomalies scale
aod_min <- min(aod_annual_mean_1420$annual_mean_value, na.rm = TRUE)
aod_max <- max(aod_annual_mean_1420$annual_mean_value, na.rm = TRUE)
zscore_min <- min(zscore_filtered$mean_zscore, na.rm = TRUE)
zscore_max <- max(zscore_filtered$mean_zscore, na.rm = TRUE)

# Calculate scale factor to ensure zero alignment
aod_zero <- 0  # AOD zero point
zs_zero <- 0  # Anomalies zero point
scale_factor <- (zscore_max - zscore_min) / (aod_max - aod_min)  # Scale based on range

# Scale AOD values to match the anomalies scale
annual_mean <- aod_annual_mean_1420 %>%
  mutate(scaled_aod = (annual_mean_value - aod_zero) * scale_factor + zs_zero)

# Plot zscore time series
ggplot(zscore_filtered, aes(x = time, y = mean_zscore, color = "PCWD Z-Scores")) +
  geom_line(show.legend = TRUE) +  # Plot lines for each region
  geom_ribbon(aes(ymin = mean_zscore - sd_zscore, ymax = mean_zscore + sd_zscore, fill = "SD across EMs"), alpha = 0.3,color = NA, show.legend = TRUE) +  # Ribbon shaded area with no black outline
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  # geom_hline(yintercept = 2, color = "indianred", linetype = "dotted")+
  # geom_hline(yintercept = -2, color = "indianred", linetype = "dotted")+
  # Secondary Y-axis: Volcanic Forcing (AOD)
  geom_line(data = annual_mean, aes(x = year, y = scaled_aod, color = "Volcanic Forcing (AOD)"), linewidth = 0.5, linetype = "dotted", show.legend = TRUE) +
  labs(
    x = "Year",
    y = "z-score (w.r.t. 1420-1450)",
    title = paste("EM PCWD (clim) Z-Scores for", selected_continent)
  ) +
  # Secondary axis transformation ensuring zero alignment
  scale_y_continuous(
    sec.axis = sec_axis(
      ~ (. - zs_zero) / scale_factor + aod_zero, 
      name = "Annual Mean AOD"
    )
  ) +
  # Manual color scale for legend
  scale_color_manual(
    values = c("PCWD Z-Scores" = "black", "Volcanic Forcing (AOD)" = "red"),
    labels = c("PCWD Z-Scores (Mean)", "Volcanic Forcing (AOD)")
  ) +
  scale_fill_manual(
    values = c("SD across EMs" = "honeydew4"), 
    labels = c("SD across EMs")
  ) +
    # Adjust legend appearance and keep the ribbon and line separate
  # Customize the legend to avoid the grey background around lines (using override.aes)
  guides(
    color = guide_legend(title = "Legend", 
                         order = 1, 
                         override.aes = list(fill = NA, shape = NA)),  # Remove background for color lines
    fill = guide_legend(title = "", order = 2)  # Fill scale: SD across Ensemble Members
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    legend.title = element_text(face = "bold"),
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "purple"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  facet_wrap(~region, scales = "free_y")  # Facet by region with independent y-axis scales

#### North America ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "North America"
zscore_filtered <- zscore_df_1420 %>% filter(continent == selected_continent)

# Normalize AOD data to fit the anomalies scale
aod_min <- min(aod_annual_mean_1420$annual_mean_value, na.rm = TRUE)
aod_max <- max(aod_annual_mean_1420$annual_mean_value, na.rm = TRUE)
zscore_min <- min(zscore_filtered$mean_zscore, na.rm = TRUE)
zscore_max <- max(zscore_filtered$mean_zscore, na.rm = TRUE)

# Calculate scale factor to ensure zero alignment
aod_zero <- 0  # AOD zero point
zs_zero <- 0  # Anomalies zero point
scale_factor <- (zscore_max - zscore_min) / (aod_max - aod_min)  # Scale based on range

# Scale AOD values to match the anomalies scale
annual_mean <- aod_annual_mean_1420 %>%
  mutate(scaled_aod = (annual_mean_value - aod_zero) * scale_factor + zs_zero)

# Plot zscore time series
ggplot(zscore_filtered, aes(x = time, y = mean_zscore, color = "PCWD Z-Scores")) +
  geom_line(show.legend = TRUE) +  # Plot lines for each region
  geom_ribbon(aes(ymin = mean_zscore - sd_zscore, ymax = mean_zscore + sd_zscore, fill = "SD across EMs"), alpha = 0.3,color = NA, show.legend = TRUE) +  # Ribbon shaded area with no black outline
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  # geom_hline(yintercept = 2, color = "indianred", linetype = "dotted")+
  # geom_hline(yintercept = -2, color = "indianred", linetype = "dotted")+
  # Secondary Y-axis: Volcanic Forcing (AOD)
  geom_line(data = annual_mean, aes(x = year, y = scaled_aod, color = "Volcanic Forcing (AOD)"), linewidth = 0.5, linetype = "dotted", show.legend = TRUE) +
  labs(
    x = "Year",
    y = "z-score (w.r.t. 1420-1450)",
    title = paste("EM PCWD (clim) Z-Scores for", selected_continent)
  ) +
  # Secondary axis transformation ensuring zero alignment
  scale_y_continuous(
    sec.axis = sec_axis(
      ~ (. - zs_zero) / scale_factor + aod_zero, 
      name = "Annual Mean AOD"
    )
  ) +
  # Manual color scale for legend
  scale_color_manual(
    values = c("PCWD Z-Scores" = "black", "Volcanic Forcing (AOD)" = "red"),
    labels = c("PCWD Z-Scores (Mean)", "Volcanic Forcing (AOD)")
  ) +
  scale_fill_manual(
    values = c("SD across EMs" = "honeydew4"), 
    labels = c("SD across EMs")
  ) +
    # Adjust legend appearance and keep the ribbon and line separate
  # Customize the legend to avoid the grey background around lines (using override.aes)
  guides(
    color = guide_legend(title = "Legend", 
                         order = 1, 
                         override.aes = list(fill = NA, shape = NA)),  # Remove background for color lines
    fill = guide_legend(title = "", order = 2)  # Fill scale: SD across Ensemble Members
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    legend.title = element_text(face = "bold"),
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "lightgreen"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  facet_wrap(~region, scales = "free_y")  # Facet by region with independent y-axis scales

#### Central America ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "Central America"
zscore_filtered <- zscore_df_1420 %>% filter(continent == selected_continent)

# Normalize AOD data to fit the anomalies scale
aod_min <- min(aod_annual_mean_1420$annual_mean_value, na.rm = TRUE)
aod_max <- max(aod_annual_mean_1420$annual_mean_value, na.rm = TRUE)
zscore_min <- min(zscore_filtered$mean_zscore, na.rm = TRUE)
zscore_max <- max(zscore_filtered$mean_zscore, na.rm = TRUE)

# Calculate scale factor to ensure zero alignment
aod_zero <- 0  # AOD zero point
zs_zero <- 0  # Anomalies zero point
scale_factor <- (zscore_max - zscore_min) / (aod_max - aod_min)  # Scale based on range

# Scale AOD values to match the anomalies scale
annual_mean <- aod_annual_mean_1420 %>%
  mutate(scaled_aod = (annual_mean_value - aod_zero) * scale_factor + zs_zero)

# Plot zscore time series
ggplot(zscore_filtered, aes(x = time, y = mean_zscore, color = "PCWD Z-Scores")) +
  geom_line(show.legend = TRUE) +  # Plot lines for each region
  geom_ribbon(aes(ymin = mean_zscore - sd_zscore, ymax = mean_zscore + sd_zscore, fill = "SD across EMs"), alpha = 0.3,color = NA, show.legend = TRUE) +  # Ribbon shaded area with no black outline
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  # geom_hline(yintercept = 2, color = "indianred", linetype = "dotted")+
  # geom_hline(yintercept = -2, color = "indianred", linetype = "dotted")+
  # Secondary Y-axis: Volcanic Forcing (AOD)
  geom_line(data = annual_mean, aes(x = year, y = scaled_aod, color = "Volcanic Forcing (AOD)"), linewidth = 0.5, linetype = "dotted", show.legend = TRUE) +
  labs(
    x = "Year",
    y = "z-score (w.r.t. 1420-1450)",
    title = paste("EM PCWD (clim) Z-Scores for", selected_continent)
  ) +
  # Secondary axis transformation ensuring zero alignment
  scale_y_continuous(
    sec.axis = sec_axis(
      ~ (. - zs_zero) / scale_factor + aod_zero, 
      name = "Annual Mean AOD"
    )
  ) +
  # Manual color scale for legend
  scale_color_manual(
    values = c("PCWD Z-Scores" = "black", "Volcanic Forcing (AOD)" = "red"),
    labels = c("PCWD Z-Scores (Mean)", "Volcanic Forcing (AOD)")
  ) +
  scale_fill_manual(
    values = c("SD across EMs" = "honeydew4"), 
    labels = c("SD across EMs")
  ) +
    # Adjust legend appearance and keep the ribbon and line separate
  # Customize the legend to avoid the grey background around lines (using override.aes)
  guides(
    color = guide_legend(title = "Legend", 
                         order = 1, 
                         override.aes = list(fill = NA, shape = NA)),  # Remove background for color lines
    fill = guide_legend(title = "", order = 2)  # Fill scale: SD across Ensemble Members
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    legend.title = element_text(face = "bold"),
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "lightblue"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  facet_wrap(~region, scales = "free_y")  # Facet by region with independent y-axis scales

#### South America ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "South America"
zscore_filtered <- zscore_df_1420 %>% filter(continent == selected_continent)

# Normalize AOD data to fit the anomalies scale
aod_min <- min(aod_annual_mean_1420$annual_mean_value, na.rm = TRUE)
aod_max <- max(aod_annual_mean_1420$annual_mean_value, na.rm = TRUE)
zscore_min <- min(zscore_filtered$mean_zscore, na.rm = TRUE)
zscore_max <- max(zscore_filtered$mean_zscore, na.rm = TRUE)

# Calculate scale factor to ensure zero alignment
aod_zero <- 0  # AOD zero point
zs_zero <- 0  # Anomalies zero point
scale_factor <- (zscore_max - zscore_min) / (aod_max - aod_min)  # Scale based on range

# Scale AOD values to match the anomalies scale
annual_mean <- aod_annual_mean_1420 %>%
  mutate(scaled_aod = (annual_mean_value - aod_zero) * scale_factor + zs_zero)

# Plot zscore time series
ggplot(zscore_filtered, aes(x = time, y = mean_zscore, color = "PCWD Z-Scores")) +
  geom_line(show.legend = TRUE) +  # Plot lines for each region
  geom_ribbon(aes(ymin = mean_zscore - sd_zscore, ymax = mean_zscore + sd_zscore, fill = "SD across EMs"), alpha = 0.3,color = NA, show.legend = TRUE) +  # Ribbon shaded area with no black outline
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  # geom_hline(yintercept = 2, color = "indianred", linetype = "dotted")+
  # geom_hline(yintercept = -2, color = "indianred", linetype = "dotted")+
  # Secondary Y-axis: Volcanic Forcing (AOD)
  geom_line(data = annual_mean, aes(x = year, y = scaled_aod, color = "Volcanic Forcing (AOD)"), linewidth = 0.5, linetype = "dotted", show.legend = TRUE) +
  labs(
    x = "Year",
    y = "z-score (w.r.t. 1420-1450)",
    title = paste("EM PCWD (clim) Z-Scores for", selected_continent)
  ) +
  # Secondary axis transformation ensuring zero alignment
  scale_y_continuous(
    sec.axis = sec_axis(
      ~ (. - zs_zero) / scale_factor + aod_zero, 
      name = "Annual Mean AOD"
    )
  ) +
  # Manual color scale for legend
  scale_color_manual(
    values = c("PCWD Z-Scores" = "black", "Volcanic Forcing (AOD)" = "red"),
    labels = c("PCWD Z-Scores (Mean)", "Volcanic Forcing (AOD)")
  ) +
  scale_fill_manual(
    values = c("SD across EMs" = "honeydew4"), 
    labels = c("SD across EMs")
  ) +
    # Adjust legend appearance and keep the ribbon and line separate
  # Customize the legend to avoid the grey background around lines (using override.aes)
  guides(
    color = guide_legend(title = "Legend", 
                         order = 1, 
                         override.aes = list(fill = NA, shape = NA)),  # Remove background for color lines
    fill = guide_legend(title = "", order = 2)  # Fill scale: SD across Ensemble Members
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    legend.title = element_text(face = "bold"),
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "yellow"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  facet_wrap(~region, scales = "free_y")  # Facet by region with independent y-axis scales


```


Plot z-scores for 1420 epoch: 
```{r}
#################all continents for 1420 epoch ###################################

#### Europe ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "Europe"
zscore_filtered <- zscore_df_1420 %>% filter(continent == selected_continent)

# Plot zscore time series
ggplot(zscore_filtered, aes(x = time, y = mean_zscore, color = "PCWD Z-Scores")) +
  geom_line(show.legend = TRUE) +  # Plot lines for each region
  geom_ribbon(aes(ymin = mean_zscore - sd_zscore, ymax = mean_zscore + sd_zscore, fill = "SD across EMs"), alpha = 0.3,color = NA, show.legend = TRUE) +  # Ribbon shaded area with no black outline
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  geom_hline(yintercept = 2, color = "violetred", linetype = "dotted")+
  geom_hline(yintercept = -2, color = "violetred", linetype = "dotted")+
  labs(
    x = "Year",
    y = "z-score (w.r.t. 1420-1450)",
    title = paste("EM PCWD (clim) Z-Scores for", selected_continent)
  ) +
    scale_color_manual(
    values = c("PCWD Z-Scores" = "black"),
    labels = c("PCWD Z-Scores (Mean)")
  ) +
  scale_fill_manual(
    values = c("SD across EMs" = "honeydew4"), 
    labels = c("SD across EMs")
  ) +
    # Adjust legend appearance and keep the ribbon and line separate
  # Customize the legend to avoid the grey background around lines (using override.aes)
  guides(
    color = guide_legend(title = "Legend", 
                         order = 1, 
                         override.aes = list(fill = NA, shape = NA)),  # Remove background for color lines
    fill = guide_legend(title = "", order = 2))+  # Fill scale: SD across Ensemble Members
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "pink"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  facet_wrap(~region)  # Facet by region with independent y-axis scales

#### Asia ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "Asia"
zscore_filtered <- zscore_df_1420 %>% filter(continent == selected_continent)

# Plot zscore time series
ggplot(zscore_filtered, aes(x = time, y = mean_zscore, color = "PCWD Z-Scores")) +
  geom_line(show.legend = TRUE) +  # Plot lines for each region
  geom_ribbon(aes(ymin = mean_zscore - sd_zscore, ymax = mean_zscore + sd_zscore, fill = "SD across EMs"), alpha = 0.3,color = NA, show.legend = TRUE) +  # Ribbon shaded area with no black outline
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  geom_hline(yintercept = 2, color = "violetred", linetype = "dotted")+
  geom_hline(yintercept = -2, color = "violetred", linetype = "dotted")+
  labs(
    x = "Year",
    y = "z-score (w.r.t. 1420-1450)",
    title = paste("EM PCWD (clim) Z-Scores for", selected_continent)
  ) +
    scale_color_manual(
    values = c("PCWD Z-Scores" = "black"),
    labels = c("PCWD Z-Scores (Mean)")
  ) +
  scale_fill_manual(
    values = c("SD across EMs" = "honeydew4"), 
    labels = c("SD across EMs")
  ) +
    # Adjust legend appearance and keep the ribbon and line separate
  # Customize the legend to avoid the grey background around lines (using override.aes)
  guides(
    color = guide_legend(title = "Legend", 
                         order = 1, 
                         override.aes = list(fill = NA, shape = NA)),  # Remove background for color lines
    fill = guide_legend(title = "", order = 2))+  # Fill scale: SD across Ensemble Members
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "orange"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  facet_wrap(~region)  # Facet by region with independent y-axis scales

##### Australia ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "Australia"
zscore_filtered <- zscore_df_1420 %>% filter(continent == selected_continent)

# Plot zscore time series
ggplot(zscore_filtered, aes(x = time, y = mean_zscore, color = "PCWD Z-Scores")) +
  geom_line(show.legend = TRUE) +  # Plot lines for each region
  geom_ribbon(aes(ymin = mean_zscore - sd_zscore, ymax = mean_zscore + sd_zscore, fill = "SD across EMs"), alpha = 0.3,color = NA, show.legend = TRUE) +  # Ribbon shaded area with no black outline
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  geom_hline(yintercept = 2, color = "violetred", linetype = "dotted")+
  geom_hline(yintercept = -2, color = "violetred", linetype = "dotted")+
  labs(
    x = "Year",
    y = "z-score (w.r.t. 1420-1450)",
    title = paste("EM PCWD (clim) Z-Scores for", selected_continent)
  ) +
    scale_color_manual(
    values = c("PCWD Z-Scores" = "black"),
    labels = c("PCWD Z-Scores (Mean)")
  ) +
  scale_fill_manual(
    values = c("SD across EMs" = "honeydew4"), 
    labels = c("SD across EMs")
  ) +
    # Adjust legend appearance and keep the ribbon and line separate
  # Customize the legend to avoid the grey background around lines (using override.aes)
  guides(
    color = guide_legend(title = "Legend", 
                         order = 1, 
                         override.aes = list(fill = NA, shape = NA)),  # Remove background for color lines
    fill = guide_legend(title = "", order = 2))+  # Fill scale: SD across Ensemble Members
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10, colour = "white"),  # Size for facet labels
    strip.background = element_rect(fill = "blue"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  facet_wrap(~region)  # Facet by region with independent y-axis scales


##### Africa ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "Africa"
zscore_filtered <- zscore_df_1420 %>% filter(continent == selected_continent)

# Plot zscore time series
# Plot zscore time series
ggplot(zscore_filtered, aes(x = time, y = mean_zscore, color = "PCWD Z-Scores")) +
  geom_line(show.legend = TRUE) +  # Plot lines for each region
  geom_ribbon(aes(ymin = mean_zscore - sd_zscore, ymax = mean_zscore + sd_zscore, fill = "SD across EMs"), alpha = 0.3,color = NA, show.legend = TRUE) +  # Ribbon shaded area with no black outline
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  geom_hline(yintercept = 2, color = "violetred", linetype = "dotted")+
  geom_hline(yintercept = -2, color = "violetred", linetype = "dotted")+
  labs(
    x = "Year",
    y = "z-score (w.r.t. 1420-1450)",
    title = paste("EM PCWD (clim) Z-Scores for", selected_continent)
  ) +
    scale_color_manual(
    values = c("PCWD Z-Scores" = "black"),
    labels = c("PCWD Z-Scores (Mean)")
  ) +
  scale_fill_manual(
    values = c("SD across EMs" = "honeydew4"), 
    labels = c("SD across EMs")
  ) +
    # Adjust legend appearance and keep the ribbon and line separate
  # Customize the legend to avoid the grey background around lines (using override.aes)
  guides(
    color = guide_legend(title = "Legend", 
                         order = 1, 
                         override.aes = list(fill = NA, shape = NA)),  # Remove background for color lines
    fill = guide_legend(title = "", order = 2))+  # Fill scale: SD across Ensemble Members
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "purple"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  facet_wrap(~region)  # Facet by region with independent y-axis scales


#### North America ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "North America"
zscore_filtered <- zscore_df_1420 %>% filter(continent == selected_continent)

# Plot zscore time series
# Plot zscore time series
ggplot(zscore_filtered, aes(x = time, y = mean_zscore, color = "PCWD Z-Scores")) +
  geom_line(show.legend = TRUE) +  # Plot lines for each region
  geom_ribbon(aes(ymin = mean_zscore - sd_zscore, ymax = mean_zscore + sd_zscore, fill = "SD across EMs"), alpha = 0.3,color = NA, show.legend = TRUE) +  # Ribbon shaded area with no black outline
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  geom_hline(yintercept = 2, color = "violetred", linetype = "dotted")+
  geom_hline(yintercept = -2, color = "violetred", linetype = "dotted")+
  labs(
    x = "Year",
    y = "z-score (w.r.t. 1420-1450)",
    title = paste("EM PCWD (clim) Z-Scores for", selected_continent)
  ) +
    scale_color_manual(
    values = c("PCWD Z-Scores" = "black"),
    labels = c("PCWD Z-Scores (Mean)")
  ) +
  scale_fill_manual(
    values = c("SD across EMs" = "honeydew4"), 
    labels = c("SD across EMs")
  ) +
    # Adjust legend appearance and keep the ribbon and line separate
  # Customize the legend to avoid the grey background around lines (using override.aes)
  guides(
    color = guide_legend(title = "Legend", 
                         order = 1, 
                         override.aes = list(fill = NA, shape = NA)),  # Remove background for color lines
    fill = guide_legend(title = "", order = 2))+  # Fill scale: SD across Ensemble Members
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "lightgreen"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  facet_wrap(~region)  # Facet by region with independent y-axis scales

#### Central America ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "Central America"
zscore_filtered <- zscore_df_1420 %>% filter(continent == selected_continent)

# Plot zscore time series
# Plot zscore time series
ggplot(zscore_filtered, aes(x = time, y = mean_zscore, color = "PCWD Z-Scores")) +
  geom_line(show.legend = TRUE) +  # Plot lines for each region
  geom_ribbon(aes(ymin = mean_zscore - sd_zscore, ymax = mean_zscore + sd_zscore, fill = "SD across EMs"), alpha = 0.3,color = NA, show.legend = TRUE) +  # Ribbon shaded area with no black outline
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  geom_hline(yintercept = 2, color = "violetred", linetype = "dotted")+
  geom_hline(yintercept = -2, color = "violetred", linetype = "dotted")+
  labs(
    x = "Year",
    y = "z-score (w.r.t. 1420-1450)",
    title = paste("EM PCWD (clim) Z-Scores for", selected_continent)
  ) +
    scale_color_manual(
    values = c("PCWD Z-Scores" = "black"),
    labels = c("PCWD Z-Scores (Mean)")
  ) +
  scale_fill_manual(
    values = c("SD across EMs" = "honeydew4"), 
    labels = c("SD across EMs")
  ) +
    # Adjust legend appearance and keep the ribbon and line separate
  # Customize the legend to avoid the grey background around lines (using override.aes)
  guides(
    color = guide_legend(title = "Legend", 
                         order = 1, 
                         override.aes = list(fill = NA, shape = NA)),  # Remove background for color lines
    fill = guide_legend(title = "", order = 2))+  # Fill scale: SD across Ensemble Members
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "lightblue"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  facet_wrap(~region)  # Facet by region with independent y-axis scales


#### South America ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "South America"
zscore_filtered <- zscore_df_1420 %>% filter(continent == selected_continent)

# Plot zscore time series
# Plot zscore time series
ggplot(zscore_filtered, aes(x = time, y = mean_zscore, color = "PCWD Z-Scores")) +
  geom_line(show.legend = TRUE) +  # Plot lines for each region
  geom_ribbon(aes(ymin = mean_zscore - sd_zscore, ymax = mean_zscore + sd_zscore, fill = "SD across EMs"), alpha = 0.3,color = NA, show.legend = TRUE) +  # Ribbon shaded area with no black outline
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  geom_hline(yintercept = 2, color = "violetred", linetype = "dotted")+
  geom_hline(yintercept = -2, color = "violetred", linetype = "dotted")+
  labs(
    x = "Year",
    y = "z-score (w.r.t. 1420-1450)",
    title = paste("EM PCWD (clim) Z-Scores for", selected_continent)
  ) +
    scale_color_manual(
    values = c("PCWD Z-Scores" = "black"),
    labels = c("PCWD Z-Scores (Mean)")
  ) +
  scale_fill_manual(
    values = c("SD across EMs" = "honeydew4"), 
    labels = c("SD across EMs")
  ) +
    # Adjust legend appearance and keep the ribbon and line separate
  # Customize the legend to avoid the grey background around lines (using override.aes)
  guides(
    color = guide_legend(title = "Legend", 
                         order = 1, 
                         override.aes = list(fill = NA, shape = NA)),  # Remove background for color lines
    fill = guide_legend(title = "", order = 2))+  # Fill scale: SD across Ensemble Members
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "yellow"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  facet_wrap(~region)  # Facet by region with independent y-axis scales

```

Plot z-scores for 1850 epoch: 
```{r}
#################all continents for 1850 epoch ###################################

#### Europe ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "Europe"
zscore_filtered <- zscore_df_1850 %>% filter(continent == selected_continent)

# Plot zscore time series
ggplot(zscore_filtered, aes(x = time, y = mean_zscore, color = "PCWD Z-Scores")) +
  geom_line(show.legend = TRUE) +  # Plot lines for each region
  geom_ribbon(aes(ymin = mean_zscore - sd_zscore, ymax = mean_zscore + sd_zscore, fill = "SD across EMs"), alpha = 0.3,color = NA, show.legend = TRUE) +  # Ribbon shaded area with no black outline
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  geom_hline(yintercept = 2, color = "violetred", linetype = "dotted")+
  geom_hline(yintercept = -2, color = "violetred", linetype = "dotted")+
  labs(
    x = "Year",
    y = "z-score (w.r.t. 1850-1880)",
    title = paste("EM PCWD (clim) Z-Scores for", selected_continent)
  ) +
    scale_color_manual(
    values = c("PCWD Z-Scores" = "black"),
    labels = c("PCWD Z-Scores (Mean)")
  ) +
  scale_fill_manual(
    values = c("SD across EMs" = "honeydew4"), 
    labels = c("SD across EMs")
  ) +
    # Adjust legend appearance and keep the ribbon and line separate
  # Customize the legend to avoid the grey background around lines (using override.aes)
  guides(
    color = guide_legend(title = "Legend", 
                         order = 1, 
                         override.aes = list(fill = NA, shape = NA)),  # Remove background for color lines
    fill = guide_legend(title = "", order = 2))+  # Fill scale: SD across Ensemble Members
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "pink"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  facet_wrap(~region)  # Facet by region with independent y-axis scales

#### Asia ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "Asia"
zscore_filtered <- zscore_df_1850 %>% filter(continent == selected_continent)

# Plot zscore time series
ggplot(zscore_filtered, aes(x = time, y = mean_zscore, color = "PCWD Z-Scores")) +
  geom_line(show.legend = TRUE) +  # Plot lines for each region
  geom_ribbon(aes(ymin = mean_zscore - sd_zscore, ymax = mean_zscore + sd_zscore, fill = "SD across EMs"), alpha = 0.3,color = NA, show.legend = TRUE) +  # Ribbon shaded area with no black outline
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  geom_hline(yintercept = 2, color = "violetred", linetype = "dotted")+
  geom_hline(yintercept = -2, color = "violetred", linetype = "dotted")+
  labs(
    x = "Year",
    y = "z-score (w.r.t. 1850-1880)",
    title = paste("EM PCWD (clim) Z-Scores for", selected_continent)
  ) +
    scale_color_manual(
    values = c("PCWD Z-Scores" = "black"),
    labels = c("PCWD Z-Scores (Mean)")
  ) +
  scale_fill_manual(
    values = c("SD across EMs" = "honeydew4"), 
    labels = c("SD across EMs")
  ) +
    # Adjust legend appearance and keep the ribbon and line separate
  # Customize the legend to avoid the grey background around lines (using override.aes)
  guides(
    color = guide_legend(title = "Legend", 
                         order = 1, 
                         override.aes = list(fill = NA, shape = NA)),  # Remove background for color lines
    fill = guide_legend(title = "", order = 2))+  # Fill scale: SD across Ensemble Members
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "orange"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  facet_wrap(~region)  # Facet by region with independent y-axis scales

##### Australia ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "Australia"
zscore_filtered <- zscore_df_1850 %>% filter(continent == selected_continent)

# Plot zscore time series
ggplot(zscore_filtered, aes(x = time, y = mean_zscore, color = "PCWD Z-Scores")) +
  geom_line(show.legend = TRUE) +  # Plot lines for each region
  geom_ribbon(aes(ymin = mean_zscore - sd_zscore, ymax = mean_zscore + sd_zscore, fill = "SD across EMs"), alpha = 0.3,color = NA, show.legend = TRUE) +  # Ribbon shaded area with no black outline
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  geom_hline(yintercept = 2, color = "violetred", linetype = "dotted")+
  geom_hline(yintercept = -2, color = "violetred", linetype = "dotted")+
  labs(
    x = "Year",
    y = "z-score (w.r.t. 1850-1880)",
    title = paste("EM PCWD (clim) Z-Scores for", selected_continent)
  ) +
    scale_color_manual(
    values = c("PCWD Z-Scores" = "black"),
    labels = c("PCWD Z-Scores (Mean)")
  ) +
  scale_fill_manual(
    values = c("SD across EMs" = "honeydew4"), 
    labels = c("SD across EMs")
  ) +
    # Adjust legend appearance and keep the ribbon and line separate
  # Customize the legend to avoid the grey background around lines (using override.aes)
  guides(
    color = guide_legend(title = "Legend", 
                         order = 1, 
                         override.aes = list(fill = NA, shape = NA)),  # Remove background for color lines
    fill = guide_legend(title = "", order = 2))+  # Fill scale: SD across Ensemble Members
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10, colour="white"),  # Size for facet labels
    strip.background = element_rect(fill = "blue"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  facet_wrap(~region)  # Facet by region with independent y-axis scales


##### Africa ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "Africa"
zscore_filtered <- zscore_df_1850 %>% filter(continent == selected_continent)

# Plot zscore time series
ggplot(zscore_filtered, aes(x = time, y = mean_zscore, color = "PCWD Z-Scores")) +
  geom_line(show.legend = TRUE) +  # Plot lines for each region
  geom_ribbon(aes(ymin = mean_zscore - sd_zscore, ymax = mean_zscore + sd_zscore, fill = "SD across EMs"), alpha = 0.3,color = NA, show.legend = TRUE) +  # Ribbon shaded area with no black outline
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  geom_hline(yintercept = 2, color = "violetred", linetype = "dotted")+
  geom_hline(yintercept = -2, color = "violetred", linetype = "dotted")+
  labs(
    x = "Year",
    y = "z-score (w.r.t. 1850-1880)",
    title = paste("EM PCWD (clim) Z-Scores for", selected_continent)
  ) +
    scale_color_manual(
    values = c("PCWD Z-Scores" = "black"),
    labels = c("PCWD Z-Scores (Mean)")
  ) +
  scale_fill_manual(
    values = c("SD across EMs" = "honeydew4"), 
    labels = c("SD across EMs")
  ) +
    # Adjust legend appearance and keep the ribbon and line separate
  # Customize the legend to avoid the grey background around lines (using override.aes)
  guides(
    color = guide_legend(title = "Legend", 
                         order = 1, 
                         override.aes = list(fill = NA, shape = NA)),  # Remove background for color lines
    fill = guide_legend(title = "", order = 2))+  # Fill scale: SD across Ensemble Members
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "purple"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  facet_wrap(~region)  # Facet by region with independent y-axis scales


#### North America ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "North America"
zscore_filtered <- zscore_df_1850 %>% filter(continent == selected_continent)

# Plot zscore time series
ggplot(zscore_filtered, aes(x = time, y = mean_zscore, color = "PCWD Z-Scores")) +
  geom_line(show.legend = TRUE) +  # Plot lines for each region
  geom_ribbon(aes(ymin = mean_zscore - sd_zscore, ymax = mean_zscore + sd_zscore, fill = "SD across EMs"), alpha = 0.3,color = NA, show.legend = TRUE) +  # Ribbon shaded area with no black outline
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  geom_hline(yintercept = 2, color = "violetred", linetype = "dotted")+
  geom_hline(yintercept = -2, color = "violetred", linetype = "dotted")+
  labs(
    x = "Year",
    y = "z-score (w.r.t. 1850-1880)",
    title = paste("EM PCWD (clim) Z-Scores for", selected_continent)
  ) +
    scale_color_manual(
    values = c("PCWD Z-Scores" = "black"),
    labels = c("PCWD Z-Scores (Mean)")
  ) +
  scale_fill_manual(
    values = c("SD across EMs" = "honeydew4"), 
    labels = c("SD across EMs")
  ) +
    # Adjust legend appearance and keep the ribbon and line separate
  # Customize the legend to avoid the grey background around lines (using override.aes)
  guides(
    color = guide_legend(title = "Legend", 
                         order = 1, 
                         override.aes = list(fill = NA, shape = NA)),  # Remove background for color lines
    fill = guide_legend(title = "", order = 2))+  # Fill scale: SD across Ensemble Members
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "lightgreen"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  facet_wrap(~region)  # Facet by region with independent y-axis scales

#### Central America ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "Central America"
zscore_filtered <- zscore_df_1850 %>% filter(continent == selected_continent)

# Plot zscore time series
ggplot(zscore_filtered, aes(x = time, y = mean_zscore, color = "PCWD Z-Scores")) +
  geom_line(show.legend = TRUE) +  # Plot lines for each region
  geom_ribbon(aes(ymin = mean_zscore - sd_zscore, ymax = mean_zscore + sd_zscore, fill = "SD across EMs"), alpha = 0.3,color = NA, show.legend = TRUE) +  # Ribbon shaded area with no black outline
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  geom_hline(yintercept = 2, color = "violetred", linetype = "dotted")+
  geom_hline(yintercept = -2, color = "violetred", linetype = "dotted")+
  labs(
    x = "Year",
    y = "z-score (w.r.t. 1850-1880)",
    title = paste("EM PCWD (clim) Z-Scores for", selected_continent)
  ) +
    scale_color_manual(
    values = c("PCWD Z-Scores" = "black"),
    labels = c("PCWD Z-Scores (Mean)")
  ) +
  scale_fill_manual(
    values = c("SD across EMs" = "honeydew4"), 
    labels = c("SD across EMs")
  ) +
    # Adjust legend appearance and keep the ribbon and line separate
  # Customize the legend to avoid the grey background around lines (using override.aes)
  guides(
    color = guide_legend(title = "Legend", 
                         order = 1, 
                         override.aes = list(fill = NA, shape = NA)),  # Remove background for color lines
    fill = guide_legend(title = "", order = 2))+  # Fill scale: SD across Ensemble Members
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "lightblue"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  facet_wrap(~region)  # Facet by region with independent y-axis scales


#### South America ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "South America"
zscore_filtered <- zscore_df_1850 %>% filter(continent == selected_continent)

# Plot zscore time series
ggplot(zscore_filtered, aes(x = time, y = mean_zscore, color = "PCWD Z-Scores")) +
  geom_line(show.legend = TRUE) +  # Plot lines for each region
  geom_ribbon(aes(ymin = mean_zscore - sd_zscore, ymax = mean_zscore + sd_zscore, fill = "SD across EMs"), alpha = 0.3,color = NA, show.legend = TRUE) +  # Ribbon shaded area with no black outline
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  geom_hline(yintercept = 2, color = "violetred", linetype = "dotted")+
  geom_hline(yintercept = -2, color = "violetred", linetype = "dotted")+
  labs(
    x = "Year",
    y = "z-score (w.r.t. 1850-1880)",
    title = paste("EM PCWD (clim) Z-Scores for", selected_continent)
  ) +
    scale_color_manual(
    values = c("PCWD Z-Scores" = "black"),
    labels = c("PCWD Z-Scores (Mean)")
  ) +
  scale_fill_manual(
    values = c("SD across EMs" = "honeydew4"), 
    labels = c("SD across EMs")
  ) +
    # Adjust legend appearance and keep the ribbon and line separate
  # Customize the legend to avoid the grey background around lines (using override.aes)
  guides(
    color = guide_legend(title = "Legend", 
                         order = 1, 
                         override.aes = list(fill = NA, shape = NA)),  # Remove background for color lines
    fill = guide_legend(title = "", order = 2))+  # Fill scale: SD across Ensemble Members
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "yellow"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  facet_wrap(~region)  # Facet by region with independent y-axis scales

```
Showing each individual ensemble member instead of the geom_ribbon: 

```{r}
# Convert ensemble z-score data into a long format for plotting individual members
zscore_long_1420 <- do.call(rbind, lapply(names(ensemble_zscores_1420), function(region) {
  df <- as.data.frame(ensemble_zscores_1420[[region]])
  df$time <- seq(1435, 1835)  # Adjust time range accordingly
  df$region <- region
  df_long <- pivot_longer(df, cols = -c(time, region), names_to = "ensemble_member", values_to = "z_score")
  return(df_long)
}))

# Add a continent column
zscore_long_1420$continent <- NA  # Initialize continent column
for (continent in names(continent_mapping)) {
  zscore_long_1420$continent[zscore_long_1420$region %in% continent_mapping[[continent]]] <- continent
}

### Plot for each region
# Filter for selected continent
selected_continent <- "Europe"
zscore_filtered <- zscore_long_1420 %>% filter(continent == selected_continent)

# Plot zscore time series
ggplot() +
  # Plot individual ensemble members as fine grey lines
  geom_line(data = zscore_filtered, aes(x = time, y = z_score, group = ensemble_member, 
            color = "Ensemble Members"), alpha = 0.5, linewidth = 0.3, show.legend = TRUE) +
  
  # Plot mean z-score as a bold black line
  geom_line(data = zscore_filtered %>% group_by(time, region) %>% summarise(mean_zscore = mean(z_score, na.rm = TRUE)),
            aes(x = time, y = mean_zscore, color = "PCWD Z-Scores"), linewidth = 1) +
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  geom_hline(yintercept = 2, color = "violetred", linetype = "dotted")+
  geom_hline(yintercept = -2, color = "violetred", linetype = "dotted")+
  labs(
    x = "Year",
    y = "z-score (w.r.t. 1420-1450)",
    title = paste("EM PCWD (clim) Z-Scores for", selected_continent)
  ) +
  # Manual color scale for legend
  scale_color_manual(
    values = c("Ensemble Members" = "grey60", "PCWD Z-Scores" = "black"),
    labels = c("Ensemble Members", "PCWD Z-Scores (Mean)")
  ) +
  # Customize the legend to avoid the grey background around lines (using override.aes)
  guides(
    color = guide_legend(title = "Legend", override.aes = list(fill = NA, shape = NA))  # Remove background for color lines
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    legend.title = element_text(face = "bold"),
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "pink"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  facet_wrap(~region, scales = "free_y")  # Facet by region with independent y-axis scales

#### Asia ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "Asia"
zscore_filtered <- zscore_long_1420 %>% filter(continent == selected_continent)
# Plot zscore time series
ggplot() +
  # Plot individual ensemble members as fine grey lines
  geom_line(data = zscore_filtered, aes(x = time, y = z_score, group = ensemble_member, 
            color = "Ensemble Members"), alpha = 0.5, linewidth = 0.3, show.legend = TRUE) +
  
  # Plot mean z-score as a bold black line
  geom_line(data = zscore_filtered %>% group_by(time, region) %>% summarise(mean_zscore = mean(z_score, na.rm = TRUE)),
            aes(x = time, y = mean_zscore, color = "PCWD Z-Scores"), linewidth = 1) +
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  geom_hline(yintercept = 2, color = "violetred", linetype = "dotted")+
  geom_hline(yintercept = -2, color = "violetred", linetype = "dotted")+
  labs(
    x = "Year",
    y = "z-score (w.r.t. 1420-1450)",
    title = paste("EM PCWD (clim) Z-Scores for", selected_continent)
  ) +
  # Manual color scale for legend
  scale_color_manual(
    values = c("Ensemble Members" = "grey60", "PCWD Z-Scores" = "black"),
    labels = c("Ensemble Members", "PCWD Z-Scores (Mean)")
  ) +
  # Customize the legend to avoid the grey background around lines (using override.aes)
  guides(
    color = guide_legend(title = "Legend", override.aes = list(fill = NA, shape = NA))  # Remove background for color lines
  ) +
  theme_classic()+
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "orange"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  facet_wrap(~region)  # Facet by region with independent y-axis scales

##### Australia ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "Australia"
zscore_filtered <- zscore_long_1420 %>% filter(continent == selected_continent)
# Plot zscore time series
ggplot() +
  # Plot individual ensemble members as fine grey lines
  geom_line(data = zscore_filtered, aes(x = time, y = z_score, group = ensemble_member, 
            color = "Ensemble Members"), alpha = 0.5, linewidth = 0.3, show.legend = TRUE) +
  
  # Plot mean z-score as a bold black line
  geom_line(data = zscore_filtered %>% group_by(time, region) %>% summarise(mean_zscore = mean(z_score, na.rm = TRUE)),
            aes(x = time, y = mean_zscore, color = "PCWD Z-Scores"), linewidth = 1) +
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  geom_hline(yintercept = 2, color = "violetred", linetype = "dotted")+
  geom_hline(yintercept = -2, color = "violetred", linetype = "dotted")+
  labs(
    x = "Year",
    y = "z-score (w.r.t. 1420-1450)",
    title = paste("EM PCWD (clim) Z-Scores for", selected_continent)
  ) +
  # Manual color scale for legend
  scale_color_manual(
    values = c("Ensemble Members" = "grey60", "PCWD Z-Scores" = "black"),
    labels = c("Ensemble Members", "PCWD Z-Scores (Mean)")
  ) +
  # Customize the legend to avoid the grey background around lines (using override.aes)
  guides(
    color = guide_legend(title = "Legend", override.aes = list(fill = NA, shape = NA))  # Remove background for color lines
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10, colour = "white"),  # Size for facet labels
    strip.background = element_rect(fill = "blue"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  facet_wrap(~region)  # Facet by region with independent y-axis scales


##### Africa ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "Africa"
zscore_filtered <- zscore_long_1420 %>% filter(continent == selected_continent)
# Plot zscore time series
ggplot() +
  # Plot individual ensemble members as fine grey lines
  geom_line(data = zscore_filtered, aes(x = time, y = z_score, group = ensemble_member, 
            color = "Ensemble Members"), alpha = 0.5, linewidth = 0.3, show.legend = TRUE) +
  
  # Plot mean z-score as a bold black line
  geom_line(data = zscore_filtered %>% group_by(time, region) %>% summarise(mean_zscore = mean(z_score, na.rm = TRUE)),
            aes(x = time, y = mean_zscore, color = "PCWD Z-Scores"), linewidth = 1) +
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  geom_hline(yintercept = 2, color = "violetred", linetype = "dotted")+
  geom_hline(yintercept = -2, color = "violetred", linetype = "dotted")+
  labs(
    x = "Year",
    y = "z-score (w.r.t. 1420-1450)",
    title = paste("EM PCWD (clim) Z-Scores for", selected_continent)
  ) +
  # Manual color scale for legend
  scale_color_manual(
    values = c("Ensemble Members" = "grey60", "PCWD Z-Scores" = "black"),
    labels = c("Ensemble Members", "PCWD Z-Scores (Mean)")
  ) +
  # Customize the legend to avoid the grey background around lines (using override.aes)
  guides(
    color = guide_legend(title = "Legend", override.aes = list(fill = NA, shape = NA))  # Remove background for color lines
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "purple"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  facet_wrap(~region)  # Facet by region with independent y-axis scales


#### North America ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "North America"
zscore_filtered <- zscore_long_1420 %>% filter(continent == selected_continent)
# Plot zscore time series
ggplot() +
  # Plot individual ensemble members as fine grey lines
  geom_line(data = zscore_filtered, aes(x = time, y = z_score, group = ensemble_member, 
            color = "Ensemble Members"), alpha = 0.5, linewidth = 0.3, show.legend = TRUE) +
  
  # Plot mean z-score as a bold black line
  geom_line(data = zscore_filtered %>% group_by(time, region) %>% summarise(mean_zscore = mean(z_score, na.rm = TRUE)),
            aes(x = time, y = mean_zscore, color = "PCWD Z-Scores"), linewidth = 1) +
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  geom_hline(yintercept = 2, color = "violetred", linetype = "dotted")+
  geom_hline(yintercept = -2, color = "violetred", linetype = "dotted")+
  labs(
    x = "Year",
    y = "z-score (w.r.t. 1420-1450)",
    title = paste("EM PCWD (clim) Z-Scores for", selected_continent)
  ) +
  # Manual color scale for legend
  scale_color_manual(
    values = c("Ensemble Members" = "grey60", "PCWD Z-Scores" = "black"),
    labels = c("Ensemble Members", "PCWD Z-Scores (Mean)")
  ) +
  # Customize the legend to avoid the grey background around lines (using override.aes)
  guides(
    color = guide_legend(title = "Legend", override.aes = list(fill = NA, shape = NA))  # Remove background for color lines
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "lightgreen"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  facet_wrap(~region)  # Facet by region with independent y-axis scales

#### Central America ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "Central America"
zscore_filtered <- zscore_long_1420 %>% filter(continent == selected_continent)
# Plot zscore time series
ggplot() +
  # Plot individual ensemble members as fine grey lines
  geom_line(data = zscore_filtered, aes(x = time, y = z_score, group = ensemble_member, 
            color = "Ensemble Members"), alpha = 0.5, linewidth = 0.3, show.legend = TRUE) +
  
  # Plot mean z-score as a bold black line
  geom_line(data = zscore_filtered %>% group_by(time, region) %>% summarise(mean_zscore = mean(z_score, na.rm = TRUE)),
            aes(x = time, y = mean_zscore, color = "PCWD Z-Scores"), linewidth = 1) +
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  geom_hline(yintercept = 2, color = "violetred", linetype = "dotted")+
  geom_hline(yintercept = -2, color = "violetred", linetype = "dotted")+
  labs(
    x = "Year",
    y = "z-score (w.r.t. 1420-1450)",
    title = paste("30-yr PCWD Z-Scores for Northern Central America (1420-1849)")
  ) +
  # Manual color scale for legend
  scale_color_manual(
    values = c("Ensemble Members" = "grey60", "PCWD Z-Scores" = "black"),
    labels = c("Ensemble Members", "PCWD Z-Scores (Mean)")
  ) +
  # Ensure y-axis tick marks appear every 2 units
  scale_y_continuous(breaks = seq(-12, 32, by = 4)) +
  # Customize the legend to avoid the grey background around lines (using override.aes)
  guides(
    color = guide_legend(title = "Legend:", override.aes = list(fill = NA, shape = NA))  # Remove background for color lines
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "lightblue"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  facet_wrap(~region)  # Facet by region with independent y-axis scales


#### South America ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "South America"
zscore_filtered <- zscore_long_1420 %>% filter(continent == selected_continent)
# Plot zscore time series
ggplot() +
  # Plot individual ensemble members as fine grey lines
  geom_line(data = zscore_filtered, aes(x = time, y = z_score, group = ensemble_member, 
            color = "Ensemble Members"), alpha = 0.5, linewidth = 0.3, show.legend = TRUE) +
  
  # Plot mean z-score as a bold black line
  geom_line(data = zscore_filtered %>% group_by(time, region) %>% summarise(mean_zscore = mean(z_score, na.rm = TRUE)),
            aes(x = time, y = mean_zscore, color = "PCWD Z-Scores"), linewidth = 1) +
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  geom_hline(color = "violetred", yintercept = 2, linetype = "dotted")+
  geom_hline(color = "violetred", yintercept = -2, linetype = "dotted")+
  labs(
    x = "Year",
    y = "z-score (w.r.t. 1420-1450)",
    title = paste("30-yr PCWD Z-Scores for Northern South America (1420-1849)")
  ) +
  # Manual color scale for legend
  scale_color_manual(
    values = c("Ensemble Members" = "grey60", "PCWD Z-Scores" = "black"),
    labels = c("Ensemble Members", "PCWD Z-Scores (Mean)")
  ) +
  # Ensure y-axis tick marks appear every 2 units
  scale_y_continuous(breaks = seq(-12, 30, by = 2)) +
  # Customize the legend to avoid the grey background around lines (using override.aes)
  guides(
    color = guide_legend(title = "Legend:", override.aes = list(fill = NA, shape = NA))  # Remove background for color lines
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "yellow"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  facet_wrap(~region)  # Facet by region with independent y-axis scales


```

```{r}
########### for 1850 epoch:.

# Convert ensemble z-score data into a long format for plotting individual members
zscore_long_1850 <- do.call(rbind, lapply(names(ensemble_zscores_1850), function(region) {
  df <- as.data.frame(ensemble_zscores_1850[[region]])
  df$time <- seq(1865, 1995)  # Adjust time range accordingly
  df$region <- region
  df_long <- pivot_longer(df, cols = -c(time, region), names_to = "ensemble_member", values_to = "z_score")
  return(df_long)
}))

# Add a continent column
zscore_long_1850$continent <- NA  # Initialize continent column
for (continent in names(continent_mapping)) {
  zscore_long_1850$continent[zscore_long_1850$region %in% continent_mapping[[continent]]] <- continent
}

### Plot for each region
# Filter for selected continent
selected_continent <- "Europe"
zscore_filtered <- zscore_long_1850 %>% filter(continent == selected_continent)

# Plot zscore time series
ggplot() +
  # Plot individual ensemble members as fine grey lines
  geom_line(data = zscore_filtered, aes(x = time, y = z_score, group = ensemble_member, 
            color = "Ensemble Members"), alpha = 0.5, linewidth = 0.3, show.legend = TRUE) +
  
  # Plot mean z-score as a bold black line
  geom_line(data = zscore_filtered %>% group_by(time, region) %>% summarise(mean_zscore = mean(z_score, na.rm = TRUE)),
            aes(x = time, y = mean_zscore, color = "PCWD Z-Scores"), linewidth = 1) +
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  geom_hline(yintercept = 2, color = "violetred", linetype = "dotted")+
  geom_hline(yintercept = -2, color = "violetred", linetype = "dotted")+
  labs(
    x = "Year",
    y = "z-score (w.r.t. 1850-1880)",
    title = paste("30-yr PCWD Z-Scores for European regions (1850-2009)")
  ) +
  # Manual color scale for legend
  scale_color_manual(
    values = c("Ensemble Members" = "grey60", "PCWD Z-Scores" = "black"),
    labels = c("Ensemble Members", "PCWD Z-Scores (Mean)")
  ) +
  scale_y_continuous(breaks = seq(-8, 18, by = 2)) +
  # Customize the legend to avoid the grey background around lines (using override.aes)
  guides(
    color = guide_legend(title = "Legend:", override.aes = list(fill = NA, shape = NA))  # Remove background for color lines
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    legend.title = element_text(),
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "pink"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  facet_wrap(~region)  # Facet by region with independent y-axis scales

#### Asia ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "Asia"
zscore_filtered <- zscore_long_1850 %>% filter(continent == selected_continent)
# Plot zscore time series
ggplot() +
  # Plot individual ensemble members as fine grey lines
  geom_line(data = zscore_filtered, aes(x = time, y = z_score, group = ensemble_member, 
            color = "Ensemble Members"), alpha = 0.5, linewidth = 0.3, show.legend = TRUE) +
  
  # Plot mean z-score as a bold black line
  geom_line(data = zscore_filtered %>% group_by(time, region) %>% summarise(mean_zscore = mean(z_score, na.rm = TRUE)),
            aes(x = time, y = mean_zscore, color = "PCWD Z-Scores"), linewidth = 1) +
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  geom_hline(yintercept = 2, color = "violetred", linetype = "dotted")+
  geom_hline(yintercept = -2, color = "violetred", linetype = "dotted")+
  labs(
    x = "Year",
    y = "z-score (w.r.t. 1850-1880)",
    title = paste("EM PCWD (clim) Z-Scores for", selected_continent)
  ) +
  # Manual color scale for legend
  scale_color_manual(
    values = c("Ensemble Members" = "grey60", "PCWD Z-Scores" = "black"),
    labels = c("Ensemble Members", "PCWD Z-Scores (Mean)")
  ) +
  # Customize the legend to avoid the grey background around lines (using override.aes)
  guides(
    color = guide_legend(title = "Legend", override.aes = list(fill = NA, shape = NA))  # Remove background for color lines
  ) +
  theme_classic()+
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "orange"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  facet_wrap(~region)  # Facet by region with independent y-axis scales

##### Australia ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "Australia"
zscore_filtered <- zscore_long_1850 %>% filter(continent == selected_continent)
# Plot zscore time series
ggplot() +
  # Plot individual ensemble members as fine grey lines
  geom_line(data = zscore_filtered, aes(x = time, y = z_score, group = ensemble_member, 
            color = "Ensemble Members"), alpha = 0.5, linewidth = 0.3, show.legend = TRUE) +
  
  # Plot mean z-score as a bold black line
  geom_line(data = zscore_filtered %>% group_by(time, region) %>% summarise(mean_zscore = mean(z_score, na.rm = TRUE)),
            aes(x = time, y = mean_zscore, color = "PCWD Z-Scores"), linewidth = 1) +
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  geom_hline(yintercept = 2, color = "violetred", linetype = "dotted")+
  geom_hline(yintercept = -2, color = "violetred", linetype = "dotted")+
  labs(
    x = "Year",
    y = "z-score (w.r.t. 1850-1880)",
    title = paste("EM PCWD (clim) Z-Scores for", selected_continent)
  ) +
  # Manual color scale for legend
  scale_color_manual(
    values = c("Ensemble Members" = "grey60", "PCWD Z-Scores" = "black"),
    labels = c("Ensemble Members", "PCWD Z-Scores (Mean)")
  ) +
  # Customize the legend to avoid the grey background around lines (using override.aes)
  guides(
    color = guide_legend(title = "Legend", override.aes = list(fill = NA, shape = NA))  # Remove background for color lines
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10, colour = "white"),  # Size for facet labels
    strip.background = element_rect(fill = "blue"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  facet_wrap(~region)  # Facet by region with independent y-axis scales


##### Africa ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "Africa"
zscore_filtered <- zscore_long_1850 %>% filter(continent == selected_continent)
# Plot zscore time series
ggplot() +
  # Plot individual ensemble members as fine grey lines
  geom_line(data = zscore_filtered, aes(x = time, y = z_score, group = ensemble_member, 
            color = "Ensemble Members"), alpha = 0.5, linewidth = 0.3, show.legend = TRUE) +
  
  # Plot mean z-score as a bold black line
  geom_line(data = zscore_filtered %>% group_by(time, region) %>% summarise(mean_zscore = mean(z_score, na.rm = TRUE)),
            aes(x = time, y = mean_zscore, color = "PCWD Z-Scores"), linewidth = 1) +
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  geom_hline(yintercept = 2, color = "violetred", linetype = "dotted")+
  geom_hline(yintercept = -2, color = "violetred", linetype = "dotted")+
  labs(
    x = "Year",
    y = "z-score (w.r.t. 1850-1880)",
    title = paste("EM PCWD (clim) Z-Scores for", selected_continent)
  ) +
  # Manual color scale for legend
  scale_color_manual(
    values = c("Ensemble Members" = "grey60", "PCWD Z-Scores" = "black"),
    labels = c("Ensemble Members", "PCWD Z-Scores (Mean)")
  ) +
  # Customize the legend to avoid the grey background around lines (using override.aes)
  guides(
    color = guide_legend(title = "Legend", override.aes = list(fill = NA, shape = NA))  # Remove background for color lines
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "purple"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  facet_wrap(~region)  # Facet by region with independent y-axis scales


#### North America ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "North America"
zscore_filtered <- zscore_long_1850 %>% filter(continent == selected_continent)
# Plot zscore time series
ggplot() +
  # Plot individual ensemble members as fine grey lines
  geom_line(data = zscore_filtered, aes(x = time, y = z_score, group = ensemble_member, 
            color = "Ensemble Members"), alpha = 0.5, linewidth = 0.3, show.legend = TRUE) +
  
  # Plot mean z-score as a bold black line
  geom_line(data = zscore_filtered %>% group_by(time, region) %>% summarise(mean_zscore = mean(z_score, na.rm = TRUE)),
            aes(x = time, y = mean_zscore, color = "PCWD Z-Scores"), linewidth = 1) +
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  geom_hline(yintercept = 2, color = "violetred", linetype = "dotted")+
  geom_hline(yintercept = -2, color = "violetred", linetype = "dotted")+
  labs(
    x = "Year",
    y = "z-score (w.r.t. 1850-1880)",
    title = paste("30-yr PCWD Z-Scores for North American regions (1850-2009)")
  ) +
  # Manual color scale for legend
  scale_color_manual(
    values = c("Ensemble Members" = "grey60", "PCWD Z-Scores" = "black"),
    labels = c("Ensemble Members", "PCWD Z-Scores (Mean)")
  ) +
  scale_y_continuous(breaks = seq(-8, 18, by = 2)) +
  # Customize the legend to avoid the grey background around lines (using override.aes)
  guides(
    color = guide_legend(title = "Legend:", override.aes = list(fill = NA, shape = NA))  # Remove background for color lines
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "lightgreen"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  facet_wrap(~region)  # Facet by region with independent y-axis scales

#### Central America ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "Central America"
zscore_filtered <- zscore_long_1850 %>% filter(continent == selected_continent)
# Plot zscore time series
ggplot() +
  # Plot individual ensemble members as fine grey lines
  geom_line(data = zscore_filtered, aes(x = time, y = z_score, group = ensemble_member, 
            color = "Ensemble Members"), alpha = 0.5, linewidth = 0.3, show.legend = TRUE) +
  
  # Plot mean z-score as a bold black line
  geom_line(data = zscore_filtered %>% group_by(time, region) %>% summarise(mean_zscore = mean(z_score, na.rm = TRUE)),
            aes(x = time, y = mean_zscore, color = "PCWD Z-Scores"), linewidth = 1) +
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  geom_hline(yintercept = 2, color = "violetred", linetype = "dotted")+
  geom_hline(yintercept = -2, color = "violetred", linetype = "dotted")+
  labs(
    x = "Year",
    y = "z-score (w.r.t. 1850-1880)",
    title = paste("EM PCWD (clim) Z-Scores for", selected_continent)
  ) +
  # Manual color scale for legend
  scale_color_manual(
    values = c("Ensemble Members" = "grey60", "PCWD Z-Scores" = "black"),
    labels = c("Ensemble Members", "PCWD Z-Scores (Mean)")
  ) +
  # Customize the legend to avoid the grey background around lines (using override.aes)
  guides(
    color = guide_legend(title = "Legend", override.aes = list(fill = NA, shape = NA))  # Remove background for color lines
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "lightblue"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  facet_wrap(~region)  # Facet by region with independent y-axis scales


#### South America ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "South America"
zscore_filtered <- zscore_long_1850 %>% filter(continent == selected_continent)
# Plot zscore time series
ggplot() +
  # Plot individual ensemble members as fine grey lines
  geom_line(data = zscore_filtered, aes(x = time, y = z_score, group = ensemble_member, 
            color = "Ensemble Members"), alpha = 0.5, linewidth = 0.3, show.legend = TRUE) +
  
  # Plot mean z-score as a bold black line
  geom_line(data = zscore_filtered %>% group_by(time, region) %>% summarise(mean_zscore = mean(z_score, na.rm = TRUE)),
            aes(x = time, y = mean_zscore, color = "PCWD Z-Scores"), linewidth = 1) +
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  geom_hline(yintercept = 2, color = "violetred", linetype = "dotted")+
  geom_hline(yintercept = -2, color = "violetred", linetype = "dotted")+
  labs(
    x = "Year",
    y = "z-score (w.r.t. 1850-1880)",
    title = paste("EM PCWD (clim) Z-Scores for", selected_continent)
  ) +
  # Manual color scale for legend
  scale_color_manual(
    values = c("Ensemble Members" = "grey60", "PCWD Z-Scores" = "black"),
    labels = c("Ensemble Members", "PCWD Z-Scores (Mean)")
  ) +
  # Customize the legend to avoid the grey background around lines (using override.aes)
  guides(
    color = guide_legend(title = "Legend", override.aes = list(fill = NA, shape = NA))  # Remove background for color lines
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "yellow"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  facet_wrap(~region)  # Facet by region with independent y-axis scales



```



Maps showing z-scores (annual) for specific 30-year periods (e.g. volcanic eruptions, trends etc)
- showing Europe after 1783 eruption (Laki? - caused french revolution)
- showing North America 
- showing Central America

Read in lat, lon and time info: 
```{r}
#lat lon and time info from netcdf files
##read in data
input_file_1850 <- "/storage/research/giub_geco/data_2/scratch/phelpap/ModESim/m001_tidy/04_result_1850/PCWD_ANNMAX.nc"
input_file_1420 <- "/storage/research/giub_geco/data_2/scratch/phelpap/ModESim/m001_tidy/04_result_1420/PCWD_ANNMAX.nc"

nc_pwcd_1850 <- nc_open(input_file_1850)
pcwd_annmax_1850 = ncvar_get(nc_pwcd_1850, varid="pcwd_annmax")
lon = ncvar_get(nc_pwcd_1850, varid="lon")
lat = ncvar_get(nc_pwcd_1850, varid="lat")
time_1850 = ncvar_get(nc_pwcd_1850, varid="time")
# Convert to actual dates (days since 2001-01-01)
reference_date <- as.Date("2001-01-01")
time_dates_1850 <- reference_date + time_1850

# # Print the resulting dates
# print(time_dates)

nc_close(nc_pwcd_1850)

#1420 file for 1420 time
nc_pwcd_1420 <- nc_open(input_file_1420)
pcwd_annmax_1420 = ncvar_get(nc_pwcd_1420, varid="pcwd_annmax")
time_1420 = ncvar_get(nc_pwcd_1420, varid="time")
# Convert to actual dates (days since 2001-01-01)
time_dates_1420 <- reference_date + time_1420

# # Print the resulting dates
# print(time_dates)

nc_close(nc_pwcd_1420)
```

aggregate files: 
```{r}
#read in netcdf data and aggregate

#### 1420 set:
# Define the base path - have to seperate sets once there are more!
path <- "/storage/research/giub_geco/data_2/scratch/phelpap/ModESim/"

# List all the directories within the base path
folders <- list.files(path, full.names = TRUE)  #only want m001-m020 for now

# Extract ensemble member identifiers from folder names
ensemble_members <- basename(folders)

# Identify the target files
target_files <- file.path(folders, "04_result_1420/PCWD_ANNMAX.nc")
target_files <- target_files[file.exists(target_files)]  # Ensure only existing files are included

# Filter ensemble members to match target files
ensemble_members <- ensemble_members[file.exists(target_files)]

# Initialize a list to store data for each ensemble member
data_by_ensemble_1420 <- list()

# Extract dimensions from the first file to initialize the array size for consistency
nc <- nc_open(target_files[1])
dim_x <- dim(ncvar_get(nc, "pcwd_annmax"))[1]
dim_y <- dim(ncvar_get(nc, "pcwd_annmax"))[2]
dim_z <- dim(ncvar_get(nc, "pcwd_annmax"))[3]
nc_close(nc)

# Loop through all the target files and store the data in a list
for (i in seq_along(target_files)) {
  file <- target_files[i]
  member <- ensemble_members[i]
  
  # Open the NetCDF file
  nc <- nc_open(file)
  
  # Extract the data variable
  data <- ncvar_get(nc, "pcwd_annmax")  # Adjust "pcwd_annmax" to your variable name
  
  # Store the data in the list, keyed by the ensemble member
  data_by_ensemble_1420[[member]] <- data
  
  # Close the file
  nc_close(nc)
}

# Output the structure of the data list
print(names(data_by_ensemble_1420))  # Check stored ensemble members
print(dim(data_by_ensemble_1420[[1]]))  # Check dimensions of the data for the first ensemble member


#### 1850 set: 
# Define the base path - have to think of way to seperate sets once there is data!!
path <- "/storage/research/giub_geco/data_2/scratch/phelpap/ModESim/"

# List all the directories within the base path
folders <- list.files(path, full.names = TRUE)

# Extract ensemble member identifiers from folder names
ensemble_members <- basename(folders)

# Identify the target files
target_files <- file.path(folders, "04_result_1850/PCWD_ANNMAX.nc")
target_files <- target_files[file.exists(target_files)]  # Ensure only existing files are included

# Filter ensemble members to match target files
ensemble_members <- ensemble_members[file.exists(target_files)]

# Initialize a list to store data for each ensemble member
data_by_ensemble_1850 <- list()

# Extract dimensions from the first file to initialize the array size for consistency
nc <- nc_open(target_files[1])
dim_x <- dim(ncvar_get(nc, "pcwd_annmax"))[1]
dim_y <- dim(ncvar_get(nc, "pcwd_annmax"))[2]
dim_z <- dim(ncvar_get(nc, "pcwd_annmax"))[3]
nc_close(nc)

# Loop through all the target files and store the data in a list
for (i in seq_along(target_files)) {
  file <- target_files[i]
  member <- ensemble_members[i]
  
  # Open the NetCDF file
  nc <- nc_open(file)
  
  # Extract the data variable
  data <- ncvar_get(nc, "pcwd_annmax")  # Adjust "pcwd_annmax" to your variable name
  
  # Store the data in the list, keyed by the ensemble member
  data_by_ensemble_1850[[member]] <- data
  
  # Close the file
  nc_close(nc)
}

# Output the structure of the data list
print(names(data_by_ensemble_1850))  # Check stored ensemble members
print(dim(data_by_ensemble_1850[[1]]))  # Check dimensions of the data for the first ensemble member

```

```{r}
## Z-Score global grid cell values for 1420 epoch: 
# Convert list of 20 ensemble members into a single 4D array: [192, 96, 431, 20]
ensemble_array <- simplify2array(data_by_ensemble_1420)  # Shape: [192, 96, 431, 20]

# Compute the ensemble mean across the 4th dimension (ensemble members)
ensemble_mean_1420 <- apply(ensemble_array, c(1, 2, 3), mean, na.rm = TRUE)  # Shape: [192, 96, 431]

# `ensemble_mean_1420` now contains the ensemble-averaged values for each grid cell over time
# Define dimensions
num_years <- 431  # Total years in the dataset
window_size <- 30  # Reference period (first 30 years)

# Create an array of the same shape [192, 96, 431] to store means and standard deviations
mean_reference_1420 <- array(NA, dim = c(192, 96))  # Mean for first 30 years
sd_reference_1420 <- array(NA, dim = c(192, 96))    # Standard deviation for first 30 years
zscore_array_1420 <- array(NA, dim = c(192, 96, num_years))  # Store z-scores

# Compute reference mean & standard deviation over first 30 years (years 1:30)
for (i in 1:192) {
  for (j in 1:96) {
    reference_values <- ensemble_mean_1420[i, j, 1:window_size]  # First 30 years
    mean_reference_1420[i, j] <- mean(reference_values, na.rm = TRUE)
    sd_reference_1420[i, j] <- sd(reference_values, na.rm = TRUE)
  }
}

# Compute z-scores for each time step
for (t in 1:num_years) {  # Loop through all years
  for (i in 1:192) {
    for (j in 1:96) {
      if (!is.na(sd_reference_1420[i, j]) && sd_reference_1420[i, j] != 0) {
        zscore_array_1420[i, j, t] <- (ensemble_mean_1420[i, j, t] - mean_reference_1420[i, j]) / sd_reference_1420[i, j]
      } else {
        zscore_array_1420[i, j, t] <- NA  # Avoid division by zero
      }
    }
  }
}

# zscore_array_1420 now contains z-scores for each grid cell at each time step


## EM Z_score global grid cell values for 1850 epoch:
# Convert list of 20 ensemble members into a single 4D array: [192, 96, 160, 20]
ensemble_array <- simplify2array(data_by_ensemble_1850)  # Shape: [192, 96, 160, 20]

# Compute the ensemble mean across the 4th dimension (ensemble members)
ensemble_mean_1850 <- apply(ensemble_array, c(1, 2, 3), mean, na.rm = TRUE)  # Shape: [192, 96, 160]

# `ensemble_mean_1850` now contains the ensemble-averaged values for each grid cell over time
# Define dimensions
num_years <- 160  # Total years in the dataset
window_size <- 30  # Reference period (first 30 years)

# Create an array of the same shape [192, 96, 160] to store means and standard deviations
mean_reference_1850 <- array(NA, dim = c(192, 96))  # Mean for first 30 years
sd_reference_1850 <- array(NA, dim = c(192, 96))    # Standard deviation for first 30 years
zscore_array_1850 <- array(NA, dim = c(192, 96, num_years))  # Store z-scores

# Compute reference mean & standard deviation over first 30 years (years 1:30)
for (i in 1:192) {
  for (j in 1:96) {
    reference_values <- ensemble_mean_1850[i, j, 1:window_size]  # First 30 years
    mean_reference_1850[i, j] <- mean(reference_values, na.rm = TRUE)
    sd_reference_1850[i, j] <- sd(reference_values, na.rm = TRUE)
  }
}

# Compute z-scores for each time step
for (t in 1:num_years) {  # Loop through all years
  for (i in 1:192) {
    for (j in 1:96) {
      if (!is.na(sd_reference_1850[i, j]) && sd_reference_1850[i, j] != 0) {
        zscore_array_1850[i, j, t] <- (ensemble_mean_1850[i, j, t] - mean_reference_1850[i, j]) / sd_reference_1850[i, j]
      } else {
        zscore_array_1850[i, j, t] <- NA  # Avoid division by zero
      }
    }
  }
}

# zscore_array_1850 now contains z-scores for each grid cell at each time step

```

plot maps: 
```{r}
# Convert `refregions` (SpatialPolygons) to an `sf` object for ggplot compatibility
refregions_sf <- st_as_sf(refregions)
# Load land data for filling continents
land <- ne_countries(scale = "medium", returnclass = "sf")


```

Region specifications: 
Continent	Longitude (xlim)	Latitude (ylim)
Europe	c(-15, 50)	c(30, 75)
North America	c(-170, -10)	c(25, 90)
Africa	c(-25, 60)	c(-35, 40)
Asia	c(30, 180)	c(5, 80)
Central America	c(-120, -60)	c(5, 35)
South America	c(-85, -30)	c(-60, 15)
Australia	c(110, 180)	c(-50, 0)

```{r}
#global z-score map for 1783: 
# Find the index for the year specified
year_index <- 1783 - 1420 + 1  #-1420 or 1850 depending on dataset
plot_data <- zscore_array_1420[,,year_index] #specify dataset, 1420 or 1850

# Convert the first year's data into a raster object
r <- raster(t(plot_data), xmn=min(lon), xmx=max(lon), ymn=min(lat), ymx=max(lat))
crs(r) <- "+proj=longlat +datum=WGS84"  # Set CRS for raster
r <- flip(r, direction='y')

land <- st_transform(land, crs = st_crs(r))  # Ensure CRS alignment

# Mask the raster with land polygons to remove ocean values
r_masked <- mask(r, as(land, "Spatial"))

# Convert the masked raster to a data frame for ggplot2
r_df <- as.data.frame(r_masked, xy = TRUE)
colnames(r_df) <- c("x", "y", "layer")  # Rename columns to match ggplot expectations

# Ensure that the layer values are numeric (continuous)
r_df$layer <- as.numeric(r_df$layer)

ggplot() +
  geom_raster(data = r_df, aes(x = x, y = y, fill = layer), na.rm = TRUE) +
  scale_fill_distiller(name = "z-scores", 
                       palette = "RdBu",  # Red-Blue diverging palette
                       values = scales::rescale(c(-9, -2, 2, 9)),  # Rescales to emphasize 0-2 range
                       limits = c(-9, 9),  # Adjust scale to focus on values between -1 and 1
                       na.value = "lightgrey") +  # Color for missing values
  labs(title = "PCWD Z-Scores for 1783", x = "Longitude", y = "Latitude") +
  theme_classic() +
  geom_sf(data = land, fill = NA, color = "black", lwd = 0.5) +
  #coord_sf(xlim = range(lon), ylim = range(lat), expand = FALSE) + #whole globe
  coord_sf(xlim = c(110, 180), ylim = 	c(-50, 0), expand = FALSE) +  # Adjusted for Europe
  
  theme(legend.title = element_text(size = 12),
        legend.text = element_text(size = 10),
        plot.title = element_text(face = "bold"))

```



### Check method for 30 year anomalies

Standard deviations for z-scores seem to be blowing up z-score results artificially
- check absolute values first before normalising
- try normalisation instead of standardization to avoid blown up values outside of the reference period

```{r}
# Convert ensemble z-score data into a long format for plotting individual members
abs_long_1420 <- do.call(rbind, lapply(names(rolling_means), function(region) {
  df <- as.data.frame(rolling_means[[region]])
  df$time <- seq(1435, 1835)  # Adjust time range accordingly
  df$region <- region
  df_long <- pivot_longer(df, cols = -c(time, region), names_to = "ensemble_member", values_to = "mean_PCWD")
  return(df_long)
}))

# Add a continent column
abs_long_1420$continent <- NA  # Initialize continent column
for (continent in names(continent_mapping)) {
  abs_long_1420$continent[abs_long_1420$region %in% continent_mapping[[continent]]] <- continent
}

### Plot for each region
# Filter for selected continent
selected_continent <- "Europe"
abs_filtered <- abs_long_1420 %>% filter(continent == selected_continent)

# Plot rolling mean time series
ggplot() +
  # Plot individual ensemble members as fine grey lines
  geom_line(data = abs_filtered, aes(x = time, y = mean_PCWD, group = ensemble_member, 
            color = "Ensemble Members"), alpha = 0.5, linewidth = 0.3, show.legend = TRUE) +
  
  # Plot mean z-score as a bold black line
  geom_line(data = abs_filtered %>% group_by(time, region) %>% summarise(EM = mean(mean_PCWD, na.rm = TRUE)),
            aes(x = time, y = EM, color = "PCWD"), linewidth = 1) +
  labs(
    x = "Year",
    y = "PCWD [mm]",
    title = paste("rollling 30yr mean PCWD for", selected_continent)
  ) +
  # Manual color scale for legend
  scale_color_manual(
    values = c("Ensemble Members" = "grey60", "PCWD" = "black"),
    labels = c("Ensemble Members", "PCWD (Mean)")
  ) +
  # Customize the legend to avoid the grey background around lines (using override.aes)
  guides(
    color = guide_legend(title = "Legend", override.aes = list(fill = NA, shape = NA))  # Remove background for color lines
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    legend.title = element_text(face = "bold"),
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "pink"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  facet_wrap(~region, scales = "free_y")  # Facet by region with independent y-axis scales


library(viridis)  # For viridis color palette

# Plot rolling mean time series
ggplot() +
  # Plot individual ensemble members with distinct colors
  geom_line(data = abs_filtered, aes(x = time, y = mean_PCWD, group = ensemble_member, 
            color = as.factor(ensemble_member)), alpha = 0.5, linewidth = 0.3, show.legend = FALSE) +
  
  # Plot mean z-score as a bold black line
  geom_line(data = abs_filtered %>% group_by(time, region) %>% summarise(EM = mean(mean_PCWD, na.rm = TRUE)),
            aes(x = time, y = EM), color = "black", linewidth = 1) +
  
  labs(
    x = "Year",
    y = "PCWD [mm]",
    title = paste("Rolling 30yr mean PCWD for", selected_continent)
  ) +
  
  # Use Viridis color palette for ensemble members and keep black for mean
  scale_color_viridis_d(option = "turbo", begin = 0.1, end = 0.9) +
  
  # Customize the legend
  guides(
    color = guide_legend(title = "Legend", override.aes = list(alpha = 1, linewidth = 1))  # Improve legend readability
  ) +
  
  theme_classic() +
  theme(
    legend.position = "top",
    legend.title = element_text(face = "bold"),
    plot.title = element_text(hjust = 0.5, face = "bold"),
    strip.text = element_text(size = 10),
    strip.background = element_rect(fill = "pink"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  
  facet_wrap(~region, scales = "free_y")


```

```{r}
# Convert ensemble z-score data into a long format for plotting individual members
abs_long_1850 <- do.call(rbind, lapply(names(rolling_means_1850), function(region) {
  df <- as.data.frame(rolling_means_1850[[region]])
  df$time <- seq(1865, 1995)  # Adjust time range accordingly
  df$region <- region
  df_long <- pivot_longer(df, cols = -c(time, region), names_to = "ensemble_member", values_to = "mean_PCWD")
  return(df_long)
}))

# Add a continent column
abs_long_1850$continent <- NA  # Initialize continent column
for (continent in names(continent_mapping)) {
  abs_long_1850$continent[abs_long_1850$region %in% continent_mapping[[continent]]] <- continent
}

### Plot for each region
# Filter for selected continent
selected_continent <- "Europe"
abs_filtered <- abs_long_1850 %>% filter(continent == selected_continent)

# Plot rolling mean time series
ggplot() +
  # Plot individual ensemble members as fine grey lines
  geom_line(data = abs_filtered, aes(x = time, y = mean_PCWD, group = ensemble_member, 
            color = "Ensemble Members"), alpha = 0.5, linewidth = 0.3, show.legend = TRUE) +
  
  # Plot mean z-score as a bold black line
  geom_line(data = abs_filtered %>% group_by(time, region) %>% summarise(EM = mean(mean_PCWD, na.rm = TRUE)),
            aes(x = time, y = EM, color = "PCWD"), linewidth = 1) +
  labs(
    x = "Year",
    y = "PCWD [mm]",
    title = paste("rollling 30yr mean PCWD for", selected_continent)
  ) +
  # Manual color scale for legend
  scale_color_manual(
    values = c("Ensemble Members" = "grey60", "PCWD" = "black"),
    labels = c("Ensemble Members", "PCWD (Mean)")
  ) +
  # Customize the legend to avoid the grey background around lines (using override.aes)
  guides(
    color = guide_legend(title = "Legend", override.aes = list(fill = NA, shape = NA))  # Remove background for color lines
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    legend.title = element_text(face = "bold"),
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "pink"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  facet_wrap(~region, scales = "free_y")  # Facet by region with independent y-axis scales


library(viridis)  # For viridis color palette

# Plot rolling mean time series
ggplot() +
  # Plot individual ensemble members with distinct colors
  geom_line(data = abs_filtered, aes(x = time, y = mean_PCWD, group = ensemble_member, 
            color = as.factor(ensemble_member)), alpha = 0.5, linewidth = 0.3, show.legend = TRUE) +
  
  # Plot mean z-score as a bold black line
  geom_line(data = abs_filtered %>% group_by(time, region) %>% summarise(EM = mean(mean_PCWD, na.rm = TRUE)),
            aes(x = time, y = EM), color = "black", linewidth = 1) +
  
  labs(
    x = "Year",
    y = "PCWD [mm]",
    title = paste("Rolling 30yr mean PCWD for", selected_continent)
  ) +
  
  # Use Viridis color palette for ensemble members and keep black for mean
  scale_color_viridis_d(option = "turbo", begin = 0.1, end = 0.9) +
  
  # Customize the legend
  guides(
    color = guide_legend(title = "Legend", override.aes = list(alpha = 1, linewidth = 1))  # Improve legend readability
  ) +
  
  theme_classic() +
  theme(
    legend.position = "top",
    legend.title = element_text(face = "bold"),
    plot.title = element_text(hjust = 0.5, face = "bold"),
    strip.text = element_text(size = 10),
    strip.background = element_rect(fill = "pink"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  
  facet_wrap(~region, scales = "free_y")


```

#### Calculate anomalies of 30yr running mean and plot

```{r}
# Initialize lists to store baselines
anom_baseline <- list()

# Compute baseline mean from the first 30 values of rolling mean
for (region_name in names(rolling_means_1850)) {
  rolling_mean_matrix <- rolling_means_1850[[region_name]]
  
  anom_baseline[[region_name]] <- colMeans(rolling_mean_matrix[1:30, ], na.rm = TRUE)
}

# Initialize lists to store anomalies
ensemble_30anom_1850 <- list()

# Compute z-scores
for (region_name in names(rolling_means_1850)) {
  rolling_mean_matrix <- rolling_means_1850[[region_name]]
  num_years <- nrow(rolling_mean_matrix)
  
  # Initialize matrix to store anomalies
  anoms <- matrix(NA, nrow=num_years, ncol=ncol(rolling_mean_matrix))
  
  # Compute anomalies using rolling mean baseline
  for (t in 1:num_years) {
    anoms[t, ] <- (rolling_mean_matrix[t, ] - anom_baseline[[region_name]])
  }
  
  # Store results
  ensemble_30anom_1850[[region_name]] <- anoms
}

# Compute mean anomalies across ensemble members
mean_30anom_1850 <- list()
for (region_name in names(ensemble_30anom_1850)) {
  mean_30anom_1850[[region_name]] <- rowMeans(ensemble_30anom_1850[[region_name]], na.rm = TRUE)
}




# Convert ensemble data into a long format for plotting individual members
anoms_long_1850 <- do.call(rbind, lapply(names(ensemble_30anom_1850), function(region) {
  df <- as.data.frame(ensemble_30anom_1850[[region]])
  df$time <- seq(1865, 1995)  # Adjust time range accordingly
  df$region <- region
  df_long <- pivot_longer(df, cols = -c(time, region), names_to = "ensemble_member", values_to = "anomalies")
  return(df_long)
}))

# Add a continent column
anoms_long_1850$continent <- NA  # Initialize continent column
for (continent in names(continent_mapping)) {
  anoms_long_1850$continent[anoms_long_1850$region %in% continent_mapping[[continent]]] <- continent
}


### plot 
### Plot for each region
# Filter for selected continent
selected_continent <- "Europe"
anoms_filtered <- anoms_long_1850 %>% filter(continent == selected_continent)

library(viridis)  # For viridis color palette

# Plot rolling mean time series
ggplot() +
  geom_hline(yintercept = 0, color= "darkgrey", linetype="dashed")+
  # Plot individual ensemble members with distinct colors
  geom_line(data = anoms_filtered, aes(x = time, y = anomalies, group = ensemble_member, 
            color = as.factor(ensemble_member)), alpha = 0.5, linewidth = 0.3, show.legend = FALSE) +
  
  # Plot mean z-score as a bold black line
  geom_line(data = anoms_filtered %>% group_by(time, region) %>% summarise(EM = mean(anomalies, na.rm = TRUE)),
            aes(x = time, y = EM), color = "black", linewidth = 1) +
  labs(
    x = "Year",
    y = "PCWD anomalies (mm)",
    title = paste("Rolling 30yr PCWD anomalies for", selected_continent)
  ) +
  
  # Use Viridis color palette for ensemble members and keep black for mean
  scale_color_viridis_d(option = "turbo", begin = 0.1, end = 0.9) +
  
  # Customize the legend
  guides(
    color = guide_legend(title = "Legend", override.aes = list(alpha = 1, linewidth = 1))  # Improve legend readability
  ) +
  
  theme_classic() +
  theme(
    legend.position = "top",
    legend.title = element_text(face = "bold"),
    plot.title = element_text(hjust = 0.5, face = "bold"),
    strip.text = element_text(size = 10),
    strip.background = element_rect(fill = "pink"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  
  facet_wrap(~region, scales = "free_y")


```

For 1420 period also: 
```{r}
# Initialize lists to store baselines
anom_baseline <- list()

# Compute baseline mean from the first 30 values of rolling mean
for (region_name in names(rolling_means)) {
  rolling_mean_matrix <- rolling_means[[region_name]]
  
  anom_baseline[[region_name]] <- colMeans(rolling_mean_matrix[1:30, ], na.rm = TRUE)
}

# Initialize lists to store anomalies
ensemble_30anom_1420 <- list()

# Compute z-scores
for (region_name in names(rolling_means)) {
  rolling_mean_matrix <- rolling_means[[region_name]]
  num_years <- nrow(rolling_mean_matrix)
  
  # Initialize matrix to store anomalies
  anoms <- matrix(NA, nrow=num_years, ncol=ncol(rolling_mean_matrix))
  
  # Compute anomalies using rolling mean baseline
  for (t in 1:num_years) {
    anoms[t, ] <- (rolling_mean_matrix[t, ] - anom_baseline[[region_name]])
  }
  
  # Store results
  ensemble_30anom_1420[[region_name]] <- anoms
}

# Compute mean anomalies across ensemble members
mean_30anom_1420 <- list()
for (region_name in names(ensemble_30anom_1420)) {
  mean_30anom_1420[[region_name]] <- rowMeans(ensemble_30anom_1420[[region_name]], na.rm = TRUE)
}




# Convert ensemble data into a long format for plotting individual members
anoms_long_1420 <- do.call(rbind, lapply(names(ensemble_30anom_1420), function(region) {
  df <- as.data.frame(ensemble_30anom_1420[[region]])
  df$time <- seq(1435, 1835)  # Adjust time range accordingly
  df$region <- region
  df_long <- pivot_longer(df, cols = -c(time, region), names_to = "ensemble_member", values_to = "anomalies")
  return(df_long)
}))

# Add a continent column
anoms_long_1420$continent <- NA  # Initialize continent column
for (continent in names(continent_mapping)) {
  anoms_long_1420$continent[anoms_long_1420$region %in% continent_mapping[[continent]]] <- continent
}


### plot 
### Plot for each region
# Filter for selected continent
selected_continent <- "Europe"
anoms_filtered <- anoms_long_1420 %>% filter(continent == selected_continent)

library(viridis)  # For viridis color palette

# Plot rolling mean time series
ggplot() +
  geom_hline(yintercept = 0, color= "darkgrey", linetype="dashed")+
  # Plot individual ensemble members with distinct colors
  geom_line(data = anoms_filtered, aes(x = time, y = anomalies, group = ensemble_member, 
            color = as.factor(ensemble_member)), alpha = 0.5, linewidth = 0.3, show.legend = FALSE) +
  
  # Plot mean z-score as a bold black line
  geom_line(data = anoms_filtered %>% group_by(time, region) %>% summarise(EM = mean(anomalies, na.rm = TRUE)),
            aes(x = time, y = EM), color = "black", linewidth = 1) +
  
  labs(
    x = "Year",
    y = "PCWD anomalies (mm)",
    title = paste("Rolling 30yr PCWD anomalies for", selected_continent)
  ) +
  
  # Use Viridis color palette for ensemble members and keep black for mean
  scale_color_viridis_d(option = "turbo", begin = 0.1, end = 0.9) +
  
  # Customize the legend
  guides(
    color = guide_legend(title = "Legend", override.aes = list(alpha = 1, linewidth = 1))  # Improve legend readability
  ) +
  
  theme_classic() +
  theme(
    legend.position = "top",
    legend.title = element_text(face = "bold"),
    plot.title = element_text(hjust = 0.5, face = "bold"),
    strip.text = element_text(size = 10),
    strip.background = element_rect(fill = "pink"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  
  facet_wrap(~region, scales = "free_y")

```



#### Calculate normalised version of 30yr running mean and plot - using standard scaling: 

```{r}
# Initialize lists to store baselines (median and IQR)
anom_median <- list()
anom_iqr <- list()

# Compute baseline median and IQR from the first 30 values of rolling mean
for (region_name in names(rolling_means)) {
  rolling_mean_matrix <- rolling_means[[region_name]]
  
  anom_median[[region_name]] <- apply(rolling_mean_matrix[1:30, ], 2, median, na.rm = TRUE)
  anom_iqr[[region_name]] <- apply(rolling_mean_matrix[1:30, ], 2, IQR, na.rm = TRUE)
}

# Initialize lists to store robustly scaled anomalies
ensemble_30anom_robust <- list()

# Compute robust anomalies
for (region_name in names(rolling_means)) {
  rolling_mean_matrix <- rolling_means[[region_name]]
  num_years <- nrow(rolling_mean_matrix)
  
  # Initialize matrix to store anomalies
  anoms <- matrix(NA, nrow=num_years, ncol=ncol(rolling_mean_matrix))
  
  # Compute robustly scaled anomalies using rolling median and IQR
  for (t in 1:num_years) {
    anoms[t, ] <- (rolling_mean_matrix[t, ] - anom_median[[region_name]]) / anom_iqr[[region_name]]
  }
  
  # Store results
  ensemble_30anom_robust[[region_name]] <- anoms
}

# Compute mean robust anomalies across ensemble members
mean_30anom_robust <- list()
for (region_name in names(ensemble_30anom_robust)) {
  mean_30anom_robust[[region_name]] <- rowMeans(ensemble_30anom_robust[[region_name]], na.rm = TRUE)
}

# Convert ensemble data into a long format for plotting individual members
anoms_long_robust <- do.call(rbind, lapply(names(ensemble_30anom_robust), function(region) {
  df <- as.data.frame(ensemble_30anom_robust[[region]])
  df$time <- seq(1435, 1835)  # Adjust time range accordingly
  df$region <- region
  df_long <- pivot_longer(df, cols = -c(time, region), names_to = "ensemble_member", values_to = "scaled_values")
  return(df_long)
}))

# Add a continent column
anoms_long_robust$continent <- NA  # Initialize continent column
for (continent in names(continent_mapping)) {
  anoms_long_robust$continent[anoms_long_robust$region %in% continent_mapping[[continent]]] <- continent
}


### plot 
### Plot for each region
# Filter for selected continent
selected_continent <- "Europe"
anoms_robust_filtered <- anoms_long_robust %>% filter(continent == selected_continent)

library(viridis)  # For viridis color palette

# Plot rolling mean time series
ggplot() +
  geom_hline(yintercept = 0, color= "darkgrey", linetype="dashed")+
  # Plot individual ensemble members with distinct colors
  geom_line(data = anoms_robust_filtered, aes(x = time, y = scaled_values, group = ensemble_member, 
            color = as.factor(ensemble_member)), alpha = 0.5, linewidth = 0.3, show.legend = FALSE) +
  
  # Plot mean z-score as a bold black line
  geom_line(data = anoms_robust_filtered %>% group_by(time, region) %>% summarise(EM = mean(scaled_values, na.rm = TRUE)),
            aes(x = time, y = EM), color = "black", linewidth = 1) +
  
  labs(
    x = "Year",
    y = "PCWD scaled anomalies (mm)",
    title = paste("Rolling 30yr PCWD scaled anomalies for", selected_continent)
  ) +
  
  # Use Viridis color palette for ensemble members and keep black for mean
  scale_color_viridis_d(option = "turbo", begin = 0.1, end = 0.9) +
  
  # Customize the legend
  guides(
    color = guide_legend(title = "Legend", override.aes = list(alpha = 1, linewidth = 1))  # Improve legend readability
  ) +
  
  theme_classic() +
  theme(
    legend.position = "top",
    legend.title = element_text(face = "bold"),
    plot.title = element_text(hjust = 0.5, face = "bold"),
    strip.text = element_text(size = 10),
    strip.background = element_rect(fill = "pink"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  
  facet_wrap(~region, scales = "free_y")


```
For 1850 epoch:
```{r}
# Initialize lists to store baselines (median and IQR)
anom_median <- list()
anom_iqr <- list()

# Compute baseline median and IQR from the first 30 values of rolling mean
for (region_name in names(rolling_means_1850)) {
  rolling_mean_matrix <- rolling_means_1850[[region_name]]
  
  anom_median[[region_name]] <- apply(rolling_mean_matrix[1:30, ], 2, median, na.rm = TRUE)
  anom_iqr[[region_name]] <- apply(rolling_mean_matrix[1:30, ], 2, IQR, na.rm = TRUE)
}

# Initialize lists to store robustly scaled anomalies
ensemble_30anom_robust_1850 <- list()

# Compute robust anomalies
for (region_name in names(rolling_means_1850)) {
  rolling_mean_matrix <- rolling_means_1850[[region_name]]
  num_years <- nrow(rolling_mean_matrix)
  
  # Initialize matrix to store anomalies
  anoms <- matrix(NA, nrow=num_years, ncol=ncol(rolling_mean_matrix))
  
  # Compute robustly scaled anomalies using rolling median and IQR
  for (t in 1:num_years) {
    anoms[t, ] <- (rolling_mean_matrix[t, ] - anom_median[[region_name]]) / anom_iqr[[region_name]]
  }
  
  # Store results
  ensemble_30anom_robust_1850[[region_name]] <- anoms
}

# Compute mean robust anomalies across ensemble members
mean_30anom_robust_1850 <- list()
for (region_name in names(ensemble_30anom_robust_1850)) {
  mean_30anom_robust_1850[[region_name]] <- rowMeans(ensemble_30anom_robust_1850[[region_name]], na.rm = TRUE)
}

# Convert ensemble data into a long format for plotting individual members
anoms_long_robust_1850 <- do.call(rbind, lapply(names(ensemble_30anom_robust_1850), function(region) {
  df <- as.data.frame(ensemble_30anom_robust_1850[[region]])
  df$time <- seq(1865, 1995)  # Adjust time range accordingly
  df$region <- region
  df_long <- pivot_longer(df, cols = -c(time, region), names_to = "ensemble_member", values_to = "scaled_values")
  return(df_long)
}))

# Add a continent column
anoms_long_robust_1850$continent <- NA  # Initialize continent column
for (continent in names(continent_mapping)) {
  anoms_long_robust_1850$continent[anoms_long_robust_1850$region %in% continent_mapping[[continent]]] <- continent
}


### plot 
### Plot for each region
# Filter for selected continent
selected_continent <- "Europe"
anoms_robust_filtered_1850 <- anoms_long_robust_1850 %>% filter(continent == selected_continent)

library(viridis)  # For viridis color palette

# Plot rolling mean time series
ggplot() +
  geom_hline(yintercept = 0, color= "darkgrey", linetype="dashed")+
  # Plot individual ensemble members with distinct colors
  geom_line(data = anoms_robust_filtered_1850, aes(x = time, y = scaled_values, group = ensemble_member, 
            color = as.factor(ensemble_member)), alpha = 0.5, linewidth = 0.3, show.legend = FALSE) +
  
  # Plot mean z-score as a bold black line
  geom_line(data = anoms_robust_filtered_1850 %>% group_by(time, region) %>% summarise(EM = mean(scaled_values, na.rm = TRUE)),
            aes(x = time, y = EM), color = "black", linewidth = 1) +
  
  labs(
    x = "Year",
    y = "PCWD scaled anomalies (mm)",
    title = paste("Rolling 30yr PCWD scaled anomalies for", selected_continent)
  ) +
  
  # Use Viridis color palette for ensemble members and keep black for mean
  scale_color_viridis_d(option = "turbo", begin = 0.1, end = 0.9) +
  
  # Customize the legend
  guides(
    color = guide_legend(title = "Legend", override.aes = list(alpha = 1, linewidth = 1))  # Improve legend readability
  ) +
  
  theme_classic() +
  theme(
    legend.position = "top",
    legend.title = element_text(face = "bold"),
    plot.title = element_text(hjust = 0.5, face = "bold"),
    strip.text = element_text(size = 10),
    strip.background = element_rect(fill = "pink"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  
  facet_wrap(~region, scales = "free_y")


```





### Gini Index for inequality

- calculate Gini index for both each epoch for every gridcell
- plot as map to show variability/ measure of inequality or unequalness
- low number (close to 0 rather than 1) implies low inequality i.e. over time PCWD values stable for that gridcell
- Gini index is more sensitive to changes in the middle of income distribution and less sensitive to changes at the top and the bottom of income distribution (Atkinson, 1970)

Read in lat, lon and time info: 
```{r}
#lat lon and time info from netcdf files
##read in data
input_file_1850 <- "/storage/research/giub_geco/data_2/scratch/phelpap/ModESim/m001_tidy/04_result_1850/PCWD_ANNMAX.nc"
input_file_1420 <- "/storage/research/giub_geco/data_2/scratch/phelpap/ModESim/m001_tidy/04_result_1420/PCWD_ANNMAX.nc"

nc_pwcd_1850 <- nc_open(input_file_1850)
pcwd_annmax_1850 = ncvar_get(nc_pwcd_1850, varid="pcwd_annmax")
lon = ncvar_get(nc_pwcd_1850, varid="lon")
lat = ncvar_get(nc_pwcd_1850, varid="lat")
time_1850 = ncvar_get(nc_pwcd_1850, varid="time")
# Convert to actual dates (days since 2001-01-01)
reference_date <- as.Date("2001-01-01")
time_dates_1850 <- reference_date + time_1850

# # Print the resulting dates
# print(time_dates)

nc_close(nc_pwcd_1850)

#1420 file for 1420 time
nc_pwcd_1420 <- nc_open(input_file_1420)
pcwd_annmax_1420 = ncvar_get(nc_pwcd_1420, varid="pcwd_annmax")
time_1420 = ncvar_get(nc_pwcd_1420, varid="time")
# Convert to actual dates (days since 2001-01-01)
time_dates_1420 <- reference_date + time_1420

# # Print the resulting dates
# print(time_dates)

nc_close(nc_pwcd_1420)
```

aggregate files: 
```{r}
#read in netcdf data and aggregate

#### 1420 set:
# Define the base path - have to seperate sets once there are more!
path <- "/storage/research/giub_geco/data_2/scratch/phelpap/ModESim/"

# List all the directories within the base path
folders <- list.files(path, full.names = TRUE)  #only want m001-m020 for now

# Extract ensemble member identifiers from folder names
ensemble_members <- basename(folders)

# Identify the target files
target_files <- file.path(folders, "04_result_1420/PCWD_ANNMAX.nc")
target_files <- target_files[file.exists(target_files)]  # Ensure only existing files are included

# Filter ensemble members to match target files
ensemble_members <- ensemble_members[file.exists(target_files)]

# Initialize a list to store data for each ensemble member
data_by_ensemble_1420 <- list()

# Extract dimensions from the first file to initialize the array size for consistency
nc <- nc_open(target_files[1])
dim_x <- dim(ncvar_get(nc, "pcwd_annmax"))[1]
dim_y <- dim(ncvar_get(nc, "pcwd_annmax"))[2]
dim_z <- dim(ncvar_get(nc, "pcwd_annmax"))[3]
nc_close(nc)

# Loop through all the target files and store the data in a list
for (i in seq_along(target_files)) {
  file <- target_files[i]
  member <- ensemble_members[i]
  
  # Open the NetCDF file
  nc <- nc_open(file)
  
  # Extract the data variable
  data <- ncvar_get(nc, "pcwd_annmax")  # Adjust "pcwd_annmax" to your variable name
  
  # Store the data in the list, keyed by the ensemble member
  data_by_ensemble_1420[[member]] <- data
  
  # Close the file
  nc_close(nc)
}

# Output the structure of the data list
print(names(data_by_ensemble_1420))  # Check stored ensemble members
print(dim(data_by_ensemble_1420[[1]]))  # Check dimensions of the data for the first ensemble member


#### 1850 set: 
# Define the base path - have to think of way to seperate sets once there is data!!
path <- "/storage/research/giub_geco/data_2/scratch/phelpap/ModESim/"

# List all the directories within the base path
folders <- list.files(path, full.names = TRUE)

# Extract ensemble member identifiers from folder names
ensemble_members <- basename(folders)

# Identify the target files
target_files <- file.path(folders, "04_result_1850/PCWD_ANNMAX.nc")
target_files <- target_files[file.exists(target_files)]  # Ensure only existing files are included

# Filter ensemble members to match target files
ensemble_members <- ensemble_members[file.exists(target_files)]

# Initialize a list to store data for each ensemble member
data_by_ensemble_1850 <- list()

# Extract dimensions from the first file to initialize the array size for consistency
nc <- nc_open(target_files[1])
dim_x <- dim(ncvar_get(nc, "pcwd_annmax"))[1]
dim_y <- dim(ncvar_get(nc, "pcwd_annmax"))[2]
dim_z <- dim(ncvar_get(nc, "pcwd_annmax"))[3]
nc_close(nc)

# Loop through all the target files and store the data in a list
for (i in seq_along(target_files)) {
  file <- target_files[i]
  member <- ensemble_members[i]
  
  # Open the NetCDF file
  nc <- nc_open(file)
  
  # Extract the data variable
  data <- ncvar_get(nc, "pcwd_annmax")  # Adjust "pcwd_annmax" to your variable name
  
  # Store the data in the list, keyed by the ensemble member
  data_by_ensemble_1850[[member]] <- data
  
  # Close the file
  nc_close(nc)
}

# Output the structure of the data list
print(names(data_by_ensemble_1850))  # Check stored ensemble members
print(dim(data_by_ensemble_1850[[1]]))  # Check dimensions of the data for the first ensemble member

```


```{r}
##### 1850 epoch
# Create an array of the same shape [192, 96, 160] to store means
mean_ensemble_1850 <- array(NA, dim = c(192, 96, 160))

# Compute the mean over all ensemble members
ensemble_array <- simplify2array(data_by_ensemble_1850)  # Convert list to array
mean_ensemble_1850 <- apply(ensemble_array, c(1,2,3), mean, na.rm = TRUE)

# Create an array to store Gini indices
gini_values_1850 <- matrix(NA, nrow = 192, ncol = 96)

# Loop through each grid cell and compute Gini index over time
for (i in 1:192) {
  for (j in 1:96) {
    gini_values_1850[i, j] <- Gini(mean_ensemble_1850[i, j, ], na.rm = TRUE)
  }
}

#### 1420 epoch
# Create an array of the same shape [192, 96, 160] to store means
mean_ensemble_1420 <- array(NA, dim = c(192, 96, 160))

# Compute the mean over all ensemble members
ensemble_array <- simplify2array(data_by_ensemble_1420)  # Convert list to array
mean_ensemble_1420 <- apply(ensemble_array, c(1,2,3), mean, na.rm = TRUE)

# Create an array to store Gini indices
gini_values_1420 <- matrix(NA, nrow = 192, ncol = 96)

# Loop through each grid cell and compute Gini index over time
for (i in 1:192) {
  for (j in 1:96) {
    gini_values_1420[i, j] <- Gini(mean_ensemble_1420[i, j, ], na.rm = TRUE)
  }
}

```

plot epoch wise GINI index

```{r}
#plot map with 1850 GINI index
#Convert data into raster object

r <- raster(t(gini_values_1850), xmn=min(lon), xmx=max(lon), ymn=min(lat), ymx=max(lat))
crs(r) <- "+proj=longlat +datum=WGS84" # Set CRS for raster
r <- flip(r, direction='y') #Flip the raster to correct orientation
#Retrieve land polygons and set the same CRS as the raster
land <- ne_countries(scale = "medium", returnclass = "sf")
land <- st_transform(land, crs=st_crs(r)) #Ensure CRS alignment
#Mask the raster with land polygons to remove ocean values
r_masked <- mask(r, as(land, "Spatial"))
#Convert the masked raster to a dataframe for ggplot
r_df <- as.data.frame(r, xy = TRUE)
colnames(r_df) <- c("x", "y", "layer")

ggplot() +
  geom_raster(data = r_df, aes(x=x, y=y, fill = layer), na.rm = TRUE) +
  scale_fill_bs5("orange", limits = c(0, 0.4)) +  
  labs(title = "GINI Index 1850 epoch (EM)", x= "Longitude", y="Latitude") +
  theme_classic() +
  geom_sf(data=land, fill=NA, color = "black", lwd = 0.5) +
  coord_sf(xlim = range(lon), ylim = range(lat), expand=FALSE)+
  theme(legend.title = element_text(size=12), legend.text = element_text(size=10)) +
  guides(fill = guide_legend(title = "Gini index", reverse = TRUE))
```


```{r}
#plot map with 1420 GINI index
#Convert data into raster object

r <- raster(t(gini_values_1420), xmn=min(lon), xmx=max(lon), ymn=min(lat), ymx=max(lat))
crs(r) <- "+proj=longlat +datum=WGS84" # Set CRS for raster
r <- flip(r, direction='y') #Flip the raster to correct orientation
#Retrieve land polygons and set the same CRS as the raster
land <- ne_countries(scale = "medium", returnclass = "sf")
land <- st_transform(land, crs=st_crs(r)) #Ensure CRS alignment
#Mask the raster with land polygons to remove ocean values
#r_masked <- mask(r, as(land, "Spatial"))
#Convert the masked raster to a dataframe for ggplot
r_df <- as.data.frame(r, xy = TRUE)
colnames(r_df) <- c("x", "y", "layer")

ggplot() +
  geom_raster(data = r_df, aes(x=x, y=y, fill = layer), na.rm = TRUE) +
  scale_fill_bs5("orange", limits = c(0, 0.4)) +  
  labs(title = "GINI Index 1420 epoch (EM)", x= "Longitude", y="Latitude") +
  theme_classic() +
  geom_sf(data=land, fill=NA, color = "black", lwd = 0.5) +
  coord_sf(xlim = range(lon), ylim = range(lat), expand=FALSE)+
  theme(legend.title = element_text(size=12), legend.text = element_text(size=10)) +
  guides(fill = guide_legend(title = "Gini index", reverse = TRUE))
```


```{r}

# Define output directory for saving images
output_dir <- "~/cwd_global/vignettes/GINI_maps/"
dir.create(output_dir, showWarnings = FALSE, recursive = TRUE)

# Loop through each time step and generate a plot
for (time_label in names(gini_list)) {
  
  # Extract the Gini values for the current time step
  gini_values_window <- gini_list[[time_label]]$gini_values
  r <- raster(t(gini_values_window), xmn=min(lon), xmx=max(lon), ymn=min(lat), ymx=max(lat))  
  crs(r) <- "+proj=longlat +datum=WGS84" # Set CRS for raster
  r <- flip(r, direction='y') #Flip the raster to correct orientation
  #Retrieve land polygons and set the same CRS as the raster
  land <- ne_countries(scale = "medium", returnclass = "sf")
  land <- st_transform(land, crs=st_crs(r)) #Ensure CRS alignment
  #Mask the raster with land polygons to remove ocean values
  r_masked <- mask(r, as(land, "Spatial"))
  #Convert the masked raster to a dataframe for ggplot
  r_df <- as.data.frame(r_masked, xy = TRUE)
  colnames(r_df) <- c("x", "y", "Gini")
  
  # Extract the time window information
  start_year <- gini_list[[time_label]]$time
  end_year <- start_year + window_size - 1

  p <- ggplot() +
    geom_raster(data = r_df, aes(x = x, y = y, fill = Gini), na.rm = TRUE) +
    scale_fill_viridis_c(option = "rocket", trans = "sqrt", direction=-1, limits = c(0, 0.4), name = "Gini Index") +
    # scale_fill_bs5("orange", limits = c(0, 0.4)) +  
    labs(title = paste0("GINI Index Evolution (EM): ", start_year, " - ", end_year), x = "Longitude", y = "Latitude") +
    theme_classic() +
    geom_sf(data = land, fill = NA, color = "black", lwd = 0.5) +  # Country borders
    coord_sf(xlim = range(lon), ylim = range(lat), expand = FALSE) +
    theme(legend.title = element_text(size = 12), legend.text = element_text(size = 10))
  
  # Save plot as PNG
  output_file <- file.path(output_dir, paste0("GINI_", start_year, "_", end_year, ".png"))
  ggsave(output_file, plot = p, width = 10, height = 5, dpi = 300)
  
  print(paste("Saved:", output_file))  # Log progress
}

print("All plots saved successfully!")
  
  
```


1420 epoch: 

```{r}

# Define output directory for saving images
output_dir <- "~/cwd_global/vignettes/GINI_maps/"
dir.create(output_dir, showWarnings = FALSE, recursive = TRUE)

# Loop through each time step and generate a plot
for (time_label in names(gini_list_1420)) {
  
  # Extract the Gini values for the current time step
  gini_values_window <- gini_list_1420[[time_label]]$gini_values
  r <- raster(t(gini_values_window), xmn=min(lon), xmx=max(lon), ymn=min(lat), ymx=max(lat))  
  crs(r) <- "+proj=longlat +datum=WGS84" # Set CRS for raster
  r <- flip(r, direction='y') #Flip the raster to correct orientation
  #Retrieve land polygons and set the same CRS as the raster
  land <- ne_countries(scale = "medium", returnclass = "sf")
  land <- st_transform(land, crs=st_crs(r)) #Ensure CRS alignment
  #Mask the raster with land polygons to remove ocean values
  r_masked <- mask(r, as(land, "Spatial"))
  #Convert the masked raster to a dataframe for ggplot
  r_df <- as.data.frame(r_masked, xy = TRUE)
  colnames(r_df) <- c("x", "y", "Gini")
  
  # Extract the time window information
  start_year <- gini_list_1420[[time_label]]$time
  end_year <- start_year + window_size - 1

  p <- ggplot() +
    geom_raster(data = r_df, aes(x = x, y = y, fill = Gini), na.rm = TRUE) +
    scale_fill_viridis_c(option = "rocket", trans = "sqrt", direction=-1, limits = c(0, 0.4), name = "Gini Index") +
    # scale_fill_bs5("orange", limits = c(0, 0.4)) +  
    labs(title = paste0("GINI Index Evolution (EM): ", start_year, " - ", end_year), x = "Longitude", y = "Latitude") +
    theme_classic() +
    geom_sf(data = land, fill = NA, color = "black", lwd = 0.5) +  # Country borders
    coord_sf(xlim = range(lon), ylim = range(lat), expand = FALSE) +
    theme(legend.title = element_text(size = 12), legend.text = element_text(size = 10))
  
  # Save plot as PNG
  output_file <- file.path(output_dir, paste0("GINI_", start_year, "_", end_year, ".png"))
  ggsave(output_file, plot = p, width = 10, height = 5, dpi = 300)
  
  print(paste("Saved:", output_file))  # Log progress
}

print("All plots saved successfully!")
  
  
```

### Gini timeseries

Create and plot Gini timeseries with 30-year moving window for each region: 

```{r}
####################### Compute running GINI timeseries for each EM #########################
################## 1420 epoch #############
window_size <- 31  # Define window size

###################### Compute 30-year moving Gini coefficients
# Initialize lists to store Gini values
regional_gini_1420 <- list()

# Loop over regions
for (region_name in names(regional_results_1420)) {
  
  # Extract ensemble members for the region
  ensemble_members <- regional_results_1420[[region_name]]
  num_years <- nrow(ensemble_members)
  
  # Initialize matrix to store Gini values (one per ensemble member per time step)
  gini_window <- matrix(NA, nrow = num_years - window_size + 1, ncol = ncol(ensemble_members))
  
  # Compute 30-year moving Gini values for each ensemble member
  for (t in 1:(num_years - window_size + 1)) {  # Prevent going out of bounds
    
    # Loop over ensemble members
    for (member in 1:ncol(ensemble_members)) {
      
      # Extract data for the current window
      window_data <- ensemble_members[t:(t + window_size - 1), member]
      
      # Compute Gini coefficient for this ensemble member
      gini_window[t, member] <- Gini(window_data, na.rm = TRUE)
    }
  }
  
  # Store results
  regional_gini_1420[[region_name]] <- gini_window
}

###################### Compute Mean Gini across Ensemble Members
# Initialize a list to store mean Gini values
mean_gini_1420 <- list()

# Loop over regions
for (region_name in names(regional_gini_1420)) {
  
  # Compute the mean Gini coefficient across ensemble members for each time step
  mean_gini_1420[[region_name]] <- rowMeans(regional_gini_1420[[region_name]], na.rm = TRUE)
}


################## 1850 epoch #############
window_size <- 31  # Define window size

###################### Compute 30-year moving Gini coefficients
# Initialize lists to store Gini values
regional_gini_1850 <- list()

# Loop over regions
for (region_name in names(regional_results_1850)) {
  
  # Extract ensemble members for the region
  ensemble_members <- regional_results_1850[[region_name]]
  num_years <- nrow(ensemble_members)
  
  # Initialize matrix to store Gini values (one per ensemble member per time step)
  gini_window <- matrix(NA, nrow = num_years - window_size + 1, ncol = ncol(ensemble_members))
  
  # Compute 30-year moving Gini values for each ensemble member
  for (t in 1:(num_years - window_size + 1)) {  # Prevent going out of bounds
    
    # Loop over ensemble members
    for (member in 1:ncol(ensemble_members)) {
      
      # Extract data for the current window
      window_data <- ensemble_members[t:(t + window_size - 1), member]
      
      # Compute Gini coefficient for this ensemble member
      gini_window[t, member] <- Gini(window_data, na.rm = TRUE)
    }
  }
  
  # Store results
  regional_gini_1850[[region_name]] <- gini_window
}

###################### Compute Mean Gini across Ensemble Members
# Initialize a list to store mean Gini values
mean_gini_1850 <- list()

# Loop over regions
for (region_name in names(regional_gini_1850)) {
  
  # Compute the mean Gini coefficient across ensemble members for each time step
  mean_gini_1850[[region_name]] <- rowMeans(regional_gini_1850[[region_name]], na.rm = TRUE)
}

######################### Pooled values across EMs ###################################
# nyears <- 30   # bin width
# 
# # Initialize a list to store results for all regions
# regional_gini_1420 <- list()
# 
# # Loop through each region in regional_results
# for (region in names(regional_results_1420)) { #swap european_regions for regional_results for all regions
#   # Extract the result array for the current region
#   result_array_region <- regional_results_1420[[region]]
# 
#   # initialise
#   gini_window <- rep(NA, nrow(result_array_region) - nyears + 1)
# 
#   for (window_start in 1:(nrow(result_array_region) - nyears + 1)){
# 
#     # Extract data for the current window
#     window_data <- result_array_region[window_start:(window_start + nyears - 1), ]
#   
#     # Flatten the matrix into a single vector
#     window_data <- as.vector(window_data)
# 
# 	  gini_window[window_start] <- Gini(window_data, na.rm = TRUE) #calc gini here!
# 
#   }
#   # Create a dataframe for the current region
#   time_info <- seq(from = as.numeric(1420), to = as.numeric(1849))  # Replace with actual time if available
#   region_df <- data.frame(
#     time = time_info[15:415],
#     GINI = gini_window,
#     region = region
#   )
#     # Store the region's dataframe in the results list
#   regional_gini_1420[[region]] <- region_df
# }
# 
# # Combine all region results into a single dataframe
# combined_gini_1420 <- do.call(rbind, regional_gini_1420)
# # Add a continent column to the SNR data frame
# combined_gini_1420$continent <- NA  # Initialize continent column
# 
# for (continent in names(continent_mapping)) {
#   combined_gini_1420$continent[combined_gini_1420$region %in% continent_mapping[[continent]]] <- continent
# }
# 
# 
# ##### 1850 epoch #####
# 
# nyears <- 30   # bin width
# 
# # Initialize a list to store results for all regions
# regional_gini_1850 <- list()
# 
# # Loop through each region in regional_results
# for (region in names(regional_results_1850)) { #swap european_regions for regional_results for all regions
#   # Extract the result array for the current region
#   result_array_region <- regional_results_1850[[region]]
# 
#   # initialise
#   gini_window <- rep(NA, nrow(result_array_region) - nyears + 1)
# 
#   for (window_start in 1:(nrow(result_array_region) - nyears + 1)){
# 
#     # Extract data for the current window
#     window_data <- result_array_region[window_start:(window_start + nyears - 1), ]
#   
#     # Flatten the matrix into a single vector
#     window_data <- as.vector(window_data)
# 
# 	  # determine return period of cwd_ref based on new fit (How much more/less probably is an event that corresponded to an X-yearly event in the reference period?)
# 	  gini_window[window_start] <- Gini(window_data, na.rm = TRUE) #calc gini here!
# 
#   }
#   # Create a dataframe for the current region
#   time_info <- seq(from = as.numeric(1850), to = as.numeric(2009))  # Replace with actual time if available
#   region_df <- data.frame(
#     time = time_info[15:145],
#     GINI = gini_window,
#     region = region
#   )
#     # Store the region's dataframe in the results list
#   regional_gini_1850[[region]] <- region_df
# }
# 
# # Combine all region results into a single dataframe
# combined_gini_1850 <- do.call(rbind, regional_gini_1850)
# # Add a continent column to the SNR data frame
# combined_gini_1850$continent <- NA  # Initialize continent column
# 
# for (continent in names(continent_mapping)) {
#   combined_gini_1850$continent[combined_gini_1850$region %in% continent_mapping[[continent]]] <- continent
# }

```

Plot 1420 timeseries for Gini: 

```{r}
# Convert ensemble z-score data into a long format for plotting individual members
gini_long_1420 <- do.call(rbind, lapply(names(regional_gini_1420), function(region) {
  df <- as.data.frame(regional_gini_1420[[region]])
  df$time <- seq(1435, 1834)  # Adjust time range accordingly
  df$region <- region
  df_long <- pivot_longer(df, cols = -c(time, region), names_to = "ensemble_member", values_to = "gini")
  return(df_long)
}))

# Add a continent column
gini_long_1420$continent <- NA  # Initialize continent column
for (continent in names(continent_mapping)) {
  gini_long_1420$continent[gini_long_1420$region %in% continent_mapping[[continent]]] <- continent
}

####################################### EUROPE #####################################
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "Europe"
gini_filtered <- gini_long_1420 %>% filter(continent == selected_continent)

# Plot anom time series
ggplot(gini_filtered) +
  geom_line(aes(x = time, y = gini, group = ensemble_member, 
            color = "Ensemble Members"), alpha = 0.5, linewidth = 0.3, show.legend = TRUE) +
  # Plot mean gini as a bold black line
  geom_line(data = gini_filtered %>% group_by(time, region) %>% summarise(mean_gini = mean(gini, na.rm = TRUE)),
            aes(x = time, y = mean_gini, color = "PCWD Gini"), linewidth = 1) +
  #geom_smooth(method = "loess", color = "blue", se = FALSE, span=0.5, linewidth=0.5) +  # Add LOESS trend line  
  labs(
    x = "Year",
    y = "Gini Index (unitless)",
    title = paste("30 year moving GINI for", selected_continent)
  ) +
  # Manual color scale for legend
  scale_color_manual(
    values = c("Ensemble Members" = "grey60", "PCWD Gini" = "black"),
    labels = c("Ensemble Members", "PCWD Gini (Mean)")
  ) +
  # Customize the legend to avoid the grey background around lines (using override.aes)
  guides(
    color = guide_legend(title = "Legend", override.aes = list(fill = NA, shape = NA))  # Remove background for color lines
  ) +
  theme_minimal() +
  theme(
    legend.position = "top",
    legend.title = element_text(face = "bold"),
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "pink"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  facet_wrap(~region)  # Facet by region with independent y-axis scales

####################################### ASIA #####################################
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "Asia"
gini_filtered <- gini_long_1420 %>% filter(continent == selected_continent)

# Plot anom time series
ggplot(gini_filtered) +
  geom_line(aes(x = time, y = gini, group = ensemble_member, 
            color = "Ensemble Members"), alpha = 0.5, linewidth = 0.3, show.legend = TRUE) +
  # Plot mean gini as a bold black line
  geom_line(data = gini_filtered %>% group_by(time, region) %>% summarise(mean_gini = mean(gini, na.rm = TRUE)),
            aes(x = time, y = mean_gini, color = "PCWD Gini"), linewidth = 1) +
  #geom_smooth(method = "loess", color = "blue", se = FALSE, span=0.5, linewidth=0.5) +  # Add LOESS trend line  
  labs(
    x = "Year",
    y = "Gini Index (unitless)",
    title = paste("30 year moving GINI for", selected_continent)
  ) +
  # Manual color scale for legend
  scale_color_manual(
    values = c("Ensemble Members" = "grey60", "PCWD Gini" = "black"),
    labels = c("Ensemble Members", "PCWD Gini (Mean)")
  ) +
  # Customize the legend to avoid the grey background around lines (using override.aes)
  guides(
    color = guide_legend(title = "Legend", override.aes = list(fill = NA, shape = NA))  # Remove background for color lines
  ) +
  theme_minimal() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "orange"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  facet_wrap(~region)  # Facet by region with independent y-axis scales

####################################### Australia #####################################
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "Australia"
gini_filtered <- gini_long_1420 %>% filter(continent == selected_continent)

# Plot anom time series
ggplot(gini_filtered) +
  geom_line(aes(x = time, y = gini, group = ensemble_member, 
            color = "Ensemble Members"), alpha = 0.5, linewidth = 0.3, show.legend = TRUE) +
  # Plot mean gini as a bold black line
  geom_line(data = gini_filtered %>% group_by(time, region) %>% summarise(mean_gini = mean(gini, na.rm = TRUE)),
            aes(x = time, y = mean_gini, color = "PCWD Gini"), linewidth = 1) +
  #geom_smooth(method = "loess", color = "blue", se = FALSE, span=0.5, linewidth=0.5) +  # Add LOESS trend line  
  labs(
    x = "Year",
    y = "Gini Index (unitless)",
    title = paste("30 year moving GINI for", selected_continent)
  ) +
  # Manual color scale for legend
  scale_color_manual(
    values = c("Ensemble Members" = "grey60", "PCWD Gini" = "black"),
    labels = c("Ensemble Members", "PCWD Gini (Mean)")
  ) +
  # Customize the legend to avoid the grey background around lines (using override.aes)
  guides(
    color = guide_legend(title = "Legend", override.aes = list(fill = NA, shape = NA))  # Remove background for color lines
  ) +
  theme_minimal() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10, colour="white"),  # Size for facet labels
    strip.background = element_rect(fill = "blue"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  facet_wrap(~region)  # Facet by region with independent y-axis scales

####################################### Africa #####################################
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "Africa"
gini_filtered <- gini_long_1420 %>% filter(continent == selected_continent)

# Plot anom time series
ggplot(gini_filtered) +
  geom_line(aes(x = time, y = gini, group = ensemble_member, 
            color = "Ensemble Members"), alpha = 0.5, linewidth = 0.3, show.legend = TRUE) +
  # Plot mean gini as a bold black line
  geom_line(data = gini_filtered %>% group_by(time, region) %>% summarise(mean_gini = mean(gini, na.rm = TRUE)),
            aes(x = time, y = mean_gini, color = "PCWD Gini"), linewidth = 1) +
  #geom_smooth(method = "loess", color = "blue", se = FALSE, span=0.5, linewidth=0.5) +  # Add LOESS trend line  
  labs(
    x = "Year",
    y = "Gini Index (unitless)",
    title = paste("30 year moving GINI for", selected_continent)
  ) +
  # Manual color scale for legend
  scale_color_manual(
    values = c("Ensemble Members" = "grey60", "PCWD Gini" = "black"),
    labels = c("Ensemble Members", "PCWD Gini (Mean)")
  ) +
  # Customize the legend to avoid the grey background around lines (using override.aes)
  guides(
    color = guide_legend(title = "Legend", override.aes = list(fill = NA, shape = NA))  # Remove background for color lines
  ) +
  theme_minimal() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "purple"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  facet_wrap(~region)  # Facet by region with independent y-axis scales

####################################### North America #####################################
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "North America"
gini_filtered <- gini_long_1420 %>% filter(continent == selected_continent)

# Plot anom time series
ggplot(gini_filtered) +
  geom_line(aes(x = time, y = gini, group = ensemble_member, 
            color = "Ensemble Members"), alpha = 0.5, linewidth = 0.3, show.legend = TRUE) +
  # Plot mean gini as a bold black line
  geom_line(data = gini_filtered %>% group_by(time, region) %>% summarise(mean_gini = mean(gini, na.rm = TRUE)),
            aes(x = time, y = mean_gini, color = "PCWD Gini"), linewidth = 1) +
  #geom_smooth(method = "loess", color = "blue", se = FALSE, span=0.5, linewidth=0.5) +  # Add LOESS trend line  
  labs(
    x = "Year",
    y = "Gini Index (unitless)",
    title = paste("30 year moving GINI for", selected_continent)
  ) +
  # Manual color scale for legend
  scale_color_manual(
    values = c("Ensemble Members" = "grey60", "PCWD Gini" = "black"),
    labels = c("Ensemble Members", "PCWD Gini (Mean)")
  ) +
  # Customize the legend to avoid the grey background around lines (using override.aes)
  guides(
    color = guide_legend(title = "Legend", override.aes = list(fill = NA, shape = NA))  # Remove background for color lines
  ) +
  theme_minimal() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "lightgreen"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  facet_wrap(~region)  # Facet by region with independent y-axis scales

####################################### Central America #####################################
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "Central America"
gini_filtered <- gini_long_1420 %>% filter(continent == selected_continent)

# Plot anom time series
ggplot(gini_filtered) +
  geom_line(aes(x = time, y = gini, group = ensemble_member, 
            color = "Ensemble Members"), alpha = 0.5, linewidth = 0.3, show.legend = TRUE) +
  # Plot mean gini as a bold black line
  geom_line(data = gini_filtered %>% group_by(time, region) %>% summarise(mean_gini = mean(gini, na.rm = TRUE)),
            aes(x = time, y = mean_gini, color = "PCWD Gini"), linewidth = 1) +
  #geom_smooth(method = "loess", color = "blue", se = FALSE, span=0.5, linewidth=0.5) +  # Add LOESS trend line  
  labs(
    x = "Year",
    y = "Gini Index (unitless)",
    title = paste("30 year moving GINI for", selected_continent)
  ) +
  # Manual color scale for legend
  scale_color_manual(
    values = c("Ensemble Members" = "grey60", "PCWD Gini" = "black"),
    labels = c("Ensemble Members", "PCWD Gini (Mean)")
  ) +
  # Customize the legend to avoid the grey background around lines (using override.aes)
  guides(
    color = guide_legend(title = "Legend", override.aes = list(fill = NA, shape = NA))  # Remove background for color lines
  ) +
  theme_minimal() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "lightblue"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  facet_wrap(~region)  # Facet by region with independent y-axis scales

####################################### Southern America #####################################
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "South America"
gini_filtered <- gini_long_1420 %>% filter(continent == selected_continent)

# Plot anom time series
ggplot(gini_filtered) +
  geom_line(aes(x = time, y = gini, group = ensemble_member, 
            color = "Ensemble Members"), alpha = 0.5, linewidth = 0.3, show.legend = TRUE) +
  # Plot mean gini as a bold black line
  geom_line(data = gini_filtered %>% group_by(time, region) %>% summarise(mean_gini = mean(gini, na.rm = TRUE)),
            aes(x = time, y = mean_gini, color = "PCWD Gini"), linewidth = 1) +
  #geom_smooth(method = "loess", color = "blue", se = FALSE, span=0.5, linewidth=0.5) +  # Add LOESS trend line  
  labs(
    x = "Year",
    y = "Gini Index (unitless)",
    title = paste("30 year moving GINI for", selected_continent)
  ) +
  # Manual color scale for legend
  scale_color_manual(
    values = c("Ensemble Members" = "grey60", "PCWD Gini" = "black"),
    labels = c("Ensemble Members", "PCWD Gini (Mean)")
  ) +
  # Customize the legend to avoid the grey background around lines (using override.aes)
  guides(
    color = guide_legend(title = "Legend", override.aes = list(fill = NA, shape = NA))  # Remove background for color lines
  ) +
  theme_minimal() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "yellow"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  facet_wrap(~region)  # Facet by region with independent y-axis scales

```


Plot timeseries for 1850 epoch: 

```{r}
# Convert ensemble z-score data into a long format for plotting individual members
gini_long_1850 <- do.call(rbind, lapply(names(regional_gini_1850), function(region) {
  df <- as.data.frame(regional_gini_1850[[region]])
  df$time <- seq(1865, 1994)  # Adjust time range accordingly
  df$region <- region
  df_long <- pivot_longer(df, cols = -c(time, region), names_to = "ensemble_member", values_to = "gini")
  return(df_long)
}))

# Add a continent column
gini_long_1850$continent <- NA  # Initialize continent column
for (continent in names(continent_mapping)) {
  gini_long_1850$continent[gini_long_1850$region %in% continent_mapping[[continent]]] <- continent
}

####################################### EUROPE #####################################
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "Europe"
gini_filtered <- gini_long_1850 %>% filter(continent == selected_continent)

# Plot anom time series
ggplot(gini_filtered) +
  geom_line(aes(x = time, y = gini, group = ensemble_member, 
            color = "Ensemble Members"), alpha = 0.5, linewidth = 0.3, show.legend = TRUE) +
  # Plot mean gini as a bold black line
  geom_line(data = gini_filtered %>% group_by(time, region) %>% summarise(mean_gini = mean(gini, na.rm = TRUE)),
            aes(x = time, y = mean_gini, color = "PCWD Gini"), linewidth = 1) +
  #geom_smooth(method = "loess", color = "blue", se = FALSE, span=0.5, linewidth=0.5) +  # Add LOESS trend line  
  labs(
    x = "Year",
    y = "Gini Index (unitless)",
    title = paste("30 year moving GINI for", selected_continent)
  ) +
  # Manual color scale for legend
  scale_color_manual(
    values = c("Ensemble Members" = "grey60", "PCWD Gini" = "black"),
    labels = c("Ensemble Members", "PCWD Gini (Mean)")
  ) +
  # Customize the legend to avoid the grey background around lines (using override.aes)
  guides(
    color = guide_legend(title = "Legend", override.aes = list(fill = NA, shape = NA))  # Remove background for color lines
  ) +
  theme_minimal() +
  theme(
    legend.position = "top",
    legend.title = element_text(face = "bold"),
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "pink"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  facet_wrap(~region)  # Facet by region with independent y-axis scales

####################################### ASIA #####################################
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "Asia"
gini_filtered <- gini_long_1850 %>% filter(continent == selected_continent)

# Plot anom time series
ggplot(gini_filtered) +
  geom_line(aes(x = time, y = gini, group = ensemble_member, 
            color = "Ensemble Members"), alpha = 0.5, linewidth = 0.3, show.legend = TRUE) +
  # Plot mean gini as a bold black line
  geom_line(data = gini_filtered %>% group_by(time, region) %>% summarise(mean_gini = mean(gini, na.rm = TRUE)),
            aes(x = time, y = mean_gini, color = "PCWD Gini"), linewidth = 1) +
  #geom_smooth(method = "loess", color = "blue", se = FALSE, span=0.5, linewidth=0.5) +  # Add LOESS trend line  
  labs(
    x = "Year",
    y = "Gini Index (unitless)",
    title = paste("30 year moving GINI for", selected_continent)
  ) +
  # Manual color scale for legend
  scale_color_manual(
    values = c("Ensemble Members" = "grey60", "PCWD Gini" = "black"),
    labels = c("Ensemble Members", "PCWD Gini (Mean)")
  ) +
  # Customize the legend to avoid the grey background around lines (using override.aes)
  guides(
    color = guide_legend(title = "Legend", override.aes = list(fill = NA, shape = NA))  # Remove background for color lines
  ) +
  theme_minimal() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "orange"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  facet_wrap(~region)  # Facet by region with independent y-axis scales

####################################### Australia #####################################
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "Australia"
gini_filtered <- gini_long_1850 %>% filter(continent == selected_continent)

# Plot anom time series
ggplot(gini_filtered) +
  geom_line(aes(x = time, y = gini, group = ensemble_member, 
            color = "Ensemble Members"), alpha = 0.5, linewidth = 0.3, show.legend = TRUE) +
  # Plot mean gini as a bold black line
  geom_line(data = gini_filtered %>% group_by(time, region) %>% summarise(mean_gini = mean(gini, na.rm = TRUE)),
            aes(x = time, y = mean_gini, color = "PCWD Gini"), linewidth = 1) +
  #geom_smooth(method = "loess", color = "blue", se = FALSE, span=0.5, linewidth=0.5) +  # Add LOESS trend line  
  labs(
    x = "Year",
    y = "Gini Index (unitless)",
    title = paste("30 year moving GINI for", selected_continent)
  ) +
  # Manual color scale for legend
  scale_color_manual(
    values = c("Ensemble Members" = "grey60", "PCWD Gini" = "black"),
    labels = c("Ensemble Members", "PCWD Gini (Mean)")
  ) +
  # Customize the legend to avoid the grey background around lines (using override.aes)
  guides(
    color = guide_legend(title = "Legend", override.aes = list(fill = NA, shape = NA))  # Remove background for color lines
  ) +
  theme_minimal() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10, colour="white"),  # Size for facet labels
    strip.background = element_rect(fill = "blue"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  facet_wrap(~region)  # Facet by region with independent y-axis scales

####################################### Africa #####################################
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "Africa"
gini_filtered <- gini_long_1850 %>% filter(continent == selected_continent)

# Plot anom time series
ggplot(gini_filtered) +
  geom_line(aes(x = time, y = gini, group = ensemble_member, 
            color = "Ensemble Members"), alpha = 0.5, linewidth = 0.3, show.legend = TRUE) +
  # Plot mean gini as a bold black line
  geom_line(data = gini_filtered %>% group_by(time, region) %>% summarise(mean_gini = mean(gini, na.rm = TRUE)),
            aes(x = time, y = mean_gini, color = "PCWD Gini"), linewidth = 1) +
  #geom_smooth(method = "loess", color = "blue", se = FALSE, span=0.5, linewidth=0.5) +  # Add LOESS trend line  
  labs(
    x = "Year",
    y = "Gini Index (unitless)",
    title = paste("30 year moving GINI for", selected_continent)
  ) +
  # Manual color scale for legend
  scale_color_manual(
    values = c("Ensemble Members" = "grey60", "PCWD Gini" = "black"),
    labels = c("Ensemble Members", "PCWD Gini (Mean)")
  ) +
  # Customize the legend to avoid the grey background around lines (using override.aes)
  guides(
    color = guide_legend(title = "Legend", override.aes = list(fill = NA, shape = NA))  # Remove background for color lines
  ) +
  theme_minimal() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "purple"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  facet_wrap(~region)  # Facet by region with independent y-axis scales

####################################### North America #####################################
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "North America"
gini_filtered <- gini_long_1850 %>% filter(continent == selected_continent)

# Plot anom time series
ggplot(gini_filtered) +
  geom_line(aes(x = time, y = gini, group = ensemble_member, 
            color = "Ensemble Members"), alpha = 0.5, linewidth = 0.3, show.legend = TRUE) +
  # Plot mean gini as a bold black line
  geom_line(data = gini_filtered %>% group_by(time, region) %>% summarise(mean_gini = mean(gini, na.rm = TRUE)),
            aes(x = time, y = mean_gini, color = "PCWD Gini"), linewidth = 1) +
  #geom_smooth(method = "loess", color = "blue", se = FALSE, span=0.5, linewidth=0.5) +  # Add LOESS trend line  
  labs(
    x = "Year",
    y = "Gini Index (unitless)",
    title = paste("30 year moving GINI for", selected_continent)
  ) +
  # Manual color scale for legend
  scale_color_manual(
    values = c("Ensemble Members" = "grey60", "PCWD Gini" = "black"),
    labels = c("Ensemble Members", "PCWD Gini (Mean)")
  ) +
  # Customize the legend to avoid the grey background around lines (using override.aes)
  guides(
    color = guide_legend(title = "Legend", override.aes = list(fill = NA, shape = NA))  # Remove background for color lines
  ) +
  theme_minimal() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "lightgreen"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  facet_wrap(~region)  # Facet by region with independent y-axis scales

####################################### Central America #####################################
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "Central America"
gini_filtered <- gini_long_1850 %>% filter(continent == selected_continent)

# Plot anom time series
ggplot(gini_filtered) +
  geom_line(aes(x = time, y = gini, group = ensemble_member, 
            color = "Ensemble Members"), alpha = 0.5, linewidth = 0.3, show.legend = TRUE) +
  # Plot mean gini as a bold black line
  geom_line(data = gini_filtered %>% group_by(time, region) %>% summarise(mean_gini = mean(gini, na.rm = TRUE)),
            aes(x = time, y = mean_gini, color = "PCWD Gini"), linewidth = 1) +
  #geom_smooth(method = "loess", color = "blue", se = FALSE, span=0.5, linewidth=0.5) +  # Add LOESS trend line  
  labs(
    x = "Year",
    y = "Gini Index (unitless)",
    title = paste("30 year moving GINI for", selected_continent)
  ) +
  # Manual color scale for legend
  scale_color_manual(
    values = c("Ensemble Members" = "grey60", "PCWD Gini" = "black"),
    labels = c("Ensemble Members", "PCWD Gini (Mean)")
  ) +
  # Customize the legend to avoid the grey background around lines (using override.aes)
  guides(
    color = guide_legend(title = "Legend", override.aes = list(fill = NA, shape = NA))  # Remove background for color lines
  ) +
  theme_minimal() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "lightblue"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  facet_wrap(~region)  # Facet by region with independent y-axis scales

####################################### Southern America #####################################
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "South America"
gini_filtered <- gini_long_1850 %>% filter(continent == selected_continent)

# Plot anom time series
ggplot(gini_filtered) +
  geom_line(aes(x = time, y = gini, group = ensemble_member, 
            color = "Ensemble Members"), alpha = 0.5, linewidth = 0.3, show.legend = TRUE) +
  # Plot mean gini as a bold black line
  geom_line(data = gini_filtered %>% group_by(time, region) %>% summarise(mean_gini = mean(gini, na.rm = TRUE)),
            aes(x = time, y = mean_gini, color = "PCWD Gini"), linewidth = 1) +
  #geom_smooth(method = "loess", color = "blue", se = FALSE, span=0.5, linewidth=0.5) +  # Add LOESS trend line  
  labs(
    x = "Year",
    y = "Gini Index (unitless)",
    title = paste("30 year moving GINI for", selected_continent)
  ) +
  # Manual color scale for legend
  scale_color_manual(
    values = c("Ensemble Members" = "grey60", "PCWD Gini" = "black"),
    labels = c("Ensemble Members", "PCWD Gini (Mean)")
  ) +
  # Customize the legend to avoid the grey background around lines (using override.aes)
  guides(
    color = guide_legend(title = "Legend", override.aes = list(fill = NA, shape = NA))  # Remove background for color lines
  ) +
  theme_minimal() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "yellow"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  facet_wrap(~region)  # Facet by region with independent y-axis scales

```



