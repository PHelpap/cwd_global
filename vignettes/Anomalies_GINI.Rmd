---
title: "PCWD Anomalies and GINI calculation"
author: "Patricia Helpap"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r libraries, message=FALSE, echo=FALSE}
library(readr)
library(dplyr)
library(here)
library(lubridate)
library(patchwork)
library(ggplot2)
library(cwd)
library(ncdf4)
library(reshape2)
library(ggpubr)
library(maps)
library(raster)
library(rnaturalearth)
library(sf)
library(rgdal)
library(sp)
library(RColorBrewer)
library(rJava)
library(loadeR.java)
library(transformeR)
library(loadeR)
library(visualizeR)
library(geoprocessoR)
library(tidyverse)
library(abind)
library(patchwork)
library(gridExtra)
library(DescTools) #for GINI calculation
library(ggsci)
```

### Anomalies wrt anomaly

- calculate timeseries of moving anomalies wrt a reference; try 1420-1450 as reference, 30 year window? Use PCWD mean values
- timeseries for each region including std? 
- calculate anomalies as in value(t) - mean(1420-1450) and plot
- calculate anomalies as z-scores: zscore = (x - mean) /std

```{r}
#read in aggregated regional data
# #Load with
regional_results_1420 <- readRDS("~/cwd_global/data/regionalResults_1420.RData")
regional_results_1850 <- readRDS("~/cwd_global/data/regionalResults_1850.RData")

```

```{r}
#read in volcanic forcing data for set 1: 
#AOD years 1000 C.E. to 1900 C.E.:
input_file <- "/storage/research/giub_geco/data_2/scratch/phelpap/ModESim/ModESim_forcings/1420_1/eva_holo2.2_forcing_echam_T63_ir_1000-1900.nc"
nc_forcings <- nc_open(input_file)
aod = ncvar_get(nc_forcings, varid="aod")[6,,] # index 6 for 500nm wavelength
lat = ncvar_get(nc_forcings, varid="lat")
time_1420 = ncvar_get(nc_forcings, varid="time")
nc_close(nc_forcings)

########### Calculate annual mean values for first epoch years:
# Define the years of interest
years_of_interest <- 1420:1849

# Find indices of columns corresponding to the desired years
selected_indices <- which(time_1420 %in% years_of_interest)

# Subset the matrix to include only those years
aod_selected <- aod[, selected_indices]
time_selected <- time_1420[selected_indices]  # Corresponding time values

# Compute the mean over latitudes (first dimension)
mean_latitude <- apply(aod_selected, 2, mean, na.rm = TRUE)

# Convert to a data frame for easier manipulation
df <- data.frame(year = time_selected, mean_value = mean_latitude)

# Compute the annual mean (since each year has 12 monthly values)
library(dplyr)
aod_annual_mean_1420 <- df %>%
  group_by(year) %>%
  summarise(annual_mean_value = mean(mean_value, na.rm = TRUE))

```


Anomalies for each time step: 

```{r}
### calculate anomalies for both epochs based on reference time 1420-1450

### calculate baseline for anomalies: 1420-1450 mean for each region
# Initialize list to store baselines for each region
anom_baseline <- list()

# Loop over regions
for (region_name in names(regional_results_1420)) {
  
  # Extract all ensemble members for the region
  ensemble_members <- regional_results_1420[[region_name]]
  
  # Compute baseline (mean over first 30 years) for each ensemble member
  anom_baseline[[region_name]] <- colMeans(ensemble_members[1:30, ], na.rm = TRUE)
}

# Initialize lists to store results
anoms_1420 <- list()      # Mean anomalies for each region
anoms_sd_1420 <- list()   # Standard deviation of anomalies for each region

# Loop over regions
for (region_name in names(regional_results_1420)) {
  
  # Extract the ensemble members for the region
  ensemble_members <- regional_results_1420[[region_name]]  # Now using full ensemble data
  
  # Compute anomalies for each ensemble member
  ensemble_anoms <- sweep(ensemble_members, 2, anom_baseline[[region_name]], "-")  # Subtract baseline
  
  # Compute mean anomaly across ensemble members
  anoms_1420[[region_name]] <- rowMeans(ensemble_anoms, na.rm = TRUE)
  
  # Compute standard deviation (uncertainty) across ensemble members
  anoms_sd_1420[[region_name]] <- apply(ensemble_anoms, 1, sd, na.rm = TRUE)
}

### calculate baseline for anomalies: 1420-1450 mean for each region
# Initialize list to store baselines for each region
anom_baseline_1850 <- list()

# Loop over regions
for (region_name in names(regional_results_1850)) {
  
  # Extract all ensemble members for the region
  ensemble_members <- regional_results_1850[[region_name]]
  
  # Compute baseline (mean over first 30 years) for each ensemble member
  anom_baseline_1850[[region_name]] <- colMeans(ensemble_members[1:30, ], na.rm = TRUE)
}

# Initialize lists to store results
anoms_1850 <- list()      # Mean anomalies for each region
anoms_sd_1850 <- list()   # Standard deviation of anomalies for each region

# Loop over regions
for (region_name in names(regional_results_1850)) {
  
  # Extract the ensemble members for the region
  ensemble_members <- regional_results_1850[[region_name]]  # Now using full ensemble data
  
  # Compute anomalies for each ensemble member
  ensemble_anoms <- sweep(ensemble_members, 2, anom_baseline_1850[[region_name]], "-")  # Subtract baseline
  
  # Compute mean anomaly across ensemble members
  anoms_1850[[region_name]] <- rowMeans(ensemble_anoms, na.rm = TRUE)
  
  # Compute standard deviation (uncertainty) across ensemble members
  anoms_sd_1850[[region_name]] <- apply(ensemble_anoms, 1, sd, na.rm = TRUE)
}

```



Create Dataframe region, SNR and time: 
```{r}
# Define continent assignments
continent_mapping <- list(
  "Europe" = c("NEU", "WCE", "EEU", "MED"),
  "North America" = c("NWN", "NEN", "WNA", "CNA", "ENA", "GIC"),
  "Africa" = c("SAH", "WAF", "CAF", "NEAF", "SEAF", "WSAF", "ESAF", "MDG"),
  "Asia" = c("WCA", "ECA", "TIB", "EAS", "ARP", "SAS", "SEA", "WSB", "ESB", "RFE", "RAR"),
  "Central America" =c("NCA", "SCA", "CAR"),
  "South America" = c("NWS", "NSA", "NES", "SAM", "SWS", "SES", "SSA"),
  "Australia" = c("NAU", "CAU", "EAU", "SAU", "NZ")
)

########### 1420 period
# Convert SNR list into a data frame
anom_df_1420 <- do.call(rbind, lapply(names(anoms_1420), function(region) {
  data.frame(
    time = seq(1420,1849),  # Extract time from names
    anomalies = anoms_1420[[region]],
    std = anoms_sd_1420[[region]],
    region = region                                # Add region identifier
  )
}))

# Add a continent column to the SNR data frame
anom_df_1420$continent <- NA  # Initialize continent column

for (continent in names(continent_mapping)) {
  anom_df_1420$continent[anom_df_1420$region %in% continent_mapping[[continent]]] <- continent
}


###### 1850 period
# Convert SNR list into a data frame
anom_df_1850 <- do.call(rbind, lapply(names(anoms_1850), function(region) {
  data.frame(
    time = seq(1850,2009),  # Extract time from names
    anomalies = anoms_1850[[region]], 
    std = anoms_sd_1850[[region]],
    region = region                                # Add region identifier
  )
}))

# Add a continent column to the SNR data frame
anom_df_1850$continent <- NA  # Initialize continent column

for (continent in names(continent_mapping)) {
  anom_df_1850$continent[anom_df_1850$region %in% continent_mapping[[continent]]] <- continent
}

```

```{r}
#test to incorporate volcanic forcings also: 
#### Europe ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "Europe"
anom_filtered <- anom_df_1420 %>% filter(continent == selected_continent)

# Normalize AOD data to fit the anomalies scale
aod_min <- min(aod_annual_mean_1420$annual_mean_value, na.rm = TRUE)
aod_max <- max(aod_annual_mean_1420$annual_mean_value, na.rm = TRUE)
anom_min <- min(anom_filtered$anomalies, na.rm = TRUE)
anom_max <- max(anom_filtered$anomalies, na.rm = TRUE)

# Calculate scale factor to ensure zero alignment
aod_zero <- 0  # AOD zero point
anom_zero <- 0  # Anomalies zero point
scale_factor <- (anom_max - anom_min) / (aod_max - aod_min)  # Scale based on range

# Scale AOD values to match the anomalies scale
annual_mean <- aod_annual_mean_1420 %>%
  mutate(scaled_aod = (annual_mean_value - aod_zero) * scale_factor + anom_zero)

# Plot
ggplot() +
  # Primary Y-axis: CWD Anomalies
  geom_line(data = anom_filtered, aes(x = time, y = anomalies, group = region, color = "CWD Anomalies")) +
  geom_ribbon(data = anom_filtered, aes(x = time, ymin = anomalies - std, ymax = anomalies + std, group = region), fill = "grey", alpha = 0.3) +
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed") +
  
  # Secondary Y-axis: Volcanic Forcing (AOD)
  geom_point(data = annual_mean, aes(x = year, y = scaled_aod, color = "Volcanic Forcing (AOD)")) +
  
  # Labels
  labs(
    x = "Year",
    y = "Anomalies [mm] (w.r.t. 1420-1450)",
    title = paste("EM PCWD anomalies for", selected_continent),
    color = "Legend"  # Title for the legend
  ) +
  
  # Secondary axis transformation ensuring zero alignment
  scale_y_continuous(
    sec.axis = sec_axis(
      ~ (. - anom_zero) / scale_factor + aod_zero, 
      name = "Annual Mean AOD"
    )
  ) +

  # Manual color scale for legend
  scale_color_manual(
    values = c("CWD Anomalies" = "black", "Volcanic Forcing (AOD)" = "red")
  ) +

  theme_classic() +
  theme(
    legend.position = "top",  # Legend at the top
    legend.title = element_text(face = "bold"),
    plot.title = element_text(hjust = 0.5, face = "bold"),  
    strip.text = element_text(size = 10),  
    strip.background = element_rect(fill = "pink")
  ) +
  
  facet_wrap(~region
             #, scales = "free_y"
             )  # Facet by region
```


Plot timeseries of anomalies for all regions: 

```{r}
#################all continents for 1420 epoch ###################################

#### Europe ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "Europe"
anom_filtered <- anom_df_1420 %>% filter(continent == selected_continent)

# Plot anom time series
ggplot(anom_filtered, aes(x = time, y = anomalies)) +
  geom_line() +  # Plot lines for each region
  geom_ribbon(aes(ymin = anomalies - std, ymax = anomalies + std), fill = "grey", alpha = 0.3) +
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  labs(
    x = "Year",
    y = "anomalies [mm] (w.r.t. 1420-1450)",
    title = paste("EM PCWD anomalies for", selected_continent)
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "pink")
  ) +
  facet_wrap(~region, scales = "free_y")  # Facet by region with independent y-axis scales

#### Asia ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "Asia"
anom_filtered <- anom_df_1420 %>% filter(continent == selected_continent)

# Plot anom time series
ggplot(anom_filtered, aes(x = time, y = anomalies)) +
  geom_line() +  # Plot lines for each region
  geom_ribbon(aes(ymin = anomalies - std, ymax = anomalies + std), fill = "grey", alpha = 0.3) +
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  labs(
    x = "Year",
    y = "anomalies [mm] (w.r.t. 1420-1450)",
    title = paste("EM PCWD anomalies for", selected_continent)
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "orange")
  ) +
  facet_wrap(~region, scales = "free_y")  # Facet by region with independent y-axis scales

##### Australia ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "Australia"
anom_filtered <- anom_df_1420 %>% filter(continent == selected_continent)

# Plot anom time series
ggplot(anom_filtered, aes(x = time, y = anomalies)) +
  geom_line() +  # Plot lines for each region
  geom_ribbon(aes(ymin = anomalies - std, ymax = anomalies + std), fill = "grey", alpha = 0.3) +
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  labs(
    x = "Year",
    y = "anomalies [mm] (w.r.t. 1420-1450)",
    title = paste("EM PCWD anomalies for", selected_continent)
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "blue")
  ) +
  facet_wrap(~region, scales = "free_y")  # Facet by region with independent y-axis scales


##### Africa ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "Africa"
anom_filtered <- anom_df_1420 %>% filter(continent == selected_continent)

# Plot anom time series
ggplot(anom_filtered, aes(x = time, y = anomalies)) +
  geom_line() +  # Plot lines for each region
  geom_ribbon(aes(ymin = anomalies - std, ymax = anomalies + std), fill = "grey", alpha = 0.3) +
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  labs(
    x = "Year",
    y = "anomalies [mm] (w.r.t. 1420-1450)",
    title = paste("EM PCWD anomalies for", selected_continent)
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "purple")
  ) +
  facet_wrap(~region, scales = "free_y")  # Facet by region with independent y-axis scales


#### North America ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "North America"
anom_filtered <- anom_df_1420 %>% filter(continent == selected_continent)

# Plot anom time series
ggplot(anom_filtered, aes(x = time, y = anomalies)) +
  geom_line() +  # Plot lines for each region
  geom_ribbon(aes(ymin = anomalies - std, ymax = anomalies + std), fill = "grey", alpha = 0.3) +
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  labs(
    x = "Year",
    y = "anomalies [mm] (w.r.t. 1420-1450)",
    title = paste("EM PCWD anomalies for", selected_continent)
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "lightgreen")
  ) +
  facet_wrap(~region, scales = "free_y")  # Facet by region with independent y-axis scales

#### Central America ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "Central America"
anom_filtered <- anom_df_1420 %>% filter(continent == selected_continent)

# Plot anom time series
ggplot(anom_filtered, aes(x = time, y = anomalies)) +
  geom_line() +  # Plot lines for each region
  geom_ribbon(aes(ymin = anomalies - std, ymax = anomalies + std), fill = "grey", alpha = 0.3) +
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  labs(
    x = "Year",
    y = "anomalies [mm] (w.r.t. 1420-1450)",
    title = paste("EM PCWD anomalies for", selected_continent)
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "lightblue")
  ) +
  facet_wrap(~region, scales = "free_y")  # Facet by region with independent y-axis scales


#### South America ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "South America"
anom_filtered <- anom_df_1420 %>% filter(continent == selected_continent)

# Plot anom time series
ggplot(anom_filtered, aes(x = time, y = anomalies)) +
  geom_line() +  # Plot lines for each region
  geom_ribbon(aes(ymin = anomalies - std, ymax = anomalies + std), fill = "grey", alpha = 0.3) +
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  labs(
    x = "Year",
    y = "anomalies [mm] (w.r.t. 1420-1450)",
    title = paste("EM PCWD anomalies for", selected_continent)
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "yellow")
  ) +
  facet_wrap(~region, scales = "free_y")  # Facet by region with independent y-axis scales

```
```{r}
#################all continents for 1850 epoch ###################################

#### Europe ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "Europe"
anom_filtered <- anom_df_1850 %>% filter(continent == selected_continent)

# Plot anom time series
ggplot(anom_filtered, aes(x = time, y = anomalies)) +
  geom_line() +  # Plot lines for each region
  geom_ribbon(aes(ymin = anomalies - std, ymax = anomalies + std), fill = "grey", alpha = 0.3) +
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  labs(
    x = "Year",
    y = "anomalies [mm] (w.r.t. 1420-1450)",
    title = paste("EM PCWD anomalies for", selected_continent)
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "pink")
  ) +
  facet_wrap(~region, scales = "free_y")  # Facet by region with independent y-axis scales

#### Asia ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "Asia"
anom_filtered <- anom_df_1850 %>% filter(continent == selected_continent)

# Plot anom time series
ggplot(anom_filtered, aes(x = time, y = anomalies)) +
  geom_line() +  # Plot lines for each region
  geom_ribbon(aes(ymin = anomalies - std, ymax = anomalies + std), fill = "grey", alpha = 0.3) +
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  labs(
    x = "Year",
    y = "anomalies [mm] (w.r.t. 1420-1450)",
    title = paste("EM PCWD anomalies for", selected_continent)
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "orange")
  ) +
  facet_wrap(~region, scales = "free_y")  # Facet by region with independent y-axis scales

##### Australia ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "Australia"
anom_filtered <- anom_df_1850 %>% filter(continent == selected_continent)

# Plot anom time series
ggplot(anom_filtered, aes(x = time, y = anomalies)) +
  geom_line() +  # Plot lines for each region
  geom_ribbon(aes(ymin = anomalies - std, ymax = anomalies + std), fill = "grey", alpha = 0.3) +
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  labs(
    x = "Year",
    y = "anomalies [mm] (w.r.t. 1420-1450)",
    title = paste("EM PCWD anomalies for", selected_continent)
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "blue")
  ) +
  facet_wrap(~region, scales = "free_y")  # Facet by region with independent y-axis scales


##### Africa ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "Africa"
anom_filtered <- anom_df_1850 %>% filter(continent == selected_continent)

# Plot anom time series
ggplot(anom_filtered, aes(x = time, y = anomalies)) +
  geom_line() +  # Plot lines for each region
  geom_ribbon(aes(ymin = anomalies - std, ymax = anomalies + std), fill = "grey", alpha = 0.3) +
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  labs(
    x = "Year",
    y = "anomalies [mm] (w.r.t. 1420-1450)",
    title = paste("EM PCWD anomalies for", selected_continent)
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "purple")
  ) +
  facet_wrap(~region, scales = "free_y")  # Facet by region with independent y-axis scales


#### North America ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "North America"
anom_filtered <- anom_df_1850 %>% filter(continent == selected_continent)

# Plot anom time series
ggplot(anom_filtered, aes(x = time, y = anomalies)) +
  geom_line() +  # Plot lines for each region
  geom_ribbon(aes(ymin = anomalies - std, ymax = anomalies + std), fill = "grey", alpha = 0.3) +
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  labs(
    x = "Year",
    y = "anomalies [mm] (w.r.t. 1420-1450)",
    title = paste("EM PCWD anomalies for", selected_continent)
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "lightgreen")
  ) +
  facet_wrap(~region, scales = "free_y")  # Facet by region with independent y-axis scales

#### Central America ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "Central America"
anom_filtered <- anom_df_1850 %>% filter(continent == selected_continent)

# Plot anom time series
ggplot(anom_filtered, aes(x = time, y = anomalies)) +
  geom_line() +  # Plot lines for each region
  geom_ribbon(aes(ymin = anomalies - std, ymax = anomalies + std), fill = "grey", alpha = 0.3) +
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  labs(
    x = "Year",
    y = "anomalies [mm] (w.r.t. 1420-1450)",
    title = paste("EM PCWD anomalies for", selected_continent)
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "lightblue")
  ) +
  facet_wrap(~region, scales = "free_y")  # Facet by region with independent y-axis scales


#### South America ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "South America"
anom_filtered <- anom_df_1850 %>% filter(continent == selected_continent)

# Plot anom time series
ggplot(anom_filtered, aes(x = time, y = anomalies)) +
  geom_line() +  # Plot lines for each region
  geom_ribbon(aes(ymin = anomalies - std, ymax = anomalies + std), fill = "grey", alpha = 0.3) +
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  labs(
    x = "Year",
    y = "anomalies [mm] (w.r.t. 1420-1450)",
    title = paste("EM PCWD anomalies for", selected_continent)
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "yellow")
  ) +
  facet_wrap(~region, scales = "free_y")  # Facet by region with independent y-axis scales

```

Calculate z-scores (annual values):

Interpreting the Z-Scores
- z = 0 → Anomaly is equal to the baseline mean.
- z = ±1 → Anomaly is one standard deviation from the baseline.
- z > ±2 → Strong anomaly, may indicate a significant departure from normal variability.
- z > ±3 → Extreme anomaly, suggesting an event outside typical variability.

```{r}
###################### 1420 epoch z-scores
# Initialize lists to store baselines and standard deviations
anom_baseline <- list()
anom_baseline_sd <- list()

# Loop over regions
for (region_name in names(regional_results_1420)) {
  
  # Extract all ensemble members for the region
  ensemble_members <- regional_results_1420[[region_name]]
  
  # Compute baseline mean (over first 30 years) for each ensemble member
  anom_baseline[[region_name]] <- colMeans(ensemble_members[1:30, ], na.rm = TRUE)
  
  # Compute baseline standard deviation (over first 30 years) for each ensemble member
  anom_baseline_sd[[region_name]] <- apply(ensemble_members[1:30, ], 2, sd, na.rm = TRUE)
}

# Initialize lists to store results
ensemble_anoms_1420 <- list()      # Mean anomalies for each region
ensemble_zscores_1420 <- list()   # Standard deviation of anomalies for each region

# Loop over regions to compute anomalies and z-scores
for (region_name in names(regional_results_1420)) {
  # Extract the ensemble members for the region
  ensemble_members <- regional_results_1420[[region_name]]  # Now using full ensemble data
  
  # Compute anomalies per ensemble member (subtract baseline)
  ensemble_anoms_1420[[region_name]] <- sweep(ensemble_members, 2, anom_baseline[[region_name]], "-")
  
  # Compute z-scores per ensemble member (divide by baseline standard deviation)
  ensemble_zscores_1420[[region_name]] <- sweep(ensemble_anoms_1420[[region_name]], 2, anom_baseline_sd[[region_name]], "/")
}

#mean z-scores for each region
# Initialize a list to store mean z-scores
mean_zscores_1420 <- list()

# Loop over regions
for (region_name in names(regional_results_1420)) {
  
  # Compute the mean z-score across ensemble members for each time step
  mean_zscores_1420[[region_name]] <- rowMeans(ensemble_zscores_1420[[region_name]], na.rm = TRUE)
}

# Initialize a list to store z-score standard deviations
sd_zscores_1420 <- list()

# Loop over regions
for (region_name in names(regional_results_1420)) {
  
  # Compute standard deviation of z-scores across ensemble members
  sd_zscores_1420[[region_name]] <- apply(ensemble_zscores_1420[[region_name]], 1, sd, na.rm = TRUE)
}

########### 1420 period
# Convert z-score data into a data frame for ggplot
zscore_df_1420 <- do.call(rbind, lapply(names(mean_zscores_1420), function(region) {
  data.frame(
    time = seq(1420, 1849),  # Adjust time range accordingly
    mean_zscore = mean_zscores_1420[[region]],  
    sd_zscore = sd_zscores_1420[[region]],  # Standard deviation for uncertainty bands
    region = region
  )
}))


# Add a continent column to the SNR data frame
zscore_df_1420$continent <- NA  # Initialize continent column

for (continent in names(continent_mapping)) {
  zscore_df_1420$continent[zscore_df_1420$region %in% continent_mapping[[continent]]] <- continent
}


```

plot z-score anomalies overlain with volcanic forcing for earlier epoch: 

```{r}
#################all continents for 1420 epoch ###################################
#test to incorporate volcanic forcings also: 

#### Europe ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "Europe"
zscore_filtered <- zscore_df_1420 %>% filter(continent == selected_continent)

# Normalize AOD data to fit the anomalies scale
aod_min <- min(aod_annual_mean_1420$annual_mean_value, na.rm = TRUE)
aod_max <- max(aod_annual_mean_1420$annual_mean_value, na.rm = TRUE)
zscore_min <- min(zscore_filtered$mean_zscore, na.rm = TRUE)
zscore_max <- max(zscore_filtered$mean_zscore, na.rm = TRUE)

# Calculate scale factor to ensure zero alignment
aod_zero <- 0  # AOD zero point
zs_zero <- 0  # Anomalies zero point
scale_factor <- (zscore_max - zscore_min) / (aod_max - aod_min)  # Scale based on range

# Scale AOD values to match the anomalies scale
annual_mean <- aod_annual_mean_1420 %>%
  mutate(scaled_aod = (annual_mean_value - aod_zero) * scale_factor + zs_zero)

# Plot zscore time series
ggplot(zscore_filtered, aes(x = time, y = mean_zscore, color = "PCWD Z-Scores")) +
  geom_line() +  # Plot lines for each region
  #geom_ribbon(aes(ymin = mean_zscore - sd_zscore, ymax = mean_zscore + sd_zscore), fill = "grey", alpha = 0.3) +
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  # geom_hline(yintercept = 2, color = "indianred", linetype = "dotted")+
  # geom_hline(yintercept = -2, color = "indianred", linetype = "dotted")+
  # Secondary Y-axis: Volcanic Forcing (AOD)
  geom_line(data = annual_mean, aes(x = year, y = scaled_aod, color = "Volcanic Forcing (AOD)"), linewidth = 0.5, linetype = "dotted") +
  labs(
    x = "Year",
    y = "z-score (w.r.t. 1420-1450)",
    title = paste("EM PCWD Z-Scores for", selected_continent)
  ) +
  # Secondary axis transformation ensuring zero alignment
  scale_y_continuous(
    sec.axis = sec_axis(
      ~ (. - zs_zero) / scale_factor + aod_zero, 
      name = "Annual Mean AOD"
    )
  ) +
  # Manual color scale for legend
  scale_color_manual(
    values = c("PCWD Z-Scores" = "black", "Volcanic Forcing (AOD)" = "red")
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    legend.title = element_text(face = "bold"),
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "pink")
  ) +
  facet_wrap(~region, scales = "free_y")  # Facet by region with independent y-axis scales


#### Asia ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "Asia"
zscore_filtered <- zscore_df_1420 %>% filter(continent == selected_continent)

# Normalize AOD data to fit the anomalies scale
aod_min <- min(aod_annual_mean_1420$annual_mean_value, na.rm = TRUE)
aod_max <- max(aod_annual_mean_1420$annual_mean_value, na.rm = TRUE)
zscore_min <- min(zscore_filtered$mean_zscore, na.rm = TRUE)
zscore_max <- max(zscore_filtered$mean_zscore, na.rm = TRUE)

# Calculate scale factor to ensure zero alignment
aod_zero <- 0  # AOD zero point
zs_zero <- 0  # Anomalies zero point
scale_factor <- (zscore_max - zscore_min) / (aod_max - aod_min)  # Scale based on range

# Scale AOD values to match the anomalies scale
annual_mean <- aod_annual_mean_1420 %>%
  mutate(scaled_aod = (annual_mean_value - aod_zero) * scale_factor + zs_zero)

# Plot zscore time series
ggplot(zscore_filtered, aes(x = time, y = mean_zscore, color = "PCWD Z-Scores")) +
  geom_line() +  # Plot lines for each region
  #geom_ribbon(aes(ymin = mean_zscore - sd_zscore, ymax = mean_zscore + sd_zscore), fill = "grey", alpha = 0.3) +
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  # geom_hline(yintercept = 2, color = "indianred", linetype = "dotted")+
  # geom_hline(yintercept = -2, color = "indianred", linetype = "dotted")+
  # Secondary Y-axis: Volcanic Forcing (AOD)
  geom_line(data = annual_mean, aes(x = year, y = scaled_aod, color = "Volcanic Forcing (AOD)"), linewidth = 0.5, linetype = "dotted") +
  labs(
    x = "Year",
    y = "z-score (w.r.t. 1420-1450)",
    title = paste("EM PCWD Z-Scores for", selected_continent)
  ) +
  # Secondary axis transformation ensuring zero alignment
  scale_y_continuous(
    sec.axis = sec_axis(
      ~ (. - zs_zero) / scale_factor + aod_zero, 
      name = "Annual Mean AOD"
    )
  ) +
  # Manual color scale for legend
  scale_color_manual(
    values = c("PCWD Z-Scores" = "black", "Volcanic Forcing (AOD)" = "red")
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    legend.title = element_text(face = "bold"),
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "orange")
  ) +
  facet_wrap(~region, scales = "free_y")  # Facet by region with independent y-axis scales

#### Australia ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "Australia"
zscore_filtered <- zscore_df_1420 %>% filter(continent == selected_continent)

# Normalize AOD data to fit the anomalies scale
aod_min <- min(aod_annual_mean_1420$annual_mean_value, na.rm = TRUE)
aod_max <- max(aod_annual_mean_1420$annual_mean_value, na.rm = TRUE)
zscore_min <- min(zscore_filtered$mean_zscore, na.rm = TRUE)
zscore_max <- max(zscore_filtered$mean_zscore, na.rm = TRUE)

# Calculate scale factor to ensure zero alignment
aod_zero <- 0  # AOD zero point
zs_zero <- 0  # Anomalies zero point
scale_factor <- (zscore_max - zscore_min) / (aod_max - aod_min)  # Scale based on range

# Scale AOD values to match the anomalies scale
annual_mean <- aod_annual_mean_1420 %>%
  mutate(scaled_aod = (annual_mean_value - aod_zero) * scale_factor + zs_zero)

# Plot zscore time series
ggplot(zscore_filtered, aes(x = time, y = mean_zscore, color = "PCWD Z-Scores")) +
  geom_line() +  # Plot lines for each region
  #geom_ribbon(aes(ymin = mean_zscore - sd_zscore, ymax = mean_zscore + sd_zscore), fill = "grey", alpha = 0.3) +
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  # geom_hline(yintercept = 2, color = "indianred", linetype = "dotted")+
  # geom_hline(yintercept = -2, color = "indianred", linetype = "dotted")+
  # Secondary Y-axis: Volcanic Forcing (AOD)
  geom_line(data = annual_mean, aes(x = year, y = scaled_aod, color = "Volcanic Forcing (AOD)"), linewidth = 0.5, linetype = "dotted") +
  labs(
    x = "Year",
    y = "z-score (w.r.t. 1420-1450)",
    title = paste("EM PCWD Z-Scores for", selected_continent)
  ) +
  # Secondary axis transformation ensuring zero alignment
  scale_y_continuous(
    sec.axis = sec_axis(
      ~ (. - zs_zero) / scale_factor + aod_zero, 
      name = "Annual Mean AOD"
    )
  ) +
  # Manual color scale for legend
  scale_color_manual(
    values = c("PCWD Z-Scores" = "black", "Volcanic Forcing (AOD)" = "red")
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    legend.title = element_text(face = "bold"),
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "blue")
  ) +
  facet_wrap(~region, scales = "free_y")  # Facet by region with independent y-axis scales

#### Africa ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "Africa"
zscore_filtered <- zscore_df_1420 %>% filter(continent == selected_continent)

# Normalize AOD data to fit the anomalies scale
aod_min <- min(aod_annual_mean_1420$annual_mean_value, na.rm = TRUE)
aod_max <- max(aod_annual_mean_1420$annual_mean_value, na.rm = TRUE)
zscore_min <- min(zscore_filtered$mean_zscore, na.rm = TRUE)
zscore_max <- max(zscore_filtered$mean_zscore, na.rm = TRUE)

# Calculate scale factor to ensure zero alignment
aod_zero <- 0  # AOD zero point
zs_zero <- 0  # Anomalies zero point
scale_factor <- (zscore_max - zscore_min) / (aod_max - aod_min)  # Scale based on range

# Scale AOD values to match the anomalies scale
annual_mean <- aod_annual_mean_1420 %>%
  mutate(scaled_aod = (annual_mean_value - aod_zero) * scale_factor + zs_zero)

# Plot zscore time series
ggplot(zscore_filtered, aes(x = time, y = mean_zscore, color = "PCWD Z-Scores")) +
  geom_line() +  # Plot lines for each region
  #geom_ribbon(aes(ymin = mean_zscore - sd_zscore, ymax = mean_zscore + sd_zscore), fill = "grey", alpha = 0.3) +
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  # geom_hline(yintercept = 2, color = "indianred", linetype = "dotted")+
  # geom_hline(yintercept = -2, color = "indianred", linetype = "dotted")+
  # Secondary Y-axis: Volcanic Forcing (AOD)
  geom_line(data = annual_mean, aes(x = year, y = scaled_aod, color = "Volcanic Forcing (AOD)"), linewidth = 0.5, linetype = "dotted") +
  labs(
    x = "Year",
    y = "z-score (w.r.t. 1420-1450)",
    title = paste("EM PCWD Z-Scores for", selected_continent)
  ) +
  # Secondary axis transformation ensuring zero alignment
  scale_y_continuous(
    sec.axis = sec_axis(
      ~ (. - zs_zero) / scale_factor + aod_zero, 
      name = "Annual Mean AOD"
    )
  ) +
  # Manual color scale for legend
  scale_color_manual(
    values = c("PCWD Z-Scores" = "black", "Volcanic Forcing (AOD)" = "red")
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    legend.title = element_text(face = "bold"),
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "purple")
  ) +
  facet_wrap(~region, scales = "free_y")  # Facet by region with independent y-axis scales

#### North America ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "North America"
zscore_filtered <- zscore_df_1420 %>% filter(continent == selected_continent)

# Normalize AOD data to fit the anomalies scale
aod_min <- min(aod_annual_mean_1420$annual_mean_value, na.rm = TRUE)
aod_max <- max(aod_annual_mean_1420$annual_mean_value, na.rm = TRUE)
zscore_min <- min(zscore_filtered$mean_zscore, na.rm = TRUE)
zscore_max <- max(zscore_filtered$mean_zscore, na.rm = TRUE)

# Calculate scale factor to ensure zero alignment
aod_zero <- 0  # AOD zero point
zs_zero <- 0  # Anomalies zero point
scale_factor <- (zscore_max - zscore_min) / (aod_max - aod_min)  # Scale based on range

# Scale AOD values to match the anomalies scale
annual_mean <- aod_annual_mean_1420 %>%
  mutate(scaled_aod = (annual_mean_value - aod_zero) * scale_factor + zs_zero)

# Plot zscore time series
ggplot(zscore_filtered, aes(x = time, y = mean_zscore, color = "PCWD Z-Scores")) +
  geom_line() +  # Plot lines for each region
  #geom_ribbon(aes(ymin = mean_zscore - sd_zscore, ymax = mean_zscore + sd_zscore), fill = "grey", alpha = 0.3) +
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  # geom_hline(yintercept = 2, color = "indianred", linetype = "dotted")+
  # geom_hline(yintercept = -2, color = "indianred", linetype = "dotted")+
  # Secondary Y-axis: Volcanic Forcing (AOD)
  geom_line(data = annual_mean, aes(x = year, y = scaled_aod, color = "Volcanic Forcing (AOD)"), linewidth = 0.5, linetype = "dotted") +
  labs(
    x = "Year",
    y = "z-score (w.r.t. 1420-1450)",
    title = paste("EM PCWD Z-Scores for", selected_continent)
  ) +
  # Secondary axis transformation ensuring zero alignment
  scale_y_continuous(
    sec.axis = sec_axis(
      ~ (. - zs_zero) / scale_factor + aod_zero, 
      name = "Annual Mean AOD"
    )
  ) +
  # Manual color scale for legend
  scale_color_manual(
    values = c("PCWD Z-Scores" = "black", "Volcanic Forcing (AOD)" = "red")
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    legend.title = element_text(face = "bold"),
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "lightgreen")
  ) +
  facet_wrap(~region, scales = "free_y")  # Facet by region with independent y-axis scales

#### Central America ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "Central America"
zscore_filtered <- zscore_df_1420 %>% filter(continent == selected_continent)

# Normalize AOD data to fit the anomalies scale
aod_min <- min(aod_annual_mean_1420$annual_mean_value, na.rm = TRUE)
aod_max <- max(aod_annual_mean_1420$annual_mean_value, na.rm = TRUE)
zscore_min <- min(zscore_filtered$mean_zscore, na.rm = TRUE)
zscore_max <- max(zscore_filtered$mean_zscore, na.rm = TRUE)

# Calculate scale factor to ensure zero alignment
aod_zero <- 0  # AOD zero point
zs_zero <- 0  # Anomalies zero point
scale_factor <- (zscore_max - zscore_min) / (aod_max - aod_min)  # Scale based on range

# Scale AOD values to match the anomalies scale
annual_mean <- aod_annual_mean_1420 %>%
  mutate(scaled_aod = (annual_mean_value - aod_zero) * scale_factor + zs_zero)

# Plot zscore time series
ggplot(zscore_filtered, aes(x = time, y = mean_zscore, color = "PCWD Z-Scores")) +
  geom_line() +  # Plot lines for each region
  #geom_ribbon(aes(ymin = mean_zscore - sd_zscore, ymax = mean_zscore + sd_zscore), fill = "grey", alpha = 0.3) +
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  # geom_hline(yintercept = 2, color = "indianred", linetype = "dotted")+
  # geom_hline(yintercept = -2, color = "indianred", linetype = "dotted")+
  # Secondary Y-axis: Volcanic Forcing (AOD)
  geom_line(data = annual_mean, aes(x = year, y = scaled_aod, color = "Volcanic Forcing (AOD)"), linewidth = 0.5, linetype = "dotted") +
  labs(
    x = "Year",
    y = "z-score (w.r.t. 1420-1450)",
    title = paste("EM PCWD Z-Scores for", selected_continent)
  ) +
  # Secondary axis transformation ensuring zero alignment
  scale_y_continuous(
    sec.axis = sec_axis(
      ~ (. - zs_zero) / scale_factor + aod_zero, 
      name = "Annual Mean AOD"
    )
  ) +
  # Manual color scale for legend
  scale_color_manual(
    values = c("PCWD Z-Scores" = "black", "Volcanic Forcing (AOD)" = "red")
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    legend.title = element_text(face = "bold"),
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "lightblue")
  ) +
  facet_wrap(~region, scales = "free_y")  # Facet by region with independent y-axis scales

#### South America ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "South America"
zscore_filtered <- zscore_df_1420 %>% filter(continent == selected_continent)

# Normalize AOD data to fit the anomalies scale
aod_min <- min(aod_annual_mean_1420$annual_mean_value, na.rm = TRUE)
aod_max <- max(aod_annual_mean_1420$annual_mean_value, na.rm = TRUE)
zscore_min <- min(zscore_filtered$mean_zscore, na.rm = TRUE)
zscore_max <- max(zscore_filtered$mean_zscore, na.rm = TRUE)

# Calculate scale factor to ensure zero alignment
aod_zero <- 0  # AOD zero point
zs_zero <- 0  # Anomalies zero point
scale_factor <- (zscore_max - zscore_min) / (aod_max - aod_min)  # Scale based on range

# Scale AOD values to match the anomalies scale
annual_mean <- aod_annual_mean_1420 %>%
  mutate(scaled_aod = (annual_mean_value - aod_zero) * scale_factor + zs_zero)

# Plot zscore time series
ggplot(zscore_filtered, aes(x = time, y = mean_zscore, color = "PCWD Z-Scores")) +
  geom_line() +  # Plot lines for each region
  #geom_ribbon(aes(ymin = mean_zscore - sd_zscore, ymax = mean_zscore + sd_zscore), fill = "grey", alpha = 0.3) +
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  # geom_hline(yintercept = 2, color = "indianred", linetype = "dotted")+
  # geom_hline(yintercept = -2, color = "indianred", linetype = "dotted")+
  # Secondary Y-axis: Volcanic Forcing (AOD)
  geom_line(data = annual_mean, aes(x = year, y = scaled_aod, color = "Volcanic Forcing (AOD)"), linewidth = 0.5, linetype = "dotted") +
  labs(
    x = "Year",
    y = "z-score (w.r.t. 1420-1450)",
    title = paste("EM PCWD Z-Scores for", selected_continent)
  ) +
  # Secondary axis transformation ensuring zero alignment
  scale_y_continuous(
    sec.axis = sec_axis(
      ~ (. - zs_zero) / scale_factor + aod_zero, 
      name = "Annual Mean AOD"
    )
  ) +
  # Manual color scale for legend
  scale_color_manual(
    values = c("PCWD Z-Scores" = "black", "Volcanic Forcing (AOD)" = "red")
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    legend.title = element_text(face = "bold"),
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "yellow")
  ) +
  facet_wrap(~region, scales = "free_y")  # Facet by region with independent y-axis scales


```



Calculate z-scores (for 30 year moving window-climatic anomalies):

Interpreting the Z-Scores
- z = 0 → Anomaly is equal to the baseline mean.
- z = ±1 → Anomaly is one standard deviation from the baseline.
- z > ±2 → Strong anomaly, may indicate a significant departure from normal variability.
- z > ±3 → Extreme anomaly, suggesting an event outside typical variability.

```{r}
# Initialize lists to store baselines and standard deviations
anom_baseline <- list()
anom_baseline_sd <- list()

###################### 1420 epoch z-scores
# Loop over regions
for (region_name in names(regional_results_1420)) {
  
  # Extract all ensemble members for the region
  ensemble_members <- regional_results_1420[[region_name]]
  
  # Compute baseline mean (over first 30 years) for each ensemble member
  anom_baseline[[region_name]] <- colMeans(ensemble_members[1:30, ], na.rm = TRUE)
  
  # Compute baseline standard deviation (over first 30 years) for each ensemble member
  anom_baseline_sd[[region_name]] <- apply(ensemble_members[1:30, ], 2, sd, na.rm = TRUE)
}

# Initialize lists to store results
ensemble_anoms_1420 <- list()      # Mean anomalies for each region
ensemble_zscores_1420 <- list()   # Standard deviation of anomalies for each region

# Define window size
window_size <- 31

###################### Compute 30-year moving means and z-scores
# Initialize lists to store z-scores
ensemble_zscores_1420 <- list()

# Loop over regions
for (region_name in names(regional_results_1420)) {
  
  # Extract ensemble members for the region
  ensemble_members <- regional_results_1420[[region_name]]
  num_years <- nrow(ensemble_members)
  
  # Initialize matrix to store moving z-scores (we get num_years - window_size + 1 values)
  z_scores <- matrix(NA, nrow=num_years - window_size + 1, ncol=ncol(ensemble_members))
  
  # Compute 30-year moving mean and z-scores
  for (t in 1:(num_years - window_size + 1)) {  # Prevent going out of bounds
    moving_mean <- colMeans(ensemble_members[t:(t+window_size-1), ], na.rm = TRUE)  # 30-year mean
    
    # Compute z-score using fixed baseline
    z_scores[t, ] <- (moving_mean - anom_baseline[[region_name]]) / anom_baseline_sd[[region_name]]
  }
  
  # Store results
  ensemble_zscores_1420[[region_name]] <- z_scores
}
#mean z-scores for each region
# Initialize a list to store mean z-scores
mean_zscores_1420 <- list()

# Loop over regions
for (region_name in names(regional_results_1420)) {
  
  # Compute the mean z-score across ensemble members for each time step
  mean_zscores_1420[[region_name]] <- rowMeans(ensemble_zscores_1420[[region_name]], na.rm = TRUE)
}

# Initialize a list to store z-score standard deviations
sd_zscores_1420 <- list()

# Loop over regions
for (region_name in names(regional_results_1420)) {
  
  # Compute standard deviation of z-scores across ensemble members
  sd_zscores_1420[[region_name]] <- apply(ensemble_zscores_1420[[region_name]], 1, sd, na.rm = TRUE)
}



####################### 1850 epoch z-scores
# Initialize lists to store baselines and standard deviations
anom_baseline_1850 <- list()
anom_baseline_sd_1850 <- list()

###################### 1420 epoch z-scores
# Loop over regions
for (region_name in names(regional_results_1850)) {
  
  # Extract all ensemble members for the region
  ensemble_members <- regional_results_1850[[region_name]]
  
  # Compute baseline mean (over first 30 years) for each ensemble member
  anom_baseline_1850[[region_name]] <- colMeans(ensemble_members[1:30, ], na.rm = TRUE)
  
  # Compute baseline standard deviation (over first 30 years) for each ensemble member
  anom_baseline_sd_1850[[region_name]] <- apply(ensemble_members[1:30, ], 2, sd, na.rm = TRUE)
}
# Define window size
window_size <- 31

###################### Compute 30-year moving means and z-scores
# Initialize lists to store z-scores
ensemble_zscores_1850 <- list()

# Loop over regions
for (region_name in names(regional_results_1850)) {
  
  # Extract ensemble members for the region
  ensemble_members <- regional_results_1850[[region_name]]
  num_years <- nrow(ensemble_members)
  
  # Initialize matrix to store moving z-scores (we get num_years - window_size + 1 values)
  z_scores <- matrix(NA, nrow=num_years - window_size + 1, ncol=ncol(ensemble_members))
  
  # Compute 30-year moving mean and z-scores
  for (t in 1:(num_years - window_size + 1)) {  # Prevent going out of bounds
    moving_mean <- colMeans(ensemble_members[t:(t+window_size-1), ], na.rm = TRUE)  # 30-year mean
    
    # Compute z-score using fixed baseline
    z_scores[t, ] <- (moving_mean - anom_baseline_1850[[region_name]]) / anom_baseline_sd_1850[[region_name]]
  }
  
  # Store results
  ensemble_zscores_1850[[region_name]] <- z_scores
}

# Initialize a list to store mean z-scores
mean_zscores_1850 <- list()

# Loop over regions
for (region_name in names(regional_results_1850)) {
  
  # Compute the mean z-score across ensemble members for each time step
  mean_zscores_1850[[region_name]] <- rowMeans(ensemble_zscores_1850[[region_name]], na.rm = TRUE)
}

# Initialize a list to store z-score standard deviations
sd_zscores_1850 <- list()

# Loop over regions
for (region_name in names(regional_results_1850)) {
  
  # Compute standard deviation of z-scores across ensemble members
  sd_zscores_1850[[region_name]] <- apply(ensemble_zscores_1850[[region_name]], 1, sd, na.rm = TRUE)
}


```

Convert to dataframes for plotting: 

```{r}
########### 1420 period
# Convert z-score data into a data frame for ggplot
zscore_df_1420 <- do.call(rbind, lapply(names(mean_zscores_1420), function(region) {
  data.frame(
    time = seq(1435, 1834),  # Adjust time range accordingly
    mean_zscore = mean_zscores_1420[[region]],  
    sd_zscore = sd_zscores_1420[[region]],  # Standard deviation for uncertainty bands
    region = region
  )
}))


# Add a continent column to the SNR data frame
zscore_df_1420$continent <- NA  # Initialize continent column

for (continent in names(continent_mapping)) {
  zscore_df_1420$continent[zscore_df_1420$region %in% continent_mapping[[continent]]] <- continent
}


###### 1850 period
# Convert z-score data into a data frame for ggplot
zscore_df_1850 <- do.call(rbind, lapply(names(mean_zscores_1850), function(region) {
  data.frame(
    time = seq(1865, 1994),  # Adjust time range accordingly
    mean_zscore = mean_zscores_1850[[region]],  
    sd_zscore = sd_zscores_1850[[region]],  # Standard deviation for uncertainty bands
    region = region
  )
}))


# Add a continent column to the SNR data frame
zscore_df_1850$continent <- NA  # Initialize continent column

for (continent in names(continent_mapping)) {
  zscore_df_1850$continent[zscore_df_1850$region %in% continent_mapping[[continent]]] <- continent
}

```

test plot with volcanic forcing overlay: 
```{r}
#################all continents for 1420 epoch ###################################
#test to incorporate volcanic forcings also: 

#### Europe ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "Europe"
zscore_filtered <- zscore_df_1420 %>% filter(continent == selected_continent)

# Normalize AOD data to fit the anomalies scale
aod_min <- min(aod_annual_mean_1420$annual_mean_value, na.rm = TRUE)
aod_max <- max(aod_annual_mean_1420$annual_mean_value, na.rm = TRUE)
zscore_min <- min(zscore_filtered$mean_zscore, na.rm = TRUE)
zscore_max <- max(zscore_filtered$mean_zscore, na.rm = TRUE)

# Calculate scale factor to ensure zero alignment
aod_zero <- 0  # AOD zero point
zs_zero <- 0  # Anomalies zero point
scale_factor <- (zscore_max - zscore_min) / (aod_max - aod_min)  # Scale based on range

# Scale AOD values to match the anomalies scale
annual_mean <- aod_annual_mean_1420 %>%
  mutate(scaled_aod = (annual_mean_value - aod_zero) * scale_factor + zs_zero)

# Plot zscore time series
ggplot(zscore_filtered, aes(x = time, y = mean_zscore, color = "PCWD Z-Scores")) +
  geom_line() +  # Plot lines for each region
  #geom_ribbon(aes(ymin = mean_zscore - sd_zscore, ymax = mean_zscore + sd_zscore), fill = "grey", alpha = 0.3) +
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  # geom_hline(yintercept = 2, color = "indianred", linetype = "dotted")+
  # geom_hline(yintercept = -2, color = "indianred", linetype = "dotted")+
  # Secondary Y-axis: Volcanic Forcing (AOD)
  geom_line(data = annual_mean, aes(x = year, y = scaled_aod, color = "Volcanic Forcing (AOD)"), linewidth = 0.5, linetype = "dotted") +
  labs(
    x = "Year",
    y = "z-score (w.r.t. 1420-1450)",
    title = paste("EM PCWD Z-Scores for", selected_continent)
  ) +
  # Secondary axis transformation ensuring zero alignment
  scale_y_continuous(
    sec.axis = sec_axis(
      ~ (. - zs_zero) / scale_factor + aod_zero, 
      name = "Annual Mean AOD"
    )
  ) +
  # Manual color scale for legend
  scale_color_manual(
    values = c("PCWD Z-Scores" = "black", "Volcanic Forcing (AOD)" = "red")
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    legend.title = element_text(face = "bold"),
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "pink")
  ) +
  facet_wrap(~region, scales = "free_y")  # Facet by region with independent y-axis scales


#### Asia ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "Asia"
zscore_filtered <- zscore_df_1420 %>% filter(continent == selected_continent)

# Normalize AOD data to fit the anomalies scale
aod_min <- min(aod_annual_mean_1420$annual_mean_value, na.rm = TRUE)
aod_max <- max(aod_annual_mean_1420$annual_mean_value, na.rm = TRUE)
zscore_min <- min(zscore_filtered$mean_zscore, na.rm = TRUE)
zscore_max <- max(zscore_filtered$mean_zscore, na.rm = TRUE)

# Calculate scale factor to ensure zero alignment
aod_zero <- 0  # AOD zero point
zs_zero <- 0  # Anomalies zero point
scale_factor <- (zscore_max - zscore_min) / (aod_max - aod_min)  # Scale based on range

# Scale AOD values to match the anomalies scale
annual_mean <- aod_annual_mean_1420 %>%
  mutate(scaled_aod = (annual_mean_value - aod_zero) * scale_factor + zs_zero)

# Plot zscore time series
ggplot(zscore_filtered, aes(x = time, y = mean_zscore, color = "PCWD Z-Scores")) +
  geom_line() +  # Plot lines for each region
  #geom_ribbon(aes(ymin = mean_zscore - sd_zscore, ymax = mean_zscore + sd_zscore), fill = "grey", alpha = 0.3) +
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  # geom_hline(yintercept = 2, color = "indianred", linetype = "dotted")+
  # geom_hline(yintercept = -2, color = "indianred", linetype = "dotted")+
  # Secondary Y-axis: Volcanic Forcing (AOD)
  geom_line(data = annual_mean, aes(x = year, y = scaled_aod, color = "Volcanic Forcing (AOD)"), linewidth = 0.5, linetype = "dotted") +
  labs(
    x = "Year",
    y = "z-score (w.r.t. 1420-1450)",
    title = paste("EM PCWD Z-Scores for", selected_continent)
  ) +
  # Secondary axis transformation ensuring zero alignment
  scale_y_continuous(
    sec.axis = sec_axis(
      ~ (. - zs_zero) / scale_factor + aod_zero, 
      name = "Annual Mean AOD"
    )
  ) +
  # Manual color scale for legend
  scale_color_manual(
    values = c("PCWD Z-Scores" = "black", "Volcanic Forcing (AOD)" = "red")
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    legend.title = element_text(face = "bold"),
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "orange")
  ) +
  facet_wrap(~region, scales = "free_y")  # Facet by region with independent y-axis scales

#### Australia ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "Australia"
zscore_filtered <- zscore_df_1420 %>% filter(continent == selected_continent)

# Normalize AOD data to fit the anomalies scale
aod_min <- min(aod_annual_mean_1420$annual_mean_value, na.rm = TRUE)
aod_max <- max(aod_annual_mean_1420$annual_mean_value, na.rm = TRUE)
zscore_min <- min(zscore_filtered$mean_zscore, na.rm = TRUE)
zscore_max <- max(zscore_filtered$mean_zscore, na.rm = TRUE)

# Calculate scale factor to ensure zero alignment
aod_zero <- 0  # AOD zero point
zs_zero <- 0  # Anomalies zero point
scale_factor <- (zscore_max - zscore_min) / (aod_max - aod_min)  # Scale based on range

# Scale AOD values to match the anomalies scale
annual_mean <- aod_annual_mean_1420 %>%
  mutate(scaled_aod = (annual_mean_value - aod_zero) * scale_factor + zs_zero)

# Plot zscore time series
ggplot(zscore_filtered, aes(x = time, y = mean_zscore, color = "PCWD Z-Scores")) +
  geom_line() +  # Plot lines for each region
  #geom_ribbon(aes(ymin = mean_zscore - sd_zscore, ymax = mean_zscore + sd_zscore), fill = "grey", alpha = 0.3) +
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  # geom_hline(yintercept = 2, color = "indianred", linetype = "dotted")+
  # geom_hline(yintercept = -2, color = "indianred", linetype = "dotted")+
  # Secondary Y-axis: Volcanic Forcing (AOD)
  geom_line(data = annual_mean, aes(x = year, y = scaled_aod, color = "Volcanic Forcing (AOD)"), linewidth = 0.5, linetype = "dotted") +
  labs(
    x = "Year",
    y = "z-score (w.r.t. 1420-1450)",
    title = paste("EM PCWD Z-Scores for", selected_continent)
  ) +
  # Secondary axis transformation ensuring zero alignment
  scale_y_continuous(
    sec.axis = sec_axis(
      ~ (. - zs_zero) / scale_factor + aod_zero, 
      name = "Annual Mean AOD"
    )
  ) +
  # Manual color scale for legend
  scale_color_manual(
    values = c("PCWD Z-Scores" = "black", "Volcanic Forcing (AOD)" = "red")
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    legend.title = element_text(face = "bold"),
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "blue")
  ) +
  facet_wrap(~region, scales = "free_y")  # Facet by region with independent y-axis scales

#### Africa ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "Africa"
zscore_filtered <- zscore_df_1420 %>% filter(continent == selected_continent)

# Normalize AOD data to fit the anomalies scale
aod_min <- min(aod_annual_mean_1420$annual_mean_value, na.rm = TRUE)
aod_max <- max(aod_annual_mean_1420$annual_mean_value, na.rm = TRUE)
zscore_min <- min(zscore_filtered$mean_zscore, na.rm = TRUE)
zscore_max <- max(zscore_filtered$mean_zscore, na.rm = TRUE)

# Calculate scale factor to ensure zero alignment
aod_zero <- 0  # AOD zero point
zs_zero <- 0  # Anomalies zero point
scale_factor <- (zscore_max - zscore_min) / (aod_max - aod_min)  # Scale based on range

# Scale AOD values to match the anomalies scale
annual_mean <- aod_annual_mean_1420 %>%
  mutate(scaled_aod = (annual_mean_value - aod_zero) * scale_factor + zs_zero)

# Plot zscore time series
ggplot(zscore_filtered, aes(x = time, y = mean_zscore, color = "PCWD Z-Scores")) +
  geom_line() +  # Plot lines for each region
  #geom_ribbon(aes(ymin = mean_zscore - sd_zscore, ymax = mean_zscore + sd_zscore), fill = "grey", alpha = 0.3) +
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  # geom_hline(yintercept = 2, color = "indianred", linetype = "dotted")+
  # geom_hline(yintercept = -2, color = "indianred", linetype = "dotted")+
  # Secondary Y-axis: Volcanic Forcing (AOD)
  geom_line(data = annual_mean, aes(x = year, y = scaled_aod, color = "Volcanic Forcing (AOD)"), linewidth = 0.5, linetype = "dotted") +
  labs(
    x = "Year",
    y = "z-score (w.r.t. 1420-1450)",
    title = paste("EM PCWD Z-Scores for", selected_continent)
  ) +
  # Secondary axis transformation ensuring zero alignment
  scale_y_continuous(
    sec.axis = sec_axis(
      ~ (. - zs_zero) / scale_factor + aod_zero, 
      name = "Annual Mean AOD"
    )
  ) +
  # Manual color scale for legend
  scale_color_manual(
    values = c("PCWD Z-Scores" = "black", "Volcanic Forcing (AOD)" = "red")
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    legend.title = element_text(face = "bold"),
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "purple")
  ) +
  facet_wrap(~region, scales = "free_y")  # Facet by region with independent y-axis scales

#### North America ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "North America"
zscore_filtered <- zscore_df_1420 %>% filter(continent == selected_continent)

# Normalize AOD data to fit the anomalies scale
aod_min <- min(aod_annual_mean_1420$annual_mean_value, na.rm = TRUE)
aod_max <- max(aod_annual_mean_1420$annual_mean_value, na.rm = TRUE)
zscore_min <- min(zscore_filtered$mean_zscore, na.rm = TRUE)
zscore_max <- max(zscore_filtered$mean_zscore, na.rm = TRUE)

# Calculate scale factor to ensure zero alignment
aod_zero <- 0  # AOD zero point
zs_zero <- 0  # Anomalies zero point
scale_factor <- (zscore_max - zscore_min) / (aod_max - aod_min)  # Scale based on range

# Scale AOD values to match the anomalies scale
annual_mean <- aod_annual_mean_1420 %>%
  mutate(scaled_aod = (annual_mean_value - aod_zero) * scale_factor + zs_zero)

# Plot zscore time series
ggplot(zscore_filtered, aes(x = time, y = mean_zscore, color = "PCWD Z-Scores")) +
  geom_line() +  # Plot lines for each region
  #geom_ribbon(aes(ymin = mean_zscore - sd_zscore, ymax = mean_zscore + sd_zscore), fill = "grey", alpha = 0.3) +
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  # geom_hline(yintercept = 2, color = "indianred", linetype = "dotted")+
  # geom_hline(yintercept = -2, color = "indianred", linetype = "dotted")+
  # Secondary Y-axis: Volcanic Forcing (AOD)
  geom_line(data = annual_mean, aes(x = year, y = scaled_aod, color = "Volcanic Forcing (AOD)"), linewidth = 0.5, linetype = "dotted") +
  labs(
    x = "Year",
    y = "z-score (w.r.t. 1420-1450)",
    title = paste("EM PCWD Z-Scores for", selected_continent)
  ) +
  # Secondary axis transformation ensuring zero alignment
  scale_y_continuous(
    sec.axis = sec_axis(
      ~ (. - zs_zero) / scale_factor + aod_zero, 
      name = "Annual Mean AOD"
    )
  ) +
  # Manual color scale for legend
  scale_color_manual(
    values = c("PCWD Z-Scores" = "black", "Volcanic Forcing (AOD)" = "red")
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    legend.title = element_text(face = "bold"),
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "lightgreen")
  ) +
  facet_wrap(~region, scales = "free_y")  # Facet by region with independent y-axis scales

#### Central America ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "Central America"
zscore_filtered <- zscore_df_1420 %>% filter(continent == selected_continent)

# Normalize AOD data to fit the anomalies scale
aod_min <- min(aod_annual_mean_1420$annual_mean_value, na.rm = TRUE)
aod_max <- max(aod_annual_mean_1420$annual_mean_value, na.rm = TRUE)
zscore_min <- min(zscore_filtered$mean_zscore, na.rm = TRUE)
zscore_max <- max(zscore_filtered$mean_zscore, na.rm = TRUE)

# Calculate scale factor to ensure zero alignment
aod_zero <- 0  # AOD zero point
zs_zero <- 0  # Anomalies zero point
scale_factor <- (zscore_max - zscore_min) / (aod_max - aod_min)  # Scale based on range

# Scale AOD values to match the anomalies scale
annual_mean <- aod_annual_mean_1420 %>%
  mutate(scaled_aod = (annual_mean_value - aod_zero) * scale_factor + zs_zero)

# Plot zscore time series
ggplot(zscore_filtered, aes(x = time, y = mean_zscore, color = "PCWD Z-Scores")) +
  geom_line() +  # Plot lines for each region
  #geom_ribbon(aes(ymin = mean_zscore - sd_zscore, ymax = mean_zscore + sd_zscore), fill = "grey", alpha = 0.3) +
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  # geom_hline(yintercept = 2, color = "indianred", linetype = "dotted")+
  # geom_hline(yintercept = -2, color = "indianred", linetype = "dotted")+
  # Secondary Y-axis: Volcanic Forcing (AOD)
  geom_line(data = annual_mean, aes(x = year, y = scaled_aod, color = "Volcanic Forcing (AOD)"), linewidth = 0.5, linetype = "dotted") +
  labs(
    x = "Year",
    y = "z-score (w.r.t. 1420-1450)",
    title = paste("EM PCWD Z-Scores for", selected_continent)
  ) +
  # Secondary axis transformation ensuring zero alignment
  scale_y_continuous(
    sec.axis = sec_axis(
      ~ (. - zs_zero) / scale_factor + aod_zero, 
      name = "Annual Mean AOD"
    )
  ) +
  # Manual color scale for legend
  scale_color_manual(
    values = c("PCWD Z-Scores" = "black", "Volcanic Forcing (AOD)" = "red")
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    legend.title = element_text(face = "bold"),
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "lightblue")
  ) +
  facet_wrap(~region, scales = "free_y")  # Facet by region with independent y-axis scales

#### South America ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "South America"
zscore_filtered <- zscore_df_1420 %>% filter(continent == selected_continent)

# Normalize AOD data to fit the anomalies scale
aod_min <- min(aod_annual_mean_1420$annual_mean_value, na.rm = TRUE)
aod_max <- max(aod_annual_mean_1420$annual_mean_value, na.rm = TRUE)
zscore_min <- min(zscore_filtered$mean_zscore, na.rm = TRUE)
zscore_max <- max(zscore_filtered$mean_zscore, na.rm = TRUE)

# Calculate scale factor to ensure zero alignment
aod_zero <- 0  # AOD zero point
zs_zero <- 0  # Anomalies zero point
scale_factor <- (zscore_max - zscore_min) / (aod_max - aod_min)  # Scale based on range

# Scale AOD values to match the anomalies scale
annual_mean <- aod_annual_mean_1420 %>%
  mutate(scaled_aod = (annual_mean_value - aod_zero) * scale_factor + zs_zero)

# Plot zscore time series
ggplot(zscore_filtered, aes(x = time, y = mean_zscore, color = "PCWD Z-Scores")) +
  geom_line() +  # Plot lines for each region
  #geom_ribbon(aes(ymin = mean_zscore - sd_zscore, ymax = mean_zscore + sd_zscore), fill = "grey", alpha = 0.3) +
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  # geom_hline(yintercept = 2, color = "indianred", linetype = "dotted")+
  # geom_hline(yintercept = -2, color = "indianred", linetype = "dotted")+
  # Secondary Y-axis: Volcanic Forcing (AOD)
  geom_line(data = annual_mean, aes(x = year, y = scaled_aod, color = "Volcanic Forcing (AOD)"), linewidth = 0.5, linetype = "dotted") +
  labs(
    x = "Year",
    y = "z-score (w.r.t. 1420-1450)",
    title = paste("EM PCWD Z-Scores for", selected_continent)
  ) +
  # Secondary axis transformation ensuring zero alignment
  scale_y_continuous(
    sec.axis = sec_axis(
      ~ (. - zs_zero) / scale_factor + aod_zero, 
      name = "Annual Mean AOD"
    )
  ) +
  # Manual color scale for legend
  scale_color_manual(
    values = c("PCWD Z-Scores" = "black", "Volcanic Forcing (AOD)" = "red")
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    legend.title = element_text(face = "bold"),
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "yellow")
  ) +
  facet_wrap(~region, scales = "free_y")  # Facet by region with independent y-axis scales


```


Plot z-scores for 1420 epoch: 
```{r}
#################all continents for 1420 epoch ###################################

#### Europe ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "Europe"
zscore_filtered <- zscore_df_1420 %>% filter(continent == selected_continent)

# Plot zscore time series
ggplot(zscore_filtered, aes(x = time, y = mean_zscore)) +
  geom_line() +  # Plot lines for each region
  geom_ribbon(aes(ymin = mean_zscore - sd_zscore, ymax = mean_zscore + sd_zscore), fill = "grey", alpha = 0.3) +
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  # geom_hline(yintercept = 2, color = "indianred", linetype = "dotted")+
  # geom_hline(yintercept = -2, color = "indianred", linetype = "dotted")+
  labs(
    x = "Year",
    y = "z-score (w.r.t. 1420-1450)",
    title = paste("EM PCWD Z-Scores for", selected_continent)
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "pink")
  ) +
  facet_wrap(~region)  # Facet by region with independent y-axis scales

#### Asia ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "Asia"
zscore_filtered <- zscore_df_1420 %>% filter(continent == selected_continent)

# Plot zscore time series
ggplot(zscore_filtered, aes(x = time, y = mean_zscore)) +
  geom_line() +  # Plot lines for each region
  geom_ribbon(aes(ymin = mean_zscore - sd_zscore, ymax = mean_zscore + sd_zscore), fill = "grey", alpha = 0.3) +
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  # geom_hline(yintercept = 2, color = "indianred", linetype = "dotted")+
  # geom_hline(yintercept = -2, color = "indianred", linetype = "dotted")+
  labs(
    x = "Year",
    y = "z-score (w.r.t. 1420-1450)",
    title = paste("EM PCWD Z-Scores for", selected_continent)
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "orange")
  ) +
  facet_wrap(~region)  # Facet by region with independent y-axis scales

##### Australia ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "Australia"
zscore_filtered <- zscore_df_1420 %>% filter(continent == selected_continent)

# Plot zscore time series
ggplot(zscore_filtered, aes(x = time, y = mean_zscore)) +
  geom_line() +  # Plot lines for each region
  geom_ribbon(aes(ymin = mean_zscore - sd_zscore, ymax = mean_zscore + sd_zscore), fill = "grey", alpha = 0.3) +
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  # geom_hline(yintercept = 2, color = "indianred", linetype = "dotted")+
  # geom_hline(yintercept = -2, color = "indianred", linetype = "dotted")+
  labs(
    x = "Year",
    y = "z-score (w.r.t. 1420-1450)",
    title = paste("EM PCWD Z-Scores for", selected_continent)
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "blue")
  ) +
  facet_wrap(~region)  # Facet by region with independent y-axis scales


##### Africa ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "Africa"
zscore_filtered <- zscore_df_1420 %>% filter(continent == selected_continent)

# Plot zscore time series
ggplot(zscore_filtered, aes(x = time, y = mean_zscore)) +
  geom_line() +  # Plot lines for each region
  geom_ribbon(aes(ymin = mean_zscore - sd_zscore, ymax = mean_zscore + sd_zscore), fill = "grey", alpha = 0.3) +
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+  
  # geom_hline(yintercept = 2, color = "indianred", linetype = "dotted")+
  # geom_hline(yintercept = -2, color = "indianred", linetype = "dotted")+
  labs(
    x = "Year",
    y = "z-score (w.r.t. 1420-1450)",
    title = paste("EM PCWD Z-Scores for", selected_continent)
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "purple")
  ) +
  facet_wrap(~region)  # Facet by region with independent y-axis scales


#### North America ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "North America"
zscore_filtered <- zscore_df_1420 %>% filter(continent == selected_continent)

# Plot zscore time series
ggplot(zscore_filtered, aes(x = time, y = mean_zscore)) +
  geom_line() +  # Plot lines for each region
  geom_ribbon(aes(ymin = mean_zscore - sd_zscore, ymax = mean_zscore + sd_zscore), fill = "grey", alpha = 0.3) +
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  # geom_hline(yintercept = 2, color = "indianred", linetype = "dotted")+
  # geom_hline(yintercept = -2, color = "indianred", linetype = "dotted")+
  labs(
    x = "Year",
    y = "z-score (w.r.t. 1420-1450)",
    title = paste("EM PCWD Z-Scores for", selected_continent)
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "lightgreen")
  ) +
  facet_wrap(~region)  # Facet by region with independent y-axis scales

#### Central America ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "Central America"
zscore_filtered <- zscore_df_1420 %>% filter(continent == selected_continent)

# Plot zscore time series
ggplot(zscore_filtered, aes(x = time, y = mean_zscore)) +
  geom_line() +  # Plot lines for each region
  geom_ribbon(aes(ymin = mean_zscore - sd_zscore, ymax = mean_zscore + sd_zscore), fill = "grey", alpha = 0.3) +
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  # geom_hline(yintercept = 2, color = "indianred", linetype = "dotted")+
  # geom_hline(yintercept = -2, color = "indianred", linetype = "dotted")+
  labs(
    x = "Year",
    y = "z-score (w.r.t. 1420-1450)",
    title = paste("EM PCWD Z-Scores for", selected_continent)
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "lightblue")
  ) +
  facet_wrap(~region)  # Facet by region with independent y-axis scales


#### South America ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "South America"
zscore_filtered <- zscore_df_1420 %>% filter(continent == selected_continent)

# Plot zscore time series
ggplot(zscore_filtered, aes(x = time, y = mean_zscore)) +
  geom_line() +  # Plot lines for each region
  geom_ribbon(aes(ymin = mean_zscore - sd_zscore, ymax = mean_zscore + sd_zscore), fill = "grey", alpha = 0.3) +
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  # geom_hline(yintercept = 2, color = "indianred", linetype = "dotted")+
  # geom_hline(yintercept = -2, color = "indianred", linetype = "dotted")+
  labs(
    x = "Year",
    y = "z-score (w.r.t. 1420-1450)",
    title = paste("EM PCWD Z-Scores for", selected_continent)
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "yellow")
  ) +
  facet_wrap(~region)  # Facet by region with independent y-axis scales

```

Plot z-scores for 1850 epoch: 
```{r}
#################all continents for 1850 epoch ###################################

#### Europe ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "Europe"
zscore_filtered <- zscore_df_1850 %>% filter(continent == selected_continent)

# Plot zscore time series
ggplot(zscore_filtered, aes(x = time, y = mean_zscore)) +
  geom_line() +  # Plot lines for each region
  geom_ribbon(aes(ymin = mean_zscore - sd_zscore, ymax = mean_zscore + sd_zscore), fill = "grey", alpha = 0.3) +
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  # geom_hline(yintercept = 2, color = "indianred", linetype = "dotted")+
  # geom_hline(yintercept = -2, color = "indianred", linetype = "dotted")+
  labs(
    x = "Year",
    y = "z-score (w.r.t. 1850-1880)",
    title = paste("EM PCWD Z-Scores for", selected_continent)
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "pink")
  ) +
  facet_wrap(~region)  # Facet by region with independent y-axis scales

#### Asia ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "Asia"
zscore_filtered <- zscore_df_1850 %>% filter(continent == selected_continent)

# Plot zscore time series
ggplot(zscore_filtered, aes(x = time, y = mean_zscore)) +
  geom_line() +  # Plot lines for each region
  geom_ribbon(aes(ymin = mean_zscore - sd_zscore, ymax = mean_zscore + sd_zscore), fill = "grey", alpha = 0.3) +
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  # geom_hline(yintercept = 2, color = "indianred", linetype = "dotted")+
  # geom_hline(yintercept = -2, color = "indianred", linetype = "dotted")+
  labs(
    x = "Year",
    y = "z-score (w.r.t. 1850-1880)",
    title = paste("EM PCWD Z-Scores for", selected_continent)
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "orange")
  ) +
  facet_wrap(~region)  # Facet by region with independent y-axis scales

##### Australia ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "Australia"
zscore_filtered <- zscore_df_1850 %>% filter(continent == selected_continent)

# Plot zscore time series
ggplot(zscore_filtered, aes(x = time, y = mean_zscore)) +
  geom_line() +  # Plot lines for each region
  geom_ribbon(aes(ymin = mean_zscore - sd_zscore, ymax = mean_zscore + sd_zscore), fill = "grey", alpha = 0.3) +
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  # geom_hline(yintercept = 2, color = "indianred", linetype = "dotted")+
  # geom_hline(yintercept = -2, color = "indianred", linetype = "dotted")+
  labs(
    x = "Year",
    y = "z-score (w.r.t. 1850-1880)",
    title = paste("EM PCWD Z-Scores for", selected_continent)
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "blue")
  ) +
  facet_wrap(~region)  # Facet by region with independent y-axis scales


##### Africa ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "Africa"
zscore_filtered <- zscore_df_1850 %>% filter(continent == selected_continent)

# Plot zscore time series
ggplot(zscore_filtered, aes(x = time, y = mean_zscore)) +
  geom_line() +  # Plot lines for each region
  geom_ribbon(aes(ymin = mean_zscore - sd_zscore, ymax = mean_zscore + sd_zscore), fill = "grey", alpha = 0.3) +
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  # geom_hline(yintercept = 2, color = "indianred", linetype = "dotted")+
  # geom_hline(yintercept = -2, color = "indianred", linetype = "dotted")+
  labs(
    x = "Year",
    y = "z-score (w.r.t. 1850-1880)",
    title = paste("EM PCWD Z-Scores for", selected_continent)
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "purple")
  ) +
  facet_wrap(~region)  # Facet by region with independent y-axis scales


#### North America ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "North America"
zscore_filtered <- zscore_df_1850 %>% filter(continent == selected_continent)

# Plot zscore time series
ggplot(zscore_filtered, aes(x = time, y = mean_zscore)) +
  geom_line() +  # Plot lines for each region
  geom_ribbon(aes(ymin = mean_zscore - sd_zscore, ymax = mean_zscore + sd_zscore), fill = "grey", alpha = 0.3) +
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  # geom_hline(yintercept = 2, color = "indianred", linetype = "dotted")+
  # geom_hline(yintercept = -2, color = "indianred", linetype = "dotted")+
  labs(
    x = "Year",
    y = "z-score (w.r.t. 1850-1880)",
    title = paste("EM PCWD Z-Scores for", selected_continent)
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "lightgreen")
  ) +
  facet_wrap(~region)  # Facet by region with independent y-axis scales

#### Central America ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "Central America"
zscore_filtered <- zscore_df_1850 %>% filter(continent == selected_continent)

# Plot zscore time series
ggplot(zscore_filtered, aes(x = time, y = mean_zscore)) +
  geom_line() +  # Plot lines for each region
  geom_ribbon(aes(ymin = mean_zscore - sd_zscore, ymax = mean_zscore + sd_zscore), fill = "grey", alpha = 0.3) +
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  # geom_hline(yintercept = 2, color = "indianred", linetype = "dotted")+
  # geom_hline(yintercept = -2, color = "indianred", linetype = "dotted")+
  labs(
    x = "Year",
    y = "z-score (w.r.t. 1850-1880)",
    title = paste("EM PCWD Z-Scores for", selected_continent)
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "lightblue")
  ) +
  facet_wrap(~region)  # Facet by region with independent y-axis scales


#### South America ####
# Filter data for the selected continent (e.g., Europe)
selected_continent <- "South America"
zscore_filtered <- zscore_df_1850 %>% filter(continent == selected_continent)

# Plot zscore time series
ggplot(zscore_filtered, aes(x = time, y = mean_zscore)) +
  geom_line() +  # Plot lines for each region
  geom_ribbon(aes(ymin = mean_zscore - sd_zscore, ymax = mean_zscore + sd_zscore), fill = "grey", alpha = 0.3) +
  geom_hline(yintercept = 0, color = "grey2", linetype = "dashed")+
  # geom_hline(yintercept = 2, color = "indianred", linetype = "dotted")+
  # geom_hline(yintercept = -2, color = "indianred", linetype = "dotted")+
  labs(
    x = "Year",
    y = "z-score (w.r.t. 1850-1880)",
    title = paste("EM PCWD Z-Scores for", selected_continent)
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "yellow")
  ) +
  facet_wrap(~region)  # Facet by region with independent y-axis scales

```
Maps showing z-scores for specific 30-year periods (e.g. volcanic eruptions, trends etc)


### Gini Index for inequality

- calculate Gini index for both each epoch for every gridcell
- plot as map to show variability/ meausre of inequality or unequalness
- low number (close to 0 rather than 1) implies low inequality i.e. over time PCWD values stable for that gridcell
- Gini index is more sensitive to changes in the middle of income distribution and less sensitive to changes at the top and the bottom of income distribution (Atkinson, 1970)

Read in lat, lon and time info: 
```{r}
#lat lon and time info from netcdf files
##read in data
input_file_1850 <- "/storage/research/giub_geco/data_2/scratch/phelpap/ModESim/m001_tidy/04_result_1850/PCWD_ANNMAX.nc"
input_file_1420 <- "/storage/research/giub_geco/data_2/scratch/phelpap/ModESim/m001_tidy/04_result_1420/PCWD_ANNMAX.nc"

nc_pwcd_1850 <- nc_open(input_file_1850)
pcwd_annmax_1850 = ncvar_get(nc_pwcd_1850, varid="pcwd_annmax")
lon = ncvar_get(nc_pwcd_1850, varid="lon")
lat = ncvar_get(nc_pwcd_1850, varid="lat")
time_1850 = ncvar_get(nc_pwcd_1850, varid="time")
# Convert to actual dates (days since 2001-01-01)
reference_date <- as.Date("2001-01-01")
time_dates_1850 <- reference_date + time_1850

# # Print the resulting dates
# print(time_dates)

nc_close(nc_pwcd_1850)

#1420 file for 1420 time
nc_pwcd_1420 <- nc_open(input_file_1420)
pcwd_annmax_1420 = ncvar_get(nc_pwcd_1420, varid="pcwd_annmax")
time_1420 = ncvar_get(nc_pwcd_1420, varid="time")
# Convert to actual dates (days since 2001-01-01)
time_dates_1420 <- reference_date + time_1420

# # Print the resulting dates
# print(time_dates)

nc_close(nc_pwcd_1420)
```

aggregate files: 
```{r}
#read in netcdf data and aggregate

#### 1420 set:
# Define the base path - have to seperate sets once there are more!
path <- "/storage/research/giub_geco/data_2/scratch/phelpap/ModESim/"

# List all the directories within the base path
folders <- list.files(path, full.names = TRUE)  #only want m001-m020 for now

# Extract ensemble member identifiers from folder names
ensemble_members <- basename(folders)

# Identify the target files
target_files <- file.path(folders, "04_result_1420/PCWD_ANNMAX.nc")
target_files <- target_files[file.exists(target_files)]  # Ensure only existing files are included

# Filter ensemble members to match target files
ensemble_members <- ensemble_members[file.exists(target_files)]

# Initialize a list to store data for each ensemble member
data_by_ensemble_1420 <- list()

# Extract dimensions from the first file to initialize the array size for consistency
nc <- nc_open(target_files[1])
dim_x <- dim(ncvar_get(nc, "pcwd_annmax"))[1]
dim_y <- dim(ncvar_get(nc, "pcwd_annmax"))[2]
dim_z <- dim(ncvar_get(nc, "pcwd_annmax"))[3]
nc_close(nc)

# Loop through all the target files and store the data in a list
for (i in seq_along(target_files)) {
  file <- target_files[i]
  member <- ensemble_members[i]
  
  # Open the NetCDF file
  nc <- nc_open(file)
  
  # Extract the data variable
  data <- ncvar_get(nc, "pcwd_annmax")  # Adjust "pcwd_annmax" to your variable name
  
  # Store the data in the list, keyed by the ensemble member
  data_by_ensemble_1420[[member]] <- data
  
  # Close the file
  nc_close(nc)
}

# Output the structure of the data list
print(names(data_by_ensemble_1420))  # Check stored ensemble members
print(dim(data_by_ensemble_1420[[1]]))  # Check dimensions of the data for the first ensemble member


#### 1850 set: 
# Define the base path - have to think of way to seperate sets once there is data!!
path <- "/storage/research/giub_geco/data_2/scratch/phelpap/ModESim/"

# List all the directories within the base path
folders <- list.files(path, full.names = TRUE)

# Extract ensemble member identifiers from folder names
ensemble_members <- basename(folders)

# Identify the target files
target_files <- file.path(folders, "04_result_1850/PCWD_ANNMAX.nc")
target_files <- target_files[file.exists(target_files)]  # Ensure only existing files are included

# Filter ensemble members to match target files
ensemble_members <- ensemble_members[file.exists(target_files)]

# Initialize a list to store data for each ensemble member
data_by_ensemble_1850 <- list()

# Extract dimensions from the first file to initialize the array size for consistency
nc <- nc_open(target_files[1])
dim_x <- dim(ncvar_get(nc, "pcwd_annmax"))[1]
dim_y <- dim(ncvar_get(nc, "pcwd_annmax"))[2]
dim_z <- dim(ncvar_get(nc, "pcwd_annmax"))[3]
nc_close(nc)

# Loop through all the target files and store the data in a list
for (i in seq_along(target_files)) {
  file <- target_files[i]
  member <- ensemble_members[i]
  
  # Open the NetCDF file
  nc <- nc_open(file)
  
  # Extract the data variable
  data <- ncvar_get(nc, "pcwd_annmax")  # Adjust "pcwd_annmax" to your variable name
  
  # Store the data in the list, keyed by the ensemble member
  data_by_ensemble_1850[[member]] <- data
  
  # Close the file
  nc_close(nc)
}

# Output the structure of the data list
print(names(data_by_ensemble_1850))  # Check stored ensemble members
print(dim(data_by_ensemble_1850[[1]]))  # Check dimensions of the data for the first ensemble member

```
```{r}
##### 1850 epoch
# Create an array of the same shape [192, 96, 160] to store means
mean_ensemble_1850 <- array(NA, dim = c(192, 96, 160))

# Compute the mean over all ensemble members
ensemble_array <- simplify2array(data_by_ensemble_1850)  # Convert list to array
mean_ensemble_1850 <- apply(ensemble_array, c(1,2,3), mean, na.rm = TRUE)

# Create an array to store Gini indices
gini_values_1850 <- matrix(NA, nrow = 192, ncol = 96)

# Loop through each grid cell and compute Gini index over time
for (i in 1:192) {
  for (j in 1:96) {
    gini_values_1850[i, j] <- Gini(mean_ensemble_1850[i, j, ], na.rm = TRUE)
  }
}

#### 1420 epoch
# Create an array of the same shape [192, 96, 160] to store means
mean_ensemble_1420 <- array(NA, dim = c(192, 96, 160))

# Compute the mean over all ensemble members
ensemble_array <- simplify2array(data_by_ensemble_1420)  # Convert list to array
mean_ensemble_1420 <- apply(ensemble_array, c(1,2,3), mean, na.rm = TRUE)

# Create an array to store Gini indices
gini_values_1420 <- matrix(NA, nrow = 192, ncol = 96)

# Loop through each grid cell and compute Gini index over time
for (i in 1:192) {
  for (j in 1:96) {
    gini_values_1420[i, j] <- Gini(mean_ensemble_1420[i, j, ], na.rm = TRUE)
  }
}

```

plot epoch wise GINI index

```{r}
#plot map with 1850 GINI index
#Convert data into raster object

r <- raster(t(gini_values_1850), xmn=min(lon), xmx=max(lon), ymn=min(lat), ymx=max(lat))
crs(r) <- "+proj=longlat +datum=WGS84" # Set CRS for raster
r <- flip(r, direction='y') #Flip the raster to correct orientation
#Retrieve land polygons and set the same CRS as the raster
land <- ne_countries(scale = "medium", returnclass = "sf")
land <- st_transform(land, crs=st_crs(r)) #Ensure CRS alignment
#Mask the raster with land polygons to remove ocean values
r_masked <- mask(r, as(land, "Spatial"))
#Convert the masked raster to a dataframe for ggplot
r_df <- as.data.frame(r_masked, xy = TRUE)
colnames(r_df) <- c("x", "y", "layer")

# ## colour palette: 
# library(wesanderson)
# #pal <- wes_palette("Zissou1", 100, type = "continuous")
# #or scientific colour palette: 
# library("ggsci")

ggplot() +
  geom_raster(data = r_df, aes(x=x, y=y, fill = layer), na.rm = TRUE) +
  scale_fill_bs5("orange", limits = c(0, 0.4)) +  
  labs(title = "GINI Index 1850 epoch (EM)", x= "Longitude", y="Latitude") +
  theme_classic() +
  geom_sf(data=land, fill=NA, color = "black", lwd = 0.5) +
  coord_sf(xlim = range(lon), ylim = range(lat), expand=FALSE)+
  theme(legend.title = element_text(size=12), legend.text = element_text(size=10)) +
  guides(fill = guide_legend(title = "Gini index", reverse = TRUE))

```

```{r}
#plot map with 1420 GINI index
#Convert data into raster object

r <- raster(t(gini_values_1420), xmn=min(lon), xmx=max(lon), ymn=min(lat), ymx=max(lat))
crs(r) <- "+proj=longlat +datum=WGS84" # Set CRS for raster
r <- flip(r, direction='y') #Flip the raster to correct orientation
#Retrieve land polygons and set the same CRS as the raster
land <- ne_countries(scale = "medium", returnclass = "sf")
land <- st_transform(land, crs=st_crs(r)) #Ensure CRS alignment
#Mask the raster with land polygons to remove ocean values
r_masked <- mask(r, as(land, "Spatial"))
#Convert the masked raster to a dataframe for ggplot
r_df <- as.data.frame(r_masked, xy = TRUE)
colnames(r_df) <- c("x", "y", "layer")

ggplot() +
  geom_raster(data = r_df, aes(x=x, y=y, fill = layer), na.rm = TRUE) +
  scale_fill_bs5("orange", limits = c(0, 0.4)) +  
  labs(title = "GINI Index 1420 epoch (EM)", x= "Longitude", y="Latitude") +
  theme_classic() +
  geom_sf(data=land, fill=NA, color = "black", lwd = 0.5) +
  coord_sf(xlim = range(lon), ylim = range(lat), expand=FALSE)+
  theme(legend.title = element_text(size=12), legend.text = element_text(size=10)) +
  guides(fill = guide_legend(title = "Gini index", reverse = TRUE))
```


Plot as animation with moving window to highlight change over time (1850 epoch):
```{r}
library(gganimate)


# Define time window size and step
window_size <- 30   # Number of years per window
step_size <- 30     # Shift window every 30 years
years <- 1850:2009  # Full time range from 1850 to 2010 (adjust as needed)

# Initialize list to store results
gini_list <- list()

# Loop through time using sliding window to compute Gini indices
for (start_year in seq(1850, length(years) - window_size + 1850, by = step_size)) {
  end_year <- start_year + window_size - 1
  gini_values_window <- matrix(NA, nrow = 192, ncol = 96)
  
  # Calculate Gini index for each grid cell
  for (i in 1:192) {
    for (j in 1:96) {
      # Correct indexing for the year range
      gini_values_window[i, j] <- Gini(mean_ensemble_1850[i, j, (start_year - 1849):(end_year - 1849)], na.rm = TRUE)
    }
  }
  
  # Create time variable and store in the list
  gini_list[[paste0("Year_", start_year, "_", end_year)]] <- list(
    gini_values = gini_values_window,
    time = start_year  # Store the first year of the time window
  )
}


```

```{r}

# Define output directory for saving images
output_dir <- "~/cwd_global/vignettes/GINI_maps/"
dir.create(output_dir, showWarnings = FALSE, recursive = TRUE)

# Loop through each time step and generate a plot
for (time_label in names(gini_list)) {
  
  # Extract the Gini values for the current time step
  gini_values_window <- gini_list[[time_label]]$gini_values
  r <- raster(t(gini_values_window), xmn=min(lon), xmx=max(lon), ymn=min(lat), ymx=max(lat))  
  crs(r) <- "+proj=longlat +datum=WGS84" # Set CRS for raster
  r <- flip(r, direction='y') #Flip the raster to correct orientation
  #Retrieve land polygons and set the same CRS as the raster
  land <- ne_countries(scale = "medium", returnclass = "sf")
  land <- st_transform(land, crs=st_crs(r)) #Ensure CRS alignment
  #Mask the raster with land polygons to remove ocean values
  r_masked <- mask(r, as(land, "Spatial"))
  #Convert the masked raster to a dataframe for ggplot
  r_df <- as.data.frame(r_masked, xy = TRUE)
  colnames(r_df) <- c("x", "y", "Gini")
  
  # Extract the time window information
  start_year <- gini_list[[time_label]]$time
  end_year <- start_year + window_size - 1

  p <- ggplot() +
    geom_raster(data = r_df, aes(x = x, y = y, fill = Gini), na.rm = TRUE) +
    scale_fill_viridis_c(option = "rocket", trans = "sqrt", direction=-1, limits = c(0, 0.4), name = "Gini Index") +
    # scale_fill_bs5("orange", limits = c(0, 0.4)) +  
    labs(title = paste0("GINI Index Evolution (EM): ", start_year, " - ", end_year), x = "Longitude", y = "Latitude") +
    theme_classic() +
    geom_sf(data = land, fill = NA, color = "black", lwd = 0.5) +  # Country borders
    coord_sf(xlim = range(lon), ylim = range(lat), expand = FALSE) +
    theme(legend.title = element_text(size = 12), legend.text = element_text(size = 10))
  
  # Save plot as PNG
  output_file <- file.path(output_dir, paste0("GINI_", start_year, "_", end_year, ".png"))
  ggsave(output_file, plot = p, width = 10, height = 5, dpi = 300)
  
  print(paste("Saved:", output_file))  # Log progress
}

print("All plots saved successfully!")
  
  
  
```


1420 epoch: 
```{r}
library(gganimate)


# Define time window size and step
window_size <- 30   # Number of years per window
step_size <- 30     # Shift window every 10 years
years <- 1420:1849  # Full time range from 1420 to 2010 (adjust as needed)

# Initialize list to store results
gini_list_1420 <- list()

# Loop through time using sliding window to compute Gini indices
for (start_year in seq(1420, length(years) - window_size + 1420, by = step_size)) {
  end_year <- start_year + window_size - 1
  gini_values_window <- matrix(NA, nrow = 192, ncol = 96)
  
  # Calculate Gini index for each grid cell
  for (i in 1:192) {
    for (j in 1:96) {
      # Correct indexing for the year range
      gini_values_window[i, j] <- Gini(mean_ensemble_1420[i, j, (start_year - 1419):(end_year - 1419)], na.rm = TRUE)
    }
  }
  
  # Create time variable and store in the list
  gini_list_1420[[paste0("Year_", start_year, "_", end_year)]] <- list(
    gini_values = gini_values_window,
    time = start_year  # Store the first year of the time window
  )
}

```

```{r}

# Define output directory for saving images
output_dir <- "~/cwd_global/vignettes/GINI_maps/"
dir.create(output_dir, showWarnings = FALSE, recursive = TRUE)

# Loop through each time step and generate a plot
for (time_label in names(gini_list_1420)) {
  
  # Extract the Gini values for the current time step
  gini_values_window <- gini_list_1420[[time_label]]$gini_values
  r <- raster(t(gini_values_window), xmn=min(lon), xmx=max(lon), ymn=min(lat), ymx=max(lat))  
  crs(r) <- "+proj=longlat +datum=WGS84" # Set CRS for raster
  r <- flip(r, direction='y') #Flip the raster to correct orientation
  #Retrieve land polygons and set the same CRS as the raster
  land <- ne_countries(scale = "medium", returnclass = "sf")
  land <- st_transform(land, crs=st_crs(r)) #Ensure CRS alignment
  #Mask the raster with land polygons to remove ocean values
  r_masked <- mask(r, as(land, "Spatial"))
  #Convert the masked raster to a dataframe for ggplot
  r_df <- as.data.frame(r_masked, xy = TRUE)
  colnames(r_df) <- c("x", "y", "Gini")
  
  # Extract the time window information
  start_year <- gini_list_1420[[time_label]]$time
  end_year <- start_year + window_size - 1

  p <- ggplot() +
    geom_raster(data = r_df, aes(x = x, y = y, fill = Gini), na.rm = TRUE) +
    scale_fill_viridis_c(option = "rocket", trans = "sqrt", direction=-1, limits = c(0, 0.4), name = "Gini Index") +
    # scale_fill_bs5("orange", limits = c(0, 0.4)) +  
    labs(title = paste0("GINI Index Evolution (EM): ", start_year, " - ", end_year), x = "Longitude", y = "Latitude") +
    theme_classic() +
    geom_sf(data = land, fill = NA, color = "black", lwd = 0.5) +  # Country borders
    coord_sf(xlim = range(lon), ylim = range(lat), expand = FALSE) +
    theme(legend.title = element_text(size = 12), legend.text = element_text(size = 10))
  
  # Save plot as PNG
  output_file <- file.path(output_dir, paste0("GINI_", start_year, "_", end_year, ".png"))
  ggsave(output_file, plot = p, width = 10, height = 5, dpi = 300)
  
  print(paste("Saved:", output_file))  # Log progress
}

print("All plots saved successfully!")
  
  
```

plot Gini timeseries with 30-year moving window for each region: 


