---
title: "Extreme Value Analysis of Drought Intensity (PCWD)"
author: "Patricia Helpap"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r libraries, message=FALSE, echo=FALSE}
library(readr)
library(dplyr)
library(here)
library(lubridate)
library(patchwork)
library(extRemes)
library(ggplot2)
library(cwd)
library(ncdf4)
library(reshape2)
library(ggpubr)
library(maps)
library(raster)
library(rnaturalearth)
library(sf)
library(rgdal)
library(sp)
library(RColorBrewer)
library(rJava)
library(loadeR.java)
library(transformeR)
library(loadeR)
library(visualizeR)
library(geoprocessoR)
library(tidyverse)
library(abind)
library(patchwork)
library(gridExtra)
```


```{r regions setup, echo=FALSE, warning=FALSE, message=FALSE}
#Load reference regions and coastlines:

load("/storage/homefs/ph23v078/Reference_regions/IPCC-WGI-reference-regions-v4_R.rda", verbose = TRUE)

#simplify this object by converting it to a SpatialPolygons class object (i.e., only the polygons are retained and their attributes discarded):
refregions <- as(IPCC_WGI_reference_regions_v4, "SpatialPolygons")

temp.dir <- tempdir()
unzip("/storage/homefs/ph23v078/Reference_regions/ne_110m_coastline.zip", exdir = temp.dir)
coastLines <- readOGR(dsn = temp.dir, layer = "ne_110m_coastline")

names(names(refregions))

proj4string(refregions)
WCE <- refregions[c("WCE")]

```

```{r map of regions, echo=FALSE, warning=FALSE, message=FALSE}
# Convert `refregions` (SpatialPolygons) to an `sf` object for ggplot compatibility
refregions_sf <- st_as_sf(refregions)

# Define continent assignments
continent_mapping <- list(
  "Europe" = c("NEU", "WCE", "EEU", "MED"),
  "North America" = c("NWN", "NEN", "WNA", "CNA", "ENA", "GIC"),
  "Africa" = c("SAH", "WAF", "CAF", "NEAF", "SEAF", "WSAF", "ESAF", "MDG"),
  "Asia" = c("WCA", "ECA", "TIB", "EAS", "ARP", "SAS", "SEA", "WSB", "ESB", "RFE", "RAR"),
  "Central America" =c("NCA", "SCA", "CAR"),
  "South America" = c("NWS", "NSA", "NES", "SAM", "SWS", "SES", "SSA"),
  "Australia" = c("NAU", "CAU", "EAU", "SAU", "NZ")
)

# Assign continents to regions
refregions_sf <- refregions_sf %>%
  mutate(
    continent = case_when(
      row.names(refregions) %in% continent_mapping$Europe ~ "Europe",
      row.names(refregions) %in% continent_mapping$`North America` ~ "North America",
      row.names(refregions) %in% continent_mapping$Africa ~ "Africa",
      row.names(refregions) %in% continent_mapping$Asia ~ "Asia",
      row.names(refregions) %in% continent_mapping$`Central America` ~ "Central America",
      row.names(refregions) %in% continent_mapping$`South America` ~ "South America",
      row.names(refregions) %in% continent_mapping$Australia ~ "Australia",
      TRUE ~ "Other"  # For regions not mapped to a continent
    )
  ) 


# Define continent colors
continent_colors <- c(
  "Europe" = "pink",
  "North America" = "lightgreen",
  "Africa" = "purple",
  "Asia" = "orange",
  "Central America" = "lightblue",
  "South America" = "yellow",
  "Australia" = "blue",
  "Other" = "white"
)

# Extract region centroids for labeling
region_labels <- refregions_sf %>%
  st_centroid() %>%
  mutate(label = row.names(refregions))  # Add region names as labels


# Load land data for filling continents
land <- ne_countries(scale = "medium", returnclass = "sf")

# Plot the map with ggplot2
ggplot() +
  geom_sf(data = land, fill = "lightgray", color = NA) +  # Fill land areas
  geom_sf(data = refregions_sf, aes(fill = continent), color = "black", alpha = 0.6) +  # Transparent overlay
  geom_sf_text(data = region_labels, aes(label = label), size = 3, color = "black", check_overlap = TRUE) +  # Add region names
  scale_fill_manual(values = continent_colors, name = "Continent") +
  theme_minimal() +
  labs(title = "Map of Regions by Continent",
       subtitle = "Regions coloured by assigned continents, region names labeled") +
  theme(
    plot.title = element_text(size = 16, face = "bold"),
    plot.subtitle = element_text(size = 12),
    legend.position = "bottom"
  )

```


```{r read in EMs WCE only, echo=FALSE, message=FALSE, warning=FALSE}
#here reading in only for WCE region for development
#aggregate EM for region i.e. 2 for loops, 1 looping over EMs, second looping over region, aggregating into one file

###############################read in data##################################
path <- "/storage/research/giub_geco/data_2/scratch/phelpap/ModESim"
folders <- list.files(path, full.names = TRUE, pattern = "m[0-9]{3}_tidy")

#################################all EMS#######################################
#e.g. loop for EMs: ### append data i.e. get rid of time dimension and just append to exisiting data
# Extract unique ensemble member identifiers from folder names
ensemble_members <- unique(basename(folders))

# Initialize an empty list to store spatial averages for each file
spatial_avg_list <- list()

# Loop over all ensemble member folders
for (em in ensemble_members) {
  # Construct the folder path for the current ensemble member
  folder <- file.path(path, em)
  # Construct file paths for the two time periods
  file_1420 <- file.path(folder, "04_result_1420/PCWD_ANNMAX.nc")
  
  # Check if both files exist
  if (file.exists(file_1420)) {
    # Load grid data for each time period
    grid_1420 <- loadGridData(dataset = file_1420, var = "pcwd_annmax")
    
    # Set spatial projection
    grid_1420 <- setGridProj(grid = grid_1420, proj = proj4string(refregions))
    
    # Perform spatial overlay
    grid.eu_1420 <- overGrid(grid_1420, WCE)
    
    # Extract data arrays
    data_array_1420 <- grid.eu_1420$Data[1:430,,]
    
    # Compute spatial average for each time step
    spatial_avg <- apply(data_array_1420, 1, function(slice) {
      mean(slice, na.rm = TRUE) # Compute mean for the spatial dimensions, ignoring NA
    })
    
    # Store the spatial average in the list
    spatial_avg_list[[em]] <- spatial_avg
  } else {
    warning(paste("Missing data for ensemble member:", em))
  }
}

# Combine all spatial averages into a single array with dimensions 160 x EMs
result_array.wce_1420 <- do.call(cbind, spatial_avg_list)

# Check the result
#dim(result_array.wce) # Should be 160 x EMs

######for 1850-2009:
# Initialize an empty list to store spatial averages for each file
spatial_avg_list <- list()

# Loop over all ensemble member folders
for (em in ensemble_members) {
  # Construct the folder path for the current ensemble member
  folder <- file.path(path, em)
  # Construct file paths for the two time periods
  file_1850 <- file.path(folder, "04_result_1850/PCWD_ANNMAX.nc")
  
  # Check if both files exist
  if (file.exists(file_1850)) {
    # Load grid data for each time period
    grid_1850 <- loadGridData(dataset = file_1850, var = "pcwd_annmax")
    
    # Set spatial projection
    grid_1850 <- setGridProj(grid = grid_1850, proj = proj4string(refregions))
    
    # Perform spatial overlay
    grid.eu_1850 <- overGrid(grid_1850, WCE)
    
    # Extract data arrays
    data_array_1850 <- grid.eu_1850$Data
    
    # Compute spatial average for each time step
    spatial_avg <- apply(data_array_1850, 1, function(slice) {
      mean(slice, na.rm = TRUE) # Compute mean for the spatial dimensions, ignoring NA
    })
    
    # Store the spatial average in the list
    spatial_avg_list[[em]] <- spatial_avg
  } else {
    warning(paste("Missing data for ensemble member:", em))
  }
}

# Combine all spatial averages into a single array with dimensions 160 x EMs
result_array.wce_1850 <- do.call(cbind, spatial_avg_list)

# Check the result
#dim(result_array.wce) # Should be 160 x EMs



```

### GIC PCWD values

GIC panel is showing interesting results in terms of return period changes; plot PCWD timeseries here
```{r read in results again}
# #Load regional averages with
regional_results_1420 <- readRDS("~/cwd_global/data/regionalResults_1420_1.RData")
regional_results_1850 <- readRDS("~/cwd_global/data/regionalResults_1850_1.RData")

NWS_1420 <- regional_results_1420[["NWS"]]
NWS_1850 <- regional_results_1850[["NWS"]]

time_info_1420 <- seq(from = as.numeric(1420), to = as.numeric(1849))
time_info_1850 <- seq(from = as.numeric(1850), to = as.numeric(2009))

NWS_1420_mean <- data.frame(
  time = time_info_1420,  # Keep the time column
  PCWD = rowMeans(NWS_1420[, -1], na.rm = TRUE)  # Calculate row means, excluding the first column
)

NWS_1850_mean <- data.frame(
  time = time_info_1850,  # Keep the time column
  PCWD = rowMeans(NWS_1850[, -1], na.rm = TRUE)  # Calculate row means, excluding the first column
)
 
ggplot(data = NWS_1420_mean) +
  geom_line(mapping= aes(x=time, y=PCWD))+
 # ylim(50, 70) +
  xlim(min(NWS_1420_mean$time), max(NWS_1420_mean$time)) +
  labs(
    x = "Year", 
    y = "PCWD(mm)",
    title = "NWS - EM PCWD values"
  ) +
  theme_classic()

ggplot(data = NWS_1850_mean) +
  geom_line(mapping= aes(x=time, y=PCWD))+
  #ylim(0, 13000) +
  xlim(min(NWS_1850_mean$time), max(NWS_1850_mean$time)) +
  labs(
    x = "Year", 
    y = "PCWD(mm)",
    title = "NWS - EM PCWD values"
  ) +
  theme_classic()

##############plot density and calculate skewness

# Install the moments package if not already installed
if (!require(moments)) install.packages("moments")
library(moments)

# Calculate skewness for each curve
skew_1420 <- skewness(as.vector(NWS_1420))
skew_1850 <- skewness(as.vector(NWS_1850))

# Calculate density
dx_1420 <- density(as.vector(NWS_1420))
dx_1850 <- density(as.vector(NWS_1850))

# Convert the densities into data frames for ggplot
df_1420 <- data.frame(x = dx_1420$x, y = dx_1420$y, set = "1420")
df_1850 <- data.frame(x = dx_1850$x, y = dx_1850$y, set = "1850")

# Combine both data frames
df_combined <- rbind(df_1420, df_1850)

# Create the ggplot density plot
ggplot(df_combined, aes(x = x, y = y, color = set)) +
  geom_line(linewidth = 1) + 
  labs(
    title = "Density of PCWD Values",
    x = "PCWD Values",
    y = "Density"
  ) +
  scale_color_manual(values = c("red", "blue")) +  # Custom colors for the lines
  geom_text(
    data = data.frame(x = rep(mean(df_combined$x), 2),  # Set x to the midpoint of the x range
                      y = c(max(df_combined$y) * 1.1, max(df_combined$y) * 1.15),  # Adjust y to place annotations above each other
                      year = c("1420", "1850"),
                      skewness = c(skew_1420, skew_1850)),
    aes(x = x, y = y, label = paste("Skewness:", round(skewness, 2))), 
    color = c("red", "blue"),
    hjust = 0.5,  # Center horizontally
    vjust = 0,    # Keep vertical positioning at the set y values
    size = 4
  ) +
  theme_classic() +
  theme(legend.position = "top")  # Position legend at the top


```


## Skewness of PCWD data sets

```{r}
regional_results_1420 <- readRDS("~/cwd_global/data/regionalResults_1420.RData")
regional_results_1850 <- readRDS("~/cwd_global/data/regionalResults_1850.RData")

# Install required packages if not already installed
if (!require(gridExtra)) install.packages("gridExtra")
if (!require(grid)) install.packages("grid")
library(gridExtra)
library(grid)

# List of regions and their corresponding data
regions <- names(regional_results_1420)

# Prepare the data for plotting and skewness calculation
density_data <- list()
skewness_results <- list()

for (continent in names(continent_mapping)) {
  continent_regions <- continent_mapping[[continent]]
  
  # Initialize lists for each continent
  continent_density_data <- list()
  continent_skewness_results <- data.frame(region = character(), skew_1420 = numeric(), skew_1850 = numeric(), stringsAsFactors = FALSE)
  
  for (region in continent_regions) {
    # Calculate skewness for each region
    skew_1420 <- round(skewness(as.vector(regional_results_1420[[region]])), 2)
    skew_1850 <- round(skewness(as.vector(regional_results_1850[[region]])), 2)
    
    # Store the skewness results
    continent_skewness_results <- rbind(continent_skewness_results, data.frame(region = region, skew_1420 = skew_1420, skew_1850 = skew_1850))
    
    # Calculate density for each region
    dx_1420 <- density(as.vector(regional_results_1420[[region]]))
    dx_1850 <- density(as.vector(regional_results_1850[[region]]))
    
    # Create a data frame for each region
    df_1420 <- data.frame(x = dx_1420$x, y = dx_1420$y, region = region, year = "1420")
    df_1850 <- data.frame(x = dx_1850$x, y = dx_1850$y, region = region, year = "1850")
    
    # Combine both year data for this region
    region_data <- rbind(df_1420, df_1850)
    continent_density_data[[region]] <- region_data
  }
  
  # Combine all regions' data for this continent
  density_data[[continent]] <- do.call(rbind, continent_density_data)
  skewness_results[[continent]] <- continent_skewness_results
}

# Plot and display results for each continent
for (continent in names(density_data)) {
  df_combined <- density_data[[continent]]
  skewness_table <- skewness_results[[continent]]
  # Rename the columns for display
  colnames(skewness_table) <- c("Region", "1420", "1850")
  
  # Custom table formatting
  table <- tableGrob(
    skewness_table,
    rows = NULL,
    theme = ttheme_default(
      core = list(
        fg_params = list(fontface = "plain", fontsize = 10),
        bg_params = list(fill = c("white", "white", "white"), col = "black")
      ),
      colhead = list(
        fg_params = list(fontface = "bold"),
        bg_params = list(fill = c("white", "red", "blue"))
      )
    )
  )
  
  # Create the ggplot density plot for each continent with free x and y axes
  p <- ggplot(df_combined, aes(x = x, y = y, color = year)) +
    geom_line(linewidth = 1) + 
    labs(
      title = paste("Density of PCWD Values -", continent),
      x = "PCWD Values",
      y = "Density"
    ) +
    scale_color_manual(values = c("red", "blue")) +  # Custom colors for the lines
    facet_wrap(~region, scales = "free", ncol = 3) +  # Faceting by region with free x and y axes
    theme_classic() +
    theme(
      legend.position = "top",  # Position legend at the top
      strip.background = element_rect(fill = continent_colors[continent], color = "black"),  # Panel background color
      strip.text = element_text(face = "bold")
    )
  
  # Arrange the plot and skewness table together using gridExtra
  grid.arrange(p, table, ncol = 2, widths=c(2.5,1))  # Adjust widths for proper spacing
}
```


#### Return levels of WCE

```{r return levels WCE, echo=FALSE, message=FALSE}
######calculate EVA for region i.e. WCE here for development
#new dataframe that contains a PCWD value for 2 year return period for each 30yr sliding window

# Define the window size (here 31 years) and return period
window_size <- 15
return_period <- 2

# Time information for the combined period
time_info_1420 <- seq(from = as.numeric(1420), to = as.numeric(1849))
time_info_1850 <- seq(from = as.numeric(1850), to = as.numeric(2009))

########1420 epoch
# Initialize a vector to store the 2-year return levels (one value per time step)
num_time_steps <- nrow(result_array.wce_1420)
return_level_vector_1420 <- rep(NA, num_time_steps)

# Loop over time steps (ensuring a 31-year moving window)
for (t in (window_size + 1):(num_time_steps - window_size)) {
  # Extract the data for the current 31-year window across all ensemble members
  window_data <- result_array.wce_1420[(t - window_size):(t + window_size), ]
  window_data <- as.vector(window_data) # Flatten the matrix to a single vector
  
  # Remove NA values (if any) before fitting
  window_data <- window_data[!is.na(window_data)]
  
  # Fit the GEV distribution to the combined data
  gev_fit <- fevd(window_data, type = "GEV", verbose = FALSE)
  
  # Calculate the 2-year return level
  return_level <- return.level(gev_fit, return.period = return_period)
  
  # Store the result in the vector
  return_level_vector_1420[t] <- return_level
}

#######1850 epoch
# Initialize a vector to store the 2-year return levels (one value per time step)
num_time_steps <- nrow(result_array.wce_1850)
return_level_vector_1850 <- rep(NA, num_time_steps)

# Loop over time steps (ensuring a 31-year moving window)
for (t in (window_size + 1):(num_time_steps - window_size)) {
  # Extract the data for the current 31-year window across all ensemble members
  window_data <- result_array.wce_1850[(t - window_size):(t + window_size), ]
  window_data <- as.vector(window_data) # Flatten the matrix to a single vector
  
  # Remove NA values (if any) before fitting
  window_data <- window_data[!is.na(window_data)]
  
  # Fit the GEV distribution to the combined data
  gev_fit <- fevd(window_data, type = "GEV", verbose = FALSE)
  
  # Calculate the 2-year return level
  return_level <- return.level(gev_fit, return.period = return_period)
  
  # Store the result in the vector
  return_level_vector_1850[t] <- return_level
}


# Create a data.frame combining time and return levels
result_df_RL_1420 <- data.frame(
  time = time_info_1420,
  return_level_1420 = return_level_vector_1420
)

result_df_RL_1850 <- data.frame(
  time = time_info_1850,
  return_level_1850 = return_level_vector_1850
)

```




Temporal evolution of 2-year return levels i.e. drought intensity
```{r plot return values, echo=FALSE}
ggplot(data = result_df_RL_1420) +
  geom_line(mapping= aes(x=time, y=return_level_1420))+
  ylim(min(result_df_RL_1420$return_level_1420), max(result_df_RL_1420$return_level_1420)) +
  xlim(min(result_df_RL_1420$time), max(result_df_RL_1420$time)) +
  labs(
    x = "Year", 
    y = "PCWD(mm)",
    title = "2-year return level - 30yr sliding window"
  ) +
  theme_classic()

ggplot(data = result_df_RL_1850) +
  geom_line(mapping= aes(x=time, y=return_level_1850))+
  ylim(min(result_df_RL_1850$return_level_1850), max(result_df_RL_1850$return_level_1850)) +
  xlim(min(result_df_RL_1850$time), max(result_df_RL_1850$time)) +
  labs(
    x = "Year", 
    y = "PCWD(mm)",
    title = "2-year return level - 30yr sliding window"
  ) +
  theme_classic()

```


## Assessing the change in frequency of 2-year drought events (Moderate drought)

- 2-year event threshold baseline calculated from start of simulation period (1420-1450)
- 30 year window size

```{r functions for RP calc}
# From https://geco-bern.github.io/cwd/articles/cwd_example.html: 
# calculate return period as a function of the CWD extreme. Using the two 
# coefficients of the fitted distribution as arguments
calc_return_period <- function(x, loc, scale){
  1 / (1 - exp(-exp(-(x-loc)/scale)))
}

extract_loc <- function(mod){
  loc <- mod$results$par[ "location" ]
  if (!is.null(loc)){
    return(loc)
  } else {
    return(NA)
  }
}

extract_scale <- function(mod){
  scale <- mod$results$par[ "scale" ]
  if (!is.null(scale)){
    return(scale)
  } else {
    return(NA)
  }
}
```


Test of method on WCE 1420 pooled dataset

```{r test of new method on WCE 1420, echo=FALSE, eval=FALSE}
use_rp <- 2    # return period of two years
nyears <- 30   # bin width

# Calculate magnitude of event with RP = X in reference period
# Calculate the baseline 2-year return level using the first 30 years
baseline <- as.vector(result_array.wce_1420[(1:nyears),])
fit_ref <- extRemes::fevd(baseline, type = "Gumbel", method = "MLE", units = "years")
cwd_ref <- extRemes::return.level(fit_ref, return.period = use_rp)

# initialise
rp_window <- rep(NA, nrow(result_array.wce_1420) - nyears + 1)

for (window_start in 1:(nrow(result_array.wce_1420) - nyears + 1)){

# Extract data for the current window
  window_data <- result_array.wce_1420[window_start:(window_start + nyears - 1), ]
  
  # Flatten the matrix into a single vector
  window_data <- as.vector(window_data)
  
  # Fit Gumbel distribution to the window data
  fit_window <- fevd(window_data, type = "Gumbel")

	# determine return period of cwd_ref based on new fit (How much more/less probably is an event that corresponded to an X-yearly event in the reference period?)
	rp_window[window_start] <- calc_return_period(cwd_ref, extract_loc(fit_window), extract_scale(fit_window))

}

# Create a data.frame combining time and effective return period
result_test <- data.frame(
  time = time_info_1420[15:415],
  RP = rp_window
)


#####plot result of test: 
ggplot() +
  geom_line(data = result_test, mapping= aes(x=time, y=RP, color="30yr"))+
  geom_hline(yintercept=2, linetype="dashed", color = "black")+
  ylim(min(result_test$RP), max(result_test$RP)) +
  xlim(min(result_test$time), max(result_test$time)) +
  labs(
    x = "Year", 
    y = "return period",
    title = "recalculated - Gumble"
  ) +
  theme_classic()+
      scale_color_manual(name="window size",values = c("10yr" = "cadetblue","30yr" = "chocolate1", "100yr" = "chartreuse"))
```


Old method for 1420 WCE
```{r calculate return period WCE, echo=FALSE, message=FALSE, warning=FALSE}
#same thing but instead calculate 2yr return period frequency for events?
#define a reference period? First 30 years: Take 30 year average of 2 year event as baseline and see how frequency of events with that threshold change

##########################5yr window size
# Define parameters
window_size <- 15
return_period <- 2

# Calculate the baseline 2-year return level using the first 30 years
baseline_window_data <- as.vector(result_array.wce_1420[1:(2 * window_size), ])

# Fit the GEV model to the baseline window
baseline_gev_fit <- fevd(baseline_window_data, type = "GEV", verbose = FALSE)

# Calculate the 2-year return level for the baseline period
baseline_return_level <- return.level(baseline_gev_fit, return.period = return_period)

# Initialize a vector to store the effective return period for each time step
num_time_steps <- nrow(result_array.wce_1420)
effective_return_period_vector <- rep(NA, num_time_steps)

# Loop over time steps (ensuring a 31-year moving window)
for (t in (window_size + 1):(num_time_steps - window_size)) {
  # Extract the data for the current 31-year window across all ensemble members
  window_data <- result_array.wce_1420[(t - window_size):(t + window_size), ]
  window_data <- as.vector(window_data) # Flatten the matrix to a single vector
  
  # Remove NA values
  window_data <- window_data[!is.na(window_data)]
  
  # Count how many events exceed the baseline 2-year return level
  exceedances <- sum(window_data > baseline_return_level, na.rm = TRUE)
  
  # Calculate the effective return period
  if (exceedances > 0) {
    effective_return_period <- length(window_data) / exceedances
  } else {
    effective_return_period <- Inf # No events exceed the baseline threshold
  }
  
  # Store the effective return period
  effective_return_period_vector[t] <- effective_return_period
}

# Create a data.frame combining time and effective return period
result_df_RP_10yr <- data.frame(
  time = time_info_1420,
  effective_return_period = effective_return_period_vector
)

```

### Frequency changes of 2-yr return period events for WCE (Western Central Europe) only:
```{r plot 2yr return periods WCE, echo = FALSE, warning=FALSE}
ggplot() +
  #geom_line(data = result_df_RP_10yr, mapping= aes(x=time, y=effective_return_period, color="10yr"))+
  geom_line(data = result_df_RP_30yr, mapping= aes(x=time, y=effective_return_period, color="30yr"))+
  #geom_line(data = result_df_RP_100yr, mapping= aes(x=time, y=effective_return_period, color="100yr"))+
  geom_hline(yintercept=2, linetype="dashed", color = "black")+
  ylim(min(result_df_RP_10yr$effective_return_period), max(result_df_RP_10yr$effective_return_period)) +
  xlim(min(result_df_RP_10yr$time), max(result_df_RP_10yr$time)) +
  labs(
    x = "Year", 
    y = "return period",
    title = "frequency change of 2yr events - sliding window"
  ) +
  theme_classic()+
      scale_color_manual(name="window size",values = c("10yr" = "cadetblue","30yr" = "chocolate1", "100yr" = "chartreuse"))
```

```{r calculate return periods all regions 2yr, eval=FALSE, echo=FALSE }
use_rp <- 2    # return period of two years
nyears <- 30   # bin width

################# 1420 -1849 epoch #################

# Initialize a list to store results for all regions
all_regions_results_1420 <- list()

# Loop through each region in regional_results
for (region in names(regional_results_1420)) { #swap european_regions for regional_results for all regions
  # Extract the result array for the current region
  result_array_region_BL <- regional_results_1420[[region]]
  result_array_region <- regional_results_1420[[region]]
  # Calculate magnitude of event with RP = X in reference period
  # Calculate the baseline 2-year return level using the first 30 years
  baseline <- as.vector(result_array_region_BL[(1:nyears),])
  fit_ref <- extRemes::fevd(baseline, type = "Gumbel", method = "MLE", units = "years")
  cwd_ref <- extRemes::return.level(fit_ref, return.period = use_rp)

  # initialise
  rp_window <- rep(NA, nrow(result_array_region) - nyears + 1)

  for (window_start in 1:(nrow(result_array_region) - nyears + 1)){

    # Extract data for the current window
    window_data <- result_array_region[window_start:(window_start + nyears - 1), ]
  
    # Flatten the matrix into a single vector
    window_data <- as.vector(window_data)
  
    # Fit Gumbel distribution to the window data
    fit_window <- fevd(window_data, type = "Gumbel")

	  # determine return period of cwd_ref based on new fit (How much more/less probably is an event that corresponded to an X-yearly event in the reference period?)
	  rp_window[window_start] <- calc_return_period(cwd_ref, extract_loc(fit_window), extract_scale(fit_window))

  }
  # Create a dataframe for the current region
  time_info <- seq(from = as.numeric(1420), to = as.numeric(1849))  # Replace with actual time if available
  region_df <- data.frame(
    time = time_info[15:415],
    RP = rp_window,
    region = region
  )
  
  # Store the region's dataframe in the results list
  all_regions_results_1420[[region]] <- region_df
}
  
# Combine all region results into a single dataframe
combined_results_1420 <- do.call(rbind, all_regions_results_1420)

# Save or process the combined dataframe
# Example: Save to a CSV file
write.csv(combined_results_1420, "~/cwd_global/data/2yr_return_periods_regions_1420.csv", row.names = FALSE)


################# 1850 - 2009 epoch #################

# Initialize a list to store results for all regions
all_regions_results_1850 <- list()

# Loop through each region in regional_results
for (region in names(regional_results_1850)) { #swap european_regions for regional_results for all regions
  # Extract the result array for the current region
  result_array_region_BL <- regional_results_1420[[region]]
  result_array_region <- regional_results_1850[[region]]
  # Calculate magnitude of event with RP = X in reference period
  # Calculate the baseline 2-year return level using the first 30 years
  baseline <- as.vector(result_array_region_BL[(1:nyears),])
  fit_ref <- extRemes::fevd(baseline, type = "Gumbel", method = "MLE", units = "years")
  cwd_ref <- extRemes::return.level(fit_ref, return.period = use_rp)

  # initialise
  rp_window <- rep(NA, nrow(result_array_region) - nyears + 1)

  for (window_start in 1:(nrow(result_array_region) - nyears + 1)){

    # Extract data for the current window
    window_data <- result_array_region[window_start:(window_start + nyears - 1), ]
  
    # Flatten the matrix into a single vector
    window_data <- as.vector(window_data)
  
    # Fit Gumbel distribution to the window data
    fit_window <- fevd(window_data, type = "Gumbel")

	  # determine return period of cwd_ref based on new fit (How much more/less probably is an event that corresponded to an X-yearly event in the reference period?)
	  rp_window[window_start] <- calc_return_period(cwd_ref, extract_loc(fit_window), extract_scale(fit_window))

  }
  # Create a dataframe for the current region
  time_info <- seq(from = as.numeric(1850), to = as.numeric(2009))  # Replace with actual time if available
  region_df <- data.frame(
    time = time_info[15:145],
    RP = rp_window,
    region = region
  )
  
  # Store the region's dataframe in the results list
  all_regions_results_1850[[region]] <- region_df
}
  
# Combine all region results into a single dataframe
combined_results_1850 <- do.call(rbind, all_regions_results_1850)

# Save or process the combined dataframe
# Example: Save to a CSV file
write.csv(combined_results_1850, "~/cwd_global/data/2yr_return_periods_regions_1850.csv", row.names = FALSE)


```


### Frequency changes of 2-yr return period events for all IPCC regions (1420 - 1849 epoch):

```{r timeseries and map plots for each region 2yr 1420, echo=FALSE, warning=FALSE, message=FALSE}
###### 1. Read in return period data
# Load the CSV files for each window size
combined_df <- read.csv("~/cwd_global/data/2yr_return_periods_regions_1420.csv")
combined_df$window_size <- "30yr"

####################################### EUROPE #####################################
##### Step 2: Filter European regions for the map and timeseries
# Filter regions for Europe
selected_continent <- "Europe"
sel_regions <- continent_mapping[[selected_continent]]

# Filter combined data for timeseries 
combined_df_sel <- combined_df %>% filter(region %in% sel_regions)

# Filter spatial data for map
sel_regions_sf <- refregions_sf %>% filter(continent %in% selected_continent)

# Define bounding box for Europe
bbox <- c(xmin = -30, xmax = 70, ymin = 25, ymax = 75)  # Approximate bounding box for Europe

# european_regions_sf <- refregions_sf %>% filter(continent == "Europe")
# # Define the bounding box for Europe
# europe_bbox <- c(xmin = -30, xmax = 70, ymin = 25, ymax = 75)  # Approximate bounding box for Europe


#### Step 4: Create the map
map_plot <- ggplot() +
  geom_sf(data = land, fill = "lightgray", color = NA) +  # Fill land areas
  geom_sf(data = sel_regions_sf, aes(fill = continent), color = "black", alpha = 0.6) +  # Transparent overlay
  geom_sf_text(data = region_labels, aes(label = label), size = 3, color = "black", check_overlap = TRUE) +  # Add region names
  scale_fill_manual(values = continent_colors, name = "") +
  theme_classic() +
  labs(title = "IPCC Regions", ylabs="", xlabs="") +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    plot.subtitle = element_text(size = 12),
    legend.position = "bottom"
  ) +
  coord_sf(xlim = bbox[1:2], ylim = bbox[3:4], expand = FALSE)  # Crop the map to Europe

##### Step 5: Plot the time series data with faceting
time_series_plot <- ggplot(combined_df_sel, aes(x = time, y = RP, color = window_size)) +
  geom_line() +  # Plot lines for each region's return period
  geom_hline(yintercept = 2, linetype = "dashed", color = "black") +  # Add a reference line for 2-year return period
  labs(
    x = "Year",
    y = "Effective Return Period",
    title = "Frequency Change of 2-Year Events"
  ) +
  scale_color_manual(name = "Window Size", values = c("10yr" = "cadetblue", "30yr" = "chocolate1", "100yr" = "chartreuse")) +
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "pink")
  ) +
  facet_wrap(~region
             #, scales = "free_y"
             )  # Facet by region with independent y-axis scales

##### Step 6: Arrange the two plots side by side using patchwork
# Explicitly control the layout with patchwork

# Arrange the Map and Time Series Side by Side
grid.arrange(
  map_plot, time_series_plot,
  ncol = 2,  # Side-by-side layout
  widths = c(1, 2)  # Adjust the relative width of the plots
)


######################################ASIA#######################################
##### Step 2: Filter Asian regions for the map and timeseries
# Filter regions for Asian
selected_continent <- "Asia"
sel_regions <- continent_mapping[[selected_continent]]

# Filter combined data for timeseries 
combined_df_sel <- combined_df %>% filter(region %in% sel_regions)

# Filter spatial data for map
sel_regions_sf <- refregions_sf %>% filter(continent %in% selected_continent)

# Define bounding box for Asia
bbox <- c(xmin = 30, xmax = 190, ymin = -20, ymax = 90)  # Approximate bounding box for Europe

# european_regions_sf <- refregions_sf %>% filter(continent == "Europe")
# # Define the bounding box for Europe
# europe_bbox <- c(xmin = -30, xmax = 70, ymin = 25, ymax = 75)  # Approximate bounding box for Europe


#### Step 4: Create the map
map_plot_A <- ggplot() +
  geom_sf(data = land, fill = "lightgray", color = NA) +  # Fill land areas
  geom_sf(data = sel_regions_sf, aes(fill = continent), color = "black", alpha = 0.6) +  # Transparent overlay
  geom_sf_text(data = region_labels, aes(label = label), size = 3, color = "black", check_overlap = TRUE) +  # Add region names
  scale_fill_manual(values = continent_colors, name = "") +
  theme_classic() +
  labs(title = "IPCC Regions", ylabs="", xlabs="") +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    plot.subtitle = element_text(size = 12),
    legend.position = "bottom"
  ) +
  coord_sf(xlim = bbox[1:2], ylim = bbox[3:4], expand = FALSE)  # Crop the map to Asia

##### Step 5: Plot the time series data with faceting
time_series_plot_A <- ggplot(combined_df_sel, aes(x = time, y = RP, color = window_size)) +
  geom_line() +  # Plot lines for each region's return period
  geom_hline(yintercept = 2, linetype = "dashed", color = "black") +  # Add a reference line for 2-year return period
  labs(
    x = "Year",
    y = "Effective Return Period",
    title = "Frequency Change of 2-Year Events"
  ) +
  scale_color_manual(name = "Window Size", values = c("10yr" = "cadetblue", "30yr" = "chocolate1", "100yr" = "chartreuse")) +
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "orange")
  ) +
  facet_wrap(~region)  # Facet by region with independent y-axis scales

##### Step 6: Arrange the two plots side by side using patchwork
# Explicitly control the layout with patchwork

# Arrange the Map and Time Series Side by Side
grid.arrange(
  map_plot_A, time_series_plot_A,
  ncol = 2,  # Side-by-side layout
  widths = c(1, 2)  # Adjust the relative width of the plots
)


###################################### OCEANIA #######################################
##### Step 2: Filter Oceanian regions for the map and timeseries
# Filter regions for Oceania
selected_continent <- "Australia"
sel_regions <- continent_mapping[[selected_continent]]

# Filter combined data for timeseries 
combined_df_sel <- combined_df %>% filter(region %in% sel_regions)

# Filter spatial data for map
sel_regions_sf <- refregions_sf %>% filter(continent %in% selected_continent)

# Define bounding box for Oceania
bbox <- c(xmin = 100, xmax = 190, ymin = -60, ymax = 0)  # Approximate bounding box for Oceania

#### Step 4: Create the map
map_plot_B <- ggplot() +
  geom_sf(data = land, fill = "lightgray", color = NA) +  # Fill land areas
  geom_sf(data = sel_regions_sf, aes(fill = continent), color = "black", alpha = 0.6) +  # Transparent overlay
  geom_sf_text(data = region_labels, aes(label = label), size = 3, color = "black", check_overlap = TRUE) +  # Add region names
  scale_fill_manual(values = continent_colors, name = "") +
  theme_classic() +
  labs(title = "IPCC Regions", ylabs="", xlabs="") +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    plot.subtitle = element_text(size = 12),
    legend.position = "bottom"
  ) +
  coord_sf(xlim = bbox[1:2], ylim = bbox[3:4], expand = FALSE)  # Crop the map to Asia

##### Step 5: Plot the time series data with faceting
time_series_plot_B <- ggplot(combined_df_sel, aes(x = time, y = RP, color = window_size)) +
  geom_line() +  # Plot lines for each region's return period
  geom_hline(yintercept = 2, linetype = "dashed", color = "black") +  # Add a reference line for 2-year return period
  labs(
    x = "Year",
    y = "Effective Return Period",
    title = "Frequency Change of 2-Year Events"
  ) +
  scale_color_manual(name = "Window Size", values = c("10yr" = "cadetblue", "30yr" = "chocolate1", "100yr" = "chartreuse")) +
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "blue")
  ) +
  facet_wrap(~region)  # Facet by region with independent y-axis scales

##### Step 6: Arrange the two plots side by side using patchwork
# Explicitly control the layout with patchwork

# Arrange the Map and Time Series Side by Side
grid.arrange(
  map_plot_B, time_series_plot_B,
  ncol = 2,  # Side-by-side layout
  widths = c(1, 2)  # Adjust the relative width of the plots
)


###################################### AFRICA #######################################
##### Step 2: Filter African regions for the map and timeseries
# Filter regions for Africa
selected_continent <- "Africa"
sel_regions <- continent_mapping[[selected_continent]]

# Filter combined data for timeseries 
combined_df_sel <- combined_df %>% filter(region %in% sel_regions)

# Filter spatial data for map
sel_regions_sf <- refregions_sf %>% filter(continent %in% selected_continent)

# Define bounding box for Africa
bbox <- c(xmin = -30, xmax = 60, ymin = -40, ymax = 40)  # Approximate bounding box for Oceania

#### Step 4: Create the map
map_plot_C <- ggplot() +
  geom_sf(data = land, fill = "lightgray", color = NA) +  # Fill land areas
  geom_sf(data = sel_regions_sf, aes(fill = continent), color = "black", alpha = 0.6) +  # Transparent overlay
  geom_sf_text(data = region_labels, aes(label = label), size = 3, color = "black", check_overlap = TRUE) +  # Add region names
  scale_fill_manual(values = continent_colors, name = "") +
  theme_classic() +
  labs(title = "IPCC Regions", ylabs="", xlabs="") +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    plot.subtitle = element_text(size = 12),
    legend.position = "bottom"
  ) +
  coord_sf(xlim = bbox[1:2], ylim = bbox[3:4], expand = FALSE)  # Crop the map to Asia

##### Step 5: Plot the time series data with faceting
time_series_plot_C <- ggplot(combined_df_sel, aes(x = time, y = RP, color = window_size)) +
  geom_line() +  # Plot lines for each region's return period
  geom_hline(yintercept = 2, linetype = "dashed", color = "black") +  # Add a reference line for 2-year return period
  labs(
    x = "Year",
    y = "Effective Return Period",
    title = "Frequency Change of 2-Year Events"
  ) +
  scale_color_manual(name = "Window Size", values = c("10yr" = "cadetblue", "30yr" = "chocolate1", "100yr" = "chartreuse")) +
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "purple")
  ) +
  facet_wrap(~region)  # Facet by region with independent y-axis scales

##### Step 6: Arrange the two plots side by side using patchwork
# Explicitly control the layout with patchwork

# Arrange the Map and Time Series Side by Side
grid.arrange(
  map_plot_C, time_series_plot_C,
  ncol = 2,  # Side-by-side layout
  widths = c(1, 2)  # Adjust the relative width of the plots
)


###################################### N AMERICA #######################################
##### Step 2: Filter N AMERICA regions for the map and timeseries
# Filter regions for N America
selected_continent <- "North America"
sel_regions <- continent_mapping[[selected_continent]]

# Filter combined data for timeseries 
combined_df_sel <- combined_df %>% filter(region %in% sel_regions)

# Filter spatial data for map
sel_regions_sf <- refregions_sf %>% filter(continent %in% selected_continent)

# Define bounding box for N America
bbox <- c(xmin = -180, xmax = -10, ymin = 20, ymax = 90)  # Approximate bounding box for Oceania

#### Step 4: Create the map
map_plot_D <- ggplot() +
  geom_sf(data = land, fill = "lightgray", color = NA) +  # Fill land areas
  geom_sf(data = sel_regions_sf, aes(fill = continent), color = "black", alpha = 0.6) +  # Transparent overlay
  geom_sf_text(data = region_labels, aes(label = label), size = 3, color = "black", check_overlap = TRUE) +  # Add region names
  scale_fill_manual(values = continent_colors, name = "") +
  theme_classic() +
  labs(title = "IPCC Regions", ylabs="", xlabs="") +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    plot.subtitle = element_text(size = 12),
    legend.position = "bottom"
  ) +
  coord_sf(xlim = bbox[1:2], ylim = bbox[3:4], expand = FALSE)  # Crop the map to Asia

##### Step 5: Plot the time series data with faceting
time_series_plot_D <- ggplot(combined_df_sel, aes(x = time, y = RP, color = window_size)) +
  geom_line() +  # Plot lines for each region's return period
  geom_hline(yintercept = 2, linetype = "dashed", color = "black") +  # Add a reference line for 2-year return period
  labs(
    x = "Year",
    y = "Effective Return Period",
    title = "Frequency Change of 2-Year Events"
  ) +
  scale_color_manual(name = "Window Size", values = c("10yr" = "cadetblue", "30yr" = "chocolate1", "100yr" = "chartreuse")) +
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "lightgreen")
  ) +
  facet_wrap(~region)  # Facet by region with independent y-axis scales

##### Step 6: Arrange the two plots side by side using patchwork
# Explicitly control the layout with patchwork

# Arrange the Map and Time Series Side by Side
grid.arrange(
  map_plot_D, time_series_plot_D,
  ncol = 2,  # Side-by-side layout
  widths = c(1, 2)  # Adjust the relative width of the plots
)


###################################### C AMERICA #######################################
##### Step 2: Filter C AMERICA regions for the map and timeseries
# Filter regions for C America
selected_continent <- "Central America"
sel_regions <- continent_mapping[[selected_continent]]

# Filter combined data for timeseries 
combined_df_sel <- combined_df %>% filter(region %in% sel_regions)

# Filter spatial data for map
sel_regions_sf <- refregions_sf %>% filter(continent %in% selected_continent)

# Define bounding box for C America
bbox <- c(xmin = -130, xmax = -50, ymin = 0, ymax = 40)  # Approximate bounding box for Oceania

#### Step 4: Create the map
map_plot_E <- ggplot() +
  geom_sf(data = land, fill = "lightgray", color = NA) +  # Fill land areas
  geom_sf(data = sel_regions_sf, aes(fill = continent), color = "black", alpha = 0.6) +  # Transparent overlay
  geom_sf_text(data = region_labels, aes(label = label), size = 3, color = "black", check_overlap = TRUE) +  # Add region names
  scale_fill_manual(values = continent_colors, name = "") +
  theme_classic() +
  labs(title = "IPCC Regions", ylabs="", xlabs="") +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    plot.subtitle = element_text(size = 12),
    legend.position = "bottom"
  ) +
  coord_sf(xlim = bbox[1:2], ylim = bbox[3:4], expand = FALSE)  # Crop the map to Asia

##### Step 5: Plot the time series data with faceting
time_series_plot_E <- ggplot(combined_df_sel, aes(x = time, y = RP, color = window_size)) +
  geom_line() +  # Plot lines for each region's return period
  geom_hline(yintercept = 2, linetype = "dashed", color = "black") +  # Add a reference line for 2-year return period
  labs(
    x = "Year",
    y = "Effective Return Period",
    title = "Frequency Change of 2-Year Events"
  ) +
  scale_color_manual(name = "Window Size", values = c("10yr" = "cadetblue", "30yr" = "chocolate1", "100yr" = "chartreuse")) +
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "lightblue")
  ) +
  facet_wrap(~region)  # Facet by region with independent y-axis scales

##### Step 6: Arrange the two plots side by side using patchwork
# Explicitly control the layout with patchwork

# Arrange the Map and Time Series Side by Side
grid.arrange(
  map_plot_E, time_series_plot_E,
  ncol = 2,  # Side-by-side layout
  widths = c(1, 2)  # Adjust the relative width of the plots
)


###################################### S AMERICA #######################################
##### Step 2: Filter S AMERICA regions for the map and timeseries
# Filter regions for S America
selected_continent <- "South America"
sel_regions <- continent_mapping[[selected_continent]]

# Filter combined data for timeseries 
combined_df_sel <- combined_df %>% filter(region %in% sel_regions)

# Filter spatial data for map
sel_regions_sf <- refregions_sf %>% filter(continent %in% selected_continent)

# Define bounding box for S America
bbox <- c(xmin = -90, xmax = -30, ymin = -60, ymax = 15)  # Approximate bounding box for Oceania

#### Step 4: Create the map
map_plot_F <- ggplot() +
  geom_sf(data = land, fill = "lightgray", color = NA) +  # Fill land areas
  geom_sf(data = sel_regions_sf, aes(fill = continent), color = "black", alpha = 0.6) +  # Transparent overlay
  geom_sf_text(data = region_labels, aes(label = label), size = 3, color = "black", check_overlap = TRUE) +  # Add region names
  scale_fill_manual(values = continent_colors, name = "") +
  theme_classic() +
  labs(title = "IPCC Regions", ylabs="", xlabs="") +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    plot.subtitle = element_text(size = 12),
    legend.position = "bottom"
  ) +
  coord_sf(xlim = bbox[1:2], ylim = bbox[3:4], expand = FALSE)  # Crop the map to South America

##### Step 5: Plot the time series data with faceting
time_series_plot_F <- ggplot(combined_df_sel, aes(x = time, y = RP, color = window_size)) +
  geom_line() +  # Plot lines for each region's return period
  geom_hline(yintercept = 2, linetype = "dashed", color = "black") +  # Add a reference line for 2-year return period
  labs(
    x = "Year",
    y = "Effective Return Period",
    title = "Frequency Change of 2-Year Events"
  ) +
  scale_color_manual(name = "Window Size", values = c("10yr" = "cadetblue", "30yr" = "chocolate1", "100yr" = "chartreuse")) +
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "yellow")
  ) +
  facet_wrap(~region)  # Facet by region with independent y-axis scales

##### Step 6: Arrange the two plots side by side using patchwork
# Explicitly control the layout with patchwork

# Arrange the Map and Time Series Side by Side
grid.arrange(
  map_plot_F, time_series_plot_F,
  ncol = 2,  # Side-by-side layout
  widths = c(1, 2)  # Adjust the relative width of the plots
)
```


```{r scatterplot 2yr RP 1435 and 1834}
# Extract data for the first and last years
combined_RP_1420 <- read.csv("~/cwd_global/data/2yr_return_periods_regions_1420.csv")

data_first_last <- combined_RP_1420 %>%
  filter(time == 1435 | time == 1834) %>%
  pivot_wider(names_from = time, values_from = RP, names_prefix = "year_") %>%
  drop_na()  # Remove rows with missing values for the years of interest

# Add continent information to the data
data_first_last <- data_first_last %>%
  mutate(continent = case_when(
    region %in% continent_mapping[["Europe"]] ~ "Europe",
    region %in% continent_mapping[["North America"]] ~ "North America",
    region %in% continent_mapping[["Africa"]] ~ "Africa",
    region %in% continent_mapping[["Asia"]] ~ "Asia",
    region %in% continent_mapping[["Central America"]] ~ "Central America",
    region %in% continent_mapping[["South America"]] ~ "South America",
    region %in% continent_mapping[["Australia"]] ~ "Australia",
    TRUE ~ "Other"
  ))

# Create the scatter plot
ggplot(data_first_last, aes(x = year_1834, y = year_1435, color = continent)) +
  geom_point(size = 3) +
  scale_color_manual(values = continent_colors) +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "black") +
  geom_text(aes(label = region), hjust = 0.5, vjust = -0.5, size = 3, colour = "black") + # Adjust hjust and vjust for positioning
  labs(
    x = "RP in 1834",
    y = "RP in 1435",
    title = "PCWD RP in 1435 vs 1834 of 2yr ref event (1420)",
    color = "Continent"
  ) +
  theme_classic()

```

Return level plots: 
```{r calc RL 1420 for scatterplot}
regional_results_1420 <- readRDS("~/cwd_global/data/regionalResults_1420.RData")

use_rp <- 2    # return period of two years
nyears <- 30   # bin width

########1420 epoch
# initialise

################# 1420 -1849 epoch #################

# Initialize a list to store results for all regions
all_regions_RL_1420 <- list()

# Loop through each region in regional_results
for (region in names(regional_results_1420)) { #swap european_regions for regional_results for all regions
  # Extract the result array for the current region
  result_array_region <- regional_results_1420[[region]]
  
  RL_window <- rep(NA, nrow(result_array_region) - nyears + 1)
  
  for (window_start in 1:(nrow(result_array_region) - nyears + 1)){
  
  # Extract data for the current window
    window_data <- result_array_region[window_start:(window_start + nyears - 1), ]
    
    # Flatten the matrix into a single vector
    window_data <- as.vector(window_data)
    
    # Fit Gumbel distribution to the window data
    fit_window <- fevd(window_data, type = "Gumbel")
    
    # Calculate the 2-year return level
    return_level <- return.level(fit_window, return.period = use_rp)
    
    # Store the result in the vector
    RL_window[window_start] <- return_level
  }
  # Create a dataframe for the current region
  time_info <- seq(from = as.numeric(1420), to = as.numeric(1849))  # Replace with actual time if available
  region_df <- data.frame(
    time = time_info[15:415],
    RL = RL_window,
    region = region
  )
  
  # Store the region's dataframe in the results list
  all_regions_RL_1420[[region]] <- region_df
}
  
# Combine all region results into a single dataframe
combined_RL_1420 <- do.call(rbind, all_regions_RL_1420)

```


```{r scatterplot 2yr RL 1435 and 1834}
# Extract data for the first and last years
data_first_last <- combined_RL_1420 %>%
  filter(time == 1435 | time == 1834) %>%
  pivot_wider(names_from = time, values_from = RL, names_prefix = "year_") %>%
  drop_na()  # Remove rows with missing values for the years of interest

# Add continent information to the data
data_first_last <- data_first_last %>%
  mutate(continent = case_when(
    region %in% continent_mapping[["Europe"]] ~ "Europe",
    region %in% continent_mapping[["North America"]] ~ "North America",
    region %in% continent_mapping[["Africa"]] ~ "Africa",
    region %in% continent_mapping[["Asia"]] ~ "Asia",
    region %in% continent_mapping[["Central America"]] ~ "Central America",
    region %in% continent_mapping[["South America"]] ~ "South America",
    region %in% continent_mapping[["Australia"]] ~ "Australia",
    TRUE ~ "Other"
  ))

# Create the scatter plot
ggplot(data_first_last, aes(x = year_1834, y = year_1435, color = continent)) +
  geom_point(size = 3) +
  scale_color_manual(values = continent_colors) +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "black") +
  geom_text(aes(label = region), hjust = 0.5, vjust = -0.5, size = 3, colour = "black") + # Adjust hjust and vjust for positioning
  labs(
    x = "2 yr PCWD (mm) in 1834",
    y = "2 yr PCWD (mm) in 1435",
    title = "2 year PCWD RL in 1435 vs 1834",
    color = "Continent"
  ) +
  theme_classic()

```
plot the "outlier" regions as timeseries: 
```{r}

###### 1. Read in return period data
# Load the CSV files for each window size
sel_regions <- c("SWS", "NWS", "WSAF")

# Filter combined data for timeseries 
combined_sel <- combined_RL_1420 %>% filter(region %in% sel_regions)

##### Step 5: Plot the time series data with faceting
ggplot(combined_sel, aes(x = time, y = RL), color = "blue") +
  geom_line() +  # Plot lines for each region's return period
  #geom_hline(yintercept = 2, linetype = "dashed", color = "black") +  # Add a reference line for 2-year return period
  labs(
    x = "Year",
    y = "PCWD RL",
    title = "PCWD 2 year events"
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "grey")
  ) +
  facet_wrap(~region, scales = "free_y"
             )  # Facet by region with independent y-axis scales
```



### Frequency changes of 2-yr return period events for all IPCC regions (1850 - 2009 epoch):

```{r timeseries and map plots for each region, echo=FALSE, warning=FALSE, message=FALSE}
###### 1. Read in return period data
# Load the CSV files for each window size
combined_df <- read.csv("~/cwd_global/data/2yr_return_periods_regions_1850.csv")
combined_df$window_size <- "30yr"

####################################### EUROPE #####################################
##### Step 2: Filter European regions for the map and timeseries
# Filter regions for Europe
selected_continent <- "Europe"
sel_regions <- continent_mapping[[selected_continent]]

# Filter combined data for timeseries 
combined_df_sel <- combined_df %>% filter(region %in% sel_regions)

# Filter spatial data for map
sel_regions_sf <- refregions_sf %>% filter(continent %in% selected_continent)

# Define bounding box for Europe
bbox <- c(xmin = -30, xmax = 70, ymin = 25, ymax = 75)  # Approximate bounding box for Europe

# european_regions_sf <- refregions_sf %>% filter(continent == "Europe")
# # Define the bounding box for Europe
# europe_bbox <- c(xmin = -30, xmax = 70, ymin = 25, ymax = 75)  # Approximate bounding box for Europe


#### Step 4: Create the map
map_plot <- ggplot() +
  geom_sf(data = land, fill = "lightgray", color = NA) +  # Fill land areas
  geom_sf(data = sel_regions_sf, aes(fill = continent), color = "black", alpha = 0.6) +  # Transparent overlay
  geom_sf_text(data = region_labels, aes(label = label), size = 3, color = "black", check_overlap = TRUE) +  # Add region names
  scale_fill_manual(values = continent_colors, name = "") +
  theme_classic() +
  labs(title = "IPCC Regions", ylabs="", xlabs="") +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    plot.subtitle = element_text(size = 12),
    legend.position = "bottom"
  ) +
  coord_sf(xlim = bbox[1:2], ylim = bbox[3:4], expand = FALSE)  # Crop the map to Europe

##### Step 5: Plot the time series data with faceting
time_series_plot <- ggplot(combined_df_sel, aes(x = time, y = RP, color = window_size)) +
  geom_line() +  # Plot lines for each region's return period
  geom_hline(yintercept = 2, linetype = "dashed", color = "black") +  # Add a reference line for 2-year return period
  labs(
    x = "Year",
    y = "Effective Return Period",
    title = "Frequency Change of 2-Year Events"
  ) +
  scale_color_manual(name = "Window Size", values = c("10yr" = "cadetblue", "30yr" = "chocolate1", "100yr" = "chartreuse")) +
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "pink")
  ) +
  facet_wrap(~region
             #, scales = "free_y"
             )  # Facet by region with independent y-axis scales

##### Step 6: Arrange the two plots side by side using patchwork
# Explicitly control the layout with patchwork

# Arrange the Map and Time Series Side by Side
grid.arrange(
  map_plot, time_series_plot,
  ncol = 2,  # Side-by-side layout
  widths = c(1, 2)  # Adjust the relative width of the plots
)


######################################ASIA#######################################
##### Step 2: Filter Asian regions for the map and timeseries
# Filter regions for Asian
selected_continent <- "Asia"
sel_regions <- continent_mapping[[selected_continent]]

# Filter combined data for timeseries 
combined_df_sel <- combined_df %>% filter(region %in% sel_regions)

# Filter spatial data for map
sel_regions_sf <- refregions_sf %>% filter(continent %in% selected_continent)

# Define bounding box for Asia
bbox <- c(xmin = 30, xmax = 190, ymin = -20, ymax = 90)  # Approximate bounding box for Europe

# european_regions_sf <- refregions_sf %>% filter(continent == "Europe")
# # Define the bounding box for Europe
# europe_bbox <- c(xmin = -30, xmax = 70, ymin = 25, ymax = 75)  # Approximate bounding box for Europe


#### Step 4: Create the map
map_plot_A <- ggplot() +
  geom_sf(data = land, fill = "lightgray", color = NA) +  # Fill land areas
  geom_sf(data = sel_regions_sf, aes(fill = continent), color = "black", alpha = 0.6) +  # Transparent overlay
  geom_sf_text(data = region_labels, aes(label = label), size = 3, color = "black", check_overlap = TRUE) +  # Add region names
  scale_fill_manual(values = continent_colors, name = "") +
  theme_classic() +
  labs(title = "IPCC Regions", ylabs="", xlabs="") +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    plot.subtitle = element_text(size = 12),
    legend.position = "bottom"
  ) +
  coord_sf(xlim = bbox[1:2], ylim = bbox[3:4], expand = FALSE)  # Crop the map to Asia

##### Step 5: Plot the time series data with faceting
time_series_plot_A <- ggplot(combined_df_sel, aes(x = time, y = RP, color = window_size)) +
  geom_line() +  # Plot lines for each region's return period
  geom_hline(yintercept = 2, linetype = "dashed", color = "black") +  # Add a reference line for 2-year return period
  labs(
    x = "Year",
    y = "Effective Return Period",
    title = "Frequency Change of 2-Year Events"
  ) +
  scale_color_manual(name = "Window Size", values = c("10yr" = "cadetblue", "30yr" = "chocolate1", "100yr" = "chartreuse")) +
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "orange")
  ) +
  facet_wrap(~region)  # Facet by region with independent y-axis scales

##### Step 6: Arrange the two plots side by side using patchwork
# Explicitly control the layout with patchwork

# Arrange the Map and Time Series Side by Side
grid.arrange(
  map_plot_A, time_series_plot_A,
  ncol = 2,  # Side-by-side layout
  widths = c(1, 2)  # Adjust the relative width of the plots
)


###################################### OCEANIA #######################################
##### Step 2: Filter Oceanian regions for the map and timeseries
# Filter regions for Oceania
selected_continent <- "Australia"
sel_regions <- continent_mapping[[selected_continent]]

# Filter combined data for timeseries 
combined_df_sel <- combined_df %>% filter(region %in% sel_regions)

# Filter spatial data for map
sel_regions_sf <- refregions_sf %>% filter(continent %in% selected_continent)

# Define bounding box for Oceania
bbox <- c(xmin = 100, xmax = 190, ymin = -60, ymax = 0)  # Approximate bounding box for Oceania

#### Step 4: Create the map
map_plot_B <- ggplot() +
  geom_sf(data = land, fill = "lightgray", color = NA) +  # Fill land areas
  geom_sf(data = sel_regions_sf, aes(fill = continent), color = "black", alpha = 0.6) +  # Transparent overlay
  geom_sf_text(data = region_labels, aes(label = label), size = 3, color = "black", check_overlap = TRUE) +  # Add region names
  scale_fill_manual(values = continent_colors, name = "") +
  theme_classic() +
  labs(title = "IPCC Regions", ylabs="", xlabs="") +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    plot.subtitle = element_text(size = 12),
    legend.position = "bottom"
  ) +
  coord_sf(xlim = bbox[1:2], ylim = bbox[3:4], expand = FALSE)  # Crop the map to Asia

##### Step 5: Plot the time series data with faceting
time_series_plot_B <- ggplot(combined_df_sel, aes(x = time, y = RP, color = window_size)) +
  geom_line() +  # Plot lines for each region's return period
  geom_hline(yintercept = 2, linetype = "dashed", color = "black") +  # Add a reference line for 2-year return period
  labs(
    x = "Year",
    y = "Effective Return Period",
    title = "Frequency Change of 2-Year Events"
  ) +
  scale_color_manual(name = "Window Size", values = c("10yr" = "cadetblue", "30yr" = "chocolate1", "100yr" = "chartreuse")) +
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "blue")
  ) +
  facet_wrap(~region)  # Facet by region with independent y-axis scales

##### Step 6: Arrange the two plots side by side using patchwork
# Explicitly control the layout with patchwork

# Arrange the Map and Time Series Side by Side
grid.arrange(
  map_plot_B, time_series_plot_B,
  ncol = 2,  # Side-by-side layout
  widths = c(1, 2)  # Adjust the relative width of the plots
)


###################################### AFRICA #######################################
##### Step 2: Filter African regions for the map and timeseries
# Filter regions for Africa
selected_continent <- "Africa"
sel_regions <- continent_mapping[[selected_continent]]

# Filter combined data for timeseries 
combined_df_sel <- combined_df %>% filter(region %in% sel_regions)

# Filter spatial data for map
sel_regions_sf <- refregions_sf %>% filter(continent %in% selected_continent)

# Define bounding box for Africa
bbox <- c(xmin = -30, xmax = 60, ymin = -40, ymax = 40)  # Approximate bounding box for Oceania

#### Step 4: Create the map
map_plot_C <- ggplot() +
  geom_sf(data = land, fill = "lightgray", color = NA) +  # Fill land areas
  geom_sf(data = sel_regions_sf, aes(fill = continent), color = "black", alpha = 0.6) +  # Transparent overlay
  geom_sf_text(data = region_labels, aes(label = label), size = 3, color = "black", check_overlap = TRUE) +  # Add region names
  scale_fill_manual(values = continent_colors, name = "") +
  theme_classic() +
  labs(title = "IPCC Regions", ylabs="", xlabs="") +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    plot.subtitle = element_text(size = 12),
    legend.position = "bottom"
  ) +
  coord_sf(xlim = bbox[1:2], ylim = bbox[3:4], expand = FALSE)  # Crop the map to Asia

##### Step 5: Plot the time series data with faceting
time_series_plot_C <- ggplot(combined_df_sel, aes(x = time, y = RP, color = window_size)) +
  geom_line() +  # Plot lines for each region's return period
  geom_hline(yintercept = 2, linetype = "dashed", color = "black") +  # Add a reference line for 2-year return period
  labs(
    x = "Year",
    y = "Effective Return Period",
    title = "Frequency Change of 2-Year Events"
  ) +
  scale_color_manual(name = "Window Size", values = c("10yr" = "cadetblue", "30yr" = "chocolate1", "100yr" = "chartreuse")) +
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "purple")
  ) +
  facet_wrap(~region)  # Facet by region with independent y-axis scales

##### Step 6: Arrange the two plots side by side using patchwork
# Explicitly control the layout with patchwork

# Arrange the Map and Time Series Side by Side
grid.arrange(
  map_plot_C, time_series_plot_C,
  ncol = 2,  # Side-by-side layout
  widths = c(1, 2)  # Adjust the relative width of the plots
)


###################################### N AMERICA #######################################
##### Step 2: Filter N AMERICA regions for the map and timeseries
# Filter regions for N America
selected_continent <- "North America"
sel_regions <- continent_mapping[[selected_continent]]

# Filter combined data for timeseries 
combined_df_sel <- combined_df %>% filter(region %in% sel_regions)

# Filter spatial data for map
sel_regions_sf <- refregions_sf %>% filter(continent %in% selected_continent)

# Define bounding box for N America
bbox <- c(xmin = -180, xmax = -10, ymin = 20, ymax = 90)  # Approximate bounding box for Oceania

#### Step 4: Create the map
map_plot_D <- ggplot() +
  geom_sf(data = land, fill = "lightgray", color = NA) +  # Fill land areas
  geom_sf(data = sel_regions_sf, aes(fill = continent), color = "black", alpha = 0.6) +  # Transparent overlay
  geom_sf_text(data = region_labels, aes(label = label), size = 3, color = "black", check_overlap = TRUE) +  # Add region names
  scale_fill_manual(values = continent_colors, name = "") +
  theme_classic() +
  labs(title = "IPCC Regions", ylabs="", xlabs="") +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    plot.subtitle = element_text(size = 12),
    legend.position = "bottom"
  ) +
  coord_sf(xlim = bbox[1:2], ylim = bbox[3:4], expand = FALSE)  # Crop the map to Asia

##### Step 5: Plot the time series data with faceting
time_series_plot_D <- ggplot(combined_df_sel, aes(x = time, y = RP, color = window_size)) +
  geom_line() +  # Plot lines for each region's return period
  geom_hline(yintercept = 2, linetype = "dashed", color = "black") +  # Add a reference line for 2-year return period
  labs(
    x = "Year",
    y = "Effective Return Period",
    title = "Frequency Change of 2-Year Events"
  ) +
  scale_color_manual(name = "Window Size", values = c("10yr" = "cadetblue", "30yr" = "chocolate1", "100yr" = "chartreuse")) +
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "lightgreen")
  ) +
  facet_wrap(~region)  # Facet by region with independent y-axis scales

##### Step 6: Arrange the two plots side by side using patchwork
# Explicitly control the layout with patchwork

# Arrange the Map and Time Series Side by Side
grid.arrange(
  map_plot_D, time_series_plot_D,
  ncol = 2,  # Side-by-side layout
  widths = c(1, 2)  # Adjust the relative width of the plots
)


###################################### C AMERICA #######################################
##### Step 2: Filter C AMERICA regions for the map and timeseries
# Filter regions for C America
selected_continent <- "Central America"
sel_regions <- continent_mapping[[selected_continent]]

# Filter combined data for timeseries 
combined_df_sel <- combined_df %>% filter(region %in% sel_regions)

# Filter spatial data for map
sel_regions_sf <- refregions_sf %>% filter(continent %in% selected_continent)

# Define bounding box for C America
bbox <- c(xmin = -130, xmax = -50, ymin = 0, ymax = 40)  # Approximate bounding box for Oceania

#### Step 4: Create the map
map_plot_E <- ggplot() +
  geom_sf(data = land, fill = "lightgray", color = NA) +  # Fill land areas
  geom_sf(data = sel_regions_sf, aes(fill = continent), color = "black", alpha = 0.6) +  # Transparent overlay
  geom_sf_text(data = region_labels, aes(label = label), size = 3, color = "black", check_overlap = TRUE) +  # Add region names
  scale_fill_manual(values = continent_colors, name = "") +
  theme_classic() +
  labs(title = "IPCC Regions", ylabs="", xlabs="") +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    plot.subtitle = element_text(size = 12),
    legend.position = "bottom"
  ) +
  coord_sf(xlim = bbox[1:2], ylim = bbox[3:4], expand = FALSE)  # Crop the map to Asia

##### Step 5: Plot the time series data with faceting
time_series_plot_E <- ggplot(combined_df_sel, aes(x = time, y = RP, color = window_size)) +
  geom_line() +  # Plot lines for each region's return period
  geom_hline(yintercept = 2, linetype = "dashed", color = "black") +  # Add a reference line for 2-year return period
  labs(
    x = "Year",
    y = "Effective Return Period",
    title = "Frequency Change of 2-Year Events"
  ) +
  scale_color_manual(name = "Window Size", values = c("10yr" = "cadetblue", "30yr" = "chocolate1", "100yr" = "chartreuse")) +
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "lightblue")
  ) +
  facet_wrap(~region)  # Facet by region with independent y-axis scales

##### Step 6: Arrange the two plots side by side using patchwork
# Explicitly control the layout with patchwork

# Arrange the Map and Time Series Side by Side
grid.arrange(
  map_plot_E, time_series_plot_E,
  ncol = 2,  # Side-by-side layout
  widths = c(1, 2)  # Adjust the relative width of the plots
)


###################################### S AMERICA #######################################
##### Step 2: Filter S AMERICA regions for the map and timeseries
# Filter regions for S America
selected_continent <- "South America"
sel_regions <- continent_mapping[[selected_continent]]

# Filter combined data for timeseries 
combined_df_sel <- combined_df %>% filter(region %in% sel_regions)

# Filter spatial data for map
sel_regions_sf <- refregions_sf %>% filter(continent %in% selected_continent)

# Define bounding box for S America
bbox <- c(xmin = -90, xmax = -30, ymin = -60, ymax = 15)  # Approximate bounding box for Oceania

#### Step 4: Create the map
map_plot_F <- ggplot() +
  geom_sf(data = land, fill = "lightgray", color = NA) +  # Fill land areas
  geom_sf(data = sel_regions_sf, aes(fill = continent), color = "black", alpha = 0.6) +  # Transparent overlay
  geom_sf_text(data = region_labels, aes(label = label), size = 3, color = "black", check_overlap = TRUE) +  # Add region names
  scale_fill_manual(values = continent_colors, name = "") +
  theme_classic() +
  labs(title = "IPCC Regions", ylabs="", xlabs="") +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    plot.subtitle = element_text(size = 12),
    legend.position = "bottom"
  ) +
  coord_sf(xlim = bbox[1:2], ylim = bbox[3:4], expand = FALSE)  # Crop the map to South America

##### Step 5: Plot the time series data with faceting
time_series_plot_F <- ggplot(combined_df_sel, aes(x = time, y = RP, color = window_size)) +
  geom_line() +  # Plot lines for each region's return period
  geom_hline(yintercept = 2, linetype = "dashed", color = "black") +  # Add a reference line for 2-year return period
  labs(
    x = "Year",
    y = "Effective Return Period",
    title = "Frequency Change of 2-Year Events"
  ) +
  scale_color_manual(name = "Window Size", values = c("10yr" = "cadetblue", "30yr" = "chocolate1", "100yr" = "chartreuse")) +
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "yellow")
  ) +
  facet_wrap(~region)  # Facet by region with independent y-axis scales

##### Step 6: Arrange the two plots side by side using patchwork
# Explicitly control the layout with patchwork

# Arrange the Map and Time Series Side by Side
grid.arrange(
  map_plot_F, time_series_plot_F,
  ncol = 2,  # Side-by-side layout
  widths = c(1, 2)  # Adjust the relative width of the plots
)
```
```{r}
combined_RP_1850 <- read.csv("~/cwd_global/data/2yr_return_periods_regions_1850.csv")
# Extract data for the first and last years
data_first_last <- combined_RP_1850 %>%
  filter(time == 1864 | time == 1994) %>%
  pivot_wider(names_from = time, values_from = RP, names_prefix = "year_") %>%
  drop_na()  # Remove rows with missing values for the years of interest

# Add continent information to the data
data_first_last <- data_first_last %>%
  mutate(continent = case_when(
    region %in% continent_mapping[["Europe"]] ~ "Europe",
    region %in% continent_mapping[["North America"]] ~ "North America",
    region %in% continent_mapping[["Africa"]] ~ "Africa",
    region %in% continent_mapping[["Asia"]] ~ "Asia",
    region %in% continent_mapping[["Central America"]] ~ "Central America",
    region %in% continent_mapping[["South America"]] ~ "South America",
    region %in% continent_mapping[["Australia"]] ~ "Australia",
    TRUE ~ "Other"
  ))

# Create the scatter plot
ggplot(data_first_last, aes(x = year_1994, y = year_1864, color = continent)) +
  geom_point(size = 3) +
  scale_color_manual(values = continent_colors) +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "black") +
  geom_text(aes(label = region), hjust = 0.5, vjust = -0.5, size = 3, colour = "black") + # Adjust hjust and vjust for positioning
  labs(
    x = "RP in 1994",
    y = "RP in 1864",
    title = "PCWD RP in 1864 vs 1994 of 2yr ref event (1420)",
    color = "Continent"
  ) +
  theme_classic()

```
```{r scatterplot 2yr RP 1435 and 1994, echo=FALSE}
# Load the CSV files for each window size
combined_RP_1850 <- read.csv("~/cwd_global/data/2yr_return_periods_regions_1850.csv")
combined_RP_1420 <- read.csv("~/cwd_global/data/2yr_return_periods_regions_1420.csv")

# Extract data for the first and last years
data_first_last_beg <- combined_RP_1420 %>%
  filter(time == 1435) %>%
  pivot_wider(names_from = time, values_from = RP, names_prefix = "year_") %>%
  drop_na()  # Remove rows with missing values for the years of interest

data_first_last_end <- combined_RP_1850 %>%
  filter(time == 1994) %>%
  pivot_wider(names_from = time, values_from = RP, names_prefix = "year_") %>%
  drop_na()  # Remove rows with missing values for the years of interest

# Merge the two datasets on the 'region' column
data_combined <- inner_join(data_first_last_beg, data_first_last_end, by = "region", suffix = c("_beg", "_end"))

# Ensure the continent information is consistent
data_combined <- data_combined %>%
  mutate(continent = case_when(
    region %in% continent_mapping[["Europe"]] ~ "Europe",
    region %in% continent_mapping[["North America"]] ~ "North America",
    region %in% continent_mapping[["Africa"]] ~ "Africa",
    region %in% continent_mapping[["Asia"]] ~ "Asia",
    region %in% continent_mapping[["Central America"]] ~ "Central America",
    region %in% continent_mapping[["South America"]] ~ "South America",
    region %in% continent_mapping[["Australia"]] ~ "Australia",
    TRUE ~ "Other"
  ))

ggplot(data_combined, aes(x = year_1994, y = year_1435, color = continent)) +
  geom_point(size = 3) +
  scale_color_manual(values = continent_colors) +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "black") +
  geom_text(aes(label = region), hjust = 0.5, vjust = -0.5, size = 3, colour = "black") + # Annotate with region names
  labs(
    x = "2 yr RP in 1994",
    y = "2 yr RP in 1435",
    title = "PCWD RP in 1435 vs 1994 of 2yr ref event (1420)",
    color = "Continent"
  ) +
  theme_classic()

```



```{r calc RL 1850 for scatterplot}
regional_results_1850 <- readRDS("~/cwd_global/data/regionalResults_1850.RData")

use_rp <- 2    # return period of two years
nyears <- 30   # bin width

########1850 epoch
# initialise

################# 1850 - 2009 epoch #################

# Initialize a list to store results for all regions
all_regions_RL_1850 <- list()

# Loop through each region in regional_results
for (region in names(regional_results_1850)) { #swap european_regions for regional_results for all regions
  # Extract the result array for the current region
  result_array_region <- regional_results_1850[[region]]
  
  RL_window <- rep(NA, nrow(result_array_region) - nyears + 1)
  
  for (window_start in 1:(nrow(result_array_region) - nyears + 1)){
  
  # Extract data for the current window
    window_data <- result_array_region[window_start:(window_start + nyears - 1), ]
    
    # Flatten the matrix into a single vector
    window_data <- as.vector(window_data)
    
    # Fit Gumbel distribution to the window data
    fit_window <- fevd(window_data, type = "Gumbel")
    
    # Calculate the 2-year return level
    return_level <- return.level(fit_window, return.period = use_rp)
    
    # Store the result in the vector
    RL_window[window_start] <- return_level
  }
  # Create a dataframe for the current region
  time_info <- seq(from = as.numeric(1850), to = as.numeric(2009))  # Replace with actual time if available
  region_df <- data.frame(
    time = time_info[15:145],
    RL = RL_window,
    region = region
  )
  
  # Store the region's dataframe in the results list
  all_regions_RL_1850[[region]] <- region_df
}
  
# Combine all region results into a single dataframe
combined_RL_1850 <- do.call(rbind, all_regions_RL_1850)

```


```{r scatterplot 2yr RL 1864 and 1994}
# Extract data for the first and last years
data_first_last <- combined_RL_1850 %>%
  filter(time == 1864 | time == 1994) %>%
  pivot_wider(names_from = time, values_from = RL, names_prefix = "year_") %>%
  drop_na()  # Remove rows with missing values for the years of interest

# Add continent information to the data
data_first_last <- data_first_last %>%
  mutate(continent = case_when(
    region %in% continent_mapping[["Europe"]] ~ "Europe",
    region %in% continent_mapping[["North America"]] ~ "North America",
    region %in% continent_mapping[["Africa"]] ~ "Africa",
    region %in% continent_mapping[["Asia"]] ~ "Asia",
    region %in% continent_mapping[["Central America"]] ~ "Central America",
    region %in% continent_mapping[["South America"]] ~ "South America",
    region %in% continent_mapping[["Australia"]] ~ "Australia",
    TRUE ~ "Other"
  ))

# Create the scatter plot
ggplot(data_first_last, aes(x = year_1994, y = year_1864, color = continent)) +
  geom_point(size = 3) +
  scale_color_manual(values = continent_colors) +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "black") +
  geom_text(aes(label = region), hjust = 0.5, vjust = -0.5, size = 3, colour = "black") + # Adjust hjust and vjust for positioning
  labs(
    x = "2 yr PCWD (mm) in 1994",
    y = "2 yr PCWD (mm) in 1864",
    title = "2 year PCWD RL in 1864 vs 1994",
    color = "Continent"
  ) +
  theme_classic()
```
plot the "outlier" regions as timeseries: 
```{r}

###### 1. Read in return period data
# Load the CSV files for each window size
sel_regions <- c("SWS", "NWS", "WSAF")

# Filter combined data for timeseries 
combined_sel <- combined_RL_1850 %>% filter(region %in% sel_regions)

##### Step 5: Plot the time series data with faceting
ggplot(combined_sel, aes(x = time, y = RL), color = "blue") +
  geom_line() +  # Plot lines for each region's return period
  #geom_hline(yintercept = 2, linetype = "dashed", color = "black") +  # Add a reference line for 2-year return period
  labs(
    x = "Year",
    y = "PCWD RL",
    title = "PCWD 2 year events"
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "grey")
  ) +
  facet_wrap(~region, scales = "free_y"
             )  # Facet by region with independent y-axis scales
```

```{r}
# Extract data for the first and last years
data_first_last_beg <- combined_RL_1420 %>%
  filter(time == 1435) %>%
  pivot_wider(names_from = time, values_from = RL, names_prefix = "year_") %>%
  drop_na()  # Remove rows with missing values for the years of interest

data_first_last_end <- combined_RL_1850 %>%
  filter(time == 1994) %>%
  pivot_wider(names_from = time, values_from = RL, names_prefix = "year_") %>%
  drop_na()  # Remove rows with missing values for the years of interest

# Merge the two datasets on the 'region' column
data_combined <- inner_join(data_first_last_beg, data_first_last_end, by = "region", suffix = c("_beg", "_end"))

# Ensure the continent information is consistent
data_combined <- data_combined %>%
  mutate(continent = case_when(
    region %in% continent_mapping[["Europe"]] ~ "Europe",
    region %in% continent_mapping[["North America"]] ~ "North America",
    region %in% continent_mapping[["Africa"]] ~ "Africa",
    region %in% continent_mapping[["Asia"]] ~ "Asia",
    region %in% continent_mapping[["Central America"]] ~ "Central America",
    region %in% continent_mapping[["South America"]] ~ "South America",
    region %in% continent_mapping[["Australia"]] ~ "Australia",
    TRUE ~ "Other"
  ))

ggplot(data_combined, aes(x = year_1994, y = year_1435, color = continent)) +
  geom_point(size = 3) +
  scale_color_manual(values = continent_colors) +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "black") +
  geom_text(aes(label = region), hjust = 0.5, vjust = -0.5, size = 3, colour = "black") + # Annotate with region names
  labs(
    x = "PCWD RL in 1994",
    y = "PCWD RL in 1435",
    title = "2 year PCWD RL in 1435 vs 1994",
    color = "Continent"
  ) +
  theme_classic()

```

## Assessing the change in frequency of 20-year drought events (Severe drought)

- moving window sizes 30 yr and sample 20-year return period events

```{r 20yr WCE only, eval=FALSE, echo=FALSE}
#same thing but instead calculate 2yr return period frequency for events?
#define a reference period? First 30 years: Take 30 year average of 2 year event as baseline and see how frequency of events with that threshold change

# Define parameters
window_size <- 50
return_period <- 20

# Calculate the baseline 2-year return level using the first 30 years
baseline_window_data <- as.vector(result_array.wce[1:(2 * window_size), ])

# Fit the GEV model to the baseline window
baseline_gev_fit <- fevd(baseline_window_data, type = "GEV", verbose = FALSE)

# Calculate the 2-year return level for the baseline period
baseline_return_level <- return.level(baseline_gev_fit, return.period = return_period)

# Initialize a vector to store the effective return period for each time step
num_time_steps <- nrow(result_array.wce)
effective_return_period_vector <- rep(NA, num_time_steps)

# Loop over time steps (ensuring a 31-year moving window)
for (t in (window_size + 1):(num_time_steps - window_size)) {
  # Extract the data for the current 31-year window across all ensemble members
  window_data <- result_array.wce[(t - window_size):(t + window_size), ]
  window_data <- as.vector(window_data) # Flatten the matrix to a single vector
  
  # Remove NA values
  window_data <- window_data[!is.na(window_data)]
  
  # Count how many events exceed the baseline 2-year return level
  exceedances <- sum(window_data > baseline_return_level, na.rm = TRUE)
  
  # Calculate the effective return period
  if (exceedances > 0) {
    effective_return_period <- length(window_data) / exceedances
  } else {
    effective_return_period <- Inf # No events exceed the baseline threshold
  }
  
  # Store the effective return period
  effective_return_period_vector[t] <- effective_return_period
}

# Create a data.frame combining time and effective return period
result_df_RP_100yr <- data.frame(
  time = time_info,
  effective_return_period = effective_return_period_vector
)

```


```{r, eval=FALSE, echo=FALSE}
ggplot() +
  geom_line(data = result_df_RP_40yr, mapping= aes(x=time, y=effective_return_period, color="40yr"))+
  geom_line(data = result_df_RP_70yr, mapping= aes(x=time, y=effective_return_period, color="70yr"))+
  geom_line(data = result_df_RP_100yr, mapping= aes(x=time, y=effective_return_period, color="100yr"))+
  geom_hline(yintercept=20, linetype="dashed", color = "black")+
  ylim(min(result_df_RP$effective_return_period), max(result_df_RP$effective_return_period)) +
  xlim(min(result_df_RP$time), max(result_df_RP$time)) +
  labs(
    x = "Year", 
    y = "return period",
    title = "frequency change of 20 yr events - sliding window"
  ) +
  theme_classic()+
      scale_color_manual(name="window size",values = c("40yr" = "cadetblue","70yr" = "chocolate1", "100yr" = "chartreuse"))
```

### Frequency changes of 20-yr return period events for all IPCC regions (1420 - 1849 epoch): 

```{r calculate return periods all regions 20 yr, echo=FALSE, message=FALSE, eval=FALSE}
use_rp <- 20    # return period of two years
nyears <- 30   # bin width

################# 1420 -1849 epoch #################

# Initialize a list to store results for all regions
all_regions_results_1420 <- list()

# Loop through each region in regional_results
for (region in names(regional_results_1420)) { #swap european_regions for regional_results for all regions
  # Extract the result array for the current region
  result_array_region_BL <- regional_results_1420[[region]]
  result_array_region <- regional_results_1420[[region]]
  # Calculate magnitude of event with RP = X in reference period
  # Calculate the baseline 2-year return level using the first 30 years
  baseline <- as.vector(result_array_region_BL[(1:nyears),])
  fit_ref <- extRemes::fevd(baseline, type = "Gumbel", method = "MLE", units = "years")
  cwd_ref <- extRemes::return.level(fit_ref, return.period = use_rp)

  # initialise
  rp_window <- rep(NA, nrow(result_array_region) - nyears + 1)

  for (window_start in 1:(nrow(result_array_region) - nyears + 1)){

    # Extract data for the current window
    window_data <- result_array_region[window_start:(window_start + nyears - 1), ]
  
    # Flatten the matrix into a single vector
    window_data <- as.vector(window_data)
  
    # Fit Gumbel distribution to the window data
    fit_window <- fevd(window_data, type = "Gumbel")

	  # determine return period of cwd_ref based on new fit (How much more/less probably is an event that corresponded to an X-yearly event in the reference period?)
	  rp_window[window_start] <- calc_return_period(cwd_ref, extract_loc(fit_window), extract_scale(fit_window))

  }
  # Create a dataframe for the current region
  time_info <- seq(from = as.numeric(1420), to = as.numeric(1849))  # Replace with actual time if available
  region_df <- data.frame(
    time = time_info[15:415],
    RP = rp_window,
    region = region
  )
  
  # Store the region's dataframe in the results list
  all_regions_results_1420[[region]] <- region_df
}
  
# Combine all region results into a single dataframe
combined_results_1420 <- do.call(rbind, all_regions_results_1420)

# Save or process the combined dataframe
# Example: Save to a CSV file
write.csv(combined_results_1420, "~/cwd_global/data/20yr_return_periods_regions_1420.csv", row.names = FALSE)


################# 1850 - 2009 epoch #################

# Initialize a list to store results for all regions
all_regions_results_1850 <- list()

# Loop through each region in regional_results
for (region in names(regional_results_1850)) { #swap european_regions for regional_results for all regions
  # Extract the result array for the current region
  result_array_region_BL <- regional_results_1420[[region]]
  result_array_region <- regional_results_1850[[region]]
  # Calculate magnitude of event with RP = X in reference period
  # Calculate the baseline 2-year return level using the first 30 years
  baseline <- as.vector(result_array_region_BL[(1:nyears),])
  fit_ref <- extRemes::fevd(baseline, type = "Gumbel", method = "MLE", units = "years")
  cwd_ref <- extRemes::return.level(fit_ref, return.period = use_rp)

  # initialise
  rp_window <- rep(NA, nrow(result_array_region) - nyears + 1)

  for (window_start in 1:(nrow(result_array_region) - nyears + 1)){

    # Extract data for the current window
    window_data <- result_array_region[window_start:(window_start + nyears - 1), ]
  
    # Flatten the matrix into a single vector
    window_data <- as.vector(window_data)
  
    # Fit Gumbel distribution to the window data
    fit_window <- fevd(window_data, type = "Gumbel")

	  # determine return period of cwd_ref based on new fit (How much more/less probably is an event that corresponded to an X-yearly event in the reference period?)
	  rp_window[window_start] <- calc_return_period(cwd_ref, extract_loc(fit_window), extract_scale(fit_window))

  }
  # Create a dataframe for the current region
  time_info <- seq(from = as.numeric(1850), to = as.numeric(2009))  # Replace with actual time if available
  region_df <- data.frame(
    time = time_info[15:145],
    RP = rp_window,
    region = region
  )
  
  # Store the region's dataframe in the results list
  all_regions_results_1850[[region]] <- region_df
}
  
# Combine all region results into a single dataframe
combined_results_1850 <- do.call(rbind, all_regions_results_1850)

# Save or process the combined dataframe
# Example: Save to a CSV file
write.csv(combined_results_1850, "~/cwd_global/data/20yr_return_periods_regions_1850.csv", row.names = FALSE)


```


```{r timeseries and map plots for each region 20 yr 1420, echo=FALSE, warning=FALSE, message=FALSE}
###### 1. Read in return period data
# Load the CSV files for each window size
combined_df <- read.csv("~/cwd_global/data/20yr_return_periods_regions_1420.csv")
combined_df$window_size <- "30yr"

####################################### EUROPE #####################################
##### Step 2: Filter European regions for the map and timeseries
# Filter regions for Europe
selected_continent <- "Europe"
sel_regions <- continent_mapping[[selected_continent]]

# Filter combined data for timeseries 
combined_df_sel <- combined_df %>% filter(region %in% sel_regions)

# Filter spatial data for map
sel_regions_sf <- refregions_sf %>% filter(continent %in% selected_continent)

# Define bounding box for Europe
bbox <- c(xmin = -30, xmax = 70, ymin = 25, ymax = 75)  # Approximate bounding box for Europe

# european_regions_sf <- refregions_sf %>% filter(continent == "Europe")
# # Define the bounding box for Europe
# europe_bbox <- c(xmin = -30, xmax = 70, ymin = 25, ymax = 75)  # Approximate bounding box for Europe


#### Step 4: Create the map
map_plot <- ggplot() +
  geom_sf(data = land, fill = "lightgray", color = NA) +  # Fill land areas
  geom_sf(data = sel_regions_sf, aes(fill = continent), color = "black", alpha = 0.6) +  # Transparent overlay
  geom_sf_text(data = region_labels, aes(label = label), size = 3, color = "black", check_overlap = TRUE) +  # Add region names
  scale_fill_manual(values = continent_colors, name = "") +
  theme_classic() +
  labs(title = "IPCC Regions", ylabs="", xlabs="") +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    plot.subtitle = element_text(size = 12),
    legend.position = "bottom"
  ) +
  coord_sf(xlim = bbox[1:2], ylim = bbox[3:4], expand = FALSE)  # Crop the map to Europe

##### Step 5: Plot the time series data with faceting
time_series_plot <- ggplot(combined_df_sel, aes(x = time, y = RP, color = window_size)) +
  geom_line() +  # Plot lines for each region's return period
  geom_hline(yintercept = 20, linetype = "dashed", color = "black") +  # Add a reference line for 2-year return period
  labs(
    x = "Year",
    y = "Effective Return Period",
    title = "Frequency Change of 20-Year Events"
  ) +
  scale_color_manual(name = "Window Size", values = c("30yr" = "cadetblue", "70yr" = "chocolate1", "100yr" = "chartreuse")) +
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "pink")
  ) +
  facet_wrap(~region
             )  # Facet by region with independent y-axis scales

##### Step 6: Arrange the two plots side by side using patchwork
# Explicitly control the layout with patchwork

# Arrange the Map and Time Series Side by Side
grid.arrange(
  map_plot, time_series_plot,
  ncol = 2,  # Side-by-side layout
  widths = c(1, 2)  # Adjust the relative width of the plots
)


######################################ASIA#######################################
##### Step 2: Filter Asian regions for the map and timeseries
# Filter regions for Asian
selected_continent <- "Asia"
sel_regions <- continent_mapping[[selected_continent]]

# Filter combined data for timeseries 
combined_df_sel <- combined_df %>% filter(region %in% sel_regions)

# Filter spatial data for map
sel_regions_sf <- refregions_sf %>% filter(continent %in% selected_continent)

# Define bounding box for Asia
bbox <- c(xmin = 30, xmax = 190, ymin = -20, ymax = 90)  # Approximate bounding box for Europe

# european_regions_sf <- refregions_sf %>% filter(continent == "Europe")
# # Define the bounding box for Europe
# europe_bbox <- c(xmin = -30, xmax = 70, ymin = 25, ymax = 75)  # Approximate bounding box for Europe


#### Step 4: Create the map
map_plot_A <- ggplot() +
  geom_sf(data = land, fill = "lightgray", color = NA) +  # Fill land areas
  geom_sf(data = sel_regions_sf, aes(fill = continent), color = "black", alpha = 0.6) +  # Transparent overlay
  geom_sf_text(data = region_labels, aes(label = label), size = 3, color = "black", check_overlap = TRUE) +  # Add region names
  scale_fill_manual(values = continent_colors, name = "") +
  theme_classic() +
  labs(title = "IPCC Regions", ylabs="", xlabs="") +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    plot.subtitle = element_text(size = 12),
    legend.position = "bottom"
  ) +
  coord_sf(xlim = bbox[1:2], ylim = bbox[3:4], expand = FALSE)  # Crop the map to Asia

##### Step 5: Plot the time series data with faceting
time_series_plot_A <- ggplot(combined_df_sel, aes(x = time, y = RP, color = window_size)) +
  geom_line() +  # Plot lines for each region's return period
  geom_hline(yintercept = 20, linetype = "dashed", color = "black") +  # Add a reference line for 2-year return period
  labs(
    x = "Year",
    y = "Effective Return Period",
    title = "Frequency Change of 20-Year Events"
  ) +
  scale_color_manual(name = "Window Size", values = c("30yr" = "cadetblue", "70yr" = "chocolate1", "100yr" = "chartreuse")) +
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "orange")
  ) +
  facet_wrap(~region)  # Facet by region with independent y-axis scales

##### Step 6: Arrange the two plots side by side using patchwork
# Explicitly control the layout with patchwork

# Arrange the Map and Time Series Side by Side
grid.arrange(
  map_plot_A, time_series_plot_A,
  ncol = 2,  # Side-by-side layout
  widths = c(1, 2)  # Adjust the relative width of the plots
)


###################################### OCEANIA #######################################
##### Step 2: Filter Oceanian regions for the map and timeseries
# Filter regions for Oceania
selected_continent <- "Australia"
sel_regions <- continent_mapping[[selected_continent]]

# Filter combined data for timeseries 
combined_df_sel <- combined_df %>% filter(region %in% sel_regions)

# Filter spatial data for map
sel_regions_sf <- refregions_sf %>% filter(continent %in% selected_continent)

# Define bounding box for Oceania
bbox <- c(xmin = 100, xmax = 190, ymin = -60, ymax = 0)  # Approximate bounding box for Oceania

#### Step 4: Create the map
map_plot_B <- ggplot() +
  geom_sf(data = land, fill = "lightgray", color = NA) +  # Fill land areas
  geom_sf(data = sel_regions_sf, aes(fill = continent), color = "black", alpha = 0.6) +  # Transparent overlay
  geom_sf_text(data = region_labels, aes(label = label), size = 3, color = "black", check_overlap = TRUE) +  # Add region names
  scale_fill_manual(values = continent_colors, name = "") +
  theme_classic() +
  labs(title = "IPCC Regions", ylabs="", xlabs="") +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    plot.subtitle = element_text(size = 12),
    legend.position = "bottom"
  ) +
  coord_sf(xlim = bbox[1:2], ylim = bbox[3:4], expand = FALSE)  # Crop the map to Asia

##### Step 5: Plot the time series data with faceting
time_series_plot_B <- ggplot(combined_df_sel, aes(x = time, y = RP, color = window_size)) +
  geom_line() +  # Plot lines for each region's return period
  geom_hline(yintercept = 20, linetype = "dashed", color = "black") +  # Add a reference line for 2-year return period
  labs(
    x = "Year",
    y = "Effective Return Period",
    title = "Frequency Change of 20-Year Events"
  ) +
  scale_color_manual(name = "Window Size", values = c("30yr" = "cadetblue", "70yr" = "chocolate1", "100yr" = "chartreuse")) +
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "blue")
  ) +
  facet_wrap(~region)  # Facet by region with independent y-axis scales

##### Step 6: Arrange the two plots side by side using patchwork
# Explicitly control the layout with patchwork

# Arrange the Map and Time Series Side by Side
grid.arrange(
  map_plot_B, time_series_plot_B,
  ncol = 2,  # Side-by-side layout
  widths = c(1, 2)  # Adjust the relative width of the plots
)


###################################### AFRICA #######################################
##### Step 2: Filter African regions for the map and timeseries
# Filter regions for Africa
selected_continent <- "Africa"
sel_regions <- continent_mapping[[selected_continent]]

# Filter combined data for timeseries 
combined_df_sel <- combined_df %>% filter(region %in% sel_regions)

# Filter spatial data for map
sel_regions_sf <- refregions_sf %>% filter(continent %in% selected_continent)

# Define bounding box for Africa
bbox <- c(xmin = -30, xmax = 60, ymin = -30, ymax = 30)  # Approximate bounding box for Oceania

#### Step 4: Create the map
map_plot_C <- ggplot() +
  geom_sf(data = land, fill = "lightgray", color = NA) +  # Fill land areas
  geom_sf(data = sel_regions_sf, aes(fill = continent), color = "black", alpha = 0.6) +  # Transparent overlay
  geom_sf_text(data = region_labels, aes(label = label), size = 3, color = "black", check_overlap = TRUE) +  # Add region names
  scale_fill_manual(values = continent_colors, name = "") +
  theme_classic() +
  labs(title = "IPCC Regions", ylabs="", xlabs="") +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    plot.subtitle = element_text(size = 12),
    legend.position = "bottom"
  ) +
  coord_sf(xlim = bbox[1:2], ylim = bbox[3:4], expand = FALSE)  # Crop the map to Asia

##### Step 5: Plot the time series data with faceting
time_series_plot_C <- ggplot(combined_df_sel, aes(x = time, y = RP, color = window_size)) +
  geom_line() +  # Plot lines for each region's return period
  geom_hline(yintercept = 20, linetype = "dashed", color = "black") +  # Add a reference line for 2-year return period
  labs(
    x = "Year",
    y = "Effective Return Period",
    title = "Frequency Change of 20-Year Events"
  ) +
  scale_color_manual(name = "Window Size", values = c("30yr" = "cadetblue", "70yr" = "chocolate1", "100yr" = "chartreuse")) +
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "purple")
  ) +
  facet_wrap(~region)  # Facet by region with independent y-axis scales

##### Step 6: Arrange the two plots side by side using patchwork
# Explicitly control the layout with patchwork

# Arrange the Map and Time Series Side by Side
grid.arrange(
  map_plot_C, time_series_plot_C,
  ncol = 2,  # Side-by-side layout
  widths = c(1, 2)  # Adjust the relative width of the plots
)


###################################### N AMERICA #######################################
##### Step 2: Filter N AMERICA regions for the map and timeseries
# Filter regions for N America
selected_continent <- "North America"
sel_regions <- continent_mapping[[selected_continent]]

# Filter combined data for timeseries 
combined_df_sel <- combined_df %>% filter(region %in% sel_regions)

# Filter spatial data for map
sel_regions_sf <- refregions_sf %>% filter(continent %in% selected_continent)

# Define bounding box for N America
bbox <- c(xmin = -180, xmax = -10, ymin = 20, ymax = 90)  # Approximate bounding box for Oceania

#### Step 4: Create the map
map_plot_D <- ggplot() +
  geom_sf(data = land, fill = "lightgray", color = NA) +  # Fill land areas
  geom_sf(data = sel_regions_sf, aes(fill = continent), color = "black", alpha = 0.6) +  # Transparent overlay
  geom_sf_text(data = region_labels, aes(label = label), size = 3, color = "black", check_overlap = TRUE) +  # Add region names
  scale_fill_manual(values = continent_colors, name = "") +
  theme_classic() +
  labs(title = "IPCC Regions", ylabs="", xlabs="") +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    plot.subtitle = element_text(size = 12),
    legend.position = "bottom"
  ) +
  coord_sf(xlim = bbox[1:2], ylim = bbox[3:4], expand = FALSE)  # Crop the map to Asia

##### Step 5: Plot the time series data with faceting
time_series_plot_D <- ggplot(combined_df_sel, aes(x = time, y = RP, color = window_size)) +
  geom_line() +  # Plot lines for each region's return period
  geom_hline(yintercept = 20, linetype = "dashed", color = "black") +  # Add a reference line for 2-year return period
  labs(
    x = "Year",
    y = "Effective Return Period",
    title = "Frequency Change of 20-Year Events"
  ) +
  scale_color_manual(name = "Window Size", values = c("30yr" = "cadetblue", "70yr" = "chocolate1", "100yr" = "chartreuse")) +
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "lightgreen")
  ) +
  facet_wrap(~region)  # Facet by region with independent y-axis scales

##### Step 6: Arrange the two plots side by side using patchwork
# Explicitly control the layout with patchwork

# Arrange the Map and Time Series Side by Side
grid.arrange(
  map_plot_D, time_series_plot_D,
  ncol = 2,  # Side-by-side layout
  widths = c(1, 2)  # Adjust the relative width of the plots
)


###################################### C AMERICA #######################################
##### Step 2: Filter C AMERICA regions for the map and timeseries
# Filter regions for C America
selected_continent <- "Central America"
sel_regions <- continent_mapping[[selected_continent]]

# Filter combined data for timeseries 
combined_df_sel <- combined_df %>% filter(region %in% sel_regions)

# Filter spatial data for map
sel_regions_sf <- refregions_sf %>% filter(continent %in% selected_continent)

# Define bounding box for C America
bbox <- c(xmin = -130, xmax = -50, ymin = 0, ymax = 30)  # Approximate bounding box for Oceania

#### Step 4: Create the map
map_plot_E <- ggplot() +
  geom_sf(data = land, fill = "lightgray", color = NA) +  # Fill land areas
  geom_sf(data = sel_regions_sf, aes(fill = continent), color = "black", alpha = 0.6) +  # Transparent overlay
  geom_sf_text(data = region_labels, aes(label = label), size = 3, color = "black", check_overlap = TRUE) +  # Add region names
  scale_fill_manual(values = continent_colors, name = "") +
  theme_classic() +
  labs(title = "IPCC Regions", ylabs="", xlabs="") +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    plot.subtitle = element_text(size = 12),
    legend.position = "bottom"
  ) +
  coord_sf(xlim = bbox[1:2], ylim = bbox[3:4], expand = FALSE)  # Crop the map to Asia

##### Step 5: Plot the time series data with faceting
time_series_plot_E <- ggplot(combined_df_sel, aes(x = time, y = RP, color = window_size)) +
  geom_line() +  # Plot lines for each region's return period
  geom_hline(yintercept = 20, linetype = "dashed", color = "black") +  # Add a reference line for 2-year return period
  labs(
    x = "Year",
    y = "Effective Return Period",
    title = "Frequency Change of 20-Year Events"
  ) +
  scale_color_manual(name = "Window Size", values = c("30yr" = "cadetblue", "70yr" = "chocolate1", "100yr" = "chartreuse")) +
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "lightblue")
  ) +
  facet_wrap(~region)  # Facet by region with independent y-axis scales

##### Step 6: Arrange the two plots side by side using patchwork
# Explicitly control the layout with patchwork

# Arrange the Map and Time Series Side by Side
grid.arrange(
  map_plot_E, time_series_plot_E,
  ncol = 2,  # Side-by-side layout
  widths = c(1, 2)  # Adjust the relative width of the plots
)


###################################### S AMERICA #######################################
##### Step 2: Filter S AMERICA regions for the map and timeseries
# Filter regions for S America
selected_continent <- "South America"
sel_regions <- continent_mapping[[selected_continent]]

# Filter combined data for timeseries 
combined_df_sel <- combined_df %>% filter(region %in% sel_regions)

# Filter spatial data for map
sel_regions_sf <- refregions_sf %>% filter(continent %in% selected_continent)

# Define bounding box for S America
bbox <- c(xmin = -90, xmax = -30, ymin = -60, ymax = 15)  # Approximate bounding box for Oceania

#### Step 4: Create the map
map_plot_F <- ggplot() +
  geom_sf(data = land, fill = "lightgray", color = NA) +  # Fill land areas
  geom_sf(data = sel_regions_sf, aes(fill = continent), color = "black", alpha = 0.6) +  # Transparent overlay
  geom_sf_text(data = region_labels, aes(label = label), size = 3, color = "black", check_overlap = TRUE) +  # Add region names
  scale_fill_manual(values = continent_colors, name = "") +
  theme_classic() +
  labs(title = "IPCC Regions", ylabs="", xlabs="") +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    plot.subtitle = element_text(size = 12),
    legend.position = "bottom"
  ) +
  coord_sf(xlim = bbox[1:2], ylim = bbox[3:4], expand = FALSE)  # Crop the map to South America

##### Step 5: Plot the time series data with faceting
time_series_plot_F <- ggplot(combined_df_sel, aes(x = time, y = RP, color = window_size)) +
  geom_line() +  # Plot lines for each region's return period
  geom_hline(yintercept = 20, linetype = "dashed", color = "black") +  # Add a reference line for 20-year return period
  labs(
    x = "Year",
    y = "Effective Return Period",
    title = "Frequency Change of 20-Year Events"
  ) +
  scale_color_manual(name = "Window Size", values = c("30yr" = "cadetblue", "70yr" = "chocolate1", "100yr" = "chartreuse")) +
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "yellow")
  ) +
  facet_wrap(~region)  # Facet by region with independent y-axis scales

##### Step 6: Arrange the two plots side by side using patchwork
# Explicitly control the layout with patchwork

# Arrange the Map and Time Series Side by Side
grid.arrange(
  map_plot_F, time_series_plot_F,
  ncol = 2,  # Side-by-side layout
  widths = c(1, 2)  # Adjust the relative width of the plots
)
```
```{r scatterplot 20yr RP 1435 and 1834}
# Extract data for the first and last years
combined_RP_1420 <- read.csv("~/cwd_global/data/20yr_return_periods_regions_1420.csv")

data_first_last <- combined_RP_1420 %>%
  filter(time == 1435 | time == 1834) %>%
  pivot_wider(names_from = time, values_from = RP, names_prefix = "year_") %>%
  drop_na()  # Remove rows with missing values for the years of interest

# Add continent information to the data
data_first_last <- data_first_last %>%
  mutate(continent = case_when(
    region %in% continent_mapping[["Europe"]] ~ "Europe",
    region %in% continent_mapping[["North America"]] ~ "North America",
    region %in% continent_mapping[["Africa"]] ~ "Africa",
    region %in% continent_mapping[["Asia"]] ~ "Asia",
    region %in% continent_mapping[["Central America"]] ~ "Central America",
    region %in% continent_mapping[["South America"]] ~ "South America",
    region %in% continent_mapping[["Australia"]] ~ "Australia",
    TRUE ~ "Other"
  ))

# Create the scatter plot
ggplot(data_first_last, aes(x = year_1834, y = year_1435, color = continent)) +
  geom_point(size = 3) +
  scale_color_manual(values = continent_colors) +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "black") +
   geom_text(aes(label = region), hjust = 0.5, vjust = -0.5, size = 3, colour = "black") + # Adjust hjust and vjust for positioning
  labs(
    x = "RP in 1834",
    y = "RP in 1435",
    title = "PCWD RP in 1435 vs 1834 of 20yr ref event (1420)",
    color = "Continent"
  ) +
  theme_classic()

```

```{r calc 20yr RL 1420 for scatterplot, echo=FALSE}
regional_results_1420 <- readRDS("~/cwd_global/data/regionalResults_1420.RData")

use_rp <- 20    # return period of two years
nyears <- 30   # bin width

########1420 epoch
# initialise

################# 1420 -1849 epoch #################

# Initialize a list to store results for all regions
all_regions_RL_1420 <- list()

# Loop through each region in regional_results
for (region in names(regional_results_1420)) { #swap european_regions for regional_results for all regions
  # Extract the result array for the current region
  result_array_region <- regional_results_1420[[region]]
  
  RL_window <- rep(NA, nrow(result_array_region) - nyears + 1)
  
  for (window_start in 1:(nrow(result_array_region) - nyears + 1)){
  
  # Extract data for the current window
    window_data <- result_array_region[window_start:(window_start + nyears - 1), ]
    
    # Flatten the matrix into a single vector
    window_data <- as.vector(window_data)
    
    # Fit Gumbel distribution to the window data
    fit_window <- fevd(window_data, type = "Gumbel")
    
    # Calculate the 2-year return level
    return_level <- return.level(fit_window, return.period = use_rp)
    
    # Store the result in the vector
    RL_window[window_start] <- return_level
  }
  # Create a dataframe for the current region
  time_info <- seq(from = as.numeric(1420), to = as.numeric(1849))  # Replace with actual time if available
  region_df <- data.frame(
    time = time_info[15:415],
    RL = RL_window,
    region = region
  )
  
  # Store the region's dataframe in the results list
  all_regions_RL_1420[[region]] <- region_df
}
  
# Combine all region results into a single dataframe
combined_RL_1420 <- do.call(rbind, all_regions_RL_1420)

```


```{r scatterplot 20yr RL 1435 and 1834, echo=FALSE}
# Extract data for the first and last years
data_first_last <- combined_RL_1420 %>%
  filter(time == 1435 | time == 1834) %>%
  pivot_wider(names_from = time, values_from = RL, names_prefix = "year_") %>%
  drop_na()  # Remove rows with missing values for the years of interest

# Add continent information to the data
data_first_last <- data_first_last %>%
  mutate(continent = case_when(
    region %in% continent_mapping[["Europe"]] ~ "Europe",
    region %in% continent_mapping[["North America"]] ~ "North America",
    region %in% continent_mapping[["Africa"]] ~ "Africa",
    region %in% continent_mapping[["Asia"]] ~ "Asia",
    region %in% continent_mapping[["Central America"]] ~ "Central America",
    region %in% continent_mapping[["South America"]] ~ "South America",
    region %in% continent_mapping[["Australia"]] ~ "Australia",
    TRUE ~ "Other"
  ))

# Create the scatter plot
ggplot(data_first_last, aes(x = year_1834, y = year_1435, color = continent)) +
  geom_point(size = 3) +
  scale_color_manual(values = continent_colors) +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "black") +
   geom_text(aes(label = region), hjust = 0.5, vjust = -0.5, size = 3, colour = "black") + # Adjust hjust and vjust for positioning
  labs(
    x = "20 yr PCWD (mm) in 1834",
    y = "20 yr PCWD (mm) in 1435",
    title = "20 year PCWD RL in 1435 vs 1834",
    color = "Continent"
  ) +
  theme_classic()

```

plot the "outlier" regions as timeseries: 
```{r}

###### 1. Read in return period data
# Load the CSV files for each window size
sel_regions <- c("SWS", "NWS", "WSAF")

# Filter combined data for timeseries 
combined_sel <- combined_RL_1420 %>% filter(region %in% sel_regions)

##### Step 5: Plot the time series data with faceting
ggplot(combined_sel, aes(x = time, y = RL), color = "blue") +
  geom_line() +  # Plot lines for each region's return period
  #geom_hline(yintercept = 2, linetype = "dashed", color = "black") +  # Add a reference line for 2-year return period
  labs(
    x = "Year",
    y = "PCWD RL",
    title = "PCWD 20 year events"
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "grey")
  ) +
  facet_wrap(~region, scales = "free_y"
             )  # Facet by region with independent y-axis scales
```

### Frequency changes of 20-yr return period events for all IPCC regions (1850 - 2009 epoch):

```{r timeseries and map plots for each region 20 yr 1850, echo=FALSE, warning=FALSE, message=FALSE }
###### 1. Read in return period data
# Load the CSV files for each window size
combined_df <- read.csv("~/cwd_global/data/20yr_return_periods_regions_1850.csv")
combined_df$window_size <- "30yr"

####################################### EUROPE #####################################
##### Step 2: Filter European regions for the map and timeseries
# Filter regions for Europe
selected_continent <- "Europe"
sel_regions <- continent_mapping[[selected_continent]]

# Filter combined data for timeseries 
combined_df_sel <- combined_df %>% filter(region %in% sel_regions)

# Filter spatial data for map
sel_regions_sf <- refregions_sf %>% filter(continent %in% selected_continent)

# Define bounding box for Europe
bbox <- c(xmin = -30, xmax = 70, ymin = 25, ymax = 75)  # Approximate bounding box for Europe

# european_regions_sf <- refregions_sf %>% filter(continent == "Europe")
# # Define the bounding box for Europe
# europe_bbox <- c(xmin = -30, xmax = 70, ymin = 25, ymax = 75)  # Approximate bounding box for Europe


#### Step 4: Create the map
map_plot <- ggplot() +
  geom_sf(data = land, fill = "lightgray", color = NA) +  # Fill land areas
  geom_sf(data = sel_regions_sf, aes(fill = continent), color = "black", alpha = 0.6) +  # Transparent overlay
  geom_sf_text(data = region_labels, aes(label = label), size = 3, color = "black", check_overlap = TRUE) +  # Add region names
  scale_fill_manual(values = continent_colors, name = "") +
  theme_classic() +
  labs(title = "IPCC Regions", ylabs="", xlabs="") +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    plot.subtitle = element_text(size = 12),
    legend.position = "bottom"
  ) +
  coord_sf(xlim = bbox[1:2], ylim = bbox[3:4], expand = FALSE)  # Crop the map to Europe

##### Step 5: Plot the time series data with faceting
time_series_plot <- ggplot(combined_df_sel, aes(x = time, y = RP, color = window_size)) +
  geom_line() +  # Plot lines for each region's return period
  geom_hline(yintercept = 20, linetype = "dashed", color = "black") +  # Add a reference line for 2-year return period
  labs(
    x = "Year",
    y = "Effective Return Period",
    title = "Frequency Change of 20-Year Events"
  ) +
  scale_color_manual(name = "Window Size", values = c("30yr" = "cadetblue", "70yr" = "chocolate1", "100yr" = "chartreuse")) +
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "pink")
  ) +
  facet_wrap(~region
             )  # Facet by region with independent y-axis scales

##### Step 6: Arrange the two plots side by side using patchwork
# Explicitly control the layout with patchwork

# Arrange the Map and Time Series Side by Side
grid.arrange(
  map_plot, time_series_plot,
  ncol = 2,  # Side-by-side layout
  widths = c(1, 2)  # Adjust the relative width of the plots
)


######################################ASIA#######################################
##### Step 2: Filter Asian regions for the map and timeseries
# Filter regions for Asian
selected_continent <- "Asia"
sel_regions <- continent_mapping[[selected_continent]]

# Filter combined data for timeseries 
combined_df_sel <- combined_df %>% filter(region %in% sel_regions)

# Filter spatial data for map
sel_regions_sf <- refregions_sf %>% filter(continent %in% selected_continent)

# Define bounding box for Asia
bbox <- c(xmin = 30, xmax = 190, ymin = -20, ymax = 90)  # Approximate bounding box for Europe

# european_regions_sf <- refregions_sf %>% filter(continent == "Europe")
# # Define the bounding box for Europe
# europe_bbox <- c(xmin = -30, xmax = 70, ymin = 25, ymax = 75)  # Approximate bounding box for Europe


#### Step 4: Create the map
map_plot_A <- ggplot() +
  geom_sf(data = land, fill = "lightgray", color = NA) +  # Fill land areas
  geom_sf(data = sel_regions_sf, aes(fill = continent), color = "black", alpha = 0.6) +  # Transparent overlay
  geom_sf_text(data = region_labels, aes(label = label), size = 3, color = "black", check_overlap = TRUE) +  # Add region names
  scale_fill_manual(values = continent_colors, name = "") +
  theme_classic() +
  labs(title = "IPCC Regions", ylabs="", xlabs="") +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    plot.subtitle = element_text(size = 12),
    legend.position = "bottom"
  ) +
  coord_sf(xlim = bbox[1:2], ylim = bbox[3:4], expand = FALSE)  # Crop the map to Asia

##### Step 5: Plot the time series data with faceting
time_series_plot_A <- ggplot(combined_df_sel, aes(x = time, y = RP, color = window_size)) +
  geom_line() +  # Plot lines for each region's return period
  geom_hline(yintercept = 20, linetype = "dashed", color = "black") +  # Add a reference line for 2-year return period
  labs(
    x = "Year",
    y = "Effective Return Period",
    title = "Frequency Change of 20-Year Events"
  ) +
  scale_color_manual(name = "Window Size", values = c("30yr" = "cadetblue", "70yr" = "chocolate1", "100yr" = "chartreuse")) +
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "orange")
  ) +
  facet_wrap(~region)  # Facet by region with independent y-axis scales

##### Step 6: Arrange the two plots side by side using patchwork
# Explicitly control the layout with patchwork

# Arrange the Map and Time Series Side by Side
grid.arrange(
  map_plot_A, time_series_plot_A,
  ncol = 2,  # Side-by-side layout
  widths = c(1, 2)  # Adjust the relative width of the plots
)


###################################### OCEANIA #######################################
##### Step 2: Filter Oceanian regions for the map and timeseries
# Filter regions for Oceania
selected_continent <- "Australia"
sel_regions <- continent_mapping[[selected_continent]]

# Filter combined data for timeseries 
combined_df_sel <- combined_df %>% filter(region %in% sel_regions)

# Filter spatial data for map
sel_regions_sf <- refregions_sf %>% filter(continent %in% selected_continent)

# Define bounding box for Oceania
bbox <- c(xmin = 100, xmax = 190, ymin = -60, ymax = 0)  # Approximate bounding box for Oceania

#### Step 4: Create the map
map_plot_B <- ggplot() +
  geom_sf(data = land, fill = "lightgray", color = NA) +  # Fill land areas
  geom_sf(data = sel_regions_sf, aes(fill = continent), color = "black", alpha = 0.6) +  # Transparent overlay
  geom_sf_text(data = region_labels, aes(label = label), size = 3, color = "black", check_overlap = TRUE) +  # Add region names
  scale_fill_manual(values = continent_colors, name = "") +
  theme_classic() +
  labs(title = "IPCC Regions", ylabs="", xlabs="") +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    plot.subtitle = element_text(size = 12),
    legend.position = "bottom"
  ) +
  coord_sf(xlim = bbox[1:2], ylim = bbox[3:4], expand = FALSE)  # Crop the map to Asia

##### Step 5: Plot the time series data with faceting
time_series_plot_B <- ggplot(combined_df_sel, aes(x = time, y = RP, color = window_size)) +
  geom_line() +  # Plot lines for each region's return period
  geom_hline(yintercept = 20, linetype = "dashed", color = "black") +  # Add a reference line for 2-year return period
  labs(
    x = "Year",
    y = "Effective Return Period",
    title = "Frequency Change of 20-Year Events"
  ) +
  scale_color_manual(name = "Window Size", values = c("30yr" = "cadetblue", "70yr" = "chocolate1", "100yr" = "chartreuse")) +
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "blue")
  ) +
  facet_wrap(~region)  # Facet by region with independent y-axis scales

##### Step 6: Arrange the two plots side by side using patchwork
# Explicitly control the layout with patchwork

# Arrange the Map and Time Series Side by Side
grid.arrange(
  map_plot_B, time_series_plot_B,
  ncol = 2,  # Side-by-side layout
  widths = c(1, 2)  # Adjust the relative width of the plots
)


###################################### AFRICA #######################################
##### Step 2: Filter African regions for the map and timeseries
# Filter regions for Africa
selected_continent <- "Africa"
sel_regions <- continent_mapping[[selected_continent]]

# Filter combined data for timeseries 
combined_df_sel <- combined_df %>% filter(region %in% sel_regions)

# Filter spatial data for map
sel_regions_sf <- refregions_sf %>% filter(continent %in% selected_continent)

# Define bounding box for Africa
bbox <- c(xmin = -30, xmax = 60, ymin = -30, ymax = 30)  # Approximate bounding box for Oceania

#### Step 4: Create the map
map_plot_C <- ggplot() +
  geom_sf(data = land, fill = "lightgray", color = NA) +  # Fill land areas
  geom_sf(data = sel_regions_sf, aes(fill = continent), color = "black", alpha = 0.6) +  # Transparent overlay
  geom_sf_text(data = region_labels, aes(label = label), size = 3, color = "black", check_overlap = TRUE) +  # Add region names
  scale_fill_manual(values = continent_colors, name = "") +
  theme_classic() +
  labs(title = "IPCC Regions", ylabs="", xlabs="") +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    plot.subtitle = element_text(size = 12),
    legend.position = "bottom"
  ) +
  coord_sf(xlim = bbox[1:2], ylim = bbox[3:4], expand = FALSE)  # Crop the map to Asia

##### Step 5: Plot the time series data with faceting
time_series_plot_C <- ggplot(combined_df_sel, aes(x = time, y = RP, color = window_size)) +
  geom_line() +  # Plot lines for each region's return period
  geom_hline(yintercept = 20, linetype = "dashed", color = "black") +  # Add a reference line for 2-year return period
  labs(
    x = "Year",
    y = "Effective Return Period",
    title = "Frequency Change of 20-Year Events"
  ) +
  scale_color_manual(name = "Window Size", values = c("30yr" = "cadetblue", "70yr" = "chocolate1", "100yr" = "chartreuse")) +
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "purple")
  ) +
  facet_wrap(~region)  # Facet by region with independent y-axis scales

##### Step 6: Arrange the two plots side by side using patchwork
# Explicitly control the layout with patchwork

# Arrange the Map and Time Series Side by Side
grid.arrange(
  map_plot_C, time_series_plot_C,
  ncol = 2,  # Side-by-side layout
  widths = c(1, 2)  # Adjust the relative width of the plots
)


###################################### N AMERICA #######################################
##### Step 2: Filter N AMERICA regions for the map and timeseries
# Filter regions for N America
selected_continent <- "North America"
sel_regions <- continent_mapping[[selected_continent]]

# Filter combined data for timeseries 
combined_df_sel <- combined_df %>% filter(region %in% sel_regions)

# Filter spatial data for map
sel_regions_sf <- refregions_sf %>% filter(continent %in% selected_continent)

# Define bounding box for N America
bbox <- c(xmin = -180, xmax = -10, ymin = 20, ymax = 90)  # Approximate bounding box for Oceania

#### Step 4: Create the map
map_plot_D <- ggplot() +
  geom_sf(data = land, fill = "lightgray", color = NA) +  # Fill land areas
  geom_sf(data = sel_regions_sf, aes(fill = continent), color = "black", alpha = 0.6) +  # Transparent overlay
  geom_sf_text(data = region_labels, aes(label = label), size = 3, color = "black", check_overlap = TRUE) +  # Add region names
  scale_fill_manual(values = continent_colors, name = "") +
  theme_classic() +
  labs(title = "IPCC Regions", ylabs="", xlabs="") +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    plot.subtitle = element_text(size = 12),
    legend.position = "bottom"
  ) +
  coord_sf(xlim = bbox[1:2], ylim = bbox[3:4], expand = FALSE)  # Crop the map to Asia

##### Step 5: Plot the time series data with faceting
time_series_plot_D <- ggplot(combined_df_sel, aes(x = time, y = RP, color = window_size)) +
  geom_line() +  # Plot lines for each region's return period
  geom_hline(yintercept = 20, linetype = "dashed", color = "black") +  # Add a reference line for 2-year return period
  labs(
    x = "Year",
    y = "Effective Return Period",
    title = "Frequency Change of 20-Year Events"
  ) +
  scale_color_manual(name = "Window Size", values = c("30yr" = "cadetblue", "70yr" = "chocolate1", "100yr" = "chartreuse")) +
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "lightgreen")
  ) +
  facet_wrap(~region)  # Facet by region with independent y-axis scales

##### Step 6: Arrange the two plots side by side using patchwork
# Explicitly control the layout with patchwork

# Arrange the Map and Time Series Side by Side
grid.arrange(
  map_plot_D, time_series_plot_D,
  ncol = 2,  # Side-by-side layout
  widths = c(1, 2)  # Adjust the relative width of the plots
)


###################################### C AMERICA #######################################
##### Step 2: Filter C AMERICA regions for the map and timeseries
# Filter regions for C America
selected_continent <- "Central America"
sel_regions <- continent_mapping[[selected_continent]]

# Filter combined data for timeseries 
combined_df_sel <- combined_df %>% filter(region %in% sel_regions)

# Filter spatial data for map
sel_regions_sf <- refregions_sf %>% filter(continent %in% selected_continent)

# Define bounding box for C America
bbox <- c(xmin = -130, xmax = -50, ymin = 0, ymax = 30)  # Approximate bounding box for Oceania

#### Step 4: Create the map
map_plot_E <- ggplot() +
  geom_sf(data = land, fill = "lightgray", color = NA) +  # Fill land areas
  geom_sf(data = sel_regions_sf, aes(fill = continent), color = "black", alpha = 0.6) +  # Transparent overlay
  geom_sf_text(data = region_labels, aes(label = label), size = 3, color = "black", check_overlap = TRUE) +  # Add region names
  scale_fill_manual(values = continent_colors, name = "") +
  theme_classic() +
  labs(title = "IPCC Regions", ylabs="", xlabs="") +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    plot.subtitle = element_text(size = 12),
    legend.position = "bottom"
  ) +
  coord_sf(xlim = bbox[1:2], ylim = bbox[3:4], expand = FALSE)  # Crop the map to Asia

##### Step 5: Plot the time series data with faceting
time_series_plot_E <- ggplot(combined_df_sel, aes(x = time, y = RP, color = window_size)) +
  geom_line() +  # Plot lines for each region's return period
  geom_hline(yintercept = 20, linetype = "dashed", color = "black") +  # Add a reference line for 2-year return period
  labs(
    x = "Year",
    y = "Effective Return Period",
    title = "Frequency Change of 20-Year Events"
  ) +
  scale_color_manual(name = "Window Size", values = c("30yr" = "cadetblue", "70yr" = "chocolate1", "100yr" = "chartreuse")) +
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "lightblue")
  ) +
  facet_wrap(~region)  # Facet by region with independent y-axis scales

##### Step 6: Arrange the two plots side by side using patchwork
# Explicitly control the layout with patchwork

# Arrange the Map and Time Series Side by Side
grid.arrange(
  map_plot_E, time_series_plot_E,
  ncol = 2,  # Side-by-side layout
  widths = c(1, 2)  # Adjust the relative width of the plots
)


###################################### S AMERICA #######################################
##### Step 2: Filter S AMERICA regions for the map and timeseries
# Filter regions for S America
selected_continent <- "South America"
sel_regions <- continent_mapping[[selected_continent]]

# Filter combined data for timeseries 
combined_df_sel <- combined_df %>% filter(region %in% sel_regions)

# Filter spatial data for map
sel_regions_sf <- refregions_sf %>% filter(continent %in% selected_continent)

# Define bounding box for S America
bbox <- c(xmin = -90, xmax = -30, ymin = -60, ymax = 15)  # Approximate bounding box for Oceania

#### Step 4: Create the map
map_plot_F <- ggplot() +
  geom_sf(data = land, fill = "lightgray", color = NA) +  # Fill land areas
  geom_sf(data = sel_regions_sf, aes(fill = continent), color = "black", alpha = 0.6) +  # Transparent overlay
  geom_sf_text(data = region_labels, aes(label = label), size = 3, color = "black", check_overlap = TRUE) +  # Add region names
  scale_fill_manual(values = continent_colors, name = "") +
  theme_classic() +
  labs(title = "IPCC Regions", ylabs="", xlabs="") +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    plot.subtitle = element_text(size = 12),
    legend.position = "bottom"
  ) +
  coord_sf(xlim = bbox[1:2], ylim = bbox[3:4], expand = FALSE)  # Crop the map to South America

##### Step 5: Plot the time series data with faceting
time_series_plot_F <- ggplot(combined_df_sel, aes(x = time, y = RP, color = window_size)) +
  geom_line() +  # Plot lines for each region's return period
  geom_hline(yintercept = 20, linetype = "dashed", color = "black") +  # Add a reference line for 20-year return period
  labs(
    x = "Year",
    y = "Effective Return Period",
    title = "Frequency Change of 20-Year Events"
  ) +
  scale_color_manual(name = "Window Size", values = c("30yr" = "cadetblue", "70yr" = "chocolate1", "100yr" = "chartreuse")) +
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "yellow")
  ) +
  facet_wrap(~region)  # Facet by region with independent y-axis scales

##### Step 6: Arrange the two plots side by side using patchwork
# Explicitly control the layout with patchwork

# Arrange the Map and Time Series Side by Side
grid.arrange(
  map_plot_F, time_series_plot_F,
  ncol = 2,  # Side-by-side layout
  widths = c(1, 2)  # Adjust the relative width of the plots
)

```

```{r scatterplot 20yr RP 1864 and 1994, echo=FALSE}
# Load the CSV files for each window size
combined_RP_1850 <- read.csv("~/cwd_global/data/20yr_return_periods_regions_1850.csv")

# Extract data for the first and last years
data_first_last <- combined_RP_1850 %>%
  filter(time == 1864 | time == 1994) %>%
  pivot_wider(names_from = time, values_from = RP, names_prefix = "year_") %>%
  drop_na()  # Remove rows with missing values for the years of interest

# Add continent information to the data
data_first_last <- data_first_last %>%
  mutate(continent = case_when(
    region %in% continent_mapping[["Europe"]] ~ "Europe",
    region %in% continent_mapping[["North America"]] ~ "North America",
    region %in% continent_mapping[["Africa"]] ~ "Africa",
    region %in% continent_mapping[["Asia"]] ~ "Asia",
    region %in% continent_mapping[["Central America"]] ~ "Central America",
    region %in% continent_mapping[["South America"]] ~ "South America",
    region %in% continent_mapping[["Australia"]] ~ "Australia",
    TRUE ~ "Other"
  ))

# Create the scatter plot
ggplot(data_first_last, aes(x = year_1994, y = year_1864, color = continent)) +
  geom_point(size = 3) +
  scale_color_manual(values = continent_colors) +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "black") +
  geom_text(aes(label = region), hjust = 0.5, vjust = -0.5, size = 3, colour = "black") + # Adjust hjust and vjust for positioning
  labs(
    x = "20 yr RP in 1994",
    y = "20 yr RP in 1864",
    title = "PCWD RP in 1864 vs 1994 of 20yr ref event (1420)",
    color = "Continent"
  ) +
  theme_classic()

```

```{r scatterplot 20yr RP 1435 and 1994, echo=FALSE}
# Load the CSV files for each window size
combined_RP_1850 <- read.csv("~/cwd_global/data/20yr_return_periods_regions_1850.csv")
combined_RP_1420 <- read.csv("~/cwd_global/data/20yr_return_periods_regions_1420.csv")

# Extract data for the first and last years
data_first_last_beg <- combined_RP_1420 %>%
  filter(time == 1435) %>%
  pivot_wider(names_from = time, values_from = RP, names_prefix = "year_") %>%
  drop_na()  # Remove rows with missing values for the years of interest

data_first_last_end <- combined_RP_1850 %>%
  filter(time == 1994) %>%
  pivot_wider(names_from = time, values_from = RP, names_prefix = "year_") %>%
  drop_na()  # Remove rows with missing values for the years of interest

# Merge the two datasets on the 'region' column
data_combined <- inner_join(data_first_last_beg, data_first_last_end, by = "region", suffix = c("_beg", "_end"))

# Ensure the continent information is consistent
data_combined <- data_combined %>%
  mutate(continent = case_when(
    region %in% continent_mapping[["Europe"]] ~ "Europe",
    region %in% continent_mapping[["North America"]] ~ "North America",
    region %in% continent_mapping[["Africa"]] ~ "Africa",
    region %in% continent_mapping[["Asia"]] ~ "Asia",
    region %in% continent_mapping[["Central America"]] ~ "Central America",
    region %in% continent_mapping[["South America"]] ~ "South America",
    region %in% continent_mapping[["Australia"]] ~ "Australia",
    TRUE ~ "Other"
  ))

ggplot(data_combined, aes(x = year_1994, y = year_1435, color = continent)) +
  geom_point(size = 3) +
  scale_color_manual(values = continent_colors) +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "black") +
  geom_text(aes(label = region), hjust = 0.5, vjust = -0.5, size = 3, colour = "black") + # Annotate with region names
  labs(
    x = "20 yr RP in 1994",
    y = "20 yr RP in 1435",
    title = "PCWD RP in 1435 vs 1994 of 20yr ref event (1420)",
    color = "Continent"
  ) +
  theme_classic()

```

```{r calc 20 yr RL 1850 for scatterplot, echo=FALSE}
regional_results_1850 <- readRDS("~/cwd_global/data/regionalResults_1850.RData")

use_rp <- 20    # return period of two years
nyears <- 30   # bin width

########1850 epoch
# initialise

################# 1850 -1849 epoch #################

# Initialize a list to store results for all regions
all_regions_RL_1850 <- list()

# Loop through each region in regional_results
for (region in names(regional_results_1850)) { #swap european_regions for regional_results for all regions
  # Extract the result array for the current region
  result_array_region <- regional_results_1850[[region]]
  
  RL_window <- rep(NA, nrow(result_array_region) - nyears + 1)
  
  for (window_start in 1:(nrow(result_array_region) - nyears + 1)){
  
  # Extract data for the current window
    window_data <- result_array_region[window_start:(window_start + nyears - 1), ]
    
    # Flatten the matrix into a single vector
    window_data <- as.vector(window_data)
    
    # Fit Gumbel distribution to the window data
    fit_window <- fevd(window_data, type = "Gumbel")
    
    # Calculate the 2-year return level
    return_level <- return.level(fit_window, return.period = use_rp)
    
    # Store the result in the vector
    RL_window[window_start] <- return_level
  }
  # Create a dataframe for the current region
  time_info <- seq(from = as.numeric(1850), to = as.numeric(2009))  # Replace with actual time if available
  region_df <- data.frame(
    time = time_info[15:145],
    RL = RL_window,
    region = region
  )
  
  # Store the region's dataframe in the results list
  all_regions_RL_1850[[region]] <- region_df
}
  
# Combine all region results into a single dataframe
combined_RL_1850 <- do.call(rbind, all_regions_RL_1850)

```

```{r scatterplot 20yr RL 1864 and 1994, echo=FALSE}
# Extract data for the first and last years
data_first_last <- combined_RL_1850 %>%
  filter(time == 1864 | time == 1994) %>%
  pivot_wider(names_from = time, values_from = RL, names_prefix = "year_") %>%
  drop_na()  # Remove rows with missing values for the years of interest

# Add continent information to the data
data_first_last <- data_first_last %>%
  mutate(continent = case_when(
    region %in% continent_mapping[["Europe"]] ~ "Europe",
    region %in% continent_mapping[["North America"]] ~ "North America",
    region %in% continent_mapping[["Africa"]] ~ "Africa",
    region %in% continent_mapping[["Asia"]] ~ "Asia",
    region %in% continent_mapping[["Central America"]] ~ "Central America",
    region %in% continent_mapping[["South America"]] ~ "South America",
    region %in% continent_mapping[["Australia"]] ~ "Australia",
    TRUE ~ "Other"
  ))

# Create the scatter plot
ggplot(data_first_last, aes(x = year_1994, y = year_1864, color = continent)) +
  geom_point(size = 3) +
  scale_color_manual(values = continent_colors) +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "black") +
  geom_text(aes(label = region), hjust = 0.5, vjust = -0.5, size = 3, colour = "black") + # Adjust hjust and vjust for positioning
  labs(
    x = "20 yr PCWD (mm) in 1994",
    y = "20 yr PCWD (mm) in 1864",
    title = "20 year PCWD RL in 1864 vs 1994",
    color = "Continent"
  ) +
  theme_classic()

```

```{r}

###### 1. Read in return period data
# Load the CSV files for each window size
sel_regions <- c("SWS", "NWS", "WSAF")

# Filter combined data for timeseries 
combined_sel <- combined_RL_1850 %>% filter(region %in% sel_regions)

##### Step 5: Plot the time series data with faceting
ggplot(combined_sel, aes(x = time, y = RL), color = "blue") +
  geom_line() +  # Plot lines for each region's return period
  #geom_hline(yintercept = 2, linetype = "dashed", color = "black") +  # Add a reference line for 2-year return period
  labs(
    x = "Year",
    y = "PCWD RL",
    title = "PCWD 20 year events"
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "grey")
  ) +
  facet_wrap(~region, scales = "free_y"
             )  # Facet by region with independent y-axis scales
```
```{r}

# Extract data for the first and last years
data_first_last_beg <- combined_RL_1420 %>%
  filter(time == 1435) %>%
  pivot_wider(names_from = time, values_from = RL, names_prefix = "year_") %>%
  drop_na()  # Remove rows with missing values for the years of interest

data_first_last_end <- combined_RL_1850 %>%
  filter(time == 1994) %>%
  pivot_wider(names_from = time, values_from = RL, names_prefix = "year_") %>%
  drop_na()  # Remove rows with missing values for the years of interest

# Merge the two datasets on the 'region' column
data_combined <- inner_join(data_first_last_beg, data_first_last_end, by = "region", suffix = c("_beg", "_end"))

# Ensure the continent information is consistent
data_combined <- data_combined %>%
  mutate(continent = case_when(
    region %in% continent_mapping[["Europe"]] ~ "Europe",
    region %in% continent_mapping[["North America"]] ~ "North America",
    region %in% continent_mapping[["Africa"]] ~ "Africa",
    region %in% continent_mapping[["Asia"]] ~ "Asia",
    region %in% continent_mapping[["Central America"]] ~ "Central America",
    region %in% continent_mapping[["South America"]] ~ "South America",
    region %in% continent_mapping[["Australia"]] ~ "Australia",
    TRUE ~ "Other"
  ))

ggplot(data_combined, aes(x = year_1994, y = year_1435, color = continent)) +
  geom_point(size = 3) +
  scale_color_manual(values = continent_colors) +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "black") +
  geom_text(aes(label = region), hjust = 0.5, vjust = -0.5, size = 3, colour = "black") + # Annotate with region names
  labs(
    x = "PCWD RL in 1994",
    y = "PCWD RL in 1435",
    title = "20 year PCWD RL in 1435 vs 1994",
    color = "Continent"
  ) +
  theme_classic()

```


## Assessing the change in frequency of 100-year drought events (Extremely severe drought)

- moving window size 30 years

```{r 100yr return period WCE only, eval=FALSE, echo=FALSE}
#same thing but instead calculate 100yr return period frequency for events?
#define a reference period? First 30 years: Take 30 year average of 2 year event as baseline and see how frequency of events with that threshold change

# Define parameters
window_size <- 25
return_period <- 100

# Calculate the baseline 2-year return level using the first 30 years
baseline_window_data <- as.vector(result_array.wce[1:(2 * window_size), ])

# Fit the GEV model to the baseline window
baseline_gev_fit <- fevd(baseline_window_data, type = "GEV", verbose = FALSE)

# Calculate the 2-year return level for the baseline period
baseline_return_level <- return.level(baseline_gev_fit, return.period = return_period)

# Initialize a vector to store the effective return period for each time step
num_time_steps <- nrow(result_array.wce)
effective_return_period_vector <- rep(NA, num_time_steps)

# Loop over time steps (ensuring a 31-year moving window)
for (t in (window_size + 1):(num_time_steps - window_size)) {
  # Extract the data for the current 31-year window across all ensemble members
  window_data <- result_array.wce[(t - window_size):(t + window_size), ]
  window_data <- as.vector(window_data) # Flatten the matrix to a single vector
  
  # Remove NA values
  window_data <- window_data[!is.na(window_data)]
  
  # Count how many events exceed the baseline 2-year return level
  exceedances <- sum(window_data > baseline_return_level, na.rm = TRUE)
  
  # Calculate the effective return period
  if (exceedances > 0) {
    effective_return_period <- length(window_data) / exceedances
  } else {
    effective_return_period <- Inf # No events exceed the baseline threshold
  }
  
  # Store the effective return period
  effective_return_period_vector[t] <- effective_return_period
}

# Create a data.frame combining time and effective return period
result_df_RP_50yr <- data.frame(
  time = time_info,
  effective_return_period = effective_return_period_vector
)

```


```{r plot for 100yr WCE, eval=FALSE, echo=FALSE}
ggplot() +
  geom_line(data = result_df_RP_150yr, mapping= aes(x=time, y=effective_return_period, color="150yr"))+
    geom_line(data = result_df_RP_50yr, mapping= aes(x=time, y=effective_return_period, color="50yr"))+
  #geom_line(data = result_df_RP_200yr, mapping= aes(x=time, y=effective_return_period, color="200yr"))+
  geom_line(data = result_df_RP_300yr, mapping= aes(x=time, y=effective_return_period, color="300yr"))+
  #  geom_line(data = result_df_RP_100yr, mapping= aes(x=time, y=effective_return_period, color="100yr"))+
  geom_hline(yintercept=100, linetype="dashed", color = "black")+
  ylim(min(result_df_RP$effective_return_period), max(result_df_RP$effective_return_period)) +
  xlim(min(result_df_RP$time), max(result_df_RP$time)) +
  labs(
    x = "Year", 
    y = "return period",
    title = "frequency change of 100 yr events - sliding window"
  ) +
  theme_classic()+
      scale_color_manual(name="window size",values = c("50yr" = "cadetblue","100yr" = "chocolate1", "150yr" = "chartreuse", "200yr" = "deeppink", "300yr" = "darkturquoise"))
```

### Frequency changes of 100-yr return period events for all IPCC regions (1420 - 1849 epoch)

```{r calculate return periods all regions 100yr, echo=FALSE, message=FALSE, eval=FALSE}
use_rp <- 100    # return period of two years
nyears <- 30   # bin width

################# 1420 -1849 epoch #################

# Initialize a list to store results for all regions
all_regions_results_1420 <- list()

# Loop through each region in regional_results
for (region in names(regional_results_1420)) { #swap european_regions for regional_results for all regions
  # Extract the result array for the current region
  result_array_region_BL <- regional_results_1420[[region]]
  result_array_region <- regional_results_1420[[region]]
  # Calculate magnitude of event with RP = X in reference period
  # Calculate the baseline 2-year return level using the first 30 years
  baseline <- as.vector(result_array_region_BL[(1:nyears),])
  fit_ref <- extRemes::fevd(baseline, type = "Gumbel", method = "MLE", units = "years")
  cwd_ref <- extRemes::return.level(fit_ref, return.period = use_rp)

  # initialise
  rp_window <- rep(NA, nrow(result_array_region) - nyears + 1)

  for (window_start in 1:(nrow(result_array_region) - nyears + 1)){

    # Extract data for the current window
    window_data <- result_array_region[window_start:(window_start + nyears - 1), ]
  
    # Flatten the matrix into a single vector
    window_data <- as.vector(window_data)
  
    # Fit Gumbel distribution to the window data
    fit_window <- fevd(window_data, type = "Gumbel")

	  # determine return period of cwd_ref based on new fit (How much more/less probably is an event that corresponded to an X-yearly event in the reference period?)
	  rp_window[window_start] <- calc_return_period(cwd_ref, extract_loc(fit_window), extract_scale(fit_window))

  }
  # Create a dataframe for the current region
  time_info <- seq(from = as.numeric(1420), to = as.numeric(1849))  # Replace with actual time if available
  region_df <- data.frame(
    time = time_info[15:415],
    RP = rp_window,
    region = region
  )
  
  # Store the region's dataframe in the results list
  all_regions_results_1420[[region]] <- region_df
}
  
# Combine all region results into a single dataframe
combined_results_1420 <- do.call(rbind, all_regions_results_1420)

# Save or process the combined dataframe
# Example: Save to a CSV file
write.csv(combined_results_1420, "~/cwd_global/data/100yr_return_periods_regions_1420.csv", row.names = FALSE)


################# 1850 - 2009 epoch #################

# Initialize a list to store results for all regions
all_regions_results_1850 <- list()

# Loop through each region in regional_results
for (region in names(regional_results_1850)) { #swap european_regions for regional_results for all regions
  # Extract the result array for the current region
  result_array_region_BL <- regional_results_1420[[region]]
  result_array_region <- regional_results_1850[[region]]
  # Calculate magnitude of event with RP = X in reference period
  # Calculate the baseline 2-year return level using the first 30 years
  baseline <- as.vector(result_array_region_BL[(1:nyears),])
  fit_ref <- extRemes::fevd(baseline, type = "Gumbel", method = "MLE", units = "years")
  cwd_ref <- extRemes::return.level(fit_ref, return.period = use_rp)

  # initialise
  rp_window <- rep(NA, nrow(result_array_region) - nyears + 1)

  for (window_start in 1:(nrow(result_array_region) - nyears + 1)){

    # Extract data for the current window
    window_data <- result_array_region[window_start:(window_start + nyears - 1), ]
  
    # Flatten the matrix into a single vector
    window_data <- as.vector(window_data)
  
    # Fit Gumbel distribution to the window data
    fit_window <- fevd(window_data, type = "Gumbel")

	  # determine return period of cwd_ref based on new fit (How much more/less probably is an event that corresponded to an X-yearly event in the reference period?)
	  rp_window[window_start] <- calc_return_period(cwd_ref, extract_loc(fit_window), extract_scale(fit_window))

  }
  # Create a dataframe for the current region
  time_info <- seq(from = as.numeric(1850), to = as.numeric(2009))  # Replace with actual time if available
  region_df <- data.frame(
    time = time_info[15:145],
    RP = rp_window,
    region = region
  )
  
  # Store the region's dataframe in the results list
  all_regions_results_1850[[region]] <- region_df
}
  
# Combine all region results into a single dataframe
combined_results_1850 <- do.call(rbind, all_regions_results_1850)

# Save or process the combined dataframe
# Example: Save to a CSV file
write.csv(combined_results_1850, "~/cwd_global/data/100yr_return_periods_regions_1850.csv", row.names = FALSE)


```


```{r timeseries and map plots for each region 100yr 1420, echo=FALSE, message=FALSE, warning=FALSE}
###### 1. Read in return period data
# Load the CSV files for each window size
combined_df <- read.csv("~/cwd_global/data/100yr_return_periods_regions_1420.csv")
combined_df$window_size <- "30yr"

####################################### EUROPE #####################################
##### Step 2: Filter European regions for the map and timeseries
# Filter regions for Europe
selected_continent <- "Europe"
sel_regions <- continent_mapping[[selected_continent]]

# Filter combined data for timeseries 
combined_df_sel <- combined_df %>% filter(region %in% sel_regions)

# Filter spatial data for map
sel_regions_sf <- refregions_sf %>% filter(continent %in% selected_continent)

# Define bounding box for Europe
bbox <- c(xmin = -30, xmax = 70, ymin = 25, ymax = 75)  # Approximate bounding box for Europe

#### Step 4: Create the map
map_plot <- ggplot() +
  geom_sf(data = land, fill = "lightgray", color = NA) +  # Fill land areas
  geom_sf(data = sel_regions_sf, aes(fill = continent), color = "black", alpha = 0.6) +  # Transparent overlay
  geom_sf_text(data = region_labels, aes(label = label), size = 3, color = "black", check_overlap = TRUE) +  # Add region names
  scale_fill_manual(values = continent_colors, name = "") +
  theme_classic() +
  labs(title = "IPCC Regions", ylabs="", xlabs="") +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    plot.subtitle = element_text(size = 12),
    legend.position = "bottom"
  ) +
  coord_sf(xlim = bbox[1:2], ylim = bbox[3:4], expand = FALSE)  # Crop the map to Europe

##### Step 5: Plot the time series data with faceting
time_series_plot <- ggplot(combined_df_sel, aes(x = time, y = RP, color = window_size)) +
  geom_line() +  # Plot lines for each region's return period
  geom_hline(yintercept = 100, linetype = "dashed", color = "black") +  # Add a reference line for 2-year return period
  labs(
    x = "Year",
    y = "Effective Return Period",
    title = "Frequency Change of 100-Year Events"
  ) +
  scale_color_manual(name = "Window Size", values = c("50yr" = "cadetblue", "150yr" = "chocolate1", "30yr" = "chartreuse")) +
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "pink")
  ) +
  facet_wrap(~region
             )  # Facet by region with independent y-axis scales

##### Step 6: Arrange the two plots side by side using patchwork
# Explicitly control the layout with patchwork

# Arrange the Map and Time Series Side by Side
grid.arrange(
  map_plot, time_series_plot,
  ncol = 2,  # Side-by-side layout
  widths = c(1, 2)  # Adjust the relative width of the plots
)


######################################ASIA#######################################
##### Step 2: Filter Asian regions for the map and timeseries
# Filter regions for Asian
selected_continent <- "Asia"
sel_regions <- continent_mapping[[selected_continent]]

# Filter combined data for timeseries 
combined_df_sel <- combined_df %>% filter(region %in% sel_regions)

# Filter spatial data for map
sel_regions_sf <- refregions_sf %>% filter(continent %in% selected_continent)

# Define bounding box for Asia
bbox <- c(xmin = 30, xmax = 190, ymin = -20, ymax = 90)  # Approximate bounding box for Europe

#### Step 4: Create the map
map_plot_A <- ggplot() +
  geom_sf(data = land, fill = "lightgray", color = NA) +  # Fill land areas
  geom_sf(data = sel_regions_sf, aes(fill = continent), color = "black", alpha = 0.6) +  # Transparent overlay
  geom_sf_text(data = region_labels, aes(label = label), size = 3, color = "black", check_overlap = TRUE) +  # Add region names
  scale_fill_manual(values = continent_colors, name = "") +
  theme_classic() +
  labs(title = "IPCC Regions", ylabs="", xlabs="") +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    plot.subtitle = element_text(size = 12),
    legend.position = "bottom"
  ) +
  coord_sf(xlim = bbox[1:2], ylim = bbox[3:4], expand = FALSE)  # Crop the map to Asia

##### Step 5: Plot the time series data with faceting
time_series_plot_A <- ggplot(combined_df_sel, aes(x = time, y = RP, color = window_size)) +
  geom_line() +  # Plot lines for each region's return period
  geom_hline(yintercept = 100, linetype = "dashed", color = "black") +  # Add a reference line for 2-year return period
  labs(
    x = "Year",
    y = "Effective Return Period",
    title = "Frequency Change of 100-Year Events"
  ) +
  scale_color_manual(name = "Window Size", values = c("50yr" = "cadetblue", "150yr" = "chocolate1", "30yr" = "chartreuse")) +
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "orange")
  ) +
  facet_wrap(~region)  # Facet by region with independent y-axis scales

##### Step 6: Arrange the two plots side by side using patchwork
# Explicitly control the layout with patchwork

# Arrange the Map and Time Series Side by Side
grid.arrange(
  map_plot_A, time_series_plot_A,
  ncol = 2,  # Side-by-side layout
  widths = c(1, 2)  # Adjust the relative width of the plots
)


###################################### OCEANIA #######################################
##### Step 2: Filter Oceanian regions for the map and timeseries
# Filter regions for Oceania
selected_continent <- "Australia"
sel_regions <- continent_mapping[[selected_continent]]

# Filter combined data for timeseries 
combined_df_sel <- combined_df %>% filter(region %in% sel_regions)

# Filter spatial data for map
sel_regions_sf <- refregions_sf %>% filter(continent %in% selected_continent)

# Define bounding box for Oceania
bbox <- c(xmin = 100, xmax = 190, ymin = -60, ymax = 0)  # Approximate bounding box for Oceania

#### Step 4: Create the map
map_plot_B <- ggplot() +
  geom_sf(data = land, fill = "lightgray", color = NA) +  # Fill land areas
  geom_sf(data = sel_regions_sf, aes(fill = continent), color = "black", alpha = 0.6) +  # Transparent overlay
  geom_sf_text(data = region_labels, aes(label = label), size = 3, color = "black", check_overlap = TRUE) +  # Add region names
  scale_fill_manual(values = continent_colors, name = "") +
  theme_classic() +
  labs(title = "IPCC Regions", ylabs="", xlabs="") +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    plot.subtitle = element_text(size = 12),
    legend.position = "bottom"
  ) +
  coord_sf(xlim = bbox[1:2], ylim = bbox[3:4], expand = FALSE)  # Crop the map to Asia

##### Step 5: Plot the time series data with faceting
time_series_plot_B <- ggplot(combined_df_sel, aes(x = time, y = RP, color = window_size)) +
  geom_line() +  # Plot lines for each region's return period
  geom_hline(yintercept = 100, linetype = "dashed", color = "black") +  # Add a reference line for 2-year return period
  labs(
    x = "Year",
    y = "Effective Return Period",
    title = "Frequency Change of 100-Year Events"
  ) +
  scale_color_manual(name = "Window Size", values = c("50yr" = "cadetblue", "150yr" = "chocolate1", "30yr" = "chartreuse")) +
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "blue")
  ) +
  facet_wrap(~region)  # Facet by region with independent y-axis scales

##### Step 6: Arrange the two plots side by side using patchwork
# Explicitly control the layout with patchwork

# Arrange the Map and Time Series Side by Side
grid.arrange(
  map_plot_B, time_series_plot_B,
  ncol = 2,  # Side-by-side layout
  widths = c(1, 2)  # Adjust the relative width of the plots
)


###################################### AFRICA #######################################
##### Step 2: Filter African regions for the map and timeseries
# Filter regions for Africa
selected_continent <- "Africa"
sel_regions <- continent_mapping[[selected_continent]]

# Filter combined data for timeseries 
combined_df_sel <- combined_df %>% filter(region %in% sel_regions)

# Filter spatial data for map
sel_regions_sf <- refregions_sf %>% filter(continent %in% selected_continent)

# Define bounding box for Africa
bbox <- c(xmin = -30, xmax = 60, ymin = -40, ymax = 40)  # Approximate bounding box for Oceania

#### Step 4: Create the map
map_plot_C <- ggplot() +
  geom_sf(data = land, fill = "lightgray", color = NA) +  # Fill land areas
  geom_sf(data = sel_regions_sf, aes(fill = continent), color = "black", alpha = 0.6) +  # Transparent overlay
  geom_sf_text(data = region_labels, aes(label = label), size = 3, color = "black", check_overlap = TRUE) +  # Add region names
  scale_fill_manual(values = continent_colors, name = "") +
  theme_classic() +
  labs(title = "IPCC Regions", ylabs="", xlabs="") +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    plot.subtitle = element_text(size = 12),
    legend.position = "bottom"
  ) +
  coord_sf(xlim = bbox[1:2], ylim = bbox[3:4], expand = FALSE)  # Crop the map to Asia

##### Step 5: Plot the time series data with faceting
time_series_plot_C <- ggplot(combined_df_sel, aes(x = time, y = RP, color = window_size)) +
  geom_line() +  # Plot lines for each region's return period
  geom_hline(yintercept = 100, linetype = "dashed", color = "black") +  # Add a reference line for 2-year return period
  labs(
    x = "Year",
    y = "Effective Return Period",
    title = "Frequency Change of 100-Year Events"
  ) +
  scale_color_manual(name = "Window Size", values = c("50yr" = "cadetblue", "150yr" = "chocolate1", "30yr" = "chartreuse")) +
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "purple")
  ) +
  facet_wrap(~region)  # Facet by region with independent y-axis scales

##### Step 6: Arrange the two plots side by side using patchwork
# Explicitly control the layout with patchwork

# Arrange the Map and Time Series Side by Side
grid.arrange(
  map_plot_C, time_series_plot_C,
  ncol = 2,  # Side-by-side layout
  widths = c(1, 2)  # Adjust the relative width of the plots
)


###################################### N AMERICA #######################################
##### Step 2: Filter N AMERICA regions for the map and timeseries
# Filter regions for N America
selected_continent <- "North America"
sel_regions <- continent_mapping[[selected_continent]]

# Filter combined data for timeseries 
combined_df_sel <- combined_df %>% filter(region %in% sel_regions)

# Filter spatial data for map
sel_regions_sf <- refregions_sf %>% filter(continent %in% selected_continent)

# Define bounding box for N America
bbox <- c(xmin = -180, xmax = -10, ymin = 20, ymax = 90)  # Approximate bounding box for Oceania

#### Step 4: Create the map
map_plot_D <- ggplot() +
  geom_sf(data = land, fill = "lightgray", color = NA) +  # Fill land areas
  geom_sf(data = sel_regions_sf, aes(fill = continent), color = "black", alpha = 0.6) +  # Transparent overlay
  geom_sf_text(data = region_labels, aes(label = label), size = 3, color = "black", check_overlap = TRUE) +  # Add region names
  scale_fill_manual(values = continent_colors, name = "") +
  theme_classic() +
  labs(title = "IPCC Regions", ylabs="", xlabs="") +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    plot.subtitle = element_text(size = 12),
    legend.position = "bottom"
  ) +
  coord_sf(xlim = bbox[1:2], ylim = bbox[3:4], expand = FALSE)  # Crop the map to Asia

##### Step 5: Plot the time series data with faceting
time_series_plot_D <- ggplot(combined_df_sel, aes(x = time, y = RP, color = window_size)) +
  geom_line() +  # Plot lines for each region's return period
  geom_hline(yintercept = 100, linetype = "dashed", color = "black") +  # Add a reference line for 2-year return period
  labs(
    x = "Year",
    y = "Effective Return Period",
    title = "Frequency Change of 100-Year Events"
  ) +
  scale_color_manual(name = "Window Size", values = c("50yr" = "cadetblue", "150yr" = "chocolate1", "30yr" = "chartreuse")) +
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "lightgreen")
  ) +
  facet_wrap(~region)  # Facet by region with independent y-axis scales

##### Step 6: Arrange the two plots side by side using patchwork
# Explicitly control the layout with patchwork

# Arrange the Map and Time Series Side by Side
grid.arrange(
  map_plot_D, time_series_plot_D,
  ncol = 2,  # Side-by-side layout
  widths = c(1, 2)  # Adjust the relative width of the plots
)


###################################### C AMERICA #######################################
##### Step 2: Filter C AMERICA regions for the map and timeseries
# Filter regions for C America
selected_continent <- "Central America"
sel_regions <- continent_mapping[[selected_continent]]

# Filter combined data for timeseries 
combined_df_sel <- combined_df %>% filter(region %in% sel_regions)

# Filter spatial data for map
sel_regions_sf <- refregions_sf %>% filter(continent %in% selected_continent)

# Define bounding box for C America
bbox <- c(xmin = -130, xmax = -50, ymin = 0, ymax = 40)  # Approximate bounding box for Oceania

#### Step 4: Create the map
map_plot_E <- ggplot() +
  geom_sf(data = land, fill = "lightgray", color = NA) +  # Fill land areas
  geom_sf(data = sel_regions_sf, aes(fill = continent), color = "black", alpha = 0.6) +  # Transparent overlay
  geom_sf_text(data = region_labels, aes(label = label), size = 3, color = "black", check_overlap = TRUE) +  # Add region names
  scale_fill_manual(values = continent_colors, name = "") +
  theme_classic() +
  labs(title = "IPCC Regions", ylabs="", xlabs="") +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    plot.subtitle = element_text(size = 12),
    legend.position = "bottom"
  ) +
  coord_sf(xlim = bbox[1:2], ylim = bbox[3:4], expand = FALSE)  # Crop the map to Asia

##### Step 5: Plot the time series data with faceting
time_series_plot_E <- ggplot(combined_df_sel, aes(x = time, y = RP, color = window_size)) +
  geom_line() +  # Plot lines for each region's return period
  geom_hline(yintercept = 100, linetype = "dashed", color = "black") +  # Add a reference line for 2-year return period
  labs(
    x = "Year",
    y = "Effective Return Period",
    title = "Frequency Change of 100-Year Events"
  ) +
  scale_color_manual(name = "Window Size", values = c("50yr" = "cadetblue", "150yr" = "chocolate1", "30yr" = "chartreuse")) +
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "lightblue")
  ) +
  facet_wrap(~region)  # Facet by region with independent y-axis scales

##### Step 6: Arrange the two plots side by side using patchwork
# Explicitly control the layout with patchwork

# Arrange the Map and Time Series Side by Side
grid.arrange(
  map_plot_E, time_series_plot_E,
  ncol = 2,  # Side-by-side layout
  widths = c(1, 2)  # Adjust the relative width of the plots
)


###################################### S AMERICA #######################################
##### Step 2: Filter S AMERICA regions for the map and timeseries
# Filter regions for S America
selected_continent <- "South America"
sel_regions <- continent_mapping[[selected_continent]]

# Filter combined data for timeseries 
combined_df_sel <- combined_df %>% filter(region %in% sel_regions)

# Filter spatial data for map
sel_regions_sf <- refregions_sf %>% filter(continent %in% selected_continent)

# Define bounding box for S America
bbox <- c(xmin = -90, xmax = -30, ymin = -60, ymax = 15)  # Approximate bounding box for Oceania

#### Step 4: Create the map
map_plot_F <- ggplot() +
  geom_sf(data = land, fill = "lightgray", color = NA) +  # Fill land areas
  geom_sf(data = sel_regions_sf, aes(fill = continent), color = "black", alpha = 0.6) +  # Transparent overlay
  geom_sf_text(data = region_labels, aes(label = label), size = 3, color = "black", check_overlap = TRUE) +  # Add region names
  scale_fill_manual(values = continent_colors, name = "") +
  theme_classic() +
  labs(title = "IPCC Regions", ylabs="", xlabs="") +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    plot.subtitle = element_text(size = 12),
    legend.position = "bottom"
  ) +
  coord_sf(xlim = bbox[1:2], ylim = bbox[3:4], expand = FALSE)  # Crop the map to South America

##### Step 5: Plot the time series data with faceting
time_series_plot_F <- ggplot(combined_df_sel, aes(x = time, y = RP, color = window_size)) +
  geom_line() +  # Plot lines for each region's return period
  geom_hline(yintercept = 100, linetype = "dashed", color = "black") +  # Add a reference line for 100-year return period
  labs(
    x = "Year",
    y = "Effective Return Period",
    title = "Frequency Change of 100-Year Events"
  ) +
  scale_color_manual(name = "Window Size", values = c("50yr" = "cadetblue", "150yr" = "chocolate1", "30yr" = "chartreuse")) +
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "yellow")
  ) +
  facet_wrap(~region)  # Facet by region with independent y-axis scales

##### Step 6: Arrange the two plots side by side using patchwork
# Explicitly control the layout with patchwork

# Arrange the Map and Time Series Side by Side
grid.arrange(
  map_plot_F, time_series_plot_F,
  ncol = 2,  # Side-by-side layout
  widths = c(1, 2)  # Adjust the relative width of the plots
)
```

```{r scatterplot 100yr RP 1435 and 1834, echo=FALSE}
# Load the CSV files for each window size
combined_RP_1420 <- read.csv("~/cwd_global/data/100yr_return_periods_regions_1420.csv")

# Extract data for the first and last years
data_first_last <- combined_RP_1420 %>%
  filter(time == 1435 | time == 1834) %>%
  pivot_wider(names_from = time, values_from = RP, names_prefix = "year_") %>%
  drop_na()  # Remove rows with missing values for the years of interest

# Add continent information to the data
data_first_last <- data_first_last %>%
  mutate(continent = case_when(
    region %in% continent_mapping[["Europe"]] ~ "Europe",
    region %in% continent_mapping[["North America"]] ~ "North America",
    region %in% continent_mapping[["Africa"]] ~ "Africa",
    region %in% continent_mapping[["Asia"]] ~ "Asia",
    region %in% continent_mapping[["Central America"]] ~ "Central America",
    region %in% continent_mapping[["South America"]] ~ "South America",
    region %in% continent_mapping[["Australia"]] ~ "Australia",
    TRUE ~ "Other"
  ))

# Create the scatter plot
ggplot(data_first_last, aes(x = year_1834, y = year_1435, color = continent)) +
  geom_point(size = 3) +
  scale_color_manual(values = continent_colors) +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "black") +
  geom_text(aes(label = region), hjust = 0.5, vjust = -0.5, size = 3, colour = "black") + # Adjust hjust and vjust for positioning

  labs(
    x = "100 yr RP in 1834",
    y = "100 yr RP in 1435",
    title = "PCWD RP in 1435 vs 1834 of 100yr ref event (1420)",
    color = "Continent"
  ) +
  theme_classic()

```

```{r calc 100yr RL 1420 for scatterplot, echo=FALSE}
regional_results_1420 <- readRDS("~/cwd_global/data/regionalResults_1420.RData")

use_rp <- 100    # return period of two years
nyears <- 30   # bin width

########1420 epoch
# initialise

################# 1420 -1849 epoch #################

# Initialize a list to store results for all regions
all_regions_RL_1420 <- list()

# Loop through each region in regional_results
for (region in names(regional_results_1420)) { #swap european_regions for regional_results for all regions
  # Extract the result array for the current region
  result_array_region <- regional_results_1420[[region]]
  
  RL_window <- rep(NA, nrow(result_array_region) - nyears + 1)
  
  for (window_start in 1:(nrow(result_array_region) - nyears + 1)){
  
  # Extract data for the current window
    window_data <- result_array_region[window_start:(window_start + nyears - 1), ]
    
    # Flatten the matrix into a single vector
    window_data <- as.vector(window_data)
    
    # Fit Gumbel distribution to the window data
    fit_window <- fevd(window_data, type = "Gumbel")
    
    # Calculate the 2-year return level
    return_level <- return.level(fit_window, return.period = use_rp)
    
    # Store the result in the vector
    RL_window[window_start] <- return_level
  }
  # Create a dataframe for the current region
  time_info <- seq(from = as.numeric(1420), to = as.numeric(1849))  # Replace with actual time if available
  region_df <- data.frame(
    time = time_info[15:415],
    RL = RL_window,
    region = region
  )
  
  # Store the region's dataframe in the results list
  all_regions_RL_1420[[region]] <- region_df
}
  
# Combine all region results into a single dataframe
combined_RL_1420 <- do.call(rbind, all_regions_RL_1420)

```

```{r scatterplot 100yr RL 1435 and 1834, echo=FALSE}
# Extract data for the first and last years
data_first_last <- combined_RL_1420 %>%
  filter(time == 1435 | time == 1834) %>%
  pivot_wider(names_from = time, values_from = RL, names_prefix = "year_") %>%
  drop_na()  # Remove rows with missing values for the years of interest

# Add continent information to the data
data_first_last <- data_first_last %>%
  mutate(continent = case_when(
    region %in% continent_mapping[["Europe"]] ~ "Europe",
    region %in% continent_mapping[["North America"]] ~ "North America",
    region %in% continent_mapping[["Africa"]] ~ "Africa",
    region %in% continent_mapping[["Asia"]] ~ "Asia",
    region %in% continent_mapping[["Central America"]] ~ "Central America",
    region %in% continent_mapping[["South America"]] ~ "South America",
    region %in% continent_mapping[["Australia"]] ~ "Australia",
    TRUE ~ "Other"
  ))

# Create the scatter plot
ggplot(data_first_last, aes(x = year_1834, y = year_1435, color = continent)) +
  geom_point(size = 3) +
  scale_color_manual(values = continent_colors) +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "black") +
  geom_text(aes(label = region), hjust = 0.5, vjust = -0.5, size = 3, colour = "black") + # Adjust hjust and vjust for positioning
  labs(
    x = "100 yr PCWD (mm) in 1834",
    y = "100 yr PCWD (mm) in 1435",
    title = "100 year PCWD RL in 1435 vs 1834",
    color = "Continent"
  ) +
  theme_classic()

```


```{r}

###### 1. Read in return period data
# Load the CSV files for each window size
sel_regions <- c("SWS", "NWS", "WSAF")

# Filter combined data for timeseries 
combined_sel <- combined_RL_1420 %>% filter(region %in% sel_regions)

##### Step 5: Plot the time series data with faceting
ggplot(combined_sel, aes(x = time, y = RL), color = "blue") +
  geom_line() +  # Plot lines for each region's return period
  #geom_hline(yintercept = 2, linetype = "dashed", color = "black") +  # Add a reference line for 2-year return period
  labs(
    x = "Year",
    y = "PCWD RL",
    title = "PCWD 100 year events"
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "grey")
  ) +
  facet_wrap(~region, scales = "free_y"
             )  # Facet by region with independent y-axis scales
```

### Frequency changes of 100-yr return period events for all IPCC regions (1850 - 2009 epoch)

```{r timeseries and map plots for each region 100yr 1850, echo=FALSE, message=FALSE, warning=FALSE}
###### 1. Read in return period data
# Load the CSV files for each window size
combined_df <- read.csv("~/cwd_global/data/100yr_return_periods_regions_1850.csv")
combined_df$window_size <- "30yr"

####################################### EUROPE #####################################
##### Step 2: Filter European regions for the map and timeseries
# Filter regions for Europe
selected_continent <- "Europe"
sel_regions <- continent_mapping[[selected_continent]]

# Filter combined data for timeseries 
combined_df_sel <- combined_df %>% filter(region %in% sel_regions)

# Filter spatial data for map
sel_regions_sf <- refregions_sf %>% filter(continent %in% selected_continent)

# Define bounding box for Europe
bbox <- c(xmin = -30, xmax = 70, ymin = 25, ymax = 75)  # Approximate bounding box for Europe

#### Step 4: Create the map
map_plot <- ggplot() +
  geom_sf(data = land, fill = "lightgray", color = NA) +  # Fill land areas
  geom_sf(data = sel_regions_sf, aes(fill = continent), color = "black", alpha = 0.6) +  # Transparent overlay
  geom_sf_text(data = region_labels, aes(label = label), size = 3, color = "black", check_overlap = TRUE) +  # Add region names
  scale_fill_manual(values = continent_colors, name = "") +
  theme_classic() +
  labs(title = "IPCC Regions", ylabs="", xlabs="") +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    plot.subtitle = element_text(size = 12),
    legend.position = "bottom"
  ) +
  coord_sf(xlim = bbox[1:2], ylim = bbox[3:4], expand = FALSE)  # Crop the map to Europe

##### Step 5: Plot the time series data with faceting
time_series_plot <- ggplot(combined_df_sel, aes(x = time, y = RP, color = window_size)) +
  geom_line() +  # Plot lines for each region's return period
  geom_hline(yintercept = 100, linetype = "dashed", color = "black") +  # Add a reference line for 2-year return period
  labs(
    x = "Year",
    y = "Effective Return Period",
    title = "Frequency Change of 100-Year Events"
  ) +
  scale_color_manual(name = "Window Size", values = c("50yr" = "cadetblue", "150yr" = "chocolate1", "30yr" = "chartreuse")) +
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "pink")
  ) +
  facet_wrap(~region
             )  # Facet by region with independent y-axis scales

##### Step 6: Arrange the two plots side by side using patchwork
# Explicitly control the layout with patchwork

# Arrange the Map and Time Series Side by Side
grid.arrange(
  map_plot, time_series_plot,
  ncol = 2,  # Side-by-side layout
  widths = c(1, 2)  # Adjust the relative width of the plots
)


######################################ASIA#######################################
##### Step 2: Filter Asian regions for the map and timeseries
# Filter regions for Asian
selected_continent <- "Asia"
sel_regions <- continent_mapping[[selected_continent]]

# Filter combined data for timeseries 
combined_df_sel <- combined_df %>% filter(region %in% sel_regions)

# Filter spatial data for map
sel_regions_sf <- refregions_sf %>% filter(continent %in% selected_continent)

# Define bounding box for Asia
bbox <- c(xmin = 30, xmax = 190, ymin = -20, ymax = 90)  # Approximate bounding box for Europe

#### Step 4: Create the map
map_plot_A <- ggplot() +
  geom_sf(data = land, fill = "lightgray", color = NA) +  # Fill land areas
  geom_sf(data = sel_regions_sf, aes(fill = continent), color = "black", alpha = 0.6) +  # Transparent overlay
  geom_sf_text(data = region_labels, aes(label = label), size = 3, color = "black", check_overlap = TRUE) +  # Add region names
  scale_fill_manual(values = continent_colors, name = "") +
  theme_classic() +
  labs(title = "IPCC Regions", ylabs="", xlabs="") +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    plot.subtitle = element_text(size = 12),
    legend.position = "bottom"
  ) +
  coord_sf(xlim = bbox[1:2], ylim = bbox[3:4], expand = FALSE)  # Crop the map to Asia

##### Step 5: Plot the time series data with faceting
time_series_plot_A <- ggplot(combined_df_sel, aes(x = time, y = RP, color = window_size)) +
  geom_line() +  # Plot lines for each region's return period
  geom_hline(yintercept = 100, linetype = "dashed", color = "black") +  # Add a reference line for 2-year return period
  labs(
    x = "Year",
    y = "Effective Return Period",
    title = "Frequency Change of 100-Year Events"
  ) +
  scale_color_manual(name = "Window Size", values = c("50yr" = "cadetblue", "150yr" = "chocolate1", "30yr" = "chartreuse")) +
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "orange")
  ) +
  facet_wrap(~region)  # Facet by region with independent y-axis scales

##### Step 6: Arrange the two plots side by side using patchwork
# Explicitly control the layout with patchwork

# Arrange the Map and Time Series Side by Side
grid.arrange(
  map_plot_A, time_series_plot_A,
  ncol = 2,  # Side-by-side layout
  widths = c(1, 2)  # Adjust the relative width of the plots
)


###################################### OCEANIA #######################################
##### Step 2: Filter Oceanian regions for the map and timeseries
# Filter regions for Oceania
selected_continent <- "Australia"
sel_regions <- continent_mapping[[selected_continent]]

# Filter combined data for timeseries 
combined_df_sel <- combined_df %>% filter(region %in% sel_regions)

# Filter spatial data for map
sel_regions_sf <- refregions_sf %>% filter(continent %in% selected_continent)

# Define bounding box for Oceania
bbox <- c(xmin = 100, xmax = 190, ymin = -60, ymax = 0)  # Approximate bounding box for Oceania

#### Step 4: Create the map
map_plot_B <- ggplot() +
  geom_sf(data = land, fill = "lightgray", color = NA) +  # Fill land areas
  geom_sf(data = sel_regions_sf, aes(fill = continent), color = "black", alpha = 0.6) +  # Transparent overlay
  geom_sf_text(data = region_labels, aes(label = label), size = 3, color = "black", check_overlap = TRUE) +  # Add region names
  scale_fill_manual(values = continent_colors, name = "") +
  theme_classic() +
  labs(title = "IPCC Regions", ylabs="", xlabs="") +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    plot.subtitle = element_text(size = 12),
    legend.position = "bottom"
  ) +
  coord_sf(xlim = bbox[1:2], ylim = bbox[3:4], expand = FALSE)  # Crop the map to Asia

##### Step 5: Plot the time series data with faceting
time_series_plot_B <- ggplot(combined_df_sel, aes(x = time, y = RP, color = window_size)) +
  geom_line() +  # Plot lines for each region's return period
  geom_hline(yintercept = 100, linetype = "dashed", color = "black") +  # Add a reference line for 2-year return period
  labs(
    x = "Year",
    y = "Effective Return Period",
    title = "Frequency Change of 100-Year Events"
  ) +
  scale_color_manual(name = "Window Size", values = c("50yr" = "cadetblue", "150yr" = "chocolate1", "30yr" = "chartreuse")) +
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "blue")
  ) +
  facet_wrap(~region)  # Facet by region with independent y-axis scales

##### Step 6: Arrange the two plots side by side using patchwork
# Explicitly control the layout with patchwork

# Arrange the Map and Time Series Side by Side
grid.arrange(
  map_plot_B, time_series_plot_B,
  ncol = 2,  # Side-by-side layout
  widths = c(1, 2)  # Adjust the relative width of the plots
)


###################################### AFRICA #######################################
##### Step 2: Filter African regions for the map and timeseries
# Filter regions for Africa
selected_continent <- "Africa"
sel_regions <- continent_mapping[[selected_continent]]

# Filter combined data for timeseries 
combined_df_sel <- combined_df %>% filter(region %in% sel_regions)

# Filter spatial data for map
sel_regions_sf <- refregions_sf %>% filter(continent %in% selected_continent)

# Define bounding box for Africa
bbox <- c(xmin = -30, xmax = 60, ymin = -40, ymax = 40)  # Approximate bounding box for Oceania

#### Step 4: Create the map
map_plot_C <- ggplot() +
  geom_sf(data = land, fill = "lightgray", color = NA) +  # Fill land areas
  geom_sf(data = sel_regions_sf, aes(fill = continent), color = "black", alpha = 0.6) +  # Transparent overlay
  geom_sf_text(data = region_labels, aes(label = label), size = 3, color = "black", check_overlap = TRUE) +  # Add region names
  scale_fill_manual(values = continent_colors, name = "") +
  theme_classic() +
  labs(title = "IPCC Regions", ylabs="", xlabs="") +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    plot.subtitle = element_text(size = 12),
    legend.position = "bottom"
  ) +
  coord_sf(xlim = bbox[1:2], ylim = bbox[3:4], expand = FALSE)  # Crop the map to Asia

##### Step 5: Plot the time series data with faceting
time_series_plot_C <- ggplot(combined_df_sel, aes(x = time, y = RP, color = window_size)) +
  geom_line() +  # Plot lines for each region's return period
  geom_hline(yintercept = 100, linetype = "dashed", color = "black") +  # Add a reference line for 2-year return period
  labs(
    x = "Year",
    y = "Effective Return Period",
    title = "Frequency Change of 100-Year Events"
  ) +
  scale_color_manual(name = "Window Size", values = c("50yr" = "cadetblue", "150yr" = "chocolate1", "30yr" = "chartreuse")) +
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "purple")
  ) +
  facet_wrap(~region)  # Facet by region with independent y-axis scales

##### Step 6: Arrange the two plots side by side using patchwork
# Explicitly control the layout with patchwork

# Arrange the Map and Time Series Side by Side
grid.arrange(
  map_plot_C, time_series_plot_C,
  ncol = 2,  # Side-by-side layout
  widths = c(1, 2)  # Adjust the relative width of the plots
)


###################################### N AMERICA #######################################
##### Step 2: Filter N AMERICA regions for the map and timeseries
# Filter regions for N America
selected_continent <- "North America"
sel_regions <- continent_mapping[[selected_continent]]

# Filter combined data for timeseries 
combined_df_sel <- combined_df %>% filter(region %in% sel_regions)

# Filter spatial data for map
sel_regions_sf <- refregions_sf %>% filter(continent %in% selected_continent)

# Define bounding box for N America
bbox <- c(xmin = -180, xmax = -10, ymin = 20, ymax = 90)  # Approximate bounding box for Oceania

#### Step 4: Create the map
map_plot_D <- ggplot() +
  geom_sf(data = land, fill = "lightgray", color = NA) +  # Fill land areas
  geom_sf(data = sel_regions_sf, aes(fill = continent), color = "black", alpha = 0.6) +  # Transparent overlay
  geom_sf_text(data = region_labels, aes(label = label), size = 3, color = "black", check_overlap = TRUE) +  # Add region names
  scale_fill_manual(values = continent_colors, name = "") +
  theme_classic() +
  labs(title = "IPCC Regions", ylabs="", xlabs="") +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    plot.subtitle = element_text(size = 12),
    legend.position = "bottom"
  ) +
  coord_sf(xlim = bbox[1:2], ylim = bbox[3:4], expand = FALSE)  # Crop the map to Asia

##### Step 5: Plot the time series data with faceting
time_series_plot_D <- ggplot(combined_df_sel, aes(x = time, y = RP, color = window_size)) +
  geom_line() +  # Plot lines for each region's return period
  geom_hline(yintercept = 100, linetype = "dashed", color = "black") +  # Add a reference line for 2-year return period
  labs(
    x = "Year",
    y = "Effective Return Period",
    title = "Frequency Change of 100-Year Events"
  ) +
  scale_color_manual(name = "Window Size", values = c("50yr" = "cadetblue", "150yr" = "chocolate1", "30yr" = "chartreuse")) +
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "lightgreen")
  ) +
  facet_wrap(~region)  # Facet by region with independent y-axis scales

##### Step 6: Arrange the two plots side by side using patchwork
# Explicitly control the layout with patchwork

# Arrange the Map and Time Series Side by Side
grid.arrange(
  map_plot_D, time_series_plot_D,
  ncol = 2,  # Side-by-side layout
  widths = c(1, 2)  # Adjust the relative width of the plots
)


###################################### C AMERICA #######################################
##### Step 2: Filter C AMERICA regions for the map and timeseries
# Filter regions for C America
selected_continent <- "Central America"
sel_regions <- continent_mapping[[selected_continent]]

# Filter combined data for timeseries 
combined_df_sel <- combined_df %>% filter(region %in% sel_regions)

# Filter spatial data for map
sel_regions_sf <- refregions_sf %>% filter(continent %in% selected_continent)

# Define bounding box for C America
bbox <- c(xmin = -130, xmax = -50, ymin = 0, ymax = 40)  # Approximate bounding box for Oceania

#### Step 4: Create the map
map_plot_E <- ggplot() +
  geom_sf(data = land, fill = "lightgray", color = NA) +  # Fill land areas
  geom_sf(data = sel_regions_sf, aes(fill = continent), color = "black", alpha = 0.6) +  # Transparent overlay
  geom_sf_text(data = region_labels, aes(label = label), size = 3, color = "black", check_overlap = TRUE) +  # Add region names
  scale_fill_manual(values = continent_colors, name = "") +
  theme_classic() +
  labs(title = "IPCC Regions", ylabs="", xlabs="") +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    plot.subtitle = element_text(size = 12),
    legend.position = "bottom"
  ) +
  coord_sf(xlim = bbox[1:2], ylim = bbox[3:4], expand = FALSE)  # Crop the map to Asia

##### Step 5: Plot the time series data with faceting
time_series_plot_E <- ggplot(combined_df_sel, aes(x = time, y = RP, color = window_size)) +
  geom_line() +  # Plot lines for each region's return period
  geom_hline(yintercept = 100, linetype = "dashed", color = "black") +  # Add a reference line for 2-year return period
  labs(
    x = "Year",
    y = "Effective Return Period",
    title = "Frequency Change of 100-Year Events"
  ) +
  scale_color_manual(name = "Window Size", values = c("50yr" = "cadetblue", "150yr" = "chocolate1", "30yr" = "chartreuse")) +
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "lightblue")
  ) +
  facet_wrap(~region)  # Facet by region with independent y-axis scales

##### Step 6: Arrange the two plots side by side using patchwork
# Explicitly control the layout with patchwork

# Arrange the Map and Time Series Side by Side
grid.arrange(
  map_plot_E, time_series_plot_E,
  ncol = 2,  # Side-by-side layout
  widths = c(1, 2)  # Adjust the relative width of the plots
)


###################################### S AMERICA #######################################
##### Step 2: Filter S AMERICA regions for the map and timeseries
# Filter regions for S America
selected_continent <- "South America"
sel_regions <- continent_mapping[[selected_continent]]

# Filter combined data for timeseries 
combined_df_sel <- combined_df %>% filter(region %in% sel_regions)

# Filter spatial data for map
sel_regions_sf <- refregions_sf %>% filter(continent %in% selected_continent)

# Define bounding box for S America
bbox <- c(xmin = -90, xmax = -30, ymin = -60, ymax = 15)  # Approximate bounding box for Oceania

#### Step 4: Create the map
map_plot_F <- ggplot() +
  geom_sf(data = land, fill = "lightgray", color = NA) +  # Fill land areas
  geom_sf(data = sel_regions_sf, aes(fill = continent), color = "black", alpha = 0.6) +  # Transparent overlay
  geom_sf_text(data = region_labels, aes(label = label), size = 3, color = "black", check_overlap = TRUE) +  # Add region names
  scale_fill_manual(values = continent_colors, name = "") +
  theme_classic() +
  labs(title = "IPCC Regions", ylabs="", xlabs="") +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    plot.subtitle = element_text(size = 12),
    legend.position = "bottom"
  ) +
  coord_sf(xlim = bbox[1:2], ylim = bbox[3:4], expand = FALSE)  # Crop the map to South America

##### Step 5: Plot the time series data with faceting
time_series_plot_F <- ggplot(combined_df_sel, aes(x = time, y = RP, color = window_size)) +
  geom_line() +  # Plot lines for each region's return period
  geom_hline(yintercept = 100, linetype = "dashed", color = "black") +  # Add a reference line for 100-year return period
  labs(
    x = "Year",
    y = "Effective Return Period",
    title = "Frequency Change of 100-Year Events"
  ) +
  scale_color_manual(name = "Window Size", values = c("50yr" = "cadetblue", "150yr" = "chocolate1", "30yr" = "chartreuse")) +
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "yellow")
  ) +
  facet_wrap(~region)  # Facet by region with independent y-axis scales

##### Step 6: Arrange the two plots side by side using patchwork
# Explicitly control the layout with patchwork

# Arrange the Map and Time Series Side by Side
grid.arrange(
  map_plot_F, time_series_plot_F,
  ncol = 2,  # Side-by-side layout
  widths = c(1, 2)  # Adjust the relative width of the plots
)
```

```{r scatterplot 100yr RP 1864 and 1994, echo=FALSE}
# Load the CSV files for each window size
combined_RP_1850 <- read.csv("~/cwd_global/data/100yr_return_periods_regions_1850.csv")

# Extract data for the first and last years
data_first_last <- combined_RP_1850 %>%
  filter(time == 1864 | time == 1994) %>%
  pivot_wider(names_from = time, values_from = RP, names_prefix = "year_") %>%
  drop_na()  # Remove rows with missing values for the years of interest

# Add continent information to the data
data_first_last <- data_first_last %>%
  mutate(continent = case_when(
    region %in% continent_mapping[["Europe"]] ~ "Europe",
    region %in% continent_mapping[["North America"]] ~ "North America",
    region %in% continent_mapping[["Africa"]] ~ "Africa",
    region %in% continent_mapping[["Asia"]] ~ "Asia",
    region %in% continent_mapping[["Central America"]] ~ "Central America",
    region %in% continent_mapping[["South America"]] ~ "South America",
    region %in% continent_mapping[["Australia"]] ~ "Australia",
    TRUE ~ "Other"
  ))

# Create the scatter plot
ggplot(data_first_last, aes(x = year_1994, y = year_1864, color = continent)) +
  geom_point(size = 3) +
  scale_color_manual(values = continent_colors) +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "black") +
  geom_text(aes(label = region), hjust = 0.5, vjust = -0.5, size = 3, colour = "black") + # Adjust hjust and vjust for positioning
  labs(
    x = "100 yr RP in 1994",
    y = "100 yr RP in 1864",
    title = "PCWD RP in 1864 vs 1994 of 100yr ref event (1420)",
    color = "Continent"
  ) +
  theme_classic()

```


```{r scatterplot 100yr RP 1435 and 1994, echo=FALSE}
# Load the CSV files for each window size
combined_RP_1850 <- read.csv("~/cwd_global/data/100yr_return_periods_regions_1850.csv")
combined_RP_1420 <- read.csv("~/cwd_global/data/100yr_return_periods_regions_1420.csv")

# Extract data for the first and last years
data_first_last_beg <- combined_RP_1420 %>%
  filter(time == 1435) %>%
  pivot_wider(names_from = time, values_from = RP, names_prefix = "year_") %>%
  drop_na()  # Remove rows with missing values for the years of interest

data_first_last_end <- combined_RP_1850 %>%
  filter(time == 1994) %>%
  pivot_wider(names_from = time, values_from = RP, names_prefix = "year_") %>%
  drop_na()  # Remove rows with missing values for the years of interest

# Merge the two datasets on the 'region' column
data_combined <- inner_join(data_first_last_beg, data_first_last_end, by = "region", suffix = c("_beg", "_end"))

# Ensure the continent information is consistent
data_combined <- data_combined %>%
  mutate(continent = case_when(
    region %in% continent_mapping[["Europe"]] ~ "Europe",
    region %in% continent_mapping[["North America"]] ~ "North America",
    region %in% continent_mapping[["Africa"]] ~ "Africa",
    region %in% continent_mapping[["Asia"]] ~ "Asia",
    region %in% continent_mapping[["Central America"]] ~ "Central America",
    region %in% continent_mapping[["South America"]] ~ "South America",
    region %in% continent_mapping[["Australia"]] ~ "Australia",
    TRUE ~ "Other"
  ))

ggplot(data_combined, aes(x = year_1994, y = year_1435, color = continent)) +
  geom_point(size = 3) +
  scale_color_manual(values = continent_colors) +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "black") +
  geom_text(aes(label = region), hjust = 0.5, vjust = -0.5, size = 3, colour = "black") + # Annotate with region names
  labs(
    x = "100 yr RP in 1994",
    y = "100 yr RP in 1435",
    title = "PCWD RP in 1435 vs 1994 of 100yr ref event (1420)",
    color = "Continent"
  ) +
  theme_classic()

```


```{r calc 100 yr RL 1850 for scatterplot, echo=FALSE}
regional_results_1850 <- readRDS("~/cwd_global/data/regionalResults_1850.RData")

use_rp <- 100    # return period of two years
nyears <- 30   # bin width

########1850 epoch
# initialise

################# 1850 -1849 epoch #################

# Initialize a list to store results for all regions
all_regions_RL_1850 <- list()

# Loop through each region in regional_results
for (region in names(regional_results_1850)) { #swap european_regions for regional_results for all regions
  # Extract the result array for the current region
  result_array_region <- regional_results_1850[[region]]
  
  RL_window <- rep(NA, nrow(result_array_region) - nyears + 1)
  
  for (window_start in 1:(nrow(result_array_region) - nyears + 1)){
  
  # Extract data for the current window
    window_data <- result_array_region[window_start:(window_start + nyears - 1), ]
    
    # Flatten the matrix into a single vector
    window_data <- as.vector(window_data)
    
    # Fit Gumbel distribution to the window data
    fit_window <- fevd(window_data, type = "Gumbel")
    
    # Calculate the 2-year return level
    return_level <- return.level(fit_window, return.period = use_rp)
    
    # Store the result in the vector
    RL_window[window_start] <- return_level
  }
  # Create a dataframe for the current region
  time_info <- seq(from = as.numeric(1850), to = as.numeric(2009))  # Replace with actual time if available
  region_df <- data.frame(
    time = time_info[15:145],
    RL = RL_window,
    region = region
  )
  
  # Store the region's dataframe in the results list
  all_regions_RL_1850[[region]] <- region_df
}
  
# Combine all region results into a single dataframe
combined_RL_1850 <- do.call(rbind, all_regions_RL_1850)

```

```{r scatterplot 100yr RL 1864 and 1994, echo=FALSE}
# Extract data for the first and last years
data_first_last <- combined_RL_1850 %>%
  filter(time == 1864 | time == 1994) %>%
  pivot_wider(names_from = time, values_from = RL, names_prefix = "year_") %>%
  drop_na()  # Remove rows with missing values for the years of interest

# Add continent information to the data
data_first_last <- data_first_last %>%
  mutate(continent = case_when(
    region %in% continent_mapping[["Europe"]] ~ "Europe",
    region %in% continent_mapping[["North America"]] ~ "North America",
    region %in% continent_mapping[["Africa"]] ~ "Africa",
    region %in% continent_mapping[["Asia"]] ~ "Asia",
    region %in% continent_mapping[["Central America"]] ~ "Central America",
    region %in% continent_mapping[["South America"]] ~ "South America",
    region %in% continent_mapping[["Australia"]] ~ "Australia",
    TRUE ~ "Other"
  ))

# Create the scatter plot
ggplot(data_first_last, aes(x = year_1994, y = year_1864, color = continent)) +
  geom_point(size = 3) +
  scale_color_manual(values = continent_colors) +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "black") +
  geom_text(aes(label = region), hjust = 0.5, vjust = -0.5, size = 3, colour = "black") + # Adjust hjust and vjust for positioning
  labs(
    x = "100 yr PCWD (mm) in 1994",
    y = "100 yr PCWD (mm) in 1864",
    title = "100 year PCWD RL in 1864 vs 1994",
    color = "Continent"
  ) +
  theme_classic()

```
plot outlier points: 

```{r}
###### 1. Read in return period data
# Load the CSV files for each window size
sel_regions <- c("SWS", "NWS", "WSAF")

# Filter combined data for timeseries 
combined_sel <- combined_RL_1420 %>% filter(region %in% sel_regions)

##### Step 5: Plot the time series data with faceting
ggplot(combined_sel, aes(x = time, y = RL), color = "blue") +
  geom_line() +  # Plot lines for each region's return period
  #geom_hline(yintercept = 2, linetype = "dashed", color = "black") +  # Add a reference line for 2-year return period
  labs(
    x = "Year",
    y = "PCWD RL",
    title = "PCWD 100 year events"
  ) +
  theme_classic() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Center the title
    strip.text = element_text(size = 10),  # Size for facet labels
    strip.background = element_rect(fill = "grey")
  ) +
  facet_wrap(~region, scales = "free_y"
             )  # Facet by region with independent y-axis scales
```


```{r}
# Extract data for the first and last years
data_first_last_beg <- combined_RL_1420 %>%
  filter(time == 1435) %>%
  pivot_wider(names_from = time, values_from = RL, names_prefix = "year_") %>%
  drop_na()  # Remove rows with missing values for the years of interest

data_first_last_end <- combined_RL_1850 %>%
  filter(time == 1994) %>%
  pivot_wider(names_from = time, values_from = RL, names_prefix = "year_") %>%
  drop_na()  # Remove rows with missing values for the years of interest

# Merge the two datasets on the 'region' column
data_combined <- inner_join(data_first_last_beg, data_first_last_end, by = "region", suffix = c("_beg", "_end"))

# Ensure the continent information is consistent
data_combined <- data_combined %>%
  mutate(continent = case_when(
    region %in% continent_mapping[["Europe"]] ~ "Europe",
    region %in% continent_mapping[["North America"]] ~ "North America",
    region %in% continent_mapping[["Africa"]] ~ "Africa",
    region %in% continent_mapping[["Asia"]] ~ "Asia",
    region %in% continent_mapping[["Central America"]] ~ "Central America",
    region %in% continent_mapping[["South America"]] ~ "South America",
    region %in% continent_mapping[["Australia"]] ~ "Australia",
    TRUE ~ "Other"
  ))

ggplot(data_combined, aes(x = year_1994, y = year_1435, color = continent)) +
  geom_point(size = 3) +
  scale_color_manual(values = continent_colors) +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "black") +
  geom_text(aes(label = region), hjust = 0.5, vjust = -0.5, size = 3, colour = "black") + # Annotate with region names
  labs(
    x = "PCWD RL in 1994",
    y = "PCWD RL in 1435",
    title = "100 year PCWD RL in 1435 vs 1994",
    color = "Continent"
  ) +
  theme_classic()

```


# Global maps with return period values

Function to extract return level values depending on return period: 
```{r}
#calculate return periods for each gridcell and plot 

#function that calculates EVA: 
calculate_return_level <- function(data, return_period) {
  # Fit Gumbel distribution
  evd_fit <- extRemes::fevd(x = data, type = "Gumbel", method = "MLE", units = "years")
  
  # Extract the return level for the specified return period
  return_level <- extRemes::return.level(evd_fit, return.period = return_period)
  
  # Return the calculated return level
  return(unname(return_level))
}

```


```{r}
#lat lon and time info from netcdf files
##read in data
input_file_1850 <- "/storage/research/giub_geco/data_2/scratch/phelpap/ModESim/m001_tidy/04_result_1850/PCWD_ANNMAX.nc"
input_file_1420 <- "/storage/research/giub_geco/data_2/scratch/phelpap/ModESim/m001_tidy/04_result_1420/PCWD_ANNMAX.nc"

nc_pwcd_1850 <- nc_open(input_file_1850)
pcwd_annmax_1850 = ncvar_get(nc_pwcd_1850, varid="pcwd_annmax")
lon = ncvar_get(nc_pwcd_1850, varid="lon")
lat = ncvar_get(nc_pwcd_1850, varid="lat")
time_1850 = ncvar_get(nc_pwcd_1850, varid="time")
# Convert to actual dates (days since 2001-01-01)
reference_date <- as.Date("2001-01-01")
time_dates_1850 <- reference_date + time_1850

# # Print the resulting dates
# print(time_dates)

nc_close(nc_pwcd_1850)

#1420 file for 1420 time
nc_pwcd_1420 <- nc_open(input_file_1420)
pcwd_annmax_1420 = ncvar_get(nc_pwcd_1420, varid="pcwd_annmax")
time_1420 = ncvar_get(nc_pwcd_1420, varid="time")
# Convert to actual dates (days since 2001-01-01)
time_dates_1420 <- reference_date + time_1420

# # Print the resulting dates
# print(time_dates)

nc_close(nc_pwcd_1420)
```


Aggregate all 1850 files: 

```{r}
# Define the base path
path <- "/storage/research/giub_geco/data_2/scratch/phelpap/ModESim/"

# List all the directories within the base path
folders <- list.files(path, full.names = TRUE)

# Extract ensemble member identifiers from folder names
ensemble_members <- basename(folders)

# Identify the target files
target_files <- file.path(folders, "04_result_1850/PCWD_ANNMAX.nc")
target_files <- target_files[file.exists(target_files)]  # Ensure only existing files are included

# Filter ensemble members to match target files
ensemble_members <- ensemble_members[file.exists(target_files)]

# Initialize a list to store data for each ensemble member
data_by_ensemble_1850 <- list()

# Extract dimensions from the first file to initialize the array size for consistency
nc <- nc_open(target_files[1])
dim_x <- dim(ncvar_get(nc, "pcwd_annmax"))[1]
dim_y <- dim(ncvar_get(nc, "pcwd_annmax"))[2]
dim_z <- dim(ncvar_get(nc, "pcwd_annmax"))[3]
nc_close(nc)

# Loop through all the target files and store the data in a list
for (i in seq_along(target_files)) {
  file <- target_files[i]
  member <- ensemble_members[i]
  
  # Open the NetCDF file
  nc <- nc_open(file)
  
  # Extract the data variable
  data <- ncvar_get(nc, "pcwd_annmax")  # Adjust "pcwd_annmax" to your variable name
  
  # Store the data in the list, keyed by the ensemble member
  data_by_ensemble_1850[[member]] <- data
  
  # Close the file
  nc_close(nc)
}

# Output the structure of the data list
print(names(data_by_ensemble_1850))  # Check stored ensemble members
print(dim(data_by_ensemble_1850[[1]]))  # Check dimensions of the data for the first ensemble member

```

Aggregate all 1420 files: 

```{r}
# Define the base path
path <- "/storage/research/giub_geco/data_2/scratch/phelpap/ModESim/"

# List all the directories within the base path
folders <- list.files(path, full.names = TRUE)

# Extract ensemble member identifiers from folder names
ensemble_members <- basename(folders)

# Identify the target files
target_files <- file.path(folders, "04_result_1420/PCWD_ANNMAX.nc")
target_files <- target_files[file.exists(target_files)]  # Ensure only existing files are included

# Filter ensemble members to match target files
ensemble_members <- ensemble_members[file.exists(target_files)]

# Initialize a list to store data for each ensemble member
data_by_ensemble_1420 <- list()

# Extract dimensions from the first file to initialize the array size for consistency
nc <- nc_open(target_files[1])
dim_x <- dim(ncvar_get(nc, "pcwd_annmax"))[1]
dim_y <- dim(ncvar_get(nc, "pcwd_annmax"))[2]
dim_z <- dim(ncvar_get(nc, "pcwd_annmax"))[3]
nc_close(nc)

# Loop through all the target files and store the data in a list
for (i in seq_along(target_files)) {
  file <- target_files[i]
  member <- ensemble_members[i]
  
  # Open the NetCDF file
  nc <- nc_open(file)
  
  # Extract the data variable
  data <- ncvar_get(nc, "pcwd_annmax")  # Adjust "pcwd_annmax" to your variable name
  
  # Store the data in the list, keyed by the ensemble member
  data_by_ensemble_1420[[member]] <- data
  
  # Close the file
  nc_close(nc)
}

# Output the structure of the data list
print(names(data_by_ensemble_1420))  # Check stored ensemble members
print(dim(data_by_ensemble_1420[[1]]))  # Check dimensions of the data for the first ensemble member

```
Calculate return level values for 30 year slices e.g. 1420-1450, 1819-1849, 1850-1880, 1979-2009 and calculate delta values
- 30 year chunks
- for 5 year return levels and 500 year return levels
- pooled from all ensemble members i.e. 30 yrs x 20 EMs

```{r}
##pool data for EVA: 

# Define the number of years to pool
years_to_pool <- 30

######################1420-1450 for X5 #####################
# Create an empty list to store pooled data for each grid cell
pooled_data <- array(NA, dim = c(dim_x, dim_y, years_to_pool * length(data_by_ensemble_1420)))

# Index to keep track of where to store the pooled data
current_index <- 1

# Loop through each ensemble member and extract the first 30 years
for (member_data in data_by_ensemble_1420) {
  # Extract the first 30 years
  data_subset <- member_data[,,1:years_to_pool] #edit 1 to whenever need to start e.g. for 1600 at 180:years to pool
  
  # Calculate the slice indices to store the data
  slice_indices <- current_index:(current_index + years_to_pool - 1)
  
  # Store the extracted data in the pooled array
  pooled_data[,,slice_indices] <- data_subset
  
  # Update the index
  current_index <- current_index + years_to_pool
}

# Output the structure of the pooled data
print(dim(pooled_data))  # Should have (x, y, years_to_pool * number of ensemble members)

#####################EVA: 

# Create an empty matrix to store 5-year return levels
X5_1450 <- matrix(NA, nrow = length(lon), ncol = length(lat))

# Loop through each grid cell
for (i in seq_along(lon)) {
  for (j in seq_along(lat)) {
    # Extract time series for the grid cell
    data <- pooled_data[i, j, 1:30]
    
    # Check for NA or insufficient data
   # if (all(is.na(data)) || length(na.omit(data)) < 10) next
    
    # Calculate 80-year return level
    X5_1450[i, j] <- calculate_return_level(data, return_period = 5)
  }
}

# Create an empty matrix to store 5-year return levels
X500_1450 <- matrix(NA, nrow = length(lon), ncol = length(lat))

# Loop through each grid cell
for (i in seq_along(lon)) {
  for (j in seq_along(lat)) {
    # Extract time series for the grid cell
    data <- pooled_data[i, j, 1:30]
    
    # Check for NA or insufficient data
   # if (all(is.na(data)) || length(na.omit(data)) < 10) next
    
    # Calculate 80-year return level
    X500_1450[i, j] <- calculate_return_level(data, return_period = 500)
  }
}

# ################### 1600 - 1630 X5 ###############################
# # Create an empty list to store pooled data for each grid cell
# pooled_data <- array(NA, dim = c(dim_x, dim_y, years_to_pool * length(data_by_ensemble_1420)))
# 
# # Index to keep track of where to store the pooled data
# current_index <- 1
# 
# # Loop through each ensemble member and extract the first 30 years
# for (member_data in data_by_ensemble_1420) {
#   # Extract the first 30 years
#   data_subset <- member_data[,,180:(180+years_to_pool-1)] #edit 1 to whenever need to start e.g. for 1600 at 180:years to pool
#   
#   # Calculate the slice indices to store the data
#   slice_indices <- current_index:(current_index + years_to_pool - 1)
#   
#   # Store the extracted data in the pooled array
#   pooled_data[,,slice_indices] <- data_subset
#   
#   # Update the index
#   current_index <- current_index + years_to_pool
# }
# 
# # Output the structure of the pooled data
# print(dim(pooled_data))  # Should have (x, y, years_to_pool * number of ensemble members)
# 
# #####################EVA: 
# 
# # Create an empty matrix to store 5-year return levels
# X5_1630 <- matrix(NA, nrow = length(lon), ncol = length(lat))
# 
# # Loop through each grid cell
# for (i in seq_along(lon)) {
#   for (j in seq_along(lat)) {
#     # Extract time series for the grid cell
#     data <- pooled_data[i, j, 1:30]
#     
#     # Check for NA or insufficient data
#    # if (all(is.na(data)) || length(na.omit(data)) < 10) next
#     
#     # Calculate 80-year return level
#     X5_1630[i, j] <- calculate_return_level(data, return_period = 5)
#   }
# }
# 
# # Create an empty matrix to store 5-year return levels
# X500_1630 <- matrix(NA, nrow = length(lon), ncol = length(lat))
# 
# # Loop through each grid cell
# for (i in seq_along(lon)) {
#   for (j in seq_along(lat)) {
#     # Extract time series for the grid cell
#     data <- pooled_data[i, j, 1:30]
#     
#     # Check for NA or insufficient data
#    # if (all(is.na(data)) || length(na.omit(data)) < 10) next
#     
#     # Calculate 80-year return level
#     X500_1630[i, j] <- calculate_return_level(data, return_period = 500)
#   }
# }


################### 1819 - 1849 X5 ###############################
# Create an empty list to store pooled data for each grid cell
pooled_data <- array(NA, dim = c(dim_x, dim_y, years_to_pool * length(data_by_ensemble_1420)))

# Index to keep track of where to store the pooled data
current_index <- 1

# Loop through each ensemble member and extract the first 30 years
for (member_data in data_by_ensemble_1420) {
  # Extract the first 30 years
  data_subset <- member_data[,,399:(399+years_to_pool-1)] #edit 1 to whenever need to start e.g. for 1600 at 180:years to pool
  
  # Calculate the slice indices to store the data
  slice_indices <- current_index:(current_index + years_to_pool - 1)
  
  # Store the extracted data in the pooled array
  pooled_data[,,slice_indices] <- data_subset
  
  # Update the index
  current_index <- current_index + years_to_pool
}

# Output the structure of the pooled data
print(dim(pooled_data))  # Should have (x, y, years_to_pool * number of ensemble members)

#####################EVA: 

# Create an empty matrix to store 5-year return levels
X5_1849 <- matrix(NA, nrow = length(lon), ncol = length(lat))

# Loop through each grid cell
for (i in seq_along(lon)) {
  for (j in seq_along(lat)) {
    # Extract time series for the grid cell
    data <- pooled_data[i, j, 1:30]
    
    # Check for NA or insufficient data
   # if (all(is.na(data)) || length(na.omit(data)) < 10) next
    
    # Calculate 80-year return level
    X5_1849[i, j] <- calculate_return_level(data, return_period = 5)
  }
}

# Create an empty matrix to store 5-year return levels
X500_1849 <- matrix(NA, nrow = length(lon), ncol = length(lat))

# Loop through each grid cell
for (i in seq_along(lon)) {
  for (j in seq_along(lat)) {
    # Extract time series for the grid cell
    data <- pooled_data[i, j, 1:30]
    
    # Check for NA or insufficient data
   # if (all(is.na(data)) || length(na.omit(data)) < 10) next
    
    # Calculate 80-year return level
    X500_1849[i, j] <- calculate_return_level(data, return_period = 500)
  }
}

################### 1850 - 1880 X5 ###############################
# Create an empty list to store pooled data for each grid cell
pooled_data <- array(NA, dim = c(dim_x, dim_y, years_to_pool * length(data_by_ensemble_1850)))

# Index to keep track of where to store the pooled data
current_index <- 1

# Loop through each ensemble member and extract the first 30 years
for (member_data in data_by_ensemble_1850) {
  # Extract the first 30 years
  data_subset <- member_data[,,1:years_to_pool] #edit 1 to whenever need to start e.g. for 1600 at 180:years to pool
  
  # Calculate the slice indices to store the data
  slice_indices <- current_index:(current_index + years_to_pool - 1)
  
  # Store the extracted data in the pooled array
  pooled_data[,,slice_indices] <- data_subset
  
  # Update the index
  current_index <- current_index + years_to_pool
}

# Output the structure of the pooled data
print(dim(pooled_data))  # Should have (x, y, years_to_pool * number of ensemble members)

#####################EVA: 

# Create an empty matrix to store 5-year return levels
X5_1880 <- matrix(NA, nrow = length(lon), ncol = length(lat))

# Loop through each grid cell
for (i in seq_along(lon)) {
  for (j in seq_along(lat)) {
    # Extract time series for the grid cell
    data <- pooled_data[i, j, 1:30]
    
    # Check for NA or insufficient data
   # if (all(is.na(data)) || length(na.omit(data)) < 10) next
    
    # Calculate 80-year return level
    X5_1880[i, j] <- calculate_return_level(data, return_period = 5)
  }
}

# Create an empty matrix to store 5-year return levels
X500_1880 <- matrix(NA, nrow = length(lon), ncol = length(lat))

# Loop through each grid cell
for (i in seq_along(lon)) {
  for (j in seq_along(lat)) {
    # Extract time series for the grid cell
    data <- pooled_data[i, j, 1:30]
    
    # Check for NA or insufficient data
   # if (all(is.na(data)) || length(na.omit(data)) < 10) next
    
    # Calculate 80-year return level
    X500_1880[i, j] <- calculate_return_level(data, return_period = 500)
  }
}



################### 1979 - 2009 X5 ###############################
# Create an empty list to store pooled data for each grid cell
pooled_data <- array(NA, dim = c(dim_x, dim_y, years_to_pool * length(data_by_ensemble_1850)))

# Index to keep track of where to store the pooled data
current_index <- 1

# Loop through each ensemble member and extract the first 30 years
for (member_data in data_by_ensemble_1850) {
  # Extract the first 30 years
  data_subset <- member_data[,,129:(129+years_to_pool-1)] #edit 1 to whenever need to start e.g. for 1600 at 180:years to pool
  
  # Calculate the slice indices to store the data
  slice_indices <- current_index:(current_index + years_to_pool - 1)
  
  # Store the extracted data in the pooled array
  pooled_data[,,slice_indices] <- data_subset
  
  # Update the index
  current_index <- current_index + years_to_pool
}

# Output the structure of the pooled data
print(dim(pooled_data))  # Should have (x, y, years_to_pool * number of ensemble members)

#####################EVA: 

# Create an empty matrix to store 5-year return levels
X5_2009 <- matrix(NA, nrow = length(lon), ncol = length(lat))

# Loop through each grid cell
for (i in seq_along(lon)) {
  for (j in seq_along(lat)) {
    # Extract time series for the grid cell
    data <- pooled_data[i, j, 1:30]
    
    # Check for NA or insufficient data
   # if (all(is.na(data)) || length(na.omit(data)) < 10) next
    
    # Calculate 80-year return level
    X5_2009[i, j] <- calculate_return_level(data, return_period = 5)
  }
}

# Create an empty matrix to store 5-year return levels
X500_2009 <- matrix(NA, nrow = length(lon), ncol = length(lat))

# Loop through each grid cell
for (i in seq_along(lon)) {
  for (j in seq_along(lat)) {
    # Extract time series for the grid cell
    data <- pooled_data[i, j, 1:30]
    
    # Check for NA or insufficient data
   # if (all(is.na(data)) || length(na.omit(data)) < 10) next
    
    # Calculate 80-year return level
    X500_2009[i, j] <- calculate_return_level(data, return_period = 500)
  }
}
```

```{r}
####calculate delta values for earlier epoch (1819-1849 - 1420-1450)
X5_D1420 <- X5_1849 - X5_1450
X500_D1420 <- X500_1849 - X500_1450

####calculate delta values for later epoch (1850-1880 - 1979-2009)
X5_D1850<- X5_2009 - X5_1880
X500_D1850 <- X500_2009 - X500_1880


```


Plot on maps: 

Maps showing 5 year return values: 

```{r}
# Convert first year's data into a raster object
r <- raster(t(X5_1450), xmn=min(lon), xmx=max(lon), ymn=min(lat), ymx=max(lat))
crs(r) <- "+proj=longlat +datum=WGS84"  # Set CRS for raster
r <- flip(r, direction='y')

# Retrieve land polygons and set the same CRS as the raster
land <- ne_countries(scale = "medium", returnclass = "sf")
land <- st_transform(land, crs = st_crs(r))  # Ensure CRS alignment

# Mask the raster with land polygons to remove ocean values
r_masked <- mask(r, as(land, "Spatial"))

# Convert the masked raster to a data frame for ggplot2
r_df <- as.data.frame(r_masked, xy = TRUE)
colnames(r_df) <- c("x", "y", "layer")  # Rename columns to match ggplot expectations

# Define custom color bins
custom_bins <- c(0, 20, 40, 60, 80, 100, 150, 200, 300, 500, 700, 900, 1200, 2000, Inf)  # Define breaks based on data range
# Define a custom 13-color palette from deep turquoise to bright pink with earthy tones in between
# Updated custom color palette with two additional colors
custom_colors <- c("#004f5a",  # New color: a darker turquoise at the beginning
                   "#006d75", "#1a9e96", "#55c1ab", "#85c68b", "#d1c54b", "#e8b249", 
                   "#e3842a", "#d45321", "#ba2e1f", "#9e2d2a", "#803c3d", "#63363f", 
                   "#9c276e",  # New color: a deeper shade in the pink tones
                   "#d238a5")

# Define the numeric labels for the breaks
break_labels <- c(as.character(scales::label_number(accuracy = 1)(custom_bins[-length(custom_bins)])), "Ocean")

# Define the ggplot2 object with the gradient scale
ggplot() +
  geom_raster(data = r_df, aes(x = x, y = y, fill = cut(layer, breaks = custom_bins)), na.rm = TRUE) +
  scale_fill_manual(name = "5 yr return level", values = custom_colors, na.value = "lightgrey", 
                    labels = c(levels(cut(r_df$layer, breaks = custom_bins)),"Ocean")) +  # Label ocean
  labs(title = "PCWD ANNMAX X5 1420-1450", x = "Longitude", y = "Latitude") +
  theme_classic() +
  geom_sf(data = land, fill = NA, color = "black", lwd = 0.5) +
  coord_sf(xlim = range(lon), ylim = range(lat), expand = FALSE) +
  theme(legend.title = element_text(size = 12),  # Adjust legend title size
        legend.text = element_text(size = 10)) +  # Adjust legend text size
  guides(fill = guide_legend(title = "PCWD (mm)", reverse = TRUE))  # Adjust legend for better presentation

#################1819-1849 X5

# Convert first year's data into a raster object
r <- raster(t(X5_1849), xmn=min(lon), xmx=max(lon), ymn=min(lat), ymx=max(lat))
crs(r) <- "+proj=longlat +datum=WGS84"  # Set CRS for raster
r <- flip(r, direction='y')

# Retrieve land polygons and set the same CRS as the raster
land <- ne_countries(scale = "medium", returnclass = "sf")
land <- st_transform(land, crs = st_crs(r))  # Ensure CRS alignment

# Mask the raster with land polygons to remove ocean values
r_masked <- mask(r, as(land, "Spatial"))

# Convert the masked raster to a data frame for ggplot2
r_df <- as.data.frame(r_masked, xy = TRUE)
colnames(r_df) <- c("x", "y", "layer")  # Rename columns to match ggplot expectations


# Define the ggplot2 object with the gradient scale
ggplot() +
  geom_raster(data = r_df, aes(x = x, y = y, fill = cut(layer, breaks = custom_bins)), na.rm = TRUE) +
  scale_fill_manual(name = "5 yr return level", values = custom_colors, na.value = "lightgrey", 
                    labels = c(levels(cut(r_df$layer, breaks = custom_bins)),"Ocean")) +  # Label ocean
  labs(title = "PCWD ANNMAX X5 1819-1849", x = "Longitude", y = "Latitude") +
  theme_classic() +
  geom_sf(data = land, fill = NA, color = "black", lwd = 0.5) +
  coord_sf(xlim = range(lon), ylim = range(lat), expand = FALSE) +
  theme(legend.title = element_text(size = 12),  # Adjust legend title size
        legend.text = element_text(size = 10)) +  # Adjust legend text size
  guides(fill = guide_legend(title = "PCWD (mm)", reverse = TRUE))  # Adjust legend for better presentation

#################1850-1880 X5

# Convert first year's data into a raster object
r <- raster(t(X5_1880), xmn=min(lon), xmx=max(lon), ymn=min(lat), ymx=max(lat))
crs(r) <- "+proj=longlat +datum=WGS84"  # Set CRS for raster
r <- flip(r, direction='y')

# Retrieve land polygons and set the same CRS as the raster
land <- ne_countries(scale = "medium", returnclass = "sf")
land <- st_transform(land, crs = st_crs(r))  # Ensure CRS alignment

# Mask the raster with land polygons to remove ocean values
r_masked <- mask(r, as(land, "Spatial"))

# Convert the masked raster to a data frame for ggplot2
r_df <- as.data.frame(r_masked, xy = TRUE)
colnames(r_df) <- c("x", "y", "layer")  # Rename columns to match ggplot expectations


# Define the ggplot2 object with the gradient scale
ggplot() +
  geom_raster(data = r_df, aes(x = x, y = y, fill = cut(layer, breaks = custom_bins)), na.rm = TRUE) +
  scale_fill_manual(name = "5 yr return level", values = custom_colors, na.value = "lightgrey", 
                    labels = c(levels(cut(r_df$layer, breaks = custom_bins)),"Ocean")) +  # Label ocean
  labs(title = "PCWD ANNMAX X5 1850-1880", x = "Longitude", y = "Latitude") +
  theme_classic() +
  geom_sf(data = land, fill = NA, color = "black", lwd = 0.5) +
  coord_sf(xlim = range(lon), ylim = range(lat), expand = FALSE) +
  theme(legend.title = element_text(size = 12),  # Adjust legend title size
        legend.text = element_text(size = 10)) +  # Adjust legend text size
  guides(fill = guide_legend(title = "PCWD (mm)", reverse = TRUE))  # Adjust legend for better presentation

#################1979-2009 X5

# Convert first year's data into a raster object
r <- raster(t(X5_2009), xmn=min(lon), xmx=max(lon), ymn=min(lat), ymx=max(lat))
crs(r) <- "+proj=longlat +datum=WGS84"  # Set CRS for raster
r <- flip(r, direction='y')

# Retrieve land polygons and set the same CRS as the raster
land <- ne_countries(scale = "medium", returnclass = "sf")
land <- st_transform(land, crs = st_crs(r))  # Ensure CRS alignment

# Mask the raster with land polygons to remove ocean values
r_masked <- mask(r, as(land, "Spatial"))

# Convert the masked raster to a data frame for ggplot2
r_df <- as.data.frame(r_masked, xy = TRUE)
colnames(r_df) <- c("x", "y", "layer")  # Rename columns to match ggplot expectations


# Define the ggplot2 object with the gradient scale
ggplot() +
  geom_raster(data = r_df, aes(x = x, y = y, fill = cut(layer, breaks = custom_bins)), na.rm = TRUE) +
  scale_fill_manual(name = "5 yr return level", values = custom_colors, na.value = "lightgrey", 
                    labels = c(levels(cut(r_df$layer, breaks = custom_bins)),"Ocean")) +  # Label ocean
  labs(title = "PCWD ANNMAX X5 1979-2009", x = "Longitude", y = "Latitude") +
  theme_classic() +
  geom_sf(data = land, fill = NA, color = "black", lwd = 0.5) +
  coord_sf(xlim = range(lon), ylim = range(lat), expand = FALSE) +
  theme(legend.title = element_text(size = 12),  # Adjust legend title size
        legend.text = element_text(size = 10)) +  # Adjust legend text size
  guides(fill = guide_legend(title = "PCWD (mm)", reverse = TRUE))  # Adjust legend for better presentation

```

Maps showing 500 year return values: 

```{r}
# Convert first year's data into a raster object
r <- raster(t(X500_1450), xmn=min(lon), xmx=max(lon), ymn=min(lat), ymx=max(lat))
crs(r) <- "+proj=longlat +datum=WGS84"  # Set CRS for raster
r <- flip(r, direction='y')

# Retrieve land polygons and set the same CRS as the raster
land <- ne_countries(scale = "medium", returnclass = "sf")
land <- st_transform(land, crs = st_crs(r))  # Ensure CRS alignment

# Mask the raster with land polygons to remove ocean values
r_masked <- mask(r, as(land, "Spatial"))

# Convert the masked raster to a data frame for ggplot2
r_df <- as.data.frame(r_masked, xy = TRUE)
colnames(r_df) <- c("x", "y", "layer")  # Rename columns to match ggplot expectations

# Define custom color bins
custom_bins <- c(0, 20, 40, 60, 80, 100, 150, 200, 300, 500, 700, 900, 1200, 2000, Inf)  # Define breaks based on data range
# Define a custom 13-color palette from deep turquoise to bright pink with earthy tones in between
# Updated custom color palette with two additional colors
custom_colors <- c("#004f5a",  # New color: a darker turquoise at the beginning
                   "#006d75", "#1a9e96", "#55c1ab", "#85c68b", "#d1c54b", "#e8b249", 
                   "#e3842a", "#d45321", "#ba2e1f", "#9e2d2a", "#803c3d", "#63363f", 
                   "#9c276e",  # New color: a deeper shade in the pink tones
                   "#d238a5")

# Define the numeric labels for the breaks
break_labels <- c(as.character(scales::label_number(accuracy = 1)(custom_bins[-length(custom_bins)])), "Ocean")

# Define the ggplot2 object with the gradient scale
ggplot() +
  geom_raster(data = r_df, aes(x = x, y = y, fill = cut(layer, breaks = custom_bins)), na.rm = TRUE) +
  scale_fill_manual(name = "500 yr return level", values = custom_colors, na.value = "lightgrey", 
                    labels = c(levels(cut(r_df$layer, breaks = custom_bins)),"Ocean")) +  # Label ocean
  labs(title = "PCWD ANNMAX X500 1420-1450", x = "Longitude", y = "Latitude") +
  theme_classic() +
  geom_sf(data = land, fill = NA, color = "black", lwd = 0.5) +
  coord_sf(xlim = range(lon), ylim = range(lat), expand = FALSE) +
  theme(legend.title = element_text(size = 12),  # Adjust legend title size
        legend.text = element_text(size = 10)) +  # Adjust legend text size
  guides(fill = guide_legend(title = "PCWD (mm)", reverse = TRUE))  # Adjust legend for better presentation

#################1819-1849 X500

# Convert first year's data into a raster object
r <- raster(t(X500_1849), xmn=min(lon), xmx=max(lon), ymn=min(lat), ymx=max(lat))
crs(r) <- "+proj=longlat +datum=WGS84"  # Set CRS for raster
r <- flip(r, direction='y')

# Retrieve land polygons and set the same CRS as the raster
land <- ne_countries(scale = "medium", returnclass = "sf")
land <- st_transform(land, crs = st_crs(r))  # Ensure CRS alignment

# Mask the raster with land polygons to remove ocean values
r_masked <- mask(r, as(land, "Spatial"))

# Convert the masked raster to a data frame for ggplot2
r_df <- as.data.frame(r_masked, xy = TRUE)
colnames(r_df) <- c("x", "y", "layer")  # Rename columns to match ggplot expectations


# Define the ggplot2 object with the gradient scale
ggplot() +
  geom_raster(data = r_df, aes(x = x, y = y, fill = cut(layer, breaks = custom_bins)), na.rm = TRUE) +
  scale_fill_manual(name = "500 yr return level", values = custom_colors, na.value = "lightgrey", 
                    labels = c(levels(cut(r_df$layer, breaks = custom_bins)),"Ocean")) +  # Label ocean
  labs(title = "PCWD ANNMAX X500 1819-1849", x = "Longitude", y = "Latitude") +
  theme_classic() +
  geom_sf(data = land, fill = NA, color = "black", lwd = 0.5) +
  coord_sf(xlim = range(lon), ylim = range(lat), expand = FALSE) +
  theme(legend.title = element_text(size = 12),  # Adjust legend title size
        legend.text = element_text(size = 10)) +  # Adjust legend text size
  guides(fill = guide_legend(title = "PCWD (mm)", reverse = TRUE))  # Adjust legend for better presentation

#################1850-1880 X500

# Convert first year's data into a raster object
r <- raster(t(X500_1880), xmn=min(lon), xmx=max(lon), ymn=min(lat), ymx=max(lat))
crs(r) <- "+proj=longlat +datum=WGS84"  # Set CRS for raster
r <- flip(r, direction='y')

# Retrieve land polygons and set the same CRS as the raster
land <- ne_countries(scale = "medium", returnclass = "sf")
land <- st_transform(land, crs = st_crs(r))  # Ensure CRS alignment

# Mask the raster with land polygons to remove ocean values
r_masked <- mask(r, as(land, "Spatial"))

# Convert the masked raster to a data frame for ggplot2
r_df <- as.data.frame(r_masked, xy = TRUE)
colnames(r_df) <- c("x", "y", "layer")  # Rename columns to match ggplot expectations


# Define the ggplot2 object with the gradient scale
ggplot() +
  geom_raster(data = r_df, aes(x = x, y = y, fill = cut(layer, breaks = custom_bins)), na.rm = TRUE) +
  scale_fill_manual(name = "500 yr return level", values = custom_colors, na.value = "lightgrey", 
                    labels = c(levels(cut(r_df$layer, breaks = custom_bins)),"Ocean")) +  # Label ocean
  labs(title = "PCWD ANNMAX X500 1850-1880", x = "Longitude", y = "Latitude") +
  theme_classic() +
  geom_sf(data = land, fill = NA, color = "black", lwd = 0.5) +
  coord_sf(xlim = range(lon), ylim = range(lat), expand = FALSE) +
  theme(legend.title = element_text(size = 12),  # Adjust legend title size
        legend.text = element_text(size = 10)) +  # Adjust legend text size
  guides(fill = guide_legend(title = "PCWD (mm)", reverse = TRUE))  # Adjust legend for better presentation

#################1979-2009 X500

# Convert first year's data into a raster object
r <- raster(t(X500_2009), xmn=min(lon), xmx=max(lon), ymn=min(lat), ymx=max(lat))
crs(r) <- "+proj=longlat +datum=WGS84"  # Set CRS for raster
r <- flip(r, direction='y')

# Retrieve land polygons and set the same CRS as the raster
land <- ne_countries(scale = "medium", returnclass = "sf")
land <- st_transform(land, crs = st_crs(r))  # Ensure CRS alignment

# Mask the raster with land polygons to remove ocean values
r_masked <- mask(r, as(land, "Spatial"))

# Convert the masked raster to a data frame for ggplot2
r_df <- as.data.frame(r_masked, xy = TRUE)
colnames(r_df) <- c("x", "y", "layer")  # Rename columns to match ggplot expectations


# Define the ggplot2 object with the gradient scale
ggplot() +
  geom_raster(data = r_df, aes(x = x, y = y, fill = cut(layer, breaks = custom_bins)), na.rm = TRUE) +
  scale_fill_manual(name = "500 yr return level", values = custom_colors, na.value = "lightgrey", 
                    labels = c(levels(cut(r_df$layer, breaks = custom_bins)),"Ocean")) +  # Label ocean
  labs(title = "PCWD ANNMAX X500 1979-2009", x = "Longitude", y = "Latitude") +
  theme_classic() +
  geom_sf(data = land, fill = NA, color = "black", lwd = 0.5) +
  coord_sf(xlim = range(lon), ylim = range(lat), expand = FALSE) +
  theme(legend.title = element_text(size = 12),  # Adjust legend title size
        legend.text = element_text(size = 10)) +  # Adjust legend text size
  guides(fill = guide_legend(title = "PCWD (mm)", reverse = TRUE))  # Adjust legend for better presentation

```

Delta values 5 yr events: 
```{r}
###1420 epoch:

# Convert first year's data into a raster object
r <- raster(t(X5_D1420), xmn=min(lon), xmx=max(lon), ymn=min(lat), ymx=max(lat))
crs(r) <- "+proj=longlat +datum=WGS84"  # Set CRS for raster
r <- flip(r, direction='y')

# Retrieve land polygons and set the same CRS as the raster
land <- ne_countries(scale = "medium", returnclass = "sf")
land <- st_transform(land, crs = st_crs(r))  # Ensure CRS alignment

# Mask the raster with land polygons to remove ocean values
r_masked <- mask(r, as(land, "Spatial"))

# Convert the masked raster to a data frame for ggplot2
r_df <- as.data.frame(r_masked, xy = TRUE)
colnames(r_df) <- c("x", "y", "layer")  # Rename columns to match ggplot expectations

# Define custom color bins
# Plot using ggplot2
custom_bins <- c(-Inf,-500, -100, -50, -20, -10, -1, 0, 1, 10, 20, 50,100, 500, Inf)  # Define breaks based on data range
# Create a 10-color scale from blue to white to red
custom_colors <- colorRampPalette(c("blue", "white", "red"))(15)

# Define the numeric labels for the breaks
break_labels <- c(as.character(scales::label_number(accuracy = 1)(custom_bins[-length(custom_bins)])), "Ocean")

# Define the ggplot2 object with the gradient scale
ggplot() +
  geom_raster(data = r_df, aes(x = x, y = y, fill = cut(layer, breaks = custom_bins)), na.rm = TRUE) +
  scale_fill_manual(name = "5 yr return level", values = custom_colors, na.value = "lightgrey", 
                    labels = c(levels(cut(r_df$layer, breaks = custom_bins)),"Ocean")) +  # Label ocean
  labs(title = "PCWD ANNMAX X5 delta 1849-1450", x = "Longitude", y = "Latitude") +
  theme_classic() +
  geom_sf(data = land, fill = NA, color = "black", lwd = 0.5) +
  coord_sf(xlim = range(lon), ylim = range(lat), expand = FALSE) +
  theme(legend.title = element_text(size = 12),  # Adjust legend title size
        legend.text = element_text(size = 10)) +  # Adjust legend text size
  guides(fill = guide_legend(title = "PCWD (mm)", reverse = TRUE))  # Adjust legend for better presentation


###1850 epoch delta:

# Convert first year's data into a raster object
r <- raster(t(X5_D1850), xmn=min(lon), xmx=max(lon), ymn=min(lat), ymx=max(lat))
crs(r) <- "+proj=longlat +datum=WGS84"  # Set CRS for raster
r <- flip(r, direction='y')

# Retrieve land polygons and set the same CRS as the raster
land <- ne_countries(scale = "medium", returnclass = "sf")
land <- st_transform(land, crs = st_crs(r))  # Ensure CRS alignment

# Mask the raster with land polygons to remove ocean values
r_masked <- mask(r, as(land, "Spatial"))

# Convert the masked raster to a data frame for ggplot2
r_df <- as.data.frame(r_masked, xy = TRUE)
colnames(r_df) <- c("x", "y", "layer")  # Rename columns to match ggplot expectations

# Define custom color bins
# Plot using ggplot2
custom_bins <- c(-Inf,-500, -100, -50, -20, -10, -1, 0, 1, 10, 20, 50,100, 500, Inf)  # Define breaks based on data range
# Create a 10-color scale from blue to white to red
custom_colors <- colorRampPalette(c("blue", "white", "red"))(15)

# Define the numeric labels for the breaks
break_labels <- c(as.character(scales::label_number(accuracy = 1)(custom_bins[-length(custom_bins)])), "Ocean")

# Define the ggplot2 object with the gradient scale
ggplot() +
  geom_raster(data = r_df, aes(x = x, y = y, fill = cut(layer, breaks = custom_bins)), na.rm = TRUE) +
  scale_fill_manual(name = "5 yr return level", values = custom_colors, na.value = "lightgrey", 
                    labels = c(levels(cut(r_df$layer, breaks = custom_bins)),"Ocean")) +  # Label ocean
  labs(title = "PCWD ANNMAX X5 delta 2009-1880", x = "Longitude", y = "Latitude") +
  theme_classic() +
  geom_sf(data = land, fill = NA, color = "black", lwd = 0.5) +
  coord_sf(xlim = range(lon), ylim = range(lat), expand = FALSE) +
  theme(legend.title = element_text(size = 12),  # Adjust legend title size
        legend.text = element_text(size = 10)) +  # Adjust legend text size
  guides(fill = guide_legend(title = "PCWD (mm)", reverse = TRUE))  # Adjust legend for better presentation

```

Delta values 500 yr events: 
```{r}
###1420 epoch:

# Convert first year's data into a raster object
r <- raster(t(X500_D1420), xmn=min(lon), xmx=max(lon), ymn=min(lat), ymx=max(lat))
crs(r) <- "+proj=longlat +datum=WGS84"  # Set CRS for raster
r <- flip(r, direction='y')

# Retrieve land polygons and set the same CRS as the raster
land <- ne_countries(scale = "medium", returnclass = "sf")
land <- st_transform(land, crs = st_crs(r))  # Ensure CRS alignment

# Mask the raster with land polygons to remove ocean values
r_masked <- mask(r, as(land, "Spatial"))

# Convert the masked raster to a data frame for ggplot2
r_df <- as.data.frame(r_masked, xy = TRUE)
colnames(r_df) <- c("x", "y", "layer")  # Rename columns to match ggplot expectations

# Define custom color bins
# Plot using ggplot2
custom_bins <- c(-Inf,-500, -100, -50, -20, -10, -1, 0, 1, 10, 20, 50,100, 500, Inf)  # Define breaks based on data range
# Create a 10-color scale from blue to white to red
custom_colors <- colorRampPalette(c("blue", "white", "red"))(15)

# Define the numeric labels for the breaks
break_labels <- c(as.character(scales::label_number(accuracy = 1)(custom_bins[-length(custom_bins)])), "Ocean")

# Define the ggplot2 object with the gradient scale
ggplot() +
  geom_raster(data = r_df, aes(x = x, y = y, fill = cut(layer, breaks = custom_bins)), na.rm = TRUE) +
  scale_fill_manual(name = "500 yr return level", values = custom_colors, na.value = "lightgrey", 
                    labels = c(levels(cut(r_df$layer, breaks = custom_bins)),"Ocean")) +  # Label ocean
  labs(title = "PCWD ANNMAX X500 delta 1849-1450", x = "Longitude", y = "Latitude") +
  theme_classic() +
  geom_sf(data = land, fill = NA, color = "black", lwd = 0.5) +
  coord_sf(xlim = range(lon), ylim = range(lat), expand = FALSE) +
  theme(legend.title = element_text(size = 12),  # Adjust legend title size
        legend.text = element_text(size = 10)) +  # Adjust legend text size
  guides(fill = guide_legend(title = "PCWD (mm)", reverse = TRUE))  # Adjust legend for better presentation


###1850 epoch delta:

# Convert first year's data into a raster object
r <- raster(t(X500_D1850), xmn=min(lon), xmx=max(lon), ymn=min(lat), ymx=max(lat))
crs(r) <- "+proj=longlat +datum=WGS84"  # Set CRS for raster
r <- flip(r, direction='y')

# Retrieve land polygons and set the same CRS as the raster
land <- ne_countries(scale = "medium", returnclass = "sf")
land <- st_transform(land, crs = st_crs(r))  # Ensure CRS alignment

# Mask the raster with land polygons to remove ocean values
r_masked <- mask(r, as(land, "Spatial"))

# Convert the masked raster to a data frame for ggplot2
r_df <- as.data.frame(r_masked, xy = TRUE)
colnames(r_df) <- c("x", "y", "layer")  # Rename columns to match ggplot expectations

# Define custom color bins
# Plot using ggplot2
custom_bins <- c(-Inf,-500, -100, -50, -20, -10, -1, 0, 1, 10, 20, 50,100, 500, Inf)  # Define breaks based on data range
# Create a 10-color scale from blue to white to red
custom_colors <- colorRampPalette(c("blue", "white", "red"))(15)

# Define the numeric labels for the breaks
break_labels <- c(as.character(scales::label_number(accuracy = 1)(custom_bins[-length(custom_bins)])), "Ocean")

# Define the ggplot2 object with the gradient scale
ggplot() +
  geom_raster(data = r_df, aes(x = x, y = y, fill = cut(layer, breaks = custom_bins)), na.rm = TRUE) +
  scale_fill_manual(name = "500 yr return level", values = custom_colors, na.value = "lightgrey", 
                    labels = c(levels(cut(r_df$layer, breaks = custom_bins)),"Ocean")) +  # Label ocean
  labs(title = "PCWD ANNMAX X500 delta 2009-1880", x = "Longitude", y = "Latitude") +
  theme_classic() +
  geom_sf(data = land, fill = NA, color = "black", lwd = 0.5) +
  coord_sf(xlim = range(lon), ylim = range(lat), expand = FALSE) +
  theme(legend.title = element_text(size = 12),  # Adjust legend title size
        legend.text = element_text(size = 10)) +  # Adjust legend text size
  guides(fill = guide_legend(title = "PCWD (mm)", reverse = TRUE))  # Adjust legend for better presentation

```
